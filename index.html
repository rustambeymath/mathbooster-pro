    <!DOCTYPE html>
    <html lang="ru">
    <head>
        <meta charset="UTF-8">
        <!-- –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –º–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ iPhone (—á–µ–ª–∫–∞) -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
        <title>MathBooster PRO</title>
        <!-- –°–°–´–õ–ö–ê –í –¢–ï–õ–ï–ì–†–ê–ú–ï –ò –ò–ù–°–¢–ï  -->
        <meta property="og:title" content="MathBooster PRO: –û—Ü–∏—Ñ—Ä—É–π —Å–≤–æ–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç üß†">
        <meta property="og:description" content="–ü—É—Ç—å –∫ 10,000 —á–∞—Å–∞–º –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∑–¥–µ—Å—å. MathBooster PRO ‚Äî —ç—Ç–æ —Ç–≤–æ–π –ª–∏—á–Ω—ã–π –±—É—Ö–≥–∞–ª—Ç–µ—Ä –∑–Ω–∞–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–π –¥–µ–ª–∞–µ—Ç –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π —Ç—Ä—É–¥ –≤–∏–¥–∏–º—ã–º. –£—á–∏—Å—å, –ø–æ–±–µ–∂–¥–∞–π –≤ –¥—É—ç–ª—è—Ö –∏ –∫–∞—á–∞–π —Å–≤–æ–π –º–æ–∑–≥.">
        <meta property="og:image" content="https://rustambeymath.github.io/mathbooster-pro/preview.png">
        <meta property="og:url" content="https://rustambeymath.github.io/mathbooster-pro/">
        <meta property="og:type" content="website">
        <!-- PWA –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <link id="manifest-link" rel="manifest" href="">
    <meta name="theme-color" content="#6C63FF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <!-- –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–±–∏—Ä–∞–µ–º –∞–¥—Ä–µ—Å–Ω—É—é —Å—Ç—Ä–æ–∫—É -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, shrink-to-fit=no"><meta name="mobile-web-app-capable" content="yes"> <!-- ‚Üê –Ω–æ–≤–∞—è -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MathBooster">

    <!-- –ò–∫–æ–Ω–∫–∏ -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
        <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ QR -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
        <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
        <!-- YANDEX METRIKA -->
        <script type="text/javascript" >
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

        ym(105919372, "init", { // <-- –í–°–¢–ê–í–¨ –°–í–û–ô ID –°–ß–ï–¢–ß–ò–ö–ê
                clickmap:true,
                trackLinks:true,
                accurateTrackBounce:true,
                webvisor:true
        });
        
        </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/105919372" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

        <!-- FIREBASE (–ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö) -->
        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
            import { getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, runTransaction, collection, getDocs, query, orderBy, limit, getCountFromServer } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

            // –ö–û–ù–§–ò–ì
            const firebaseConfig = {
                apiKey: "AIzaSyAK4kX2dl93WlpEFLg_eGvpvoeAAF935tQ",
                authDomain: "mathbooster-pro.firebaseapp.com",
                projectId: "mathbooster-pro",
                storageBucket: "mathbooster-pro.firebasestorage.app",
                messagingSenderId: "990295839020",
                appId: "1:990295839020:web:ba5bb8cfa471c2c4a89c89",
                measurementId: "G-8N8MYJPCHR"
            };
        
            let DB_Online; 

            // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ —Å–∫—Ä–∏–ø—Ç–∞)
    try {
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –ö–†–ê–ô–ù–ï –ë–´–°–¢–†–û
        window.DB_Online = { 
            db, doc, setDoc, getDoc, updateDoc, deleteDoc, 
            onSnapshot, runTransaction, 
            collection, getDocs, query, orderBy, limit, getCountFromServer 
        };
        
        window.isFirebaseLoaded = true; // –°–∏–≥–Ω–∞–ª –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
        console.log("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∞");
    } catch(e) {
        console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ Firebase:", e);
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–∏–≤—è–∑–∞–ª–∏—Å—å –ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∫ window —Å–ª—É—á–∞–π–Ω–æ
    delete window.DB;
    delete window.Data;
    delete window._internalState; // –ï—Å–ª–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª
    delete window._storageEngine; // –ï—Å–ª–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª

    // –°–æ–∑–¥–∞–µ–º –ø–æ–¥–¥–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ-–ø—É—Å—Ç—ã—à–∫–∏. 
    // –ï—Å–ª–∏ —Ö–∞–∫–µ—Ä –Ω–∞–ø–∏—à–µ—Ç DB.user.coins = 999, –æ–Ω –∏–∑–º–µ–Ω–∏—Ç —ç—Ç–æ—Ç –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç, 
    // –∞ –Ω–µ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–µ–Ω—å–≥–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.
    window.DB = { user: { coins: 0, level: 0 }, msg: "Nice try, hacker!" };
    window.Data = { save: () => console.log("Save blocked by security system üõ°Ô∏è") };

    console.log("%cüõ°Ô∏è MathBooster Security Active", "color: green; font-weight: bold; font-size: 16px;");
        </script>
        
    <style>
            @supports (padding: max(0px)) {
        body.zen-active {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
    }
            /* === –ë–ê–ó–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï === */
            :root {
                --primary: #6C63FF;
                --bg: #F4F7FE;
                --surface: #FFFFFF;
                --text: #2B3674;
                --text-light: #707EAE;
                --shadow: 0 10px 30px rgba(112, 144, 176, 0.12);
                --radius: 24px;
                --accent: #FF7675;
                --gold: #FFD700;
                --success: #00d26a;
                
                /* Safe Areas for iPhone X+ */
                --safe-top: env(safe-area-inset-top, 0px);
                --safe-bottom: env(safe-area-inset-bottom, 0px);
            }

            /* === –¢–ï–ú–´ –û–§–û–†–ú–õ–ï–ù–ò–Ø (–ü–û–õ–ù–´–ô –°–ü–ò–°–û–ö) === */
            
            /* 1. –°–¢–ê–ù–î–ê–†–¢–ù–´–ï */
            body.theme-standard { --primary: #6C63FF; --bg: #F4F7FE; --surface: #FFFFFF; --text: #2B3674; --text-light: #707EAE; }
            body.theme-gold { --primary: #FFD700; --bg: #1E1E2E; --surface: #2D2D44; --text: #FFFFFF; --text-light: #B8B8D1; --shadow: 0 10px 30px rgba(255, 215, 0, 0.3); }
            body.theme-math { --primary: #00E0D0; --bg: #E0F7FA; --surface: #FFFFFF; --text: #006064; --text-light: #4DD0E1; --shadow: 0 10px 30px rgba(0, 224, 208, 0.2); }
            body.theme-neon { --primary: #D60270; --bg: #0B0014; --surface: #180028; --text: #DE05F8; --text-light: #9B4F96; }
            body.theme-pantone { 
                --primary: #FF8A65;   /* –ù–∞—Å—ã—â–µ–Ω–Ω—ã–π –ø–µ—Ä—Å–∏–∫ */
                --bg: #FFF8E1;        /* –¢–µ–ø–ª—ã–π –∫—Ä–µ–º–æ–≤—ã–π —Ñ–æ–Ω */
                --surface: #FFFFFF;   /* –ë–µ–ª—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ */
                --text: #5D4037;      /* –¢–µ–∫—Å—Ç —Ü–≤–µ—Ç–∞ –∫–æ—Ñ–µ */
                --text-light: #8D6E63; 
                --shadow: 0 10px 30px rgba(255, 138, 101, 0.2); 
            }

            /* üå≤ FOREST (–õ–µ—Å) - –ì–ª—É–±–æ–∫–∏–π –∏–∑—É–º—Ä—É–¥ (Focus) */
            body.theme-forest { 
                --primary: #2E7D32;   /* –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∑–µ–ª–µ–Ω—ã–π */
                --bg: #E8F5E9;        /* –û—á–µ–Ω—å —Å–≤–µ—Ç–ª—ã–π –º—è—Ç–Ω—ã–π —Ñ–æ–Ω */
                --surface: #FFFFFF; 
                --text: #1B5E20;      /* –¢–µ–º–Ω–æ-–∑–µ–ª–µ–Ω—ã–π —Ç–µ–∫—Å—Ç */
                --text-light: #43A047; 
                --shadow: 0 10px 30px rgba(46, 125, 50, 0.15); 
            }
            /* 2. üî• –ù–û–í–´–ï –¢–ï–ú–´  */
            
            /* üìù PAPER (–ë—É–º–∞–≥–∞) */
            body.theme-paper { --primary: #333333; --bg: #F2F2EB; --surface: #FFFFFF; --text: #111111; --text-light: #999999; --shadow: 0 5px 0 rgba(0,0,0,0.05); }

            /* üå∏ SAKURA (–°–∞–∫—É—Ä–∞) */
            body.theme-sakura { --primary: #FF80AB; --bg: #FFF0F5; --surface: #FFFFFF; --text: #880E4F; --text-light: #F06292; --shadow: 0 10px 30px rgba(255, 128, 171, 0.2); }

            /* üçã LEMON (–õ–∏–º–æ–Ω) */
            body.theme-lemon { 
                --primary: #FFD600;   /* –Ø—Ä–∫–∏–π –ñ–µ–ª—Ç—ã–π (–ö–æ—Å—Ç—é–º) */
                --bg: #F2F5F8;        /* –û—á–µ–Ω—å —Å–≤–µ—Ç–ª—ã–π —Ö–æ–ª–æ–¥–Ω—ã–π —Ñ–æ–Ω (–î–µ–Ω—å) */
                --surface: #FFFFFF;   /* –ë–µ–ª—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ */
                --text: #1565C0;      /* –ì–µ—Ä–æ–π—Å–∫–∏–π –°–∏–Ω–∏–π (–¢–µ–∫—Å—Ç) */
                --text-light: #546E7A; /* –°—Ç–∞–ª—å–Ω–æ–π —Å–µ—Ä—ã–π */
                --shadow: 0 10px 30px rgba(21, 101, 192, 0.15); /* –°–∏–Ω—è—è —Ç–µ–Ω—å */
            }

            /* –ö–Ω–æ–ø–∫–∏: –ñ–µ–ª—Ç—ã–µ —Å —Å–∏–Ω–µ–π –æ–±–≤–æ–¥–∫–æ–π (–ö–æ–º–∏–∫—Å-—Å—Ç–∏–ª—å) */
            body.theme-lemon .btn-primary,
            body.theme-lemon .nav-btn.active,
            body.theme-lemon .daily-day.active {
                background: #FFD600;
                color: #0D47A1; /* –¢–µ–º–Ω–æ-—Å–∏–Ω–∏–π –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç */
                font-weight: 900;
                border: 2px solid #0D47A1; /* –ö–æ–Ω—Ç—É—Ä */
            }



            /* üî• MAGMA (–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è) */
            body.theme-magma { --primary: #FF3333; --bg: #000000; --surface: #121212; --text: #FFFFFF; --text-light: #888888; --shadow: 0 0 25px rgba(255, 51, 51, 0.4); }
            
            /* –°–≤–µ—á–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ —Ç–æ–ª—å–∫–æ –¥–ª—è –ú–∞–≥–º—ã */
            body.theme-magma .btn-primary, 
            body.theme-magma .nav-btn.active, 
            body.theme-magma .daily-day.active { 
                box-shadow: 0 0 15px rgba(255, 51, 51, 0.6); 
                border: 1px solid #FF3333; 
            }
    /* üÉè –¢–ï–ú–ê JOKER (–¢–æ–∫—Å–∏–∫) */
            body.theme-joker { 
                --primary: #00E676; /* –Ø–¥–æ–≤–∏—Ç—ã–π –∑–µ–ª–µ–Ω—ã–π */
                --bg: #0F0216;      /* –ü–æ—á—Ç–∏ —á–µ—Ä–Ω—ã–π —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π */
                --surface: #2E003E; /* –ì–ª—É–±–æ–∫–∏–π —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π */
                --text: #FFFFFF;    /* –ë–µ–ª—ã–π (–ì—Ä–∏–º) */
                --text-light: #B388FF; /* –°–≤–µ—Ç–ª–æ-—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π */
                --shadow: 0 0 25px rgba(0, 230, 118, 0.25); /* –ó–µ–ª–µ–Ω–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ */
            }

            /* –û—Å–æ–±—ã–π —Å—Ç–∏–ª—å –∫–Ω–æ–ø–æ–∫ –¥–ª—è –î–∂–æ–∫–µ—Ä–∞ (–ó–µ–ª–µ–Ω—ã–µ —Å —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–º —Ç–µ–∫—Å—Ç–æ–º) */
            body.theme-joker .btn-primary,
            body.theme-joker .nav-btn.active { 
                background: #00E676; 
                color: #2E003E; /* –¢–µ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ —è—Ä–∫–æ–º —Ñ–æ–Ω–µ */
                font-weight: 900;
                box-shadow: 0 0 15px rgba(0, 230, 118, 0.5);
                border: none;
            }
            
            /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è —Ç–µ–º–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ (–æ–Ω–∞ –∏ —Ç–∞–∫ —Ç–µ–º–Ω–∞—è, —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ü–≤–µ—Ç–∞) */
            body.dark-mode.theme-joker {
                --bg: #0F0216;
                --surface: #2E003E;
                --primary: #00E676;
            }

            /* üåå –¢–ï–ú–ê GALAXY (LEGENDARY) */
            body.theme-galaxy { 
                --bg: #0b0014;        /* –û—á–µ–Ω—å —Ç–µ–º–Ω—ã–π —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π */
                --surface: #18002b;   /* –¢–µ–º–Ω–∞—è –º–∞—Ç–µ—Ä–∏—è */
                --text: #ffffff;      /* –ó–≤–µ–∑–¥–Ω–æ-–±–µ–ª—ã–π */
                --text-light: #b39ddb; /* –ó–≤–µ–∑–¥–Ω–∞—è –ø—ã–ª—å */
                --primary: #d500f9;   /* –Ø—Ä–∫–∏–π –Ω–µ–æ–Ω */
                --shadow: 0 0 30px rgba(124, 77, 255, 0.3); /* –§–∏–æ–ª–µ—Ç–æ–≤–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ */
            }

            /* ‚òÑÔ∏è –ê–Ω–∏–º–∞—Ü–∏—è: –ü–ª—ã–≤—É—â–∞—è —Ç—É–º–∞–Ω–Ω–æ—Å—Ç—å */
            @keyframes galaxy-move {
                0% { background-position: 0% 50%; }
                50% { background-position: 100% 50%; }
                100% { background-position: 0% 50%; }
            }

            /* –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∫ –∫–Ω–æ–ø–∫–∞–º */
            body.theme-galaxy .btn-primary,
            body.theme-galaxy .nav-btn.active,
            body.theme-galaxy .daily-day.active,
            body.theme-galaxy .shop-item.active {
                /* –ì—Ä–∞–¥–∏–µ–Ω—Ç –ö–æ—Å–º–æ—Å: –§–∏–æ–ª–µ—Ç–æ–≤—ã–π -> –°–∏–Ω–∏–π -> –†–æ–∑–æ–≤—ã–π */
                background: linear-gradient(270deg, #6200ea, #2962ff, #c51162, #6200ea);
                background-size: 600% 600%; /* –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º, —á—Ç–æ–±—ã –ø–ª—ã–ª–æ –ø–ª–∞–≤–Ω–æ */
                
                animation: galaxy-move 12s ease infinite; /* –ú–µ–¥–ª–µ–Ω–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ */
                
                color: white;
                border: none;
                font-weight: 800;
                box-shadow: 0 0 20px rgba(101, 31, 255, 0.4); /* –ì–ª—É–±–æ–∫–∞—è —Ç–µ–Ω—å */
            }

            /* –¢–µ–º–Ω—ã–π —Ä–µ–∂–∏–º (–§–∏–∫—Å–∏—Ä—É–µ–º, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞–ª–æ—Å—å) */
            body.dark-mode.theme-galaxy {
                --bg: #05000a;
                --surface: #120021;
            }
    /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–∞–ª–æ–∫ –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
    body.dark-mode .modal-content {
        background: var(--surface) !important;
        color: var(--text) !important;
    }

    body.dark-mode #wheel-canvas {
        filter: brightness(0.8) contrast(1.2); /* –ù–µ–º–Ω–æ–≥–æ –ø—Ä–∏–≥–ª—É—à–∞–µ–º —è—Ä–∫–æ—Å—Ç—å –∫–æ–ª–µ—Å–∞ */
    }

    /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è –≤–≤–æ–¥–∞ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è */
    body.dark-mode #transfer-code-display {
        background: var(--bg) !important;
        color: var(--primary) !important;
        border-color: var(--primary) !important;
    }
            /* === –¢–ï–ú–ù–´–ô –†–ï–ñ–ò–ú === */
            body.dark-mode { --bg: #1A1A2E; --surface: #16213E; --text: #EAEAEA; --text-light: #8892B0; --shadow: 0 10px 30px rgba(0, 0, 0, 0.5); }
            body.dark-mode.theme-gold { --primary: #FFEA80; --bg: #1E1E1E; --surface: #2A2A2A; --text-light: #D4AF37; }
            body.dark-mode.theme-standard { --primary: #8B7EFF; }
            body.dark-mode.theme-math { --primary: #00F5E0; }
            body.dark-mode.theme-pantone { 
                --bg: #3E2723;        /* –¢–µ–º–Ω—ã–π —à–æ–∫–æ–ª–∞–¥ */
                --surface: #4E342E; 
                --primary: #FFAB91;   /* –°–≤–µ—Ç–ª—ã–π –ø–µ—Ä—Å–∏–∫ */
                --text: #EFEBE9;
            }

            /* –õ–µ—Å –Ω–æ—á—å—é (–ß–∞—â–∞) */
            body.dark-mode.theme-forest { 
                --bg: #002820;        /* –¢–µ–º–Ω–æ-–±–æ–ª–æ—Ç–Ω—ã–π */
                --surface: #004D40; 
                --primary: #69F0AE;   /* –°–≤–µ—Ç—è—â–∏–π—Å—è –ª–∞–π–º */
                --text: #E0F2F1;
            }

            body.dark-mode.theme-neon { --primary: #FF69B4; }
            
            /* –ù–æ–≤—ã–µ —Ç–µ–º—ã –≤ —Ç–µ–º–Ω–æ–º —Ä–µ–∂–∏–º–µ */
            body.dark-mode.theme-paper { --primary: #FFFFFF; --bg: #121212; --surface: #1E1E1E; --text: #EEEEEE; }
            body.dark-mode.theme-sakura { --primary: #FF80AB; --bg: #1A1A2E; --surface: #16213E; }
            body.dark-mode.theme-lemon { 
                --bg: #0D1B2A;        /* –¢–µ–º–Ω–æ-—Å–∏–Ω–∏–π */
                --surface: #1B263B;   
                --text: #FFFFFF;
                --primary: #FFC107;   
            }        
            body.dark-mode.theme-magma { --bg: #000000; --surface: #121212; --primary: #FF3333; }         
            body.theme-dark {
        --primary: #7B73FF;
        --bg: #1E1E2E;
        --surface: #27293D;
        --text: #EAEAEA;
        --text-light: #A0A0B0;
        --shadow: 0 10px 30px rgba(0,0,0,0.4);
    }

    /* –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –∫–æ–º–±–æ —Å –¥—Ä—É–≥–∏–º–∏ —Ç–µ–º–∞–º–∏ –≤ —Ç—ë–º–Ω–æ–º —Ä–µ–∂–∏–º–µ */
    body.theme-dark.theme-standard { --primary: #8B7EFF; }
    body.theme-dark.theme-math { --primary: #00F5E0; }
    body.theme-dark.theme-pantone { --primary: #FFAB91; }
    body.theme-dark.theme-gold { --primary: #FFD700; --bg: #1E1E1E; --surface: #2A2A2A; }
        /* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ –≤—Ö–æ–¥–∞ */
    .delete-user-btn {
        background: #ff4d4d;
        color: white;
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 10px;
        font-size: 14px;
        flex-shrink: 0;
    }
    .delete-user-btn:active {
        transform: scale(0.9);
    } 
            * { 
                box-sizing: border-box; 
                margin: 0; 
                padding: 0; 
                -webkit-tap-highlight-color: transparent; 
                outline: none; 
            }
            
            body { 
        /* –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã */
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
        background: var(--bg); 
        color: var(--text); 
        /* transition: 0.3s; <-- –≠–¢–û –õ–£–ß–®–ï –û–°–¢–ê–í–ò–¢–¨ –ó–ê–ö–û–ú–ú–ï–ù–¢–ò–†–û–í–ê–ù–ù–´–ú, –ß–¢–û–ë–´ –ù–ï –õ–ê–ì–ê–õ–û */
        min-height: 100vh;
        overflow-x: hidden; 
        user-select: none;
        -webkit-user-select: none;
        
        padding-top: calc(var(--safe-top) + 10px);
        padding-bottom: calc(90px + var(--safe-bottom)); 
    }



            .container { 
                max-width: 1000px; 
                margin: 0 auto; 
                padding: 0 20px; 
                transition: 0.5s; 
            }

            /* === LOGO === */
            .app-logo {
                width: 80px; 
                height: 80px; 
                object-fit: contain; 
                margin-bottom: 10px;
                filter: drop-shadow(0 5px 10px rgba(0,0,0,0.1));
            }

            
            
            /* === UI ELEMENTS === */
            #auth-screen { 
                position: fixed; 
                top: 0; 
                left: 0; 
                width: 100%; 
                height: 100%; 
                background: var(--bg); 
                z-index: 5000; 
                display: flex; 
                flex-direction: column; 
                align-items: center; 
                justify-content: center; 
                padding: 20px; 
                transition: 0.4s; 
                overflow-y: auto; 
                padding-top: var(--safe-top); 
            }
            #auth-screen.hidden { opacity: 0; pointer-events: none; transform: scale(1.1); }
            
            .auth-card { background: var(--surface); padding: 40px; border-radius: 30px; box-shadow: var(--shadow); width: 100%; max-width: 400px; text-align: center; margin: auto; }
            .avatar-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0; }
            .avatar-option { font-size: 30px; padding: 10px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; background: var(--bg); transition: 0.2s; }
            .avatar-option.selected { border-color: var(--primary); background: rgba(0,0,0,0.05); }
            
            .user-list-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--bg); border-radius: 15px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; text-align: left; }
            .user-list-item:hover { transform: translateX(5px); border: 1px solid var(--primary); }
            .user-avatar { font-size: 24px; width: 40px; height: 40px; background: var(--surface); border-radius: 50%; display: flex; align-items: center; justify-content: center; }

            .header-card { background: var(--surface); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
            .profile-mini { display: flex; align-items: center; gap: 12px; cursor: pointer; }
    /* –ê–í–ê–¢–ê–†–ö–ê (–ú–∞–ª–µ–Ω—å–∫–∞—è –≤ —à–∞–ø–∫–µ) */
            .profile-img { 
                width: 50px; 
                height: 50px; 
                min-width: 50px; /* –ß—Ç–æ–±—ã –Ω–µ —Å–∂–∏–º–∞–ª—Å—è */
                
                background: var(--bg); 
                border-radius: 50%; 
                border: 4px solid transparent;
                
                position: relative; /* –í–∞–∂–Ω–æ –¥–ª—è —Ü–µ–Ω—Ç—Ä–æ–≤–∫–∏ */
                overflow: hidden;   /* –û–±—Ä–µ–∑–∞–µ–º, –µ—Å–ª–∏ —ç–º–æ–¥–∑–∏ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π */
                user-select: none;
            }

            /* –≠–ú–û–î–ó–ò –í–ù–£–¢–†–ò (–õ—é–±–æ–≥–æ –∫—Ä—É–≥–∞) */
            .profile-img div {
                position: absolute;
                top: 50%;
                left: 50%;
                
                /* –ú–∞–≥–∏—è —Ü–µ–Ω—Ç—Ä–æ–≤–∫–∏: —Å–¥–≤–∏–≥–∞–µ–º –Ω–∞ 50% –æ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ */
                /* -54% –ø–æ Y –ø–æ–¥–Ω–∏–º–∞–µ—Ç —ç–º–æ–¥–∑–∏ —á—É—Ç—å –≤—ã—à–µ, –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É—è –æ—Ç—Å—Ç—É–ø Apple */
                transform: translate(-50%, -54%); 
                
                font-size: 32px; 
                line-height: 1;
                text-align: center;
                width: 100%;
                height: auto;
                margin: 0;
                padding: 0;
            }

            /* –ê–í–ê–¢–ê–†–ö–ê (–ë–æ–ª—å—à–∞—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ) */
            #profile-avatar-box {
                width: 80px !important;
                height: 80px !important;
                border-width: 6px;
            }
            
            /* –≠–º–æ–¥–∑–∏ –≤–Ω—É—Ç—Ä–∏ –±–æ–ª—å—à–æ–π –∞–≤–∞—Ç–∞—Ä–∫–∏ */
            #profile-avatar-box div {
                font-size: 52px !important; /* –ß—É—Ç—å –±–æ–ª—å—à–µ, —á—Ç–æ–±—ã –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∫—Ä—É–≥ */
            }        
            /* LEAGUES */
            .league-bronze { border-color: #CD7F32; }
            .league-silver { border-color: #C0C0C0; }
            .league-gold { border-color: #FFD700; box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
            .league-platinum { border-color: #E5E4E2; box-shadow: 0 0 12px rgba(229, 228, 226, 0.8); }
            .league-diamond { border-color: #b9f2ff; box-shadow: 0 0 15px rgba(185, 242, 255, 0.6); }
            .league-legend { border-color: #ff4d4d; animation: pulse 2s infinite; }
            @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 77, 77, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0); } }

            .currency-block { display:flex; gap:15px; align-items:center; }
            .currency-item { display:flex; align-items:center; gap:5px; font-weight:bold; font-size:14px; background:var(--bg); padding:5px 12px; border-radius:12px; }
            
            .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
            .stat-pill { background: var(--bg); padding: 10px; border-radius: 15px; text-align: center; }
            .stat-val { font-weight: 800; font-size: 16px; color: var(--primary); }
            .stat-label { font-size: 10px; color: var(--text-light); text-transform: uppercase; font-weight: bold; }

            /* FIXED BOTTOM NAV FOR MOBILE */
            .nav { 
                position: fixed; bottom: 0; left: 0; width: 100%; 
                background: var(--surface); z-index: 1000;
                display: flex; gap: 8px; overflow-x: auto; 
                padding: 10px 10px calc(10px + var(--safe-bottom)) 10px; 
                box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
                scrollbar-width: none; 
            }
            .nav::-webkit-scrollbar { display: none; }
            .nav-btn { background: var(--bg); border: none; padding: 12px 20px; border-radius: 18px; color: var(--text-light); font-weight: 700; cursor: pointer; transition: 0.2s; white-space: nowrap; flex-shrink: 0; font-size: 15px; }
            .nav-btn.active { background: var(--primary); color: white; transform: scale(1.05); box-shadow: 0 5px 15px rgba(108, 99, 255, 0.3); }

            .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
            .card { background: var(--surface); padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow); transition: 0.2s; }
            .btn { padding: 15px; border-radius: 15px; border: none; font-weight: bold; cursor: pointer; width: 100%; transition: 0.2s; font-size: 16px; display:flex; justify-content:center; align-items:center; gap:5px; -webkit-tap-highlight-color: transparent; }
            .btn-primary { background: var(--primary); color: white; }
            .btn-outline { background: transparent; border: 2px solid var(--text-light); color: var(--text-light); }
            .input-field { width: 100%; padding: 15px; border-radius: 15px; border: 2px solid var(--bg); background: var(--bg); color: var(--text); font-size: 16px; margin-bottom: 15px; outline: none; -webkit-appearance: none; }
            .timer-display { font-size: 72px; font-weight: 800; color: var(--text); text-align: center; margin: 15px 0; font-variant-numeric: tabular-nums; transition: 0.3s; }
            
            .achievements-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; }
            .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; }
            .shop-item { padding: 15px; border-radius: 15px; background: var(--bg); cursor: pointer; text-align: center; border: 2px solid transparent; transition: 0.2s; position:relative; overflow:hidden;}
            .shop-item.active { border-color: var(--primary); background: rgba(0,0,0,0.03); box-shadow: var(--shadow); }
            .shop-price-tag { font-size:12px; font-weight:bold; margin-top:5px; color:var(--text-light); }
            .shop-price-tag.affordable { color: var(--primary); }

            .section { display: none; animation: fadeIn 0.3s; }
            .section.active { display: block; }
            @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
            
            .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 6000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); padding: 20px; }
            .modal.show { display: flex; animation: popIn 0.3s; }
            @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
            .modal-content { background: var(--surface); padding: 30px; border-radius: 25px; text-align: center; width: 100%; max-width: 400px; box-shadow: var(--shadow); max-height: 80vh; overflow-y: auto; }
            
            #toast-container { position: fixed; bottom: calc(90px + var(--safe-bottom)); left: 50%; transform: translateX(-50%); z-index: 9999; pointer-events: none; width: max-content; }
            .toast { background: var(--surface); color: var(--text); padding: 12px 25px; border-radius: 50px; font-weight: bold; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-top: 10px; opacity: 0; transform: translateY(20px); transition: 0.4s; border: 2px solid var(--primary); text-align: center; }
            .toast.show { opacity: 1; transform: translateY(0); }

            .stat-detail-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
            .stat-detail-card { background: var(--bg); padding: 12px; border-radius: 15px; text-align: center; }
            .stat-detail-title { font-size: 10px; color: var(--text-light); font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
            .stat-detail-value { font-size: 18px; font-weight: 800; color: var(--primary); }
            .stat-detail-sub { font-size: 10px; color: var(--text-light); margin-top: 2px; }

            .trainer-box { text-align: center; padding: 20px; }
            .trainer-problem { font-size: 42px; font-weight: 800; color: var(--primary); margin: 20px 0; font-family: monospace; white-space: nowrap; }
            .trainer-stats { display: flex; justify-content: space-around; margin-bottom: 20px; font-size: 18px; font-weight: bold; color: var(--text-light); }
            .trainer-input { font-size: 32px; text-align: center; font-weight: bold; letter-spacing: 2px; background: var(--surface); border-color: var(--text-light); }

            .daily-grid { display: flex; justify-content: center; gap: 8px; margin: 20px 0; }
            .daily-day { width: 45px; height: 65px; border-radius: 12px; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; opacity: 0.5; transition: 0.3s; }
            .daily-day.active { opacity: 1; border: 2px solid var(--primary); background: var(--surface); transform: scale(1.15); box-shadow: var(--shadow); }
            .daily-day.claimed { opacity: 1; background: var(--primary); color: white; }
            .daily-coin { font-size: 18px; margin-bottom: 4px; }

    .subject-manage-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 12px;
    }

    .subject-item {
        padding: 12px;
        border-radius: 12px;
        background: var(--surface);
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid var(--primary);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .subject-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    }

    /* –£–±–∏—Ä–∞–µ–º –ª—é–±–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ ‚Äî —Ç–µ–ø–µ—Ä—å –í–°–Å –æ–¥–∏–Ω–∞–∫–æ–≤–æ */


    .subject-item .icon {
        font-size: 28px;
        margin-bottom: 6px;
    }
    .subject-item .name {
        font-size: 13px;
        font-weight: 600;
    }        .subject-manage-row { display: flex; justify-content: space-between; align-items: center; background: var(--bg); padding: 12px 15px; border-radius: 15px; }
            .subject-manage-info { display: flex; align-items: center; gap: 10px; font-weight: bold; }
            .btn-delete { width: 32px; height: 32px; border-radius: 50%; border: none; background: #FF7675; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: 0.2s; }
            .btn-delete:hover { transform: scale(1.1); }
            
            .preset-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin-top: 10px; }
            .preset-btn {
        padding: 12px;
        border-radius: 12px;
        background: var(--surface);
        border: 2px solid var(--primary);
        color: var(--text);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 16px;
    }

    .preset-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        background: rgba(var(--primary-rgb), 0.1);
    }

    .preset-btn::before {
        font-size: 24px;
        content: attr(data-emoji); /* –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å data-–∞—Ç—Ä–∏–±—É—Ç */
    }

            /* CALCULATOR */
            .calc-box { width: 95%; max-width: 320px; }
            .calc-display { background: var(--bg); padding: 20px; font-size: 32px; text-align: right; border-radius: 15px; margin-bottom: 15px; font-family: monospace; font-weight: bold; color: var(--text); overflow: hidden; white-space: nowrap; }
            .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
            .calc-btn { padding: 15px; font-size: 22px; border-radius: 12px; border: none; background: var(--bg); color: var(--text); cursor: pointer; transition: 0.1s; font-weight: bold; touch-action: manipulation; }
            .calc-btn:active { transform: scale(0.9); background: rgba(0,0,0,0.1); }
            .calc-btn.op { color: var(--primary); background: rgba(108, 99, 255, 0.1); }
            .calc-btn.eq { background: var(--primary); color: white; grid-column: span 2; }
            .calc-btn.clr { color: #FF7675; }

            /* WHITEBOARD */
            .canvas-box { background: white; border-radius: 15px; cursor: crosshair; touch-action: none; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); width: 100%; border: 2px solid var(--bg); }
            .whiteboard-controls { display: flex; gap: 10px; margin-top: 10px; }

            /* SESSION LOG */
            .session-log { max-height: 250px; overflow-y: auto; }
            .session-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 13px; }
            .session-row:last-child { border-bottom: none; }
            .session-info { display: flex; flex-direction: column; }
            .session-date { font-size: 10px; color: var(--text-light); }
            .session-coins { color: var(--gold); font-weight: bold; background: rgba(255, 215, 0, 0.1); padding: 2px 8px; border-radius: 8px; }

            /* FX */
            .float-text { position: fixed; pointer-events: none; animation: floatUp 1s forwards; font-weight: 800; z-index: 9999; text-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 18px; }
            @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-50px) scale(1.3); opacity: 0; } }
            .confetti-piece { position: fixed; width: 10px; height: 10px; z-index: 9999; pointer-events: none; animation: fall linear forwards; }
            @keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotate(720deg); opacity: 0; } }

            /* ACHIEVEMENTS LIST */
            .ach-list { display: flex; flex-direction: column; gap: 10px; }
            .ach-row { display: flex; align-items: center; gap: 15px; background: var(--bg); padding: 15px; border-radius: 15px; transition: 0.2s; border: 2px solid transparent; }
    .ach-row.unlocked { 
        background: linear-gradient(135deg, #ffffff, #fff9e6); 
        border-color: #FFD700; 
        box-shadow: 0 5px 15px rgba(255, 215, 0, 0.2); 
        transform: scale(1.02);
    }
    /* –î–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
    body.dark-mode .ach-row.unlocked {
        background: linear-gradient(135deg, #16213E, #2c2501);
        border-color: #FFD700;
    }        .ach-icon { font-size: 28px; width: 50px; height: 50px; background: rgba(0,0,0,0.05); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
            .ach-row.unlocked .ach-icon { background: var(--success); color: white; }
            .ach-info { flex-grow: 1; }
            .ach-title { font-weight: bold; font-size: 14px; margin-bottom: 3px; display: flex; justify-content: space-between; }
            .ach-desc { font-size: 12px; color: var(--text-light); margin-bottom: 8px; }
            .ach-bar-bg { width: 100%; height: 6px; background: rgba(0,0,0,0.1); border-radius: 3px; overflow: hidden; }
            .ach-bar-fill { height: 100%; background: var(--primary); transition: 0.5s; }
            .ach-row.unlocked .ach-bar-fill { background: var(--success); }

            /* GENDER & DATE PICKER */
            .reg-group { text-align: left; margin-bottom: 15px; }
            .reg-label { font-size: 12px; color: var(--text-light); margin-bottom: 5px; font-weight: bold; }
            .gender-switch { display: flex; gap: 10px; }
            .gender-btn { flex: 1; padding: 10px; border: 2px solid var(--bg); background: var(--bg); border-radius: 12px; cursor: pointer; font-weight: bold; color: var(--text-light); }
            .gender-btn.active { border-color: var(--primary); color: var(--primary); background: rgba(108, 99, 255, 0.05); }

            /* DIFFICULTY BUTTONS */
            .diff-switch { display: flex; gap: 5px; justify-content: center; margin-bottom: 20px; }
            .diff-btn { padding: 8px 15px; border: 2px solid var(--bg); background: var(--surface); border-radius: 10px; cursor: pointer; font-size: 12px; font-weight: bold; color: var(--text-light); }
            .diff-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

            /* MUSIC WIDGET */
            .music-widget { display: flex; align-items: center; justify-content: space-between; background: var(--bg); padding: 10px 15px; border-radius: 15px; margin-bottom: 15px; }
            .music-info { display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 13px; color: var(--text); }
            .visualizer { display: flex; gap: 2px; align-items: flex-end; height: 15px; }
            .bar { width: 3px; background: var(--primary); animation: equalizer 1s infinite; }
            @keyframes equalizer { 0% { height: 5px; } 50% { height: 15px; } 100% { height: 5px; } }

            @media (max-width: 600px) {
                .stat-detail-grid { grid-template-columns: 1fr; }
                .header-card { flex-direction: column; align-items: flex-start; gap: 15px; }
                .currency-block { width: 100%; justify-content: space-between; }
                .nav-btn { padding: 10px 15px; font-size: 13px; }
                .preset-grid { grid-template-columns: repeat(3, 1fr); }
                .auth-card { padding: 30px 20px; }
            }

    /* === –ê–î–ê–ü–¢–ê–¶–ò–Ø –ü–û–î –¢–ï–õ–ï–§–û–ù ‚Äî –ì–õ–ê–í–ù–û–ï === */
    body {
        -webkit-text-size-adjust: 100%;
        word-break: break-word; /* –¥–ª–∏–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ –ø–µ—Ä–µ–Ω–æ—Å—è—Ç—Å—è */
        overflow-wrap: anywhere;
    }

    /* –í—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∏ –∫–Ω–æ–ø–∫–∏ */
    .card, .btn, .input-field, .modal-content, .nav-btn {
        word-wrap: break-word;
        overflow-wrap: anywhere;
    }

    /* –¢–µ–∫—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —á–∞—Å—Ç–æ –≤—ã–ª–µ–∑–∞–ª–∏ */
    .trainer-problem {
        font-size: 9vw; /* –≤–º–µ—Å—Ç–æ 42px ‚Äî —Ç–µ–ø–µ—Ä—å –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è */
        word-break: break-all;
        padding: 10px;
    }

    /* –¢–∞–π–º–µ—Ä –≤ Zen-—Ä–µ–∂–∏–º–µ */
    body.zen-active #timer {
        font-size: 16vw; /* –±—ã–ª–æ 18vw ‚Äî —á—É—Ç—å –º–µ–Ω—å—à–µ, —á—Ç–æ–±—ã –≤–ª–µ–∑–∞–ª */
    }

    /* –ö–Ω–æ–ø–∫–∏ –≤ –Ω–∏–∂–Ω–µ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
    .nav {
        padding: 10px 5px calc(10px + var(--safe-bottom));
        gap: 5px;
    }
    .nav-btn {
        padding: 10px 12px;
        font-size: 12px;
        min-width: 60px;
    }

    /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ‚Äî —á—Ç–æ–±—ã –≥—Ä–∞—Ñ–∏–∫–∏ –Ω–µ –≤—ã–ª–µ–∑–∞–ª–∏ */
    #subjectChart, #weekChart {
        max-height: 250px;
    }

    /* –ú–æ–¥–∞–ª–∫–∏ */
    .modal-content {
        margin: 20px;
        max-width: calc(100vw - 40px);
    }

    /* –ê–∫—Ç–∏–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ —Ä–µ–∂–∏–º–∞ */
    .mode-btn.active {
        border-color: var(--primary) !important;
        background: rgba(108, 99, 255, 0.05) !important; /* –õ–µ–≥–∫–∏–π —Ñ–æ–Ω */
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        transform: scale(1.02);
    }

    /* –£–º–µ–Ω—å—à–∞–µ–º —à—Ä–∏—Ñ—Ç—ã –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
    @media (max-width: 380px) {
        .timer-display { font-size: 60px; }
        .trainer-problem { font-size: 8vw; }
        .nav-btn { font-size: 11px; padding: 10px 8px; }
        h2 { font-size: 22px; }
        h3 { font-size: 18px; }
    }

    /* === PREMIUM SPLASH SCREEN (WHITE VERSION) === */
            #splash-screen {
                position: fixed;
                top: 0; left: 0;
                width: 100vw; height: 100vh;
                background: #ffffff; /* üî• –ë–ï–õ–´–ô –§–û–ù */
                z-index: 99999;
                display: flex;
                justify-content: center;
                align-items: center;
                overflow: hidden;
                transition: opacity 0.6s ease-out, visibility 0.6s;
                font-family: 'Inter', sans-serif;
            }

            #splash-screen.hidden {
                opacity: 0;
                visibility: hidden;
                pointer-events: none;
            }

            /* –§–æ–Ω–æ–≤—ã–µ –ø—è—Ç–Ω–∞ (–î–µ–ª–∞–µ–º –∏—Ö –Ω–µ–∂–Ω–µ–µ –Ω–∞ –±–µ–ª–æ–º) */
            .splash-bg-circle {
                position: absolute;
                border-radius: 50%;
                filter: blur(60px);
                opacity: 0.15; /* –ß—É—Ç—å –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ */
                animation: float-bg 6s infinite alternate;
            }
            .c1 { width: 300px; height: 300px; background: #6C63FF; top: -50px; left: -50px; }
            .c2 { width: 250px; height: 250px; background: #FF7675; bottom: -50px; right: -50px; animation-delay: 2s; }

            @keyframes float-bg { from { transform: translate(0,0); } to { transform: translate(20px, 20px); } }

            .splash-content {
                text-align: center;
                position: relative;
                z-index: 2;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            /* –õ–æ–≥–æ—Ç–∏–ø */
            .splash-logo-wrapper { position: relative; margin-bottom: 20px; }
            .splash-logo-img {
                width: 120px;
                height: auto;
                position: relative;
                z-index: 2;
                animation: logo-breath 3s infinite ease-in-out;
                /* –¢–µ–Ω—å –¥–ª—è –ª–æ–≥–æ—Ç–∏–ø–∞, —á—Ç–æ–±—ã –≤—ã–¥–µ–ª—è–ª—Å—è –Ω–∞ –±–µ–ª–æ–º */
                filter: drop-shadow(0 10px 20px rgba(108, 99, 255, 0.2)); 
            }
            
            /* –°–≤–µ—á–µ–Ω–∏–µ –ø–æ–¥ –ª–æ–≥–æ */
            .splash-glow {
                position: absolute;
                top: 50%; left: 50%;
                transform: translate(-50%, -50%);
                width: 100px; height: 100px;
                background: rgba(108, 99, 255, 0.2); /* –°–≤–µ—Ç–ª–µ–µ */
                border-radius: 50%;
                filter: blur(20px);
                z-index: 1;
                animation: glow-pulse 2s infinite;
            }

            @keyframes logo-breath { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
            @keyframes glow-pulse { 0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(1); } 50% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.2); } }

            /* –¢–µ–∫—Å—Ç (–¢–ï–ú–ù–´–ô) */
            .splash-title {
                font-size: 28px;
                color: #2B3674; /* üî• –¢–ï–ú–ù–û-–°–ò–ù–ò–ô */
                font-weight: 900;
                margin-bottom: 30px;
                letter-spacing: 1px;
            }
            .splash-badge {
                background: linear-gradient(45deg, #FFD700, #FFA500);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                font-size: 14px;
                vertical-align: super;
            }

            /* –ü–æ–ª–æ—Å–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ */
            .splash-progress-container {
                width: 200px;
                height: 6px;
                background: #F4F7FE; /* üî• –°–í–ï–¢–õ–û-–°–ï–†–´–ô */
                border-radius: 10px;
                overflow: hidden;
                margin-bottom: 10px;
                position: relative;
            }
            .splash-progress-bar {
                height: 100%;
                width: 0%;
                background: linear-gradient(90deg, #6C63FF, #FF7675);
                border-radius: 10px;
                transition: width 0.3s ease-out;
            }

            .splash-text {
                color: #707EAE; /* üî• –°–ï–†–´–ô –¢–ï–ö–°–¢ */
                font-size: 12px;
                font-weight: 600;
                min-height: 18px;
            }

    /* === ECO MODE (OLED SAVER) === */
    #eco-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: #000000;
        z-index: 99999;
        display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: #333; /* –û—á–µ–Ω—å —Ç—É—Å–∫–ª—ã–π —Ç–µ–∫—Å—Ç */
        font-family: monospace;
        touch-action: manipulation;
    }

    #eco-overlay.active {
        display: flex;
    }

    .eco-text {
        font-size: 14px;
        margin-top: 20px;
        opacity: 0.3;
    }

    /* –§–∏–∫—Å –¥–ª—è —Ç—Ä–µ–Ω–∞–∂–µ—Ä–∞ –≤ —Ä–∞–∑–Ω—ã—Ö —Ç–µ–º–∞—Ö */
    .trainer-problem {
        color: var(--primary); /* –í—Å–µ–≥–¥–∞ –±–µ—Ä–µ—Ç –≥–ª–∞–≤–Ω—ã–π —Ü–≤–µ—Ç —Ç–µ–º—ã (–ö—Ä–∞—Å–Ω—ã–π –≤ –º–∞–≥–º–µ, –ó–æ–ª–æ—Ç–æ–π –≤ –∑–æ–ª–æ—Ç–µ) */
        text-shadow: 2px 2px 0px var(--bg); /* –¢–µ–Ω—å —Ü–≤–µ—Ç–∞ —Ñ–æ–Ω–∞ –¥–µ–ª–∞–µ—Ç —Ç–µ–∫—Å—Ç —á–∏—Ç–∞–µ–º—ã–º –≤–µ–∑–¥–µ */
    }

    /* –ö–Ω–æ–ø–∫–∏ –≤ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–µ */
    #sign-area .btn {
        transition: transform 0.1s, background 0.2s;
    }
    #sign-area .btn:active {
        transform: scale(0.9);
        background: var(--primary) !important;
        color: white !important;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–≤–∏–∂–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ –≤—ã–≥–æ—Ä–∞–ª —ç–∫—Ä–∞–Ω */
    @keyframes drift {
        0% { transform: translate(0, 0); }
        25% { transform: translate(10px, 10px); }
        50% { transform: translate(-10px, 20px); }
        75% { transform: translate(-20px, -10px); }
        100% { transform: translate(0, 0); }
    }

    .eco-floater {
        animation: drift 60s infinite linear;
        text-align: center;
    }

    #eco-timer-display {
        font-size: 80px;
        font-weight: bold;
        color: #444444; /* <--- –¢–ï–ü–ï–†–¨ –û–ù –ë–£–î–ï–¢ –í–ò–î–ï–ù */
        font-family: monospace;
    }



    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    * {
        font-family: "Segoe UI", Roboto, "Noto Color Emoji", sans-serif !important;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –æ—à–∏–±–∫–∏ (–¢—Ä—è—Å–∫–∞) */
    @keyframes shake {
        0% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        50% { transform: translateX(5px); }
        75% { transform: translateX(-5px); }
        100% { transform: translateX(0); }
    }

    .error-shake {
        animation: shake 0.4s;
        border-color: red !important;
        background: rgba(255, 0, 0, 0.1) !important;
    }

    /* –ö–ª–∞—Å—Å –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞–∂–∞—Ç–∏–π */
    .input-locked {
        opacity: 0.5;
        pointer-events: none; /* –ó–∞–ø—Ä–µ—â–∞–µ—Ç –∫–ª–∏–∫–∏ */
        filter: grayscale(1);
    }

    /* === –†–ê–ú–ö–ò –ê–í–ê–¢–ê–†–û–í === */
            
            /* –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è —Ä–∞–º–æ–∫ */
            .profile-img.framed { box-sizing: content-box; } /* –í–∞–∂–Ω–æ –¥–ª—è –æ–±–≤–æ–¥–∫–∏ */

            /* ü•á –ó–æ–ª–æ—Ç–æ */
            .frame-gold {
                border: 3px solid #FFD700 !important;
                box-shadow: 0 0 10px #FFD700, inset 0 0 5px #FFD700;
            }

            /* ü¶Ñ –ù–µ–æ–Ω */
            /* ü¶Ñ –£–õ–£–ß–®–ï–ù–ù–ê–Ø –ù–ï–û–ù–û–í–ê–Ø –†–ê–ú–ö–ê (CYBERPUNK) */
            @keyframes neon-glow {
                0% { 
                    border-color: #00FFFF; 
                    box-shadow: 0 0 10px #00FFFF, 0 0 20px #00FFFF, inset 0 0 5px #00FFFF;
                    filter: hue-rotate(0deg);
                }
                50% { 
                    border-color: #FF00FF; 
                    box-shadow: 0 0 15px #FF00FF, 0 0 30px #FF00FF, inset 0 0 10px #FF00FF;
                }
                100% { 
                    border-color: #00FF00; 
                    box-shadow: 0 0 10px #00FF00, 0 0 20px #00FF00, inset 0 0 5px #00FF00;
                    filter: hue-rotate(360deg);
                }
            }

            /* –≠—Ñ—Ñ–µ–∫—Ç –º–µ—Ä—Ü–∞–Ω–∏—è (–∫–∞–∫ —É —Å—Ç–∞—Ä–æ–π –ª–∞–º–ø—ã) */
            @keyframes neon-flicker {
                0%, 19.999%, 22%, 62.999%, 64%, 64.999%, 70%, 100% { opacity: 1; }
                20%, 21.999%, 63%, 63.999%, 65%, 69.999% { opacity: 0.8; filter: brightness(0.5); }
            }

            .frame-neon {
                border: 3px solid #00FFFF !important;
                animation: neon-glow 4s linear infinite, neon-flicker 10s infinite;
                position: relative;
                background: #000000 !important; /* –ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ */
                overflow: visible !important;
            }

            /* –î–µ–∫–æ—Ä: –ù–µ–æ–Ω–æ–≤—ã–µ –∏—Å–∫—Ä—ã —Å–≤–µ—Ä—Ö—É –∏ —Å–Ω–∏–∑—É */
            .frame-neon::before {
                content: '‚ú®';
                position: absolute;
                top: -15px;
                right: -5px;
                font-size: 14px;
                animation: neon-star 2s infinite ease-in-out;
            }

            .frame-neon::after {
                content: '‚ö°';
                position: absolute;
                bottom: -10px;
                left: -5px;
                font-size: 14px;
                animation: neon-star 2s infinite ease-in-out reverse;
            }

            @keyframes neon-star {
                0%, 100% { transform: scale(1); opacity: 0.5; }
                50% { transform: scale(1.3); opacity: 1; }
            }

            /* üî• –û–≥–æ–Ω—å (–ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π) */
            /* üî• –£–õ–£–ß–®–ï–ù–ù–ê–Ø –†–ê–ú–ö–ê: –û–ì–û–ù–¨ */
            @keyframes fire-burn {
                0% { 
                    box-shadow: 0 0 10px #FF4500, 0 0 20px #FF8C00, inset 0 0 10px #FF4500; 
                    border-color: #FF4500; 
                }
                50% { 
                    box-shadow: 0 0 25px #FF0000, 0 0 35px #FFD700, inset 0 0 15px #FF0000; 
                    border-color: #FFD700; 
                    transform: scale(1.02); /* –õ–µ–≥–∫–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –æ—Ç "–∂–∞—Ä–∞" */
                }
                100% { 
                    box-shadow: 0 0 10px #FF4500, 0 0 20px #FF8C00, inset 0 0 10px #FF4500; 
                    border-color: #FF4500; 
                }
            }

            .frame-fire {
                border: 4px solid #FF4500 !important;
                animation: fire-burn 1.2s infinite ease-in-out;
                position: relative;
                background: linear-gradient(0deg, #8B0000, #FF4500) !important;
                overflow: visible !important;
            }

            /* –Ø–∑—ã–∫–∏ –ø–ª–∞–º–µ–Ω–∏ –ø–æ –±–æ–∫–∞–º */
            .frame-fire::before {
                content: 'üî•';
                position: absolute;
                bottom: -12px;
                left: -10px;
                font-size: 20px;
                z-index: 10;
                animation: flame-flicker 0.4s infinite alternate;
            }

            .frame-fire::after {
                content: 'üî•';
                position: absolute;
                bottom: -12px;
                right: -10px;
                font-size: 20px;
                z-index: 10;
                animation: flame-flicker 0.4s infinite alternate-reverse;
            }

            @keyframes flame-flicker {
                from { transform: translateY(0) scale(1) rotate(-10deg); filter: brightness(1); }
                to { transform: translateY(-5px) scale(1.2) rotate(10deg); filter: brightness(1.3); }
            }

            /* üëæ –£–õ–£–ß–®–ï–ù–ù–ê–Ø –†–ê–ú–ö–ê: –•–ê–ö–ï–† (MATRIX) */
            @keyframes matrix-border {
                0% { border-color: #00FF00; box-shadow: 0 0 5px #00FF00, inset 0 0 5px #00FF00; }
                50% { border-color: #003300; box-shadow: 0 0 15px #00FF00, inset 0 0 10px #00FF00; }
                100% { border-color: #00FF00; box-shadow: 0 0 5px #00FF00, inset 0 0 5px #00FF00; }
            }

            @keyframes glitch-move {
                0% { transform: translate(0); }
                20% { transform: translate(-2px, 1px); }
                40% { transform: translate(-2px, -1px); }
                60% { transform: translate(2px, 1px); }
                80% { transform: translate(2px, -1px); }
                100% { transform: translate(0); }
            }

            .frame-glitch {
                border: 3px solid #00FF00 !important;
                animation: matrix-border 0.5s infinite, glitch-move 0.2s infinite;
                background: #000000 !important;
                position: relative;
                overflow: visible !important;
            }

            /* –ë–µ–≥—É—â–∏–π –±–∏–Ω–∞—Ä–Ω—ã–π –∫–æ–¥ —Å–ª–µ–≤–∞ */
            .frame-glitch::before {
                content: '0110';
                position: absolute;
                left: -20px;
                top: 50%;
                transform: translateY(-50%);
                font-family: monospace;
                font-size: 10px;
                color: #00FF00;
                text-shadow: 0 0 5px #00FF00;
                writing-mode: vertical-rl;
                animation: matrix-rain 1s infinite linear;
            }

            /* –ë–µ–≥—É—â–∏–π –∫–æ–¥ —Å–ø—Ä–∞–≤–∞ */
            .frame-glitch::after {
                content: '1001';
                position: absolute;
                right: -20px;
                top: 50%;
                transform: translateY(-50%);
                font-family: monospace;
                font-size: 10px;
                color: #00FF00;
                text-shadow: 0 0 5px #00FF00;
                writing-mode: vertical-rl;
                animation: matrix-rain 1.2s infinite linear reverse;
            }

            @keyframes matrix-rain {
                0% { opacity: 0; transform: translateY(-100%); }
                50% { opacity: 1; }
                100% { opacity: 0; transform: translateY(100%); }
            }

            /* üëë –ù–û–í–ê–Ø –ö–û–†–û–õ–ï–í–°–ö–ê–Ø –†–ê–ú–ö–ê */
            @keyframes royal-glow {
                0% { box-shadow: 0 0 10px #FFD700, inset 0 0 5px #FFD700; border-color: #FFD700; }
                50% { box-shadow: 0 0 25px #FFD700, inset 0 0 15px #FFD700; border-color: #FFFACD; }
                100% { box-shadow: 0 0 10px #FFD700, inset 0 0 5px #FFD700; border-color: #FFD700; }
            }

            .frame-royal {
                border: 4px solid #FFD700 !important; /* –¢–æ–ª—Å—Ç–∞—è –∑–æ–ª–æ—Ç–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ */
                animation: royal-glow 2s infinite ease-in-out;
                background: linear-gradient(135deg, #FFD700 0%, #B8860B 50%, #FFD700 100%) !important;
                position: relative;
                overflow: visible !important; /* –ß—Ç–æ–±—ã –∫–æ—Ä–æ–Ω–∞ –Ω–µ –æ–±—Ä–µ–∑–∞–ª–∞—Å—å */
            }

            /* –°–∞–º–∞ –∫–æ—Ä–æ–Ω–∞ –Ω–∞–¥ —Ä–∞–º–∫–æ–π */
            .frame-royal::before {
                content: 'üëë';
                position: absolute;
                top: -22px; /* –ü–æ–¥–Ω–∏–º–∞–µ–º –Ω–∞–¥ –∫—Ä—É–≥–æ–º */
                left: 50%;
                transform: translateX(-50%);
                font-size: 24px;
                z-index: 100;
                filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
                animation: crown-float 2s infinite ease-in-out;
            }

            @keyframes crown-float {
                0%, 100% { transform: translateX(-50%) translateY(0) rotate(-5deg); }
                50% { transform: translateX(-50%) translateY(-5px) rotate(5deg); }
            }
            /* –§–∏–∫—Å –¥–ª—è –∞–≤–∞—Ç–∞—Ä–æ–∫ –≤ —Å–ø–∏—Å–∫–µ –ª–∏–¥–µ—Ä–æ–≤ */
    .user-list-item .profile-img {
        margin: 2px; /* –ù–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø, —á—Ç–æ–±—ã —Ç–µ–Ω—å —Ä–∞–º–∫–∏ –Ω–µ –æ–±—Ä–µ–∑–∞–ª–∞—Å—å */
        box-sizing: content-box; /* –ß—Ç–æ–±—ã —Ä–∞–º–∫–∞ —Ä–∏—Å–æ–≤–∞–ª–∞—Å—å —Å–Ω–∞—Ä—É–∂–∏ */
    }

    /* –ï—Å–ª–∏ —Ä–∞–º–∫–∞ –µ—Å—Ç—å, —É–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –ø—Ä–æ–∑—Ä–∞—á–Ω—É—é –≥—Ä–∞–Ω–∏—Ü—É */
    .user-list-item .profile-img.framed {
        border: none; 
    }

    /* === –ò–°–¢–û–†–ò–Ø –ó–ê–ù–Ø–¢–ò–ô (NEW) === */
            .history-list {
                display: flex; 
                flex-direction: column; 
                gap: 10px; 
                max-height: 300px; 
                overflow-y: auto;
                padding-right: 5px; /* –ß—Ç–æ–±—ã —Å–∫—Ä–æ–ª–ª –Ω–µ –Ω–∞–µ–∑–∂–∞–ª */
            }

            .history-card {
                display: flex; 
                justify-content: space-between; 
                align-items: center; 
                background: var(--bg); 
                padding: 12px 15px; 
                border-radius: 16px; 
                border-left: 4px solid var(--primary); /* –¶–≤–µ—Ç–Ω–∞—è –ø–æ–ª–æ—Å–∫–∞ —Å–ª–µ–≤–∞ */
            }

            .history-left {
                display: flex; 
                align-items: center; 
                gap: 12px;
            }

            .history-icon {
                font-size: 24px;
                width: 40px; 
                height: 40px; 
                background: var(--surface); 
                border-radius: 50%; 
                display: flex; 
                align-items: center; 
                justify-content: center;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            }

            .history-info div:first-child {
                font-weight: bold; 
                font-size: 14px; 
                color: var(--text);
            }

            .history-date {
                font-size: 11px; 
                color: var(--text-light); 
                margin-top: 2px;
            }

            .history-right {
                text-align: right;
            }

            .history-time {
                font-weight: 800; 
                font-size: 15px; 
                color: var(--primary);
            }

            .history-coins {
                font-size: 11px; 
                color: #FFD700; 
                font-weight: bold; 
                background: rgba(255, 215, 0, 0.1); 
                padding: 2px 6px; 
                border-radius: 6px; 
                margin-top: 4px; 
                display: inline-block;
            }
            /* –ê–Ω–∏–º–∞—Ü–∏—è –¥—ã—Ö–∞–Ω–∏—è –¥–ª—è —Ç–∞–π–º–µ—Ä–∞ */
        @keyframes timer-breath {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.05); opacity: 0.8; }
        100% { transform: scale(1); opacity: 1; }
        }
        .timer-active-anim {
        animation: timer-breath 2s infinite ease-in-out;
        text-shadow: 0 0 20px var(--primary);
        }
        /* –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è –¥–ª—è –≤—Å–µ—Ö –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */


    /* –≠–ª–∏—Ç–Ω–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ –¥–ª—è –≤–µ—Ç–µ—Ä–∞–Ω–æ–≤ (14+ –¥–Ω–µ–π) */
    @keyframes veteran-glow {
        0% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.2); border-color: #FFD700; }
        50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.6); border-color: #FFA500; }
        100% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.2); border-color: #FFD700; }
    }
    .veteran-card {
        animation: veteran-glow 3s infinite ease-in-out !important;
        border: 2px solid #FFD700 !important;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ */
    .logo-spin {
        animation: logo-rotate 0.5s ease-in-out;
    }
    @keyframes logo-rotate {
        from { transform: rotate(0deg) scale(1.2); }
        to { transform: rotate(360deg) scale(1); }
    }

    /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –∫–æ–¥–∞ —Å–ø–∞—Å–µ–Ω–∏—è */
    body.dark-mode #rescue-code-display {
        color: #FFD700 !important; /* –ó–æ–ª–æ—Ç–æ–π —Ü–≤–µ—Ç –¥–ª—è –∫–æ–¥–∞ ‚Äî –≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω */
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
    }

    /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –º–æ–¥–∞–ª–∫–∞ –∫–æ–ª–µ—Å–∞ –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –±–µ–ª—ã—Ö —Ñ–æ–Ω–æ–≤ –≤–Ω—É—Ç—Ä–∏ */
    body.dark-mode #wheel-modal .modal-content {
        background-color: var(--surface) !important;
        border: 2px solid var(--primary);
    }

    /* –ö–Ω–æ–ø–∫–∞ –≤ –∫–æ–ª–µ—Å–µ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏/–Ω–∞–∂–∞—Ç–∏–∏ */
    #wheel-spin-btn:active {
        transform: scale(0.95);
        filter: brightness(0.9);
    }
    #strict-mode-toggle {
        width: 25px;
        height: 25px;
        cursor: pointer;
        accent-color: #FF4757; /* –î–µ–ª–∞–µ–º –≥–∞–ª–æ—á–∫—É –∫—Ä–∞—Å–Ω–æ–π */
    }
    /* –û—Ç–∫–ª—é—á–∞–µ–º –ª—é–±—ã–µ —à–µ–≤–µ–ª–µ–Ω–∏—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ */
    .card:active, 
    .btn:active, 
    .shop-item:active, 
    .nav-btn:active, 
    .subject-item:active,
    .avatar-option:active {
        transform: none !important; /* –£–±–∏—Ä–∞–µ—Ç —É–º–µ–Ω—å—à–µ–Ω–∏–µ/—É–≤–µ–ª–∏—á–µ–Ω–∏–µ */
        transition: none !important; /* –£–±–∏—Ä–∞–µ—Ç –ø–ª–∞–≤–Ω–æ—Å—Ç—å, –¥–µ–ª–∞–µ—Ç –æ—Ç–∫–ª–∏–∫ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–º */
    }

    /* –£–±–∏—Ä–∞–µ–º —Å–∏–Ω–µ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ (–≤—Å–ø—ã—à–∫—É) –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∞—Ö */
    * {
        -webkit-tap-highlight-color: transparent !important;
        outline: none !important;
    }
    /* –ö—Ä–∞—Å–∏–≤—ã–π —Ç–æ–Ω–∫–∏–π —Å–∫—Ä–æ–ª–ª –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ */
    #subject-breakdown::-webkit-scrollbar, 
    #session-log::-webkit-scrollbar {
        width: 4px;
    }

    #subject-breakdown::-webkit-scrollbar-thumb, 
    #session-log::-webkit-scrollbar-thumb {
        background: var(--primary);
        border-radius: 10px;
        opacity: 0.3;
    }

    #subject-breakdown::-webkit-scrollbar-track, 
    #session-log::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.05);
    }
        </style>
        
    </head>
    <body>

    <!-- PREMIUM SPLASH SCREEN -->
    <div id="splash-screen">
        <!-- –§–æ–Ω–æ–≤—ã–µ –∫—Ä—É–≥–∏ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã -->
        <div class="splash-bg-circle c1"></div>
        <div class="splash-bg-circle c2"></div>

        <div class="splash-content">
            <!-- –õ–æ–≥–æ—Ç–∏–ø —Å –ø—É–ª—å—Å–∞—Ü–∏–µ–π -->
            <div class="splash-logo-wrapper">
                <img src="logo.png" alt="Logo" class="splash-logo-img">
                <div class="splash-glow"></div>
            </div>

            <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
            <h1 class="splash-title">MathBooster <span class="splash-badge">PRO</span></h1>

            <!-- –ü–æ–ª–æ—Å–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <div class="splash-progress-container">
                <div class="splash-progress-bar" id="splash-bar"></div>
            </div>

            <!-- –ú–µ–Ω—è—é—â–∏–π—Å—è —Ç–µ–∫—Å—Ç -->
            <div class="splash-text" id="splash-text">–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª–µ–π...</div>
        </div>
    </div>

    <style>
    /* –ê–Ω–∏–º–∞—Ü–∏—è –ª–æ–≥–æ ‚Äî –ø–ª–∞–≤–Ω–æ–µ "–ø–ª–∞–≤–∞–Ω–∏–µ" –≤–≤–µ—Ä—Ö-–≤–Ω–∏–∑ */
    @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-12px); }
    }
    </style>

    <script>
    // –ñ—ë—Å—Ç–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ PWA (—Ç–æ–ª—å–∫–æ –¥–ª—è iOS)
    if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
        // –û—á–∏—â–∞–µ–º –∫—ç—à Service Worker
        if ('caches' in window) {
            caches.keys().then(keys => {
                keys.forEach(key => caches.delete(key));
            });
        }
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ—Ñ—Ä–µ—à manifest
        if (navigator.serviceWorker) {
            navigator.serviceWorker.getRegistrations().then(regs => {
                regs.forEach(reg => reg.unregister());
            });
        }
    }

    // –ü–ª–∞–≤–Ω–æ–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ splash —á–µ—Ä–µ–∑ 1.8 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
    window.addEventListener('load', () => {
        setTimeout(() => {
            const splash = document.getElementById('splash-screen');
            if (splash) {
                splash.style.opacity = '0';
                setTimeout(() => splash.remove(), 800);
            }
        }, 1800); // 1.8 —Å–µ–∫—É–Ω–¥—ã –ø–æ–∫–∞–∑–∞
    });
    </script>

    <!-- PWA Manifest Generation (–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è) -->
    <script>
        const manifest = {
        "name": "MathBooster PRO",
        "short_name": "MathBooster",
        "start_url": ".",
        "display": "standalone",
        "background_color": "#F4F7FE",
        "theme_color": "#6C63FF",
        "orientation": "portrait",
        "icons": [
            { 
                "src": "icon-192.png", 
                "sizes": "192x192", 
                "type": "image/png",
                "purpose": "any maskable"  // <--- –í–ê–ñ–ù–û –î–õ–Ø ANDROID
            },
            { 
                "src": "icon-512.png", 
                "sizes": "512x512", 
                "type": "image/png",
                "purpose": "any maskable"  // <--- –í–ê–ñ–ù–û –î–õ–Ø ANDROID
            }
        ]
    };
        const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        document.getElementById('manifest-link').setAttribute('href', URL.createObjectURL(blob));
    </script>

    <!-- AUTH SCREEN -->
    <div id="auth-screen">
        <div class="auth-card" id="login-view">

        <img src="logo.png" alt="Logo" class="app-logo" onclick="SecretSys.handleLogoClick()">
            <h2 style="margin-bottom: 5px; color: var(--primary);">MathBooster PRO</h2>
            <p style="color: var(--text-light); font-size: 14px; margin-bottom: 20px;">–¢–≤–æ–π –ø—É—Ç—å –∫ –∑–Ω–∞–Ω–∏—è–º</p>
            <div id="user-list"></div>
            <button class="btn btn-primary" onclick="Auth.showRegister()" style="margin-top: 10px;">+ –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
    <button class="btn" onclick="Transfer.transferByID()" style="margin-top: 15px; background: white; border: 2px dashed var(--primary); color: var(--primary); font-weight: bold; width: 100%; padding: 15px; animation: pulse-btn 2s infinite;">
        üì• –£ –º–µ–Ω—è –µ—Å—Ç—å –∫–æ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
    </button>

    <style>
    @keyframes pulse-btn {
        0% { transform: scale(1); }
        50% { transform: scale(1.02); }
        100% { transform: scale(1); }
    }
    </style>
        </div>

        <div class="auth-card" id="register-view" style="display: none;">
            <h2>–ù–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
            <div class="avatar-grid" id="avatar-selector"></div>
            
            <!-- –í–û–¢ –°–ê–ú–ê–Ø –í–ê–ñ–ù–ê–Ø –°–¢–†–û–ö–ê. –ë–ï–ó ID="reg-name" –ù–ò–ß–ï–ì–û –ù–ï –†–ê–ë–û–¢–ê–ï–¢ -->
    <!-- –ü—Ä–æ—Å—Ç–æ–µ –ø–æ–ª–µ –≤–≤–æ–¥–∞ (–±–µ–∑ –∫–Ω–æ–ø–æ–∫) -->
            <input type="text" id="reg-name" class="input-field" placeholder="–í–∞—à–µ –∏–º—è..." maxlength="12" style="margin-bottom: 15px;">        <!-- ----------------------------------------------------------- -->

            <div class="reg-group" style="margin:15px 0;">
                <div style="font-size:12px; color:var(--text-light); margin-bottom:5px;">–ü–æ–ª</div>
                <div style="display:flex; gap:10px;">
                    <button class="btn gender-btn active" onclick="Auth.setGender('male')" style="border:2px solid var(--bg);">üë® –ü–∞—Ä–µ–Ω—å</button>
                    <button class="btn gender-btn" onclick="Auth.setGender('female')" style="border:2px solid var(--bg);">üë© –î–µ–≤—É—à–∫–∞</button>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-outline" onclick="Auth.showLogin()">–ù–∞–∑–∞–¥</button>
                <button class="btn btn-primary" onclick="Auth.createAccount()">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="container" id="app-container" style="display: none;"> 
        <div class="header-card">
            <div class="profile-mini" onclick="App.switchTab('profile')">
                <div class="profile-img" id="header-avatar-box"><div id="header-avatar">üòé</div></div>
                <div>
                    <div style="font-weight: bold; font-size: 18px;" id="header-name">–ò–≥—Ä–æ–∫</div>
                    <div style="font-size: 12px; color: var(--text-light);" id="header-league">–ù–æ–≤–∏—á–æ–∫</div>
                </div>
            </div>
            <div class="currency-block">
                <div class="currency-item"><span>üí∞</span> <span id="coin-display">0</span></div>
                <div class="currency-item" style="color:#FF7675;"><span>üî•</span> <span id="streak-display">0</span></div>
            </div>
        </div>

        <nav class="nav">
            <button class="nav-btn active" onclick="App.switchTab('dashboard', this)">‚è±Ô∏è –£—á–µ–±–∞</button>
            <button class="nav-btn" onclick="App.switchTab('trainer', this)">üß† –¢—Ä–µ–Ω–∞–∂–µ—Ä</button>
            <button class="nav-btn" onclick="App.switchTab('stats', this)">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
            <button class="nav-btn" onclick="App.switchTab('leaderboard', this)">üèÜ –¢–æ–ø</button>
            <button class="nav-btn" onclick="App.switchTab('shop', this)">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
            <button class="nav-btn" onclick="App.switchTab('achievements', this)">üèÖ –ù–∞–≥—Ä–∞–¥—ã</button>
            <button class="nav-btn" onclick="App.switchTab('settings', this)">‚öôÔ∏è –û–ø—Ü–∏–∏</button>
        </nav>

        <!-- 1. DASHBOARD -->
        <section id="dashboard" class="section active">
            <div class="grid">
                <div class="card zen-target" style="text-align: center; position: relative;">
                    <!-- TOOLS -->
                    <div style="position: absolute; top: 15px; right: 15px; display:flex; gap:5px;">
                        <button onclick="WheelSys.open()" style="background: transparent; border: none; font-size: 24px; cursor: pointer; opacity: 0.5;" title="–ö–æ–ª–µ—Å–æ —É–¥–∞—á–∏">üé°</button>
                        <button onclick="Whiteboard.toggle()" style="background: transparent; border: none; font-size: 24px; cursor: pointer; opacity: 0.5;" title="–ß–µ—Ä–Ω–æ–≤–∏–∫">‚úèÔ∏è</button>
                        <button onclick="Calc.toggle()" style="background: transparent; border: none; font-size: 24px; cursor: pointer; opacity: 0.5;" title="–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä">üßÆ</button>
                        <button onclick="App.toggleEcoMode(true)" style="background: transparent; border: none; font-size: 24px; cursor: pointer; opacity: 0.5;" title="–≠–∫–æ —Ä–µ–∂–∏–º (—á–µ—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω)">üîã</button>
                    </div>
                    
                    <h3 style="color: var(--text-light); font-size: 12px; text-transform: uppercase;">–§–æ–∫—É—Å</h3>
                    <h2 id="subject-title" style="font-size: 28px; color: var(--primary); margin-bottom: 10px;">–ê–ª–≥–µ–±—Ä–∞</h2>
                    
                    <div id="timer" class="timer-display">00:00:00</div>
                    
                    <!-- 1. –ò–ù–§–û –û –ú–û–ù–ï–¢–ê–• -->
                    <div style="font-size: 13px; color: var(--text-light); margin-bottom: 5px;">
                        üî• <b>5+ –º–æ–Ω–µ—Ç</b> (—Ä–∞—Å—Ç–µ—Ç –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω)
                    </div>

                    <!-- 2. –ò–ù–§–û –û –†–û–°–¢–ï –ù–ê–ì–†–ê–î–´ -->
                    <div style="font-size: 10px; color: var(--success); font-weight: bold; margin-bottom: 20px; opacity: 0.9;">
                        –ß–µ–º –¥–æ–ª—å—à–µ —Å–∏–¥–∏—à—å ‚Äî —Ç–µ–º –±–æ–ª—å—à–µ –Ω–∞–≥—Ä–∞–¥–∞! üìà
                    </div>
                    
                    <!-- 3. –¶–ò–¢–ê–¢–ê –î–ù–Ø (–í–µ—Ä–Ω—É–ª–∏ –Ω–∞ –º–µ—Å—Ç–æ) -->
                    <div id="daily-quote" style="font-size: 11px; font-style: italic; color: var(--text); opacity: 0.6; margin-bottom: 20px; padding: 0 30px; line-height: 1.4;">
                        "–ó–∞–≥—Ä—É–∑–∫–∞ –º—É–¥—Ä–æ—Å—Ç–∏..."
                    </div>

                    
                    <!-- SESSION GOAL -->
                    <input type="text" id="session-goal" class="input-field" placeholder="üéØ –¶–µ–ª—å –Ω–∞ —Å–µ—Å—Å–∏—é (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)..." style="text-align: center; font-size: 14px; padding: 10px;">
                    
                    <div class="zen-controls" style="position: relative; width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                        <button id="btn-start" class="btn btn-primary" onclick="Timer.preStart()">üöÄ –°–¢–ê–†–¢</button>
                        <button class="btn btn-outline" onclick="Timer.stop()">‚èπ –°–¢–û–ü</button>
                    </div>
                </div>
                
                <div class="card">
                    <h3>üéß Lo-Fi –†–∞–¥–∏–æ</h3>
                    <div class="music-widget">
                        <div class="music-info">
                            <span style="font-size: 20px;">üéµ</span>
                            <span>Chill Study Beats</span>
                        </div>
                        <div class="visualizer" id="music-vis" style="opacity: 0;">
                            <div class="bar" style="animation-duration: 0.5s"></div>
                            <div class="bar" style="animation-duration: 0.7s"></div>
                            <div class="bar" style="animation-duration: 0.4s"></div>
                            <div class="bar" style="animation-duration: 0.6s"></div>
                        </div>
                        <button id="music-btn" class="btn btn-primary" style="width: auto; padding: 5px 15px; font-size: 12px;" onclick="MusicPlayer.toggle()">‚ñ∂</button>
                    </div>
                    <!-- FIXED AUDIO SOURCE -->
                    <audio id="lofi-stream" crossorigin="anonymous" preload="none">
                        <source src="https://lofi.stream.laut.fm/lofi" type="audio/mpeg">
                        <source src="https://stream.zeno.fm/f3wvbbqmdg8uv" type="audio/mpeg">
                    </audio>
                    
                    <h3 style="margin-top: 20px;">üìö –ü—Ä–µ–¥–º–µ—Ç—ã</h3>
                    <div id="subjects-grid" style="display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:15px; justify-items:center;"></div>            </div>
            </div>
            <div style="margin-top: 25px;">
                    <h3 style="margin-bottom: 10px;">üéØ –ö–≤–µ—Å—Ç—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
                    <div id="quests-container"></div>
                </div>
                <div class="card" onclick="App.editMonthlyGoal()" style="margin-top: 20px; cursor: pointer; background: linear-gradient(135deg, var(--surface), #f0f3ff);">
        <h3 style="margin-bottom: 15px; font-size: 14px;">üìÖ –ü–ª–∞–Ω –Ω–∞ –º–µ—Å—è—Ü</h3>
        <div style="display: flex; align-items: center; gap: 20px;">
            <!-- –ö—Ä—É–≥–æ–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å -->
            <div style="position: relative; width: 70px; height: 70px; flex-shrink: 0;">
                <svg viewBox="0 0 36 36" style="width: 100%; height: 100%; transform: rotate(-90deg);">
                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#eee" stroke-width="3" />
                    <path id="goal-circle" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="var(--primary)" stroke-width="3" stroke-dasharray="0, 100" stroke-linecap="round" style="transition: stroke-dasharray 1s ease;" />
                </svg>
                <div id="goal-pct" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: 900; font-size: 14px; color: var(--primary);">0%</div>
            </div>
            
            <div>
                <div id="goal-text" style="font-weight: bold; font-size: 16px; color: var(--text);">0 / 40 —á</div>
                <div style="font-size: 11px; color: var(--text-light); margin-top: 4px;">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å —Ü–µ–ª—å</div>
            </div>
        </div>
    </div>
        </section>

    <!-- 8. ABOUT SECTION (–ù–æ–≤—ã–π –∫—Ä–∞—Å–∏–≤—ã–π —Ä–∞–∑–¥–µ–ª) -->
        <section id="about" class="section">
        <!-- –ì–ª–∞–≤–Ω—ã–π –±–∞–Ω–Ω–µ—Ä -->
        <div class="card" style="background: linear-gradient(135deg, #6C63FF, #4834d4); color: white; text-align: center; padding: 40px 20px; position: relative; overflow: hidden; border: none; border-radius: 30px;">
            <div style="position: absolute; top: -20px; right: -20px; font-size: 150px; opacity: 0.1;">üìà</div>
            <img src="logo.png" alt="MathBooster" style="width: 90px; height: 90px; background: white; border-radius: 22px; padding: 5px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); margin-bottom: 15px; position: relative; z-index: 2;">
            <h2 style="font-size: 28px; margin: 0; font-weight: 800; position: relative; z-index: 2;">MathBooster PRO</h2>
            <div style="opacity: 0.9; font-size: 14px; margin-top: 5px; font-weight: 500; position: relative; z-index: 2;">–¢–≤–æ—ë –≤—Ä–µ–º—è ‚Äî —Ç–≤–æ–π –≥–ª–∞–≤–Ω—ã–π —Ä–µ—Å—É—Ä—Å üá∫üáø</div>
        </div>

        <!-- –§–∏–ª–æ—Å–æ—Ñ–∏—è -->
        <!-- –£–ª—É—á—à–µ–Ω–Ω–∞—è –§–∏–ª–æ—Å–æ—Ñ–∏—è: –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –£—Å–∏–ª–∏–π -->
        <div class="card" style="margin-top: 20px; border-left: 5px solid var(--primary); background: linear-gradient(to right, rgba(108, 99, 255, 0.05), transparent);">
            <h3 style="color: var(--primary); display: flex; align-items: center; gap: 10px;">
                üéØ –¢–≤–æ–π –∫–∞–ø–∏—Ç–∞–ª ‚Äî —ç—Ç–æ —Ç–≤–æ–∏ —á–∞—Å—ã
            </h3>
            <p style="color: var(--text); line-height: 1.7; margin-top: 15px; font-size: 15px;">
                –°–∞–º–∞—è –±–æ–ª—å—à–∞—è –ª–æ–≤—É—à–∫–∞ –≤ —É—á—ë–±–µ ‚Äî —ç—Ç–æ <b>–∏–ª–ª—é–∑–∏—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</b>. –ú–æ–∂–Ω–æ –ø—Ä–æ—Å–∏–¥–µ—Ç—å –∑–∞ —Å—Ç–æ–ª–æ–º –≤–µ—Å—å –¥–µ–Ω—å, –Ω–æ —Ç–∞–∫ –∏ –Ω–µ –ø–æ–Ω—è—Ç—å, —Å–∫–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ.
                <br><br>
                <b>–û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å MathBooster PRO</b> ‚Äî —Å–¥–µ–ª–∞—Ç—å —Ç–≤–æ–π —Ç—Ä—É–¥ –≤–∏–¥–∏–º—ã–º. –ú—ã –≤–µ—Ä–∏–º –≤ –ø—Ä–æ—Å—Ç–æ–µ –ø—Ä–∞–≤–∏–ª–æ: <i>"–¢–æ, —á—Ç–æ –Ω–µ–ª—å–∑—è –∏–∑–º–µ—Ä–∏—Ç—å ‚Äî –Ω–µ–ª—å–∑—è —É–ª—É—á—à–∏—Ç—å"</i>. 
                <br><br>
                –≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Äî —Ç–≤–æ–π –ª–∏—á–Ω—ã–π <b>–±—É—Ö–≥–∞–ª—Ç–µ—Ä –∑–Ω–∞–Ω–∏–π</b>. –û–Ω–æ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É —Ç–≤–æ–µ–≥–æ —Ñ–æ–∫—É—Å–∞, –ø—Ä–µ–≤—Ä–∞—â–∞—è –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ–µ "—è —É—á–∏–ª—Å—è" –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã:
            </p>
            
            <div style="margin-top: 15px; background: var(--surface); padding: 15px; border-radius: 15px; box-shadow: inset 0 0 10px rgba(0,0,0,0.05);">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <span style="font-size: 20px;">üìú</span>
                    <span style="font-size: 13px;"><b>–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ —Ä–∞–±–æ—Ç—ã:</b> –í –∫–æ–Ω—Ü–µ –º–µ—Å—è—Ü–∞ —Ç—ã —É–≤–∏–¥–∏—à—å –Ω–µ –ø—Ä–æ—Å—Ç–æ –æ—Ü–µ–Ω–∫–∏, –∞ 100+ —á–∞—Å–æ–≤ —á–∏—Å—Ç–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, –≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –≤ —Å–µ–±—è.</span>
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <span style="font-size: 20px;">‚öñÔ∏è</span>
                    <span style="font-size: 13px;"><b>–ë–∞–ª–∞–Ω—Å –∑–Ω–∞–Ω–∏–π:</b> –¢—ã —Ç–æ—á–Ω–æ –±—É–¥–µ—à—å –∑–Ω–∞—Ç—å, —á—Ç–æ —É–¥–µ–ª–∏–ª –ê–ª–≥–µ–±—Ä–µ 40 —á–∞—Å–æ–≤, –∞ –ì–µ–æ–º–µ—Ç—Ä–∏–∏ –≤—Å–µ–≥–æ 5. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç —Ç–µ–±–µ –≤–æ–≤—Ä–µ–º—è –∑–∞–∫—Ä—ã—Ç—å –ø—Ä–æ–±–µ–ª—ã.</span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <span style="font-size: 20px;">üíé</span>
                    <span style="font-size: 13px;"><b>–¶–µ–Ω–∞ —É—Å–ø–µ—Ö–∞:</b> –ö–∞–∂–¥–∞—è –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –º–æ–Ω–µ—Ç–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ ‚Äî —ç—Ç–æ –ø—Ä—è–º–æ–µ –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ —Ç–≤–æ–µ–π —É—Å–∏–¥—á–∏–≤–æ—Å—Ç–∏. –ß–µ–º –±–æ–ª—å—à–µ —á–∞—Å–æ–≤, —Ç–µ–º –±–æ–≥–∞—á–µ —Ç–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å.</span>
                </div>
            </div>

            <p style="color: var(--text-light); font-size: 13px; margin-top: 15px; font-style: italic;">
                –ú—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ —Å—á–∏—Ç–∞–µ–º –≤—Ä–µ–º—è. –ú—ã –ø–æ–º–æ–≥–∞–µ–º —Ç–µ–±–µ –æ—Å–æ–∑–Ω–∞—Ç—å —Ü–µ–Ω—É —Ç–≤–æ–µ–≥–æ –±—É–¥—É—â–µ–≥–æ –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞.
            </p>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –ø–ª—é—Å–æ–≤ (–°–µ—Ç–∫–∞) -->
        <div class="grid" style="margin-top: 20px; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="card" style="padding: 15px; text-align: center;">
                <div style="font-size: 30px; margin-bottom: 10px;">üõ°Ô∏è</div>
                <div style="font-weight: bold; font-size: 14px;">–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞</div>
                <div style="font-size: 11px; color: var(--text-light); margin-top: 5px;">–•–∞—Ä–¥–∫–æ—Ä-—Ä–µ–∂–∏–º –ø—Ä–∏—É—á–∞–µ—Ç –Ω–µ –æ—Ç–≤–ª–µ–∫–∞—Ç—å—Å—è –Ω–∞ —Å–æ—Ü—Å–µ—Ç–∏.</div>
            </div>
            <div class="card" style="padding: 15px; text-align: center;">
                <div style="font-size: 30px; margin-bottom: 10px;">üß†</div>
                <div style="font-weight: bold; font-size: 14px;">–ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ</div>
                <div style="font-size: 11px; color: var(--text-light); margin-top: 5px;">–†–∞–∑–¥–µ–ª—å–Ω–∞—è –ø—Ä–æ–∫–∞—á–∫–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞.</div>
            </div>
            <div class="card" style="padding: 15px; text-align: center;">
                <div style="font-size: 30px; margin-bottom: 10px;">‚öîÔ∏è</div>
                <div style="font-weight: bold; font-size: 14px;">–°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ</div>
                <div style="font-size: 11px; color: var(--text-light); margin-top: 5px;">–î—É—ç–ª–∏ –∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ç–æ–ø –º–æ—Ç–∏–≤–∏—Ä—É—é—Ç –±—ã—Ç—å –ø–µ—Ä–≤—ã–º.</div>
            </div>
            <div class="card" style="padding: 15px; text-align: center;">
                <div style="font-size: 30px; margin-bottom: 10px;">üìä</div>
                <div style="font-weight: bold; font-size: 14px;">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
                <div style="font-size: 11px; color: var(--text-light); margin-top: 5px;">–ü–æ–¥—Ä–æ–±–Ω—ã–µ –æ—Ç—á–µ—Ç—ã –∏ —Ü–µ–ª–∏ –Ω–∞ –º–µ—Å—è—Ü.</div>
            </div>
        </div>

        <!-- –ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–π –±–ª–æ–∫ -->
        <!-- –ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–π –±–ª–æ–∫ (–°–µ–∫—Ä–µ—Ç–Ω—ã–π) -->
        <div class="card" style="margin-top: 20px; background: #FFF9E6; border: 2px dashed #FFD700; text-align: center;">
            <h3 style="color: #B8860B; cursor: pointer; user-select: none;" onclick="SecretSys.claimMotivationReward()">
                üíé –°—Ç–∞–Ω—å –ª—É—á—à–µ–π –≤–µ—Ä—Å–∏–µ–π —Å–µ–±—è
            </h3>
            <p style="font-size: 13px; color: #5D4037; margin-top: 10px;">
                –ü–æ–º–Ω–∏: –ø–æ–∫–∞ —Ç—ã –æ—Ç–¥—ã—Ö–∞–µ—à—å, –∫—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–π –∫–∞—á–∞–µ—Ç —Å–≤–æ–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç. <br>
                <b>–ù–∞—á–Ω–∏ —Å–µ—Å—Å–∏—é –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!</b>
            </p>
        </div>

        

            <!-- –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ -->
            <div class="card" style="margin-top: 20px;">
                <h3>üë®‚Äçüè´ –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫</h3>
                <div style="display: flex; align-items: center; gap: 15px; margin-top: 15px;">
                    <div style="width: 60px; height: 60px; background: #eee; border-radius: 50%; font-size: 30px; display: flex; align-items: center; justify-content: center;">üë®‚Äçüíª</div>
                    <div>
                        <div style="font-weight: bold; font-size: 16px;">–ú–∞–Ω—Å—É—Ä–æ–≤ –†—É—Å—Ç–∞–º –£–∫—Ç–∞–º–æ–≤–∏—á</div>
                        <div style="color: var(--text-light); font-size: 12px;">Math Teacher</div>
                        <div style="color: var(--primary); font-size: 12px; font-weight: bold; margin-top: 3px;">Bukhara, Uzbekistan</div>
                    </div>
                </div>
                <p style="margin-top: 15px; font-size: 13px; color: var(--text-light);">
                    "–Ø —Å–æ–∑–¥–∞–ª —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, —á—Ç–æ–±—ã –¥–æ–∫–∞–∑–∞—Ç—å: —É—á–∏—Ç—å—Å—è –º–æ–∂–Ω–æ —Å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º. –°–ø–∞—Å–∏–±–æ, —á—Ç–æ –≤—ã —Å –Ω–∞–º–∏!"
                </p>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –¢–µ–ª–µ–≥—Ä–∞–º -->
                <a href="https://t.me/mathboosterpro" target="_blank" style="text-decoration: none;">
                    <button class="btn" style="background: #0088cc; color: white; margin-top: 15px; width: 100%;">
                        ‚úàÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram
                    </button>
                </a>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥ -->
            <button class="btn btn-outline" style="margin-top: 30px; margin-bottom: 30px;" onclick="App.switchTab('settings')">
                ‚¨ÖÔ∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>
        </section>

        <!-- 2. TRAINER (–ú–µ–Ω—é —Å –≤—ã–±–æ—Ä–æ–º + –ó–∞–≤–µ—Ä—à–∏—Ç—å) -->
    <!-- 2. TRAINER (–ú—É–ª—å—Ç–∏-—Ä–µ–∂–∏–º) -->
        <section id="trainer" class="section">
            
            <!-- –ú–ï–ù–Æ -->
            <div class="card" id="trainer-menu" style="text-align: center; padding: 30px 20px;">
                <div style="font-size: 60px; margin-bottom: 10px;">üß†</div>
                <h2 style="margin-bottom: 5px;">–¢—Ä–µ–Ω–∞–∂–µ—Ä</h2>
                <p style="color: var(--text-light); font-size: 13px; margin-bottom: 20px;">–í—ã–±–µ—Ä–∏ —Ä–µ–∂–∏–º:</p>
                
                <!-- –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ -->
                <div style="display: grid; gap: 10px; margin-bottom: 25px;">
                    <button class="btn mode-btn active" onclick="Trainer.selectMode('standard', this)" style="background: var(--bg); border: 2px solid var(--bg); color: var(--text); text-align: left; padding: 15px; transition: 0.2s;">
                        <span style="font-size: 20px;">üî¢</span> <b>–ö–ª–∞—Å—Å–∏–∫–∞</b>
                    </button>
                    
                    <button class="btn mode-btn" onclick="Trainer.selectMode('sign', this)" style="background: var(--bg); border: 2px solid var(--bg); color: var(--text); text-align: left; padding: 15px; transition: 0.2s;">
                        <span style="font-size: 20px;">üß©</span> <b>–ù–∞–π–¥–∏ –∑–Ω–∞–∫</b>
                    </button>
                    
                    <button class="btn mode-btn" onclick="Trainer.selectMode('square', this)" style="background: var(--bg); border: 2px solid var(--bg); color: var(--text); text-align: left; padding: 15px; transition: 0.2s;">
                        <span style="font-size: 20px;">üü•</span> <b>–ö–≤–∞–¥—Ä–∞—Ç—ã</b>
                    </button>
                </div>

                <!-- –ö–ù–û–ü–ö–ê –î–£–≠–õ–ò  -->
                <button class="btn" onclick="BattleSys.openMenu()" style="background: linear-gradient(45deg, #FF416C, #FF4B2B); color: white; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(255, 75, 43, 0.4); border: none;">
                    ‚öîÔ∏è PVP –î–£–≠–õ–¨ 
                </button>
                <!-------------------->
                

                <!-- –°–ª–æ–∂–Ω–æ—Å—Ç—å -->
                <div style="margin-bottom: 10px; font-size: 12px; font-weight: bold; color: var(--text-light);">–°–õ–û–ñ–ù–û–°–¢–¨</div>
                <div class="diff-switch">
                    <div class="diff-btn active" onclick="Trainer.setDiff('easy', this)">–õ–µ–≥–∫–æ</div>
                    <div class="diff-btn" onclick="Trainer.setDiff('medium', this)">–°—Ä–µ–¥–Ω–µ</div>
                    <div class="diff-btn" onclick="Trainer.setDiff('hard', this)">–°–ª–æ–∂–Ω–æ</div>
                </div>

                <!-- –†–µ–∫–æ—Ä–¥ -->
                <div style="margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--bg);">
                    <div style="font-size: 11px; color: var(--text-light); margin-bottom: 5px;">
                        –†–µ–∫–æ—Ä–¥ (<span id="record-mode-label">–ö–ª–∞—Å—Å–∏–∫–∞</span>)
                    </div>
                    <div style="font-size: 32px; font-weight: 800; color: var(--primary);" id="trainer-high-score">0</div>
                </div>

                <button class="btn btn-primary" onclick="Trainer.start()" style="margin-top: 20px; width: 100%; padding: 15px; font-size: 18px;">üöÄ –°–¢–ê–†–¢</button>
            </div>

            <!-- –ò–ì–†–ê -->
            <div class="card" id="trainer-game" style="display: none; text-align: center;">
                <div class="trainer-stats">
                    <div>‚è≥ <span id="game-time">60</span>s</div>
                    <div>‚úÖ <span id="game-score">0</span></div>
                </div>

                <div class="trainer-problem" id="game-problem" style="word-break:break-all;">2 x 2</div>

                <!-- –í–í–û–î –ß–ò–°–ï–õ (–î–ª—è –ö–ª–∞—Å—Å–∏–∫–∏ –∏ –ö–≤–∞–¥—Ä–∞—Ç–æ–≤) -->
                <div id="input-area">
                    <div style="display: flex; gap: 10px; justify-content: center; align-items: center; max-width: 320px; margin: 20px auto;">
                        <input type="tel" id="game-input" class="input-field trainer-input" placeholder="?" style="margin-bottom: 0;">
                        <button class="btn btn-outline" onclick="Trainer.toggleMinus()" style="width: 60px; height: 60px; padding: 0; font-size: 20px;" title="–ú–∏–Ω—É—Å">+/-</button>
                    </div>
                    <button class="btn btn-primary" onclick="Trainer.check()" style="margin-top: 15px; width: 100%;">–û—Ç–≤–µ—Ç–∏—Ç—å ‚ûú</button>
                </div>

                <!-- –ö–ù–û–ü–ö–ò –ó–ù–ê–ö–û–í (–î–ª—è –ù–∞–π–¥–∏ –∑–Ω–∞–∫) -->
                <div id="sign-area" style="display: none; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 300px; margin: 20px auto;">
                    <button class="btn" onclick="Trainer.checkSign('+')" style="font-size: 32px; border: 2px solid var(--primary); background: var(--bg); color: var(--text); font-weight: bold; aspect-ratio: 1/1;">+</button>
                    <button class="btn" onclick="Trainer.checkSign('-')" style="font-size: 32px; border: 2px solid var(--primary); background: var(--bg); color: var(--text); font-weight: bold; aspect-ratio: 1/1;">‚àí</button>
                    <button class="btn" onclick="Trainer.checkSign('*')" style="font-size: 32px; border: 2px solid var(--primary); background: var(--bg); color: var(--text); font-weight: bold; aspect-ratio: 1/1;">√ó</button>
                    <button class="btn" onclick="Trainer.checkSign('/')" style="font-size: 32px; border: 2px solid var(--primary); background: var(--bg); color: var(--text); font-weight: bold; aspect-ratio: 1/1;">√∑</button>
                </div>

                <button class="btn btn-outline" style="margin-top: 20px;" onclick="Trainer.end()">üèÅ –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
            </div>

            <!-- –†–ï–ó–£–õ–¨–¢–ê–¢ -->
            <div class="card" id="trainer-result" style="display: none; text-align: center;">
                <h2>–í—Ä–µ–º—è –≤—ã—à–ª–æ! üèÅ</h2>
                <div style="margin: 30px 0;">
                    <div style="font-size: 14px; color: var(--text-light);">–í–∞—à —Å—á–µ—Ç</div>
                    <div style="font-size: 48px; font-weight: bold; color: var(--primary);" id="result-score">0</div>
                </div>
                <div class="grid" style="margin-bottom: 20px;">
                    <div class="stat-pill"><div class="stat-val" id="result-xp">+0 XP</div></div>
                    <div class="stat-pill"><div class="stat-val" id="result-coins">+0 üí∞</div></div>
                </div>
                <button class="btn btn-primary" onclick="Trainer.init()">–í –º–µ–Ω—é</button>
            </div>
        </section>


        <!-- 3. STATS -->
        <section id="stats" class="section">
            <!-- –í–µ—Ä—Ö–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (—É–∂–µ –µ—Å—Ç—å) -->
            <div class="card" style="margin-bottom: 20px;">
                <h3>üìä –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div class="stat-detail-grid">
                    <div class="stat-detail-card">
                        <div class="stat-detail-title">–ó–∞ –Ω–µ–¥–µ–ª—é</div>
                        <div id="stat-week-time" class="stat-detail-value">0—á</div>
                    </div>
                    <div class="stat-detail-card">
                        <div class="stat-detail-title">–ó–∞ –º–µ—Å—è—Ü</div>
                        <div id="stat-month-time" class="stat-detail-value">0—á</div>
                    </div>
                    <div class="stat-detail-card">
                        <div class="stat-detail-title">–í—Å–µ –≤—Ä–µ–º—è</div>
                        <div id="stat-total-time" class="stat-detail-value">0—á</div>
                    </div>
                </div>
            </div>

            <!-- –ì–õ–ê–í–ù–ê–Ø –°–ï–¢–ö–ê (–¢–µ–ø–µ—Ä—å —Ç—É—Ç 3 –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞ –æ–¥–Ω–æ–º —É—Ä–æ–≤–Ω–µ) -->
            <div class="grid">
                <!-- 1. –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å -->
                <div class="card">
                    <h3>üî• –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (30 –¥–Ω–µ–π)</h3>
                    <div id="heatmap" style="display:grid; grid-template-columns:repeat(7,1fr); gap:5px; margin-top:15px;"></div>
                </div>

                <!-- 2. –ñ—É—Ä–Ω–∞–ª –∑–∞–Ω—è—Ç–∏–π -->
                <div class="card">
                    <h3>üìú –ñ—É—Ä–Ω–∞–ª –∑–∞–Ω—è—Ç–∏–π</h3>
                    <div id="session-log" class="history-list" style="max-height: 300px; overflow-y: auto; margin-top: 15px;"></div>
                </div>

                <!-- 3. –¢–≤–æ–∏ –ø—Ä–µ–¥–º–µ—Ç—ã (–ü–ï–†–ï–ú–ï–©–ï–ù–û –°–Æ–î–ê –ò –î–û–ë–ê–í–õ–ï–ù –°–ö–†–û–õ–õ) -->
                <div class="card">
                    <h3>üéì –¢–≤–æ–∏ –ø—Ä–µ–¥–º–µ—Ç—ã</h3>
                    <p style="font-size:11px; color:var(--text-light); margin-bottom:10px;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞–º</p>
                    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ —Å–∫—Ä–æ–ª–ª–æ–º -->
                    <div id="subject-breakdown" style="max-height: 250px; overflow-y: auto; padding-right: 5px; display: flex; flex-direction: column; gap: 10px;">
                        <!-- –°—é–¥–∞ JS –≤—Å—Ç–∞–≤–∏—Ç —Å–ø–∏—Å–æ–∫ -->
                    </div>
                </div>
            </div>

            <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –Ω–∏–∂–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã) -->
            <div class="grid" style="margin-top: 20px;">
                <div class="card">
                    <h3>üìà –ò—Å—Ç–æ—Ä–∏—è (–ù–µ–¥–µ–ª—è)</h3>
                    <canvas id="weekChart"></canvas>
                </div>
                <div class="card">
                    <h3>üß© –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</h3>
                    <canvas id="subjectChart"></canvas>
                </div>
            </div>
        </section>

        <!-- 4. LEADERBOARD -->
        <section id="leaderboard" class="section">
            <div class="card">
                <h3>üèÜ –ì–ª–æ–±–∞–ª—å–Ω—ã–π –¢–æ–ø</h3>
                <p style="font-size:12px; color:var(--text-light); margin-bottom:15px;">–ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ (—Ç—Ä–µ–±—É–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç)</p>
                <div id="total-players-count" style="text-align:center; font-weight:bold; color:var(--primary); margin-bottom:10px;"></div>
                <button class="btn btn-primary" onclick="Online.loadLeaderboard()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                <div id="leaderboard-list" style="margin-top:15px; display:flex; flex-direction:column; gap:10px;">
                    <div style="text-align:center; color:gray;">–ù–∞–∂–º–∏ –æ–±–Ω–æ–≤–∏—Ç—å...</div>
                </div>
            </div>
        </section>

        <!-- 5. SHOP -->
        <section id="shop" class="section">
            <div class="card">
                <h3>üé® –¢–µ–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</h3>
                <p style="color: var(--text-light); font-size: 13px; margin-bottom: 15px;">–ü–æ–∫—É–ø–∞–π—Ç–µ –Ω–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –∑–∞ üí∞ –º–æ–Ω–µ—Ç—ã!</p>
                <div id="theme-list" class="shop-grid"></div>
            </div>
            <div class="card" style="margin-top: 20px;">
                <h3>üòé –ê–≤–∞—Ç–∞—Ä—ã</h3>
                <p style="color: var(--text-light); font-size: 13px; margin-bottom: 15px;">–í—ã–¥–µ–ª–∏—Ç–µ—Å—å –∏–∑ —Ç–æ–ª–ø—ã!</p>
                <div id="avatar-shop-list" class="shop-grid"></div>
            </div>
            <div class="card" style="margin-top: 20px;">
                <h3>‚ö° –£—Å–∏–ª–∏—Ç–µ–ª–∏</h3>
                <p style="color: var(--text-light); font-size: 13px; margin-bottom: 15px;">–ü–æ–ª–µ–∑–Ω—ã–µ –≤–µ—â–∏ –¥–ª—è –≤—ã–∂–∏–≤–∞–Ω–∏—è.</p>
                <div id="item-shop-list" class="shop-grid"></div>
            </div>        
            <div class="card" style="margin-top: 20px;">
                <h3>üñºÔ∏è –†–∞–º–∫–∏</h3>
                <div id="frame-shop-list" class="shop-grid"></div>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h3>üîä –ó–≤—É–∫–æ–≤—ã–µ –ø–∞–∫–∏</h3>
                <div id="sound-shop-list" class="shop-grid"></div>
            </div>
            <!-- –ë–ª–æ–∫ –°—Ç–∞—Ç—É—Å–æ–≤ -->
            <div class="card" style="margin-top: 20px;">
                <h3>üè∑Ô∏è –°—Ç–∞—Ç—É—Å—ã</h3>
                <p style="color: var(--text-light); font-size: 13px; margin-bottom: 15px;">–£—Å—Ç–∞–Ω–æ–≤–∏ –∫—Ä—É—Ç—É—é –ø–æ–¥–ø–∏—Å—å –ø–æ–¥ –∏–º–µ–Ω–µ–º!</p>
                <div id="title-shop-list" class="shop-grid" style="grid-template-columns: 1fr 1fr;"></div>
            </div>
        </section>

        <!-- 6. SETTINGS & DONATION -->
        <section id="settings" class="section">
            <!-- –ö–Ω–æ–ø–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ) -->
    <div id="install-promo-card" class="card" style="background: linear-gradient(135deg, #00d26a, #00b894); color: white; display: none; margin-bottom: 20px; cursor: pointer;" onclick="InstallSys.startFlow()">
        <div style="display: flex; align-items: center; gap: 15px;">
            <div style="font-size: 30px;">üì≤</div>
            <div>
                <div style="font-weight: bold; font-size: 16px;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</div>
                <div style="font-size: 12px; opacity: 0.9;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ —É–±—Ä–∞—Ç—å —Ä–∞–º–∫–∏</div>
            </div>
        </div>
    </div>
            
    <!-- –ö–Ω–æ–ø–∫–∞ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è -->
    <div class="card" onclick="App.shareApp()" style="margin-top: 10px; display: flex; align-items: center; gap: 15px; cursor: pointer; background: linear-gradient(135deg, #6C63FF, #8B7EFF); color: white;">
        <div style="font-size: 26px;">üöÄ</div>
        <div>
            <div style="font-weight: bold; font-size: 16px;">–ü–æ–∑–≤–∞—Ç—å –¥—Ä—É–∑–µ–π</div>
            <div style="font-size: 12px; opacity: 0.9;">–°–∫–∏–Ω—É—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –∏–≥—Ä—É</div>
        </div>
        <div style="margin-left: auto; font-size: 20px;">‚ûú</div>
    </div>
    <!-- –ö–ù–û–ü–ö–ê –¢–ï–õ–ï–ì–†–ê–ú –ë–û–¢–ê -->
    <a href="https://t.me/mathboosterpro" target="_blank" style="text-decoration: none;">
        <div class="card" style="margin-top: 10px; display: flex; align-items: center; gap: 15px; cursor: pointer; background: #2AABEE; color: white;">
            <div style="font-size: 26px;">ü§ñ</div>
            <div>
                <div style="font-weight: bold; font-size: 16px;">–ü–æ–¥–¥–µ—Ä–∂–∫–∞ / –î–æ–Ω–∞—Ç</div>
                <div style="font-size: 12px; opacity: 0.9;">–°–∫–∏–Ω—É—Ç—å —á–µ–∫ –∏–ª–∏ –∏–¥–µ—é</div>
            </div>
            <div style="margin-left: auto; font-size: 20px;">‚ûú</div>
        </div>
    </a>
    <!-- PREMIUM CARD (USD + UZS) -->
    <div style="background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%); padding: 20px; border-radius: 24px; color: #333; margin: 20px 0; text-align: center; box-shadow: 0 10px 30px rgba(253, 185, 49, 0.3); position: relative; overflow: hidden;">
        
        <!-- –î–µ–∫–æ—Ä -->
        <div style="position: absolute; top: -10px; right: -10px; font-size: 80px; opacity: 0.15; transform: rotate(15deg);">üíé</div>

        <h3 style="margin: 0; font-weight: 900; font-size: 24px; color: #2B3674; text-transform: uppercase; letter-spacing: 1px;">Premium Shop</h3>
        <p style="font-size: 13px; margin: 5px 0 15px 0; opacity: 0.8; font-weight: 600;">–¶–µ–Ω—ã –≤ UZS –∏ USD</p>

        <!-- –¢–ê–ë–õ–ò–¶–ê –¶–ï–ù -->
        <div style="background: rgba(255, 255, 255, 0.95); border-radius: 16px; padding: 5px 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);">
            
            <!-- 1. –°—Ç–∞—Ä—Ç -->
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee;">
                <div style="text-align: left;">
                    <div style="font-weight: 800; color: #2B3674; font-size: 15px;">300 üí∞</div>
                    <div style="font-size: 10px; color: #777;">–ù–∞—á–∞–ª—å–Ω—ã–π –ø–∞–∫</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-weight: 700; font-size: 14px;">5 000 UZS</div>
                    <div style="font-size: 10px; color: #888;">~ $0.40</div>
                </div>
            </div>

            <!-- 2. –•–ò–¢ –ü–†–û–î–ê–ñ -->
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; position: relative;">
                <div style="position: absolute; top: 0; left: 0; background: #FF416C; color: white; font-size: 8px; font-weight: bold; padding: 2px 6px; border-radius: 0 0 6px 0;">–•–ò–¢ üî•</div>
                
                <div style="text-align: left; margin-top: 5px;">
                    <div style="font-weight: 900; color: #FF416C; font-size: 16px;">1 000 üí∞</div>
                    <div style="font-size: 10px; color: #FF416C;">–í—ã–≥–æ–¥–Ω—ã–π –≤—ã–±–æ—Ä</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-weight: 800; font-size: 15px; color: #FF416C;">15 000 UZS</div>
                    <div style="font-size: 10px; color: #FF416C; opacity: 0.8;">~ $1.20</div>
                </div>
            </div>

            <!-- 3. VIP -->
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee;">
                <div style="text-align: left;">
                    <div style="font-weight: 900; color: #6C63FF; font-size: 16px;">3 000 üí∞</div>
                    <div style="font-size: 10px; background: #6C63FF; color: white; padding: 1px 5px; border-radius: 4px; display: inline-block;">üíé VIP –°–¢–ê–¢–£–°</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-weight: 700; font-size: 14px; color: #6C63FF;">35 000 UZS</div>
                    <div style="font-size: 10px; color: #6C63FF; opacity: 0.7;">~ $2.80</div>
                </div>
            </div>

            <!-- 4. KING -->
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0;">
                <div style="text-align: left;">
                    <div style="font-weight: 900; color: #997b00; text-shadow: 0 1px 1px rgba(0,0,0,0.1); font-size: 16px;">5 000 üí∞</div>
                    <div style="font-size: 10px; background: #2B3674; color: #FFD700; padding: 1px 5px; border-radius: 4px; display: inline-block;">üëë LEGENG –°–¢–ê–¢–£–°</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-weight: 700; font-size: 14px; color: #333;">55 000 UZS</div>
                    <div style="font-size: 10px; color: #666;">~ $4.40</div>
                </div>
            </div>

        </div>
            <!-- –ù–û–í–ê–Ø –ò–ù–°–¢–†–£–ö–¶–ò–Ø -->

    <div style="background: rgba(255,255,255,0.5); padding: 10px; border-radius: 12px; margin-top: 15px; font-size: 12px; color: #333; text-align: left; border: 1px solid rgba(255,255,255,0.8);">
            <b>–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –º–æ–Ω–µ—Ç—ã?</b><br>
            1. –°–∫–æ–ø–∏—Ä—É–π –∫–∞—Ä—Ç—É (–∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ).<br>
            2. –û–ø–ª–∞—Ç–∏ —á–µ—Ä–µ–∑ Click / Payme.<br>
            3. –°–∫–∏–Ω—å —Å–∫—Ä–∏–Ω—à–æ—Ç –≤ –±–æ—Ç–∞: 
            <a href="https://t.me/mathboosterpro" target="_blank" style="font-weight: bold; color: #2B3674; text-decoration: none; border-bottom: 2px solid #2B3674;">@MathBoosterBot</a>
        </div>
        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:15px;">
            <button class="btn" style="background:white; color:#2B3674; font-size:11px; font-weight:bold; padding: 10px;" onclick="Donation.payUz()">
                üí≥ HUMO / UZCARD
            </button>
            <button class="btn" style="background:#2B3674; color:white; font-size:11px; font-weight:bold; padding: 10px;" onclick="Donation.payWorld()">
                üåç VISA / MASTERCARD
            </button>
        </div>
        
        <button class="btn" style="background:rgba(255,255,255,0.4); border: 2px solid rgba(255,255,255,0.5); color:#2B3674; margin-top:10px; font-weight:bold; width: 100%;" onclick="Donation.enterCode()">
            üîë –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
        </button>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã–∑–æ–≤–∞ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è -->
    <div class="card" style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="document.getElementById('terms-modal').classList.add('show')">
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 20px;">‚öñÔ∏è</span>
            <span style="font-weight: bold; font-size: 14px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ</span>
        </div>
        <div style="color: var(--text-light);">‚ûú</div>
    </div>
            
    <div class="card">
        <h3>‚öôÔ∏è –û–ø—Ü–∏–∏</h3>
        
        <!-- 1. –ó–í–£–ö–ò -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; background: var(--bg); padding: 15px; border-radius: 15px;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 22px;">üîä</span>
                <div>
                    <div style="font-weight: bold; font-size: 14px; color: var(--text);">–ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã</div>
                    <div style="font-size: 11px; opacity: 0.6; color: var(--text);">–ó–≤—É–∫–∏ –∫–ª–∏–∫–æ–≤</div>
                </div>
            </div>
            <input type="checkbox" id="sfx-toggle" onchange="SoundSys.toggleSFX(this.checked)" checked style="transform: scale(1.4);">
        </div>

        <!-- 2. –¢–ï–ú–ù–´–ô –†–ï–ñ–ò–ú -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; background: var(--bg); padding: 15px; border-radius: 15px;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 22px;">üåô</span>
                <div>
                    <div style="font-weight: bold; font-size: 14px; color: var(--text);">–¢—ë–º–Ω—ã–π —Ä–µ–∂–∏–º</div>
                    <div style="font-size: 11px; opacity: 0.6; color: var(--text);">–ù–æ—á–Ω–∞—è —Ç–µ–º–∞</div>
                </div>
            </div>
            <input type="checkbox" id="dark-toggle" onchange="App.toggleDarkMode(this.checked)" style="transform: scale(1.4);">
        </div>

        <!-- 3. –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; background: var(--bg); padding: 15px; border-radius: 15px;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 22px;">üîî</span>
                <div>
                    <div style="font-weight: bold; font-size: 14px; color: var(--text);">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                    <div style="font-size: 11px; opacity: 0.6; color: var(--text);">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</div>
                </div>
            </div>
            <input type="checkbox" id="notify-toggle" onchange="Notify.toggle(this.checked)" style="transform: scale(1.4);">
        </div>

        <div id="notify-time-box" style="display: none; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--bg); padding: 12px 15px; border-radius: 15px; border: 1px dashed var(--primary);">
            <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 20px;">‚è∞</span>
                <div style="font-weight: bold; font-size: 13px; color: var(--text);">–í—Ä–µ–º—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</div>
            </div>
            <input type="time" id="notify-time-input" onchange="Notify.updateTime(this.value)" style="border: none; background: var(--surface); padding: 5px 10px; border-radius: 8px; font-weight: bold; color: var(--primary); font-size: 15px; outline: none; box-shadow: var(--shadow);">
        </div>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏ -->
        <div style="margin-bottom: 20px; margin-top: 20px;">
            <h4 style="margin-bottom: 10px;">üìö –ú–æ–∏ –ø—Ä–µ–¥–º–µ—Ç—ã</h4>
            <div id="my-subjects-list" class="subject-manage-grid"></div>

            <h4 style="margin-top: 30px; margin-bottom: 10px;">–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</h4>
            <div id="available-subjects-list" class="subject-manage-grid"></div>
        </div>    
        <div class="card" style="margin-bottom: 15px; border: 1px solid rgba(108, 99, 255, 0.2);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; font-size: 16px;">‚òÅÔ∏è –û–±–ª–∞—á–Ω–æ–µ –æ–±–ª–∞–∫–æ</h3>
            <div id="sync-status-dot" style="width: 10px; height: 10px; background: #00d26a; border-radius: 50%; box-shadow: 0 0 10px #00d26a;"></div>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div id="last-sync-text" style="font-size: 12px; color: var(--text-light);">–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: —Ç–æ–ª—å–∫–æ —á—Ç–æ</div>
                <div style="font-size: 10px; color: var(--primary); font-weight: bold; margin-top: 2px;">–°—Ç–∞—Ç—É—Å: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ</div>
            </div>
            <button id="manual-sync-btn" onclick="App.manualSync()" class="btn btn-primary" style="width: auto; padding: 8px 15px; font-size: 12px;">
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å
            </button>
        </div>
    </div>
        <!-- üõ°Ô∏è –ë–õ–û–ö –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò (NEW) -->
        <div class="card" style="border: 2px solid #FF4757; background: rgba(255, 71, 87, 0.05);">
            <h3 style="color: #FF4757; display: flex; align-items: center; gap: 10px;">
                ‚ö†Ô∏è –í–ê–ñ–ù–û: –¢–≤–æ–π –ü—Ä–æ–≥—Ä–µ—Å—Å
            </h3>
            
            <p style="font-size: 13px; line-height: 1.5; margin: 10px 0;">
                –¢–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞. <br>
                <b style="color: #FF4757;">–ï–°–õ–ò –¢–´ –û–ß–ò–°–¢–ò–®–¨ –ö–≠–® –ò–õ–ò –ò–°–¢–û–†–ò–Æ –ë–†–ê–£–ó–ï–†–ê ‚Äî –ê–ö–ö–ê–£–ù–¢ –ò–°–ß–ï–ó–ù–ï–¢!</b>
            </p>

            <div style="background: var(--bg); padding: 15px; border-radius: 12px; border: 1px dashed var(--primary); margin: 15px 0;">
        <div style="font-size: 11px; text-transform: uppercase; color: var(--text-light); font-weight: bold;">–¢–≤–æ–π –ö–æ–¥ –°–ø–∞—Å–µ–Ω–∏—è (–°–∫—Ä–∏–Ω—à–æ—Ç—å!)</div>
        <div id="rescue-code-display" style="font-size: 28px; font-weight: 900; letter-spacing: 3px; color: var(--text); margin-top: 5px; user-select: all;">
            ...
        </div>
    </div>

            <button class="btn" onclick="App.copyRescueCode()" style="background: #2B3674; color: white; width: 100%;">
                üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
            
            <p style="font-size: 11px; color: var(--text-light); margin-top: 10px; text-align: center;">
                –ó–∞–ø–∏—à–∏ —ç—Ç–æ—Ç –∫–æ–¥ –≤ –ó–∞–º–µ—Ç–∫–∏. –¢–æ–ª—å–∫–æ –æ–Ω –≤–µ—Ä–Ω–µ—Ç –∞–∫–∫–∞—É–Ω—Ç.
            </p>
        </div>
        <div class="card" style="margin-top: 20px; text-align: center; cursor: pointer;" onclick="document.getElementById('about-modal').classList.add('show')">
                <h3>‚ÑπÔ∏è –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</h3>
                    <div style="margin-top: 20px; text-align: center; opacity: 0.5; font-size: 10px;" onclick="SecretSys.triggerPrompt()">
                        –í–µ—Ä—Å–∏—è 1.0 PRO (Active)
                    </div>        
                </div>
        </div>
        </section>
        
        <!-- 7. ACHIEVEMENTS -->
        <section id="achievements" class="section">
            <div class="card">
                <h3>üèÖ –ù–∞–≥—Ä–∞–¥—ã</h3>
                <div id="ach-list" class="ach-list"></div>
            </div>
        </section>
        
        <!-- PROFILE -->
        <section id="profile" class="section">
            <div class="card" style="text-align: center;">
                <div class="profile-img" id="profile-avatar-box" style="width: 80px; height: 80px; margin: 0 auto; font-size: 40px; border-width: 6px;">
                    <div id="profile-avatar-big">üòé</div>
                </div>
    <div style="display:flex; align-items:center; justify-content:center; gap:10px; margin-top:10px;">
        <h2 id="profile-name-big" style="margin:0;">–ò–≥—Ä–æ–∫</h2>
        <button onclick="App.changeNickname()" style="background:none; border:none; font-size:18px; cursor:pointer; opacity:0.6;">‚úèÔ∏è</button>
    </div>            
    <div onclick="App.copyId()" style="font-size: 11px; color: var(--text-light); margin-top: 5px; cursor: pointer; opacity: 0.7; background: rgba(0,0,0,0.05); display: inline-block; padding: 4px 10px; border-radius: 10px;">
        ID: <span id="profile-id-text">...</span> üìã
    </div>
            <div style="color: var(--primary); font-weight: bold; margin-bottom: 20px; font-size: 18px;" id="profile-league-big">ü•â –ë—Ä–æ–Ω–∑–æ–≤–∞—è –õ–∏–≥–∞</div>    
                <div id="league-progress-info" style="font-size: 11px; color: var(--text-light); margin-top: -15px; margin-bottom: 20px; font-weight: bold; text-transform: uppercase;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞...</div>
            <div class="stats-row">
                    <div class="stat-pill"><div class="stat-val" id="prof-lvl">1</div><div class="stat-label">–£—Ä–æ–≤–µ–Ω—å</div></div>
                    <div class="stat-pill"><div class="stat-val" id="prof-xp">0</div><div class="stat-label">–û–ø—ã—Ç</div></div>
                    <div class="stat-pill"><div class="stat-val" id="prof-coins">0</div><div class="stat-label">–ú–æ–Ω–µ—Ç—ã</div></div>
                </div>
                <div style="margin-top: 20px; text-align: left;">
                    <p style="font-size: 12px; color: var(--text-light); margin-bottom: 5px;">
                        –ü—Ä–æ–≥—Ä–µ—Å—Å —É—Ä–æ–≤–Ω—è: 
                        <span id="xp-progress-text" style="float:right; font-weight:bold;">0 / 500 XP</span>
                    </p>
                    <div style="height: 10px; background: rgba(0,0,0,0.1); border-radius: 5px; overflow: hidden;">
                        <div id="prof-xp-bar" style="height: 100%; width: 0%; background: var(--primary);"></div>
                    </div>
                </div>
                <button class="btn btn-outline" style="margin-top: 30px; border-color: #FF7675; color: #FF7675;" onclick="Auth.logout()">üö™ –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
            </div>
        </section>
    </div>

    <!-- MODALS -->
    <div id="calc-modal" class="modal">
        <div class="modal-content calc-box">
            <div id="calc-display" class="calc-display">0</div>
            <div class="calc-grid">
                <button class="calc-btn" style="color:#FF7675" onclick="Calc.clear()">C</button>
                <button class="calc-btn" onclick="Calc.append('(')">(</button>
                <button class="calc-btn" onclick="Calc.append(')')">)</button>
                <button class="calc-btn op" onclick="Calc.append('/')">√∑</button>
                <button class="calc-btn" onclick="Calc.append('7')">7</button>
                <button class="calc-btn" onclick="Calc.append('8')">8</button>
                <button class="calc-btn" onclick="Calc.append('9')">9</button>
                <button class="calc-btn op" onclick="Calc.append('*')">√ó</button>
                <button class="calc-btn" onclick="Calc.append('4')">4</button>
                <button class="calc-btn" onclick="Calc.append('5')">5</button>
                <button class="calc-btn" onclick="Calc.append('6')">6</button>
                <button class="calc-btn op" onclick="Calc.append('-')">-</button>
                <button class="calc-btn" onclick="Calc.append('1')">1</button>
                <button class="calc-btn" onclick="Calc.append('2')">2</button>
                <button class="calc-btn" onclick="Calc.append('3')">3</button>
                <button class="calc-btn op" onclick="Calc.append('+')">+</button>
                <button class="calc-btn" onclick="Calc.append('0')">0</button>
                <button class="calc-btn" onclick="Calc.append('.')">.</button>
                <button class="calc-btn eq" style="grid-column:span 2; background:var(--primary); color:white;" onclick="Calc.solve()">=</button>
            </div>
            <button class="btn btn-outline" style="margin-top: 15px; width: 100%;" onclick="Calc.toggle()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="wb-modal" class="modal">
        <div class="modal-content" style="width:95%;">
            <h3>–ß–µ—Ä–Ω–æ–≤–∏–∫</h3>
            <div style="border:2px solid var(--text-light); border-radius:15px; overflow:hidden;">
                <canvas id="wb-canvas" class="canvas-box" height="350"></canvas>
            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn btn-outline" style="color:#FF7675;" onclick="Whiteboard.clear()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                <button class="btn btn-primary" onclick="Whiteboard.close()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="daily-modal" class="modal">
        <div class="modal-content" style="background:linear-gradient(135deg,var(--surface),var(--bg)); border:2px solid var(--gold);">
            <h2 style="color:var(--gold);">üéÅ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ë–æ–Ω—É—Å!</h2>
            <div class="daily-grid" id="daily-grid"></div>
            <div style="margin:20px 0; font-size:40px;">üí∞ <span id="daily-reward-amount">10</span></div>
            <button class="btn btn-primary" style="background:var(--gold); color:#333;" onclick="DailySys.claim()">–ó–∞–±—Ä–∞—Ç—å –ù–∞–≥—Ä–∞–¥—É</button>
        </div>
    </div>

    <div id="ach-details-box" class="modal">
        <div class="modal-content">
            <h2 id="ach-title"></h2>
            <p id="ach-desc" style="color:var(--text-light); margin-bottom:10px;"></p>
            <div id="ach-status" style="font-weight:bold;"></div>
            <button class="btn btn-primary" style="margin-top:20px;" onclick="document.getElementById('ach-details-box').classList.remove('show')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- ABOUT MODAL -->
    <div id="about-modal" class="modal">
        <div class="modal-content" style="padding: 0; overflow: hidden; max-width: 360px; border-radius: 30px;">
            
            <!-- –®–∞–ø–∫–∞ -->
            <div style="background: linear-gradient(135deg, #6C63FF, #8B7EFF); padding: 30px 20px; color: white; text-align: center;">
                <div style="width: 65px; height: 65px; background: white; border-radius: 20px; margin: 0 auto 15px auto; display: flex; align-items: center; justify-content: center; font-size: 32px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                    üöÄ
                </div>
                <h2 style="margin: 0; font-size: 22px; font-weight: 800;">MathBooster PRO</h2>
                <div style="opacity: 0.9; font-size: 13px;">–≠–≤–æ–ª—é—Ü–∏—è —Ç–≤–æ–µ–≥–æ –æ–±—É—á–µ–Ω–∏—è</div>
            </div>

            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
            <div style="padding: 25px;">
                <h4 style="margin-bottom: 10px; color: var(--primary);">–ß—Ç–æ —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å?</h4>
                <ul style="text-align: left; font-size: 13px; color: var(--text); padding-left: 20px; line-height: 1.6;">
                    <li><b>–ö–æ–Ω—Ç—Ä–æ–ª—å –≤—Ä–µ–º–µ–Ω–∏:</b> –£–º–Ω—ã–π —Ç–∞–π–º–µ—Ä —Å Anti-AFK –∑–∞—â–∏—Ç–æ–π.</li>
                    <li><b>–≠–∫–æ–Ω–æ–º–∏–∫–∞:</b> –ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π –º–æ–Ω–µ—Ç—ã —Å–≤–æ–∏–º —É–º–æ–º.</li>
                    <li><b>PVP –ê—Ä–µ–Ω–∞:</b> –í—ã–∑—ã–≤–∞–π –¥—Ä—É–∑–µ–π –Ω–∞ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥—É—ç–ª–∏.</li>
                    <li><b>RPG –ü—Ä–æ–≥—Ä–µ—Å—Å:</b> –ü—Ä–æ–π–¥–∏ –ø—É—Ç—å –æ—Ç –ë—Ä–æ–Ω–∑—ã –¥–æ –õ–µ–≥–µ–Ω–¥—ã.</li>
                    <li><b>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:</b> –ö–æ–¥ —Å–ø–∞—Å–µ–Ω–∏—è –∑–∞—â–∏—Ç–∏—Ç —Ç–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å.</li>
                </ul>

                <div style="background: var(--bg); border-radius: 15px; padding: 15px; margin-top: 20px; text-align: left; font-size: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="color: var(--text-light);">–ê–≤—Ç–æ—Ä:</span>
                        <span style="font-weight: bold;">Mansurov Rustam</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-light);">–í–µ—Ä—Å–∏—è:</span>
                        <span style="font-weight: bold; color: var(--success);">1.0 PRO Active ‚úÖ</span>
                    </div>
                </div>

                <button class="btn btn-primary" style="margin-top: 20px; width: 100%;" onclick="App.switchTab('about'); document.getElementById('about-modal').classList.remove('show')">
                    üìñ –£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ
                </button>
                <button class="btn btn-outline" style="margin-top: 10px; width: 100%; border: none;" onclick="document.getElementById('about-modal').classList.remove('show')">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- LEVEL UP MODAL (–ù–æ–≤–æ–µ –∫—Ä–∞—Å–∏–≤–æ–µ –æ–∫–Ω–æ) -->
    <div id="levelup-modal" class="modal" style="z-index: 10000;">
        <div class="modal-content" style="text-align: center; background: linear-gradient(135deg, #FFD700, #FFA500); color: #2B3674; border: 4px solid white; box-shadow: 0 0 50px rgba(255, 215, 0, 0.8); max-width: 320px; padding: 30px 20px;">
            
            <!-- –ò–∫–æ–Ω–∫–∞ –≤—ã–ª–µ—Ç–∞–µ—Ç —Å–≤–µ—Ä—Ö—É -->
    <div style="font-size: 80px; margin-top: -60px; margin-bottom: 10px; text-shadow: 0 5px 10px rgba(0,0,0,0.2); animation: bounce 2s infinite;">üöÄ</div>        
            <h2 style="font-weight: 900; font-size: 32px; text-transform: uppercase; margin: 0;">Level Up!</h2>
            
            <div style="font-size: 16px; font-weight: bold; margin-bottom: 20px; opacity: 0.9;">
                –ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å: <span id="lvl-up-new-level" style="font-size: 28px; color: white; text-shadow: 1px 1px 0 rgba(0,0,0,0.3);">2</span>
            </div>

            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Å –Ω–∞–≥—Ä–∞–¥–æ–π -->
            <div style="background: rgba(255,255,255,0.9); padding: 15px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                <div style="font-size: 11px; text-transform: uppercase; color: #888; font-weight: bold; margin-bottom: 5px;">–¢–≤–æ—è –Ω–∞–≥—Ä–∞–¥–∞</div>
                <div style="font-size: 28px; font-weight: 800; color: #00d26a;">+50 üí∞</div>
            </div>

            <button class="btn" onclick="document.getElementById('levelup-modal').classList.remove('show')" style="background: #2B3674; color: white; width: 100%; font-weight: bold; box-shadow: 0 5px 15px rgba(43, 54, 116, 0.4);">
                –ö—Ä—É—Ç–æ! üöÄ
            </button>
        </div>
    </div>
    <!-- INSTALL INSTRUCTION MODAL -->
    <div id="install-modal" class="modal" style="z-index: 15000;">
        <div class="modal-content" style="text-align: left; max-width: 340px;">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 50px; margin-bottom: 10px;">üì≤</div>
                <h3 style="margin: 0;">–ö–∞–∫ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å?</h3>
                <p style="font-size: 12px; color: var(--success); margin-top: 5px; font-weight: bold;">‚úÖ –ö–æ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!</p>
            </div>

            <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è iPhone (iOS) -->
            <div id="ios-instruction" style="display: none; background: #F2F2F7; padding: 15px; border-radius: 15px; color: black;">
                <div style="font-weight: bold; margin-bottom: 10px; color: #007AFF;">üçé –î–ª—è iPhone (Safari):</div>
                <div style="font-size: 13px; line-height: 1.6;">
                    1. –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É <b>"–ü–æ–¥–µ–ª–∏—Ç—å—Å—è"</b> <span style="font-size: 18px;">‚éã</span> –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞.<br>
                    2. –ü—Ä–æ–∫—Ä—É—Ç–∏ —Å–ø–∏—Å–æ–∫ –≤–Ω–∏–∑.<br>
                    3. –ù–∞–∂–º–∏ <b>"–ù–∞ —ç–∫—Ä–∞–Ω ¬´–î–æ–º–æ–π¬ª"</b> <span style="font-size: 16px;">‚ûï</span>.<br>
                    4. –ù–∞–∂–º–∏ "–î–æ–±–∞–≤–∏—Ç—å".
                </div>
            </div>

            <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è Android -->
            <div id="android-instruction" style="display: none; background: #F1F8E9; padding: 15px; border-radius: 15px; color: black;">
                <div style="font-weight: bold; margin-bottom: 10px; color: #4CAF50;">ü§ñ –î–ª—è Android (Chrome):</div>
                <div style="font-size: 13px; line-height: 1.6;">
                    1. –ù–∞–∂–º–∏ <b>—Ç—Ä–∏ —Ç–æ—á–∫–∏</b> <span style="font-size: 18px;">‚ãÆ</span> –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É.<br>
                    2. –í—ã–±–µ—Ä–∏ <b>"–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"</b> –∏–ª–∏ <b>"–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª. —ç–∫—Ä–∞–Ω"</b>.<br>
                    3. –ù–∞–∂–º–∏ "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å".
                </div>
            </div>

            <div style="font-size: 12px; color: var(--text-light); margin-top: 20px; text-align: center;">
                –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É <b>"üì• –£ –º–µ–Ω—è –µ—Å—Ç—å –∫–æ–¥"</b>.
            </div>

            <button class="btn btn-primary" onclick="document.getElementById('install-modal').classList.remove('show')" style="margin-top: 15px; width: 100%;">–ü–æ–Ω—è—Ç–Ω–æ</button>
        </div>
    </div>
    <!-- TERMS MODAL (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ) -->
    <div id="terms-modal" class="modal">
        <div class="modal-content" style="text-align: left; padding: 0; overflow: hidden; max-height: 85vh; display: flex; flex-direction: column;">
            
            <!-- –®–∞–ø–∫–∞ -->
            <div style="background: var(--surface); padding: 20px; border-bottom: 1px solid rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 18px;">üìÑ –°–æ–≥–ª–∞—à–µ–Ω–∏–µ</h3>
                <button onclick="document.getElementById('terms-modal').classList.remove('show')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light);">√ó</button>
            </div>

            <!-- –¢–µ–∫—Å—Ç (—Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π) -->
            <div style="padding: 20px; overflow-y: auto; font-size: 13px; color: var(--text); line-height: 1.6;">
                <p style="color: var(--text-light); margin-bottom: 15px;">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –Ø–Ω–≤–∞—Ä—å 2026</p>

                <h4 style="margin-top: 15px; color: var(--primary);">1. –û–±—â–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è</h4>
                <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ MathBooster PRO. –ò—Å–ø–æ–ª—å–∑—É—è –¥–∞–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –≤—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ –¥–∞–Ω–Ω–æ–≥–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –ú–∞–Ω—Å—É—Ä–æ–≤—ã–º –†—É—Å—Ç–∞–º–æ–º (–¥–∞–ª–µ–µ ‚Äî –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫) –∏ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–æ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ª–∏—á–Ω–æ–π –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.</p>

                <h4 style="margin-top: 15px; color: var(--primary);">2. –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å</h4>
                <p>–í—Å–µ –ø—Ä–∞–≤–∞ –Ω–∞ –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥, –¥–∏–∑–∞–π–Ω, –ª–æ–≥–æ—Ç–∏–ø, –Ω–∞–∑–≤–∞–Ω–∏–µ "MathBooster", –∞ —Ç–∞–∫–∂–µ –∏–≥—Ä–æ–≤—ã–µ –º–µ—Ö–∞–Ω–∏–∫–∏ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É. <br>‚õîÔ∏è <b>–ó–∞–ø—Ä–µ—â–µ–Ω–æ:</b> –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ, –¥–µ–∫–æ–º–ø–∏–ª—è—Ü–∏—è, –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –∏–ª–∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –±–µ–∑ –ø–∏—Å—å–º–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∞. –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–µ—Å–ª–µ–¥—É–µ—Ç—Å—è –ø–æ –ó–∞–∫–æ–Ω—É –†–£–∑ ¬´–û–± –∞–≤—Ç–æ—Ä—Å–∫–æ–º –ø—Ä–∞–≤–µ¬ª.</p>

                <h4 style="margin-top: 15px; color: var(--primary);">3. –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –∏ –î–æ–Ω–∞—Ç</h4>
                <p>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ (Freeware). –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–æ–≤–µ—Ä—à–∞—Ç—å –¥–æ–±—Ä–æ–≤–æ–ª—å–Ω—ã–µ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è (–¥–æ–Ω–∞—Ç—ã) –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.</p>
                <ul>
                    <li><b>–ú–æ–Ω–µ—Ç—ã (Coins)</b> ‚Äî —ç—Ç–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –∏–≥—Ä–æ–≤–∞—è –µ–¥–∏–Ω–∏—Ü–∞, –Ω–µ –∏–º–µ—é—â–∞—è —Ä–µ–∞–ª—å–Ω–æ–π –¥–µ–Ω–µ–∂–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏.</li>
                    <li>–ú–æ–Ω–µ—Ç—ã –Ω–µ–ª—å–∑—è –æ–±–º–µ–Ω—è—Ç—å –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –¥–µ–Ω—å–≥–∏ (—Å—É–º—ã, –¥–æ–ª–ª–∞—Ä—ã –∏ —Ç.–¥.).</li>
                    <li>–°–æ–≤–µ—Ä—à–∞—è –ø–µ—Ä–µ–≤–æ–¥ (—á–µ—Ä–µ–∑ Click, Payme, Visa), –≤—ã —Å–æ–≤–µ—Ä—à–∞–µ—Ç–µ <b>–±–µ–∑–≤–æ–∑–º–µ–∑–¥–Ω–æ–µ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–µ</b>. –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –Ω–µ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω.</li>
                </ul>

                <h4 style="margin-top: 15px; color: var(--primary);">4. –û—Ç–∫–∞–∑ –æ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏</h4>
                <p>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É "–∫–∞–∫ –µ—Å—Ç—å" (As Is). –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ –Ω–µ—Å–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ —Å–±–æ–∏ –≤ —Ä–∞–±–æ—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –ø–æ—Ç–µ—Ä—é –∏–≥—Ä–æ–≤–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏–∑-–∑–∞ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.</p>

                <h4 style="margin-top: 15px; color: var(--primary);">5. –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</h4>
                <p>–ú—ã —É–≤–∞–∂–∞–µ–º –≤–∞—à—É –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —Å–æ–±–∏—Ä–∞–µ—Ç –ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤, –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é), –∫—Ä–æ–º–µ —Ç–µ—Ö, —á—Ç–æ –≤—ã –≤–≤–æ–¥–∏—Ç–µ —Å–∞–º–∏ (–ò–º—è). –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ –≤–∞—à–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –∏ –≤ –∑–∞—â–∏—â–µ–Ω–Ω–æ–π –æ–±–ª–∞—á–Ω–æ–π –±–∞–∑–µ.</p>

                <div style="margin-top: 20px; padding: 15px; background: rgba(108, 99, 255, 0.1); border-radius: 10px; text-align: center;">
                    <b>MathBooster Inc.</b><br>
                    Bukhara, Uzbekistan üá∫üáø
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –≤–Ω–∏–∑—É -->
            <div style="padding: 15px; border-top: 1px solid rgba(0,0,0,0.1); background: var(--surface);">
                <button id="terms-accept-btn" class="btn btn-primary" onclick="document.getElementById('terms-modal').classList.remove('show')">
                    –Ø –ø–æ–Ω–∏–º–∞—é –∏ –ø—Ä–∏–Ω–∏–º–∞—é
                </button>
            </div>
        </div>
    </div>
    <div id="toast-container"></div>
    <script>
    /* ==========================================
    0. FX SYSTEM
    ========================================== */
    const FX = {
        floatText(x, y, text, color) {
            const el = document.createElement('div'); 
            el.className = 'float-text';
            // –£–ª—É—á—à–∞–µ–º —Å—Ç–∏–ª—å –≤—ã–ª–µ—Ç–∞—é—â–µ–≥–æ —Ç–µ–∫—Å—Ç–∞
            el.style.cssText = `
                position: fixed;
                left: ${x}px;
                top: ${y}px;
                color: ${color || '#FFD700'};
                font-weight: 900;
                font-size: 24px;
                pointer-events: none;
                z-index: 9999;
                text-shadow: 0 4px 10px rgba(0,0,0,0.2);
                transition: all 1s ease-out;
            `;
            el.innerText = text;
            document.body.appendChild(el);

            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —á–µ—Ä–µ–∑ requestAnimationFrame
            requestAnimationFrame(() => {
                el.style.transform = `translateY(-100px) scale(1.5) rotate(${Math.random() * 20 - 10}deg)`;
                el.style.opacity = '0';
            });

            setTimeout(() => el.remove(), 1000);
        },
        confetti() {
            const colors = ['#FFD700', '#FF7675', '#6C63FF', '#00d26a', '#ffffff'];
            for(let i=0; i<100; i++) { // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ 100
                const el = document.createElement('div'); 
                el.className = 'confetti-piece';
                el.style.cssText = `
                    position: fixed;
                    width: ${Math.random() * 10 + 5}px;
                    height: ${Math.random() * 10 + 5}px;
                    background: ${colors[Math.floor(Math.random()*colors.length)]};
                    left: ${Math.random() * 100}vw;
                    top: -10px;
                    opacity: ${Math.random()};
                    z-index: 99999;
                    pointer-events: none;
                    border-radius: ${Math.random() > 0.5 ? '50%' : '2px'};
                    animation: fall ${Math.random() * 3 + 2}s linear forwards;
                `;
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 5000);
            }
        }
    };

    /* ==========================================
    0. PWA & SOUND
    ========================================== */
    const PWA = {
        prompt: null,
        init() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault(); this.prompt = e;
                document.getElementById('btn-install').style.display = 'block';
            });
        },
        install() {
            if(this.prompt) {
                this.prompt.prompt();
                this.prompt.userChoice.then(() => {
                    document.getElementById('btn-install').style.display = 'none'; this.prompt = null;
                });
            }
        }
    };

    const MusicPlayer = {
        playing: false,
        audio: null,
        
        init() { 
            this.audio = document.getElementById('lofi-stream'); 
            this.audio.addEventListener('ended', () => this.reset());
            this.audio.addEventListener('error', (e) => {
                App.toast("‚ùå –û—à–∏–±–∫–∞ —Ä–∞–¥–∏–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
                this.reset();
            });
        },

        reset() {
            this.playing = false;
            const btn = document.getElementById('music-btn');
            const vis = document.getElementById('music-vis');
            if(btn) btn.innerText = "‚ñ∂";
            if(vis) vis.style.opacity = "0";
        },

        toggle() {
            if(!this.audio) this.init();
            
            const btn = document.getElementById('music-btn');
            const vis = document.getElementById('music-vis');
            
            if(this.playing) {
                this.audio.pause();
                this.reset();
            } else {
                const playPromise = this.audio.play();
                if (playPromise !== undefined) {
                    btn.innerText = "‚è≥";
                    playPromise.then(_ => {
                        this.playing = true;
                        btn.innerText = "‚è∏";
                        vis.style.opacity = "1";
                    })
                    .catch(error => {
                        console.error("Audio Play Error:", error);
                        App.toast("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å —Ä–∞–¥–∏–æ");
                        this.reset();
                    });
                }
            }
        }
    };

    const SoundSys = {
        ctx: null, enabled: true,
        init() { try { const AudioContext = window.AudioContext || window.webkitAudioContext; this.ctx = new AudioContext(); } catch(e) {} },
        
        toggleSFX(val) { this.enabled = val; DB.settings.sfx = val; Data.save(); if(val) this.play('click'); },
        
        play(type) {
            if(!this.enabled || !this.ctx) return; 
            if(this.ctx.state === 'suspended') this.ctx.resume();
            
            const t = this.ctx.currentTime; 
            const osc = this.ctx.createOscillator(); 
            const gain = this.ctx.createGain();
            
            osc.connect(gain); 
            gain.connect(this.ctx.destination);

            const pack = (DB && DB.user && DB.user.soundPack) ? DB.user.soundPack : 'standard';

            if (type === 'quest_done') {
                // –ú–µ–ª–æ–¥–∏—è —É—Å–ø–µ—Ö–∞: –î–æ-–ú–∏-–°–æ–ª—å-–î–æ (–≤–æ—Å—Ö–æ–¥—è—â–∞—è)
                [523, 659, 783, 1046].forEach((f, i) => {
                    this.beep(f, t + i * 0.1, 0.1);
                });
                return;
            }

            if (type === 'level_up') {
                // –§–∞–Ω—Ñ–∞—Ä—ã: —Ç—Ä–∏ –∫–æ—Ä–æ—Ç–∫–∏—Ö –∏ –æ–¥–∏–Ω –¥–ª–∏–Ω–Ω—ã–π –≤—ã—Å–æ–∫–∏–π –∑–≤—É–∫
                [523, 523, 523, 1046].forEach((f, i) => {
                    this.beep(f, t + i * 0.15, i === 3 ? 0.5 : 0.1);
                });
                return;
            }
            // --- üïπÔ∏è 8-BIT (–†–ï–¢–†–û) ---
            if (pack === 'retro') {
                osc.type = 'square'; 
                gain.gain.setValueAtTime(0.05, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);

                if (type === 'click') { osc.frequency.setValueAtTime(440, t); osc.start(t); osc.stop(t+0.1); }
                else if (type === 'coin')  { osc.frequency.setValueAtTime(900, t); osc.frequency.linearRampToValueAtTime(1800, t+0.1); osc.start(t); osc.stop(t+0.1); }
                else if (type === 'success') { osc.frequency.setValueAtTime(500, t); osc.frequency.setValueAtTime(1000, t+0.1); osc.start(t); osc.stop(t+0.2); }
                else if (type === 'error') { osc.frequency.setValueAtTime(150, t); osc.frequency.linearRampToValueAtTime(50, t+0.2); osc.start(t); osc.stop(t+0.2); }
                else if (type === 'win')   { osc.frequency.setValueAtTime(500, t); osc.frequency.linearRampToValueAtTime(1500, t+0.3); osc.start(t); osc.stop(t+0.3); }
            }
            
            // --- üßº BUBBLE (–ë–£–õ–¨–ö) ---
            else if (pack === 'bubble') {
                osc.type = 'sine';
                gain.gain.setValueAtTime(0.2, t);
                gain.gain.linearRampToValueAtTime(0, t + 0.15);

                if (type === 'click') { osc.frequency.setValueAtTime(300, t); osc.frequency.linearRampToValueAtTime(600, t+0.1); osc.start(t); osc.stop(t+0.1); }
                else if (type === 'coin')  { osc.frequency.setValueAtTime(600, t); osc.frequency.linearRampToValueAtTime(1200, t+0.15); osc.start(t); osc.stop(t+0.15); }
                else { osc.frequency.setValueAtTime(400, t); osc.start(t); osc.stop(t+0.1); }
            }

            // --- üöÄ SCI-FI (–ö–û–°–ú–û–°) ---
            else if (pack === 'sci-fi') {
                osc.type = 'sawtooth';
                gain.gain.setValueAtTime(0.04, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.2);

                if (type === 'click') { osc.frequency.setValueAtTime(800, t); osc.frequency.exponentialRampToValueAtTime(100, t+0.1); osc.start(t); osc.stop(t+0.1); }
                else { osc.frequency.setValueAtTime(200, t); osc.frequency.linearRampToValueAtTime(800, t+0.3); osc.start(t); osc.stop(t+0.3); }
            }

            else if (pack === 'mechanical') {
                osc.type = 'triangle'; // –ë–æ–ª–µ–µ "–º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–π" –∑–≤—É–∫
                gain.gain.setValueAtTime(0.1, t);
                if (type === 'click') { 
                    osc.frequency.setValueAtTime(150, t); 
                    osc.start(t); osc.stop(t+0.05); 
                } else { 
                    osc.frequency.setValueAtTime(300, t); 
                    osc.start(t); osc.stop(t+0.1); 
                }
            }
            // --- üíú STANDARD (–ö–õ–ê–°–°–ò–ö–ê) ---
            else {
                if(type === 'click') { osc.type = 'sine'; osc.frequency.setValueAtTime(800, t); osc.frequency.exponentialRampToValueAtTime(1200, t+0.1); gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.001, t+0.1); osc.start(t); osc.stop(t+0.1); }
                else if(type === 'coin') { osc.type = 'sine'; osc.frequency.setValueAtTime(1200, t); osc.frequency.exponentialRampToValueAtTime(1800, t+0.3); gain.gain.setValueAtTime(0.1, t); gain.gain.linearRampToValueAtTime(0, t+0.5); osc.start(t); osc.stop(t+0.5); }
                else if(type === 'success') { this.beep(523.25, t, 0.1); this.beep(659.25, t+0.1, 0.1); this.beep(783.99, t+0.2, 0.2); }
                else if(type === 'error') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, t); osc.frequency.linearRampToValueAtTime(100, t+0.3); gain.gain.setValueAtTime(0.1, t); gain.gain.linearRampToValueAtTime(0, t+0.3); osc.start(t); osc.stop(t+0.3); }
                else if(type === 'win') { this.beep(523.25, t, 0.15); this.beep(523.25, t+0.15, 0.15); this.beep(523.25, t+0.30, 0.15); this.beep(659.25, t+0.45, 0.4); }
            }
        },
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∑–≤—É–∫–æ–≤
        beep(freq, time, dur) { 
            const osc = this.ctx.createOscillator(); 
            const gain = this.ctx.createGain(); 
            osc.connect(gain); 
            gain.connect(this.ctx.destination); 
            osc.type = 'triangle'; 
            osc.frequency.setValueAtTime(freq, time); 
            gain.gain.setValueAtTime(0.1, time); 
            gain.gain.linearRampToValueAtTime(0, time+dur); 
            osc.start(time); 
            osc.stop(time+dur); 
        }
    };

    /* ==========================================
    1. DATA & CONFIG
    ========================================= */
    const GenAch = () => {
        const list = []; 
        let id = 1; 
        const add = (title, desc, max, icon, type) => list.push({id: id++, title, desc, max, icon, type, unlocked:false});

        // --- ‚è≥ –í–†–ï–ú–Ø (–ò–ù–í–ï–°–¢–ò–¶–ò–ò –í –°–ï–ë–Ø) ---
        add("–ü–µ—Ä–≤—ã–π —à–∞–≥", "1 –º–∏–Ω—É—Ç–∞ —É—á–µ–±—ã", 60, "üå±", "total"); 
        add("–†–∞–∑–º–∏–Ω–∫–∞", "15 –º–∏–Ω—É—Ç", 900, "ü§∏", "total"); 
        add("–ß–∞—Å —Å–∏–ª—ã", "1 —á–∞—Å", 3600, "üïê", "total"); 
        add("–ì–ª—É–±–æ–∫–æ–µ –ø–æ–≥—Ä—É–∂–µ–Ω–∏–µ", "5 —á–∞—Å–æ–≤", 18000, "ü§ø", "total"); 
        add("–ú–∞—Ä–∞—Ñ–æ–Ω–µ—Ü", "24 —á–∞—Å–∞ –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏", 86400, "üèÉ", "total"); 
        add("–£—á–µ–Ω—ã–π —Å–æ–≤–µ—Ç", "100 —á–∞—Å–æ–≤ —É—á–µ–±—ã", 360000, "üéì", "total"); 

        // --- üî• –°–¢–†–ò–ö–ò (–î–ò–°–¶–ò–ü–õ–ò–ù–ê) ---
        add("–¢—Ä–∏ –¥–Ω—è", "–î–µ—Ä–∂–∏ –æ–≥–æ–Ω—å 3 –¥–Ω—è", 3, "üî•", "streak");
        add("–ù–µ–¥–µ–ª—è –≤ –æ–≥–Ω–µ", "–î–µ—Ä–∂–∏ –æ–≥–æ–Ω—å 7 –¥–Ω–µ–π", 7, "üî•", "streak");
        add("–ñ–µ–ª–µ–∑–Ω–∞—è –ø—Ä–∏–≤—ã—á–∫–∞", "–î–µ—Ä–∂–∏ –æ–≥–æ–Ω—å 30 –¥–Ω–µ–π", 30, "üåã", "streak");

        // --- üîí –•–ê–†–î–ö–û–† (–°–ò–õ–ê –í–û–õ–ò) ---
        add("–°–º–µ–ª—å—á–∞–∫", "1 —á–∞—Å –≤ –•–∞—Ä–¥–∫–æ—Ä —Ä–µ–∂–∏–º–µ", 3600, "üõ°Ô∏è", "strict_time");
        add("–°—Ç–∞–ª—å–Ω—ã–µ –Ω–µ—Ä–≤—ã", "5 —á–∞—Å–æ–≤ –≤ –•–∞—Ä–¥–∫–æ—Ä —Ä–µ–∂–∏–º–µ", 18000, "‚õìÔ∏è", "strict_time");
        add("–¢–∏—Ç–∞–Ω–æ–≤–∞—è –≤–æ–ª—è", "10 —á–∞—Å–æ–≤ –≤ –•–∞—Ä–¥–∫–æ—Ä —Ä–µ–∂–∏–º–µ", 36000, "üóø", "strict_time");

        // --- üß† –¢–†–ï–ù–ê–ñ–ï–† –ò PVP ---
        add("–°—á–µ—Ç–æ–≤–æ–¥", "100 —Ä–µ—à–µ–Ω–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–æ–≤", 100, "üî¢", "math_total");
        add("–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä", "1000 —Ä–µ—à–µ–Ω–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–æ–≤", 1000, "ü§ñ", "math_total");
        add("–ü–µ—Ä–≤–∞—è –∫—Ä–æ–≤—å", "–í—ã–∏–≥—Ä–∞–π 1 –¥—É—ç–ª—å", 1, "‚öîÔ∏è", "pvp_wins");
        add("–ì–ª–∞–¥–∏–∞—Ç–æ—Ä", "–í—ã–∏–≥—Ä–∞–π 10 –¥—É—ç–ª–µ–π", 10, "üó°Ô∏è", "pvp_wins");
        add("–õ–µ–≥–µ–Ω–¥–∞ –ê—Ä–µ–Ω—ã", "–í—ã–∏–≥—Ä–∞–π 50 –¥—É—ç–ª–µ–π", 50, "üëë", "pvp_wins");

        // --- üí∞ –≠–ö–û–ù–û–ú–ò–ö–ê (–ë–û–ì–ê–¢–°–¢–í–û) ---
        add("–ü–µ—Ä–≤–∞—è —Å–æ—Ç–Ω—è", "–ù–∞–∫–æ–ø–∏ 100 –º–æ–Ω–µ—Ç", 100, "üí∞", "coins_max");
        add("–ë–æ–≥–∞—Ç–µ–π", "–ù–∞–∫–æ–ø–∏ 1000 –º–æ–Ω–µ—Ç", 1000, "üíé", "coins_max");
        add("–ú–∏–ª–ª–∏–æ–Ω–µ—Ä", "–ù–∞–∫–æ–ø–∏ 5000 –º–æ–Ω–µ—Ç", 5000, "üí∏", "coins_max");
        add("–®–æ–ø–æ–≥–æ–ª–∏–∫", "–ü–æ—Ç—Ä–∞—Ç—å –≤—Å–µ–≥–æ 1000 –º–æ–Ω–µ—Ç", 1000, "üõí", "coins_spent");

        // --- üÜô –£–†–û–í–ù–ò ---
        add("–ù–æ–≤–∏—á–æ–∫", "–î–æ—Å—Ç–∏–≥–Ω–∏ 5 —É—Ä–æ–≤–Ω—è", 5, "üê£", "lvl");
        add("–û–ø—ã—Ç–Ω—ã–π", "–î–æ—Å—Ç–∏–≥–Ω–∏ 15 —É—Ä–æ–≤–Ω—è", 15, "ü¶ä", "lvl");
        add("–ú–∞—Å—Ç–µ—Ä", "–î–æ—Å—Ç–∏–≥–Ω–∏ 30 —É—Ä–æ–≤–Ω—è", 30, "üêØ", "lvl");
        add("–ì—Ä–∞–Ω–¥–º–∞—Å—Ç–µ—Ä", "–î–æ—Å—Ç–∏–≥–Ω–∏ 50 —É—Ä–æ–≤–Ω—è", 50, "üêâ", "lvl");

        // --- üé® –ö–û–õ–õ–ï–ö–¶–ò–ò ---
        add("–°—Ç–∏–ª—å–Ω—ã–π", "–ö—É–ø–∏ 3 —Ç–µ–º—ã", 3, "üé®", "themes_count");
        add("–•–∞–º–µ–ª–µ–æ–Ω", "–ö—É–ø–∏ 7 —Ç–µ–º", 7, "üåà", "themes_count");
        add("–ó–æ–æ–ø–∞—Ä–∫", "–ö—É–ø–∏ 5 –∞–≤–∞—Ç–∞—Ä–æ–∫", 5, "üê±", "avatars_count");

        // --- ü¶â –†–ï–ñ–ò–ú –î–ù–Ø ---
        add("–ù–æ—á–Ω–∞—è —Å–æ–≤–∞", "–£—á–∏—Å—å –ø–æ—Å–ª–µ 22:00", 1, "ü¶â", "night_study");
        add("–†–∞–Ω–Ω—è—è –ø—Ç–∞—à–∫–∞", "–£—á–∏—Å—å –¥–æ 08:00 —É—Ç—Ä–∞", 1, "üåÖ", "morning_study");
        add("–û–±–µ–¥ ‚Äî –≤—Ä–µ–º—è –∑–Ω–∞–Ω–∏–π", "–£—á–∏—Å—å –≤ 14:00", 1, "üçú", "lunch_study");

        return list;
    };

    const DefaultDB = { 
        user: { 
            darkMode: false,
            xp: 0, level: 1, nextXp: 500, 
            totalSec: 0, subject: 'algebra', theme: 'standard', 
            avatar: 'üòé', gender: 'male', 
            coins: 0, streak: 0,
            lastStudyDate: null,
            lifetimeMathSolved: 0,
            pvpWins: 0, 
            dailyStreak: 0, lastDailyClaim: null, 
            ownedThemes: ['standard'], ownedAvatars: [], 
            ownedTitles: [],
            currentTitle: null, // –ï—Å–ª–∏ null, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –õ–∏–≥—É
            lastSaveTime: 0,
            lifetimeStrictSec: 0,
            lifetimeCoinsSpent: 0,
            ownedFrames: [],      // –ö—É–ø–ª–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏
            currentFrame: null,   // –¢–µ–∫—É—â–∞—è —Ä–∞–º–∫–∞
            ownedSounds: ['standard'], // –ö—É–ø–ª–µ–Ω–Ω—ã–µ –∑–≤—É–∫–∏
            soundPack: 'standard',     // –¢–µ–∫—É—â–∏–π –ø–∞–∫
            trainerRecords: {
                standard: { easy: 0, medium: 0, hard: 0 },
                sign:     { easy: 0, medium: 0, hard: 0 },
                square:   { easy: 0, medium: 0, hard: 0 }
            },
            usedCodes: [],
            lifetimeXP: 0,
            inventory: { shield: 0 }
        }, 

        settings: { 
            sfx: true,  
            notifications: false,
            notifyTime: "19:00" // –í—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        },
        // –ü—Ä–µ–¥–º–µ—Ç—ã
        subjects: { 
            algebra: {name:'–ê–ª–≥–µ–±—Ä–∞', icon:'‚úñÔ∏è', sec:0}, 
            geometry: {name:'–ì–µ–æ–º–µ—Ç—Ä–∏—è', icon:'üìê', sec:0},
            calculus: {name:'–ú–∞—Ç. –∞–Ω–∞–ª–∏–∑', icon:'‚à´', sec:0},
            arithmetic: {name:'–ê—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞', icon:'üî¢', sec:0},
            combinatorics: {name:'–ö–æ–º–±–∏–Ω–∞—Ç–æ—Ä–∏–∫–∞', icon:'üîÄ', sec:0},
            statistics: {name:'–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', icon:'üìä', sec:0},
            trigonometry: {name:'–¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è', icon:'üìè', sec:0},
            stereometry: {name:'–°—Ç–µ—Ä–µ–æ–º–µ—Ç—Ä–∏—è', icon:'üßä', sec:0}
        }, 
        history:{}, sessions:[], achievements:[] 
    };


    const AVATARS = [
        {id:'lion',icon:'ü¶Å',price:50}, 
        {id:'robot',icon:'ü§ñ',price:100}, 
        {id:'alien',icon:'üëΩ',price:150}, 
        {id:'dragon',icon:'üê≤',price:300}, 
        {id:'wizard',icon:'üßô‚Äç‚ôÇÔ∏è',price:300}, 
        {id:'king',icon:'üëë',price:500}
    ];

    const THEMES = [
        // –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∏ –î–µ—à–µ–≤—ã–µ
        { id: 'standard', name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç', icon: 'üíú', price: 0 },
        { id: 'dark', name: '–¢–µ–º–Ω–∞—è', icon: 'üåô', price: 0 }, /* –°–¥–µ–ª–∞–ª –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ */
        
        // –ù–æ–≤—ã–µ –î–Ω–µ–≤–Ω—ã–µ (–õ–µ–≥–∫–∏–µ)
        { id: 'paper', name: '–ë—É–º–∞–≥–∞', icon: 'üìù', price: 300 },
        { id: 'sakura', name: '–°–∞–∫—É—Ä–∞', icon: 'üå∏', price: 400 },
        { id: 'lemon', name: '–õ–∏–º–æ–Ω', icon: 'üçã', price: 400 },

        // –°—Ç–∏–ª—å–Ω—ã–µ (–°—Ä–µ–¥–Ω–∏–µ)
        { id: 'pantone', name: '–ü–µ—Ä—Å–∏–∫', icon: 'üçë', price: 500 },
        { id: 'forest', name: '–õ–µ—Å', icon: 'üå≤', price: 600 },
        
        // –≠–ª–∏—Ç–Ω—ã–µ
        { id: 'neon', name: '–ù–µ–æ–Ω', icon: 'ü¶Ñ', price: 800 },
        { id: 'math', name: '–ê–ª–º–∞–∑', icon: 'üíé', price: 1000 },
        { id: 'gold', name: '–ó–æ–ª–æ—Ç–æ', icon: 'ü•á', price: 1500 },
        
        // –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è
        { id: 'magma', name: 'MAGMA', icon: 'üî•', price: 2500 },
        { id: 'joker', name: 'JOKER', icon: 'üÉè', price: 3000 },


        // –ö–û–°–ú–ò–ß–ï–°–ö–ê–Ø –¢–ï–ú–ê
        { id: 'galaxy', name: '–ì–∞–ª–∞–∫—Ç–∏–∫–∞', icon: 'üåå', price: 5000 }
    ];

    const SHOP_AVATARS = [
        // üê£ –ù–ê–ß–ê–õ–¨–ù–´–ï (–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ ‚Äî –≤–∏–¥—è—Ç –≤—Å–µ)
        { id: 'cat', icon: 'üê±', name: '–ö–æ—Ç–∏–∫', price: 50 },
        { id: 'dog', icon: 'üê∂', name: '–ü–µ—Å–µ–ª—å', price: 50 },
        { id: 'hamster', icon: 'üêπ', name: '–•–æ–º—è–∫', price: 50 },
        { id: 'panda', icon: 'üêº', name: '–ü–∞–Ω–¥–∞', price: 200 },
        { id: 'robot', icon: 'ü§ñ', name: '–†–æ–±–æ—Ç', price: 200 },

        // üë©‚Äçüéì –ñ–ï–ù–°–ö–ò–ï (–¢–æ–ª—å–∫–æ –¥–ª—è –¥–µ–≤—É—à–µ–∫)
        { id: 'girl_student', icon: 'üë©‚Äçüéì', name: '–°—Ç—É–¥–µ–Ω—Ç–∫–∞', price: 100, gender: 'female' },
        { id: 'muslimah', icon: 'üßï', name: '–ú—É—Å–ª–∏–º–∞', price: 150, gender: 'female' },
        { id: 'artist', icon: 'üë©‚Äçüé®', name: '–•—É–¥–æ–∂–Ω–∏—Ü–∞', price: 250, gender: 'female' },
        { id: 'supergirl', icon: 'ü¶∏‚Äç‚ôÄÔ∏è', name: '–°—É–ø–µ—Ä–≥—ë—Ä–ª', price: 350, gender: 'female' },
        { id: 'queen', icon: 'üë∏', name: '–ö–æ—Ä–æ–ª–µ–≤–∞', price: 1000, gender: 'female' },

        // üë®‚Äçüéì –ú–£–ñ–°–ö–ò–ï (–¢–æ–ª—å–∫–æ –¥–ª—è –ø–∞—Ä–Ω–µ–π)
        { id: 'boy_student', icon: 'üë®‚Äçüéì', name: '–°—Ç—É–¥–µ–Ω—Ç', price: 100, gender: 'male' },
        { id: 'brother', icon: 'üßî', name: '–ë–æ—Ä–æ–¥–∞—á', price: 150, gender: 'male' },
        { id: 'gamer', icon: 'üéß', name: '–ì–µ–π–º–µ—Ä', price: 100, gender: 'male' },
        { id: 'superman', icon: 'ü¶∏‚Äç‚ôÇÔ∏è', name: '–°—É–ø–µ—Ä–º–µ–Ω', price: 350, gender: 'male' },
        { id: 'king', icon: 'üëë', name: '–ö–æ—Ä–æ–ª—å', price: 1000, gender: 'male' },
        { id: 'wizard', icon: 'üßô‚Äç‚ôÇÔ∏è', name: '–í–æ–ª—à–µ–±–Ω–∏–∫', price: 450, gender: 'male' },

        // üî• –≠–ü–ò–ß–ï–°–ö–ò–ï (–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ ‚Äî –≤–∏–¥—è—Ç –≤—Å–µ)
        { id: 'alien', icon: 'üëΩ', name: '–ü—Ä–∏—à–µ–ª–µ—Ü', price: 300 },
        { id: 'skull', icon: 'üíÄ', name: '–ß–µ—Ä–µ–ø', price: 350 },
        { id: 'dragon', icon: 'üê≤', name: '–î—Ä–∞–∫–æ–Ω', price: 500 },
        { id: 'samurai', icon: 'üë∫', name: '–°–∞–º—É—Ä–∞–π', price: 600 },
        { id: 'diamond', icon: 'üíé', name: '–ú–∞–≥–Ω–∞—Ç', price: 2000 },

        // üöÄ LEGENDARY (–î–ª—è –º–∏–ª–ª–∏–æ–Ω–µ—Ä–æ–≤)
        { id: 'hacker', icon: 'üïµÔ∏è‚Äç‚ôÇÔ∏è', name: '–ê–Ω–æ–Ω–∏–º—É—Å', price: 5000 },
        { id: 'elon', icon: 'üöÄ', name: 'SpaceX', price: 10000 }
    ];

    const SHOP_ITEMS = [
        { id: 'shield', name: '–©–∏—Ç –°—Ç—Ä–∏–∫–∞', icon: 'üõ°Ô∏è', price: 300, desc: '–°–ø–∞—Å–µ—Ç —Ç–≤–æ–π –æ–≥–æ–Ω—å –ø—Ä–∏ –ø—Ä–æ–ø—É—Å–∫–µ –¥–Ω—è' },
        { id: 'booster', name: 'XP –ë—É—Å—Ç–µ—Ä', icon: '‚ö°', price: 500, desc: '–î–≤–æ–π–Ω–æ–π –æ–ø—ã—Ç (x2) –Ω–∞ 30 –º–∏–Ω—É—Ç' }
    ];

    const SHOP_TITLES = [
        { id: 'student', name: '–£—á–µ–Ω–∏–∫', price: 50 },
        { id: 'nerd', name: '–ë–æ—Ç–∞–Ω ü§ì', price: 100 },
        { id: 'pro', name: 'PRO –ò–≥—Ä–æ–∫', price: 200 },
        { id: 'brain', name: '–ú–µ–≥–∞–º–æ–∑–≥ üß†', price: 300 },
        { id: 'boss', name: 'Big Boss üòé', price: 500 },
        { id: 'sigma', name: 'SIGMA üóø', price: 1000 },
        { id: 'khan', name: '–•–ê–ù üëë', price: 2000 },
        { id: 'future', name: 'Future Millionaire üíº', price: 5000 },
        
        // –≠–ö–°–ö–õ–Æ–ó–ò–í–ù–´–ô –°–¢–ê–¢–£–°
        { id: 'vip', name: 'VIP', price: -1 }, 
        { id: 'legend', name: 'LEGEND', price: -1 }
    ];

    // üñºÔ∏è –†–ê–ú–ö–ò
    const SHOP_FRAMES = [
        { id: 'gold', name: '–ó–æ–ª–æ—Ç–∞—è —Ü–µ–ø—å', price: 500, css: 'frame-gold' },
        { id: 'glitch', name: '–•–∞–∫–µ—Ä', price: 2000, css: 'frame-glitch' },
        { id: 'neon', name: '–ù–µ–æ–Ω', price: 3000, css: 'frame-neon' },
        { id: 'fire', name: '–û–≥–æ–Ω—å üî•', price: 4000, css: 'frame-fire' },
        { id: 'royal', name: '–ö–æ—Ä–æ–Ω–∞', price: 5000, css: 'frame-royal' }
    ];

    // üîä –ó–í–£–ö–ò (–°–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä)
    const SHOP_SOUNDS = [
        { id: 'standard', name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç', price: 0 },
        { id: 'retro', name: '8-Bit (–î–µ–Ω–¥–∏)', price: 500 },
        { id: 'bubble', name: '–ë—É–ª—å–∫ (Bubble)', price: 500 },
        { id: 'sci-fi', name: '–ö–æ—Å–º–æ—Å', price: 1000 },
        { id: 'mechanical', name: '–ú–µ—Ö–∞–Ω–∏–∫–∞ ‚öôÔ∏è', price: 1200 } 
    ];
    // –õ–ò–ì–ò 
    const LEAGUES = [
        { min: 1,  name: "ü•â –ë—Ä–æ–Ω–∑–æ–≤–∞—è –õ–∏–≥–∞", color: "league-bronze" },
        { min: 5,  name: "ü•à –°–µ—Ä–µ–±—Ä—è–Ω–∞—è –õ–∏–≥–∞", color: "league-silver" },
        { min: 10, name: "ü•á –ó–æ–ª–æ—Ç–∞—è –õ–∏–≥–∞", color: "league-gold" },
        { min: 20, name: "üí† –ü–ª–∞—Ç–∏–Ω–æ–≤–∞—è –õ–∏–≥–∞", color: "league-platinum" },
        { min: 35, name: "üíé –ê–ª–º–∞–∑–Ω–∞—è –õ–∏–≥–∞", color: "league-diamond" },
        { min: 50, name: "üëë –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è –õ–∏–≥–∞", color: "league-legend" }
    ];


    // üá∫üáø –§–£–ù–ö–¶–ò–Ø –í–†–ï–ú–ï–ù–ò
    const getUZDate = (dateObj = new Date()) => {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–¥–≤–∏–≥, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –≤ TimeGuard
        const offset = (window.TimeGuard && TimeGuard.serverOffset) ? TimeGuard.serverOffset : 0;
        const correctedTime = dateObj.getTime() + offset;
        
        // –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ –¥–∞—Ç—É –¢–∞—à–∫–µ–Ω—Ç–∞
        const uzDate = new Date(correctedTime + (3600000 * 5)); 
        return uzDate.toISOString().slice(0, 10);
    };





    const NameGuard = {
        // –°–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö –∫–æ—Ä–Ω–µ–π (RU, UZ, EN)
        // –ú—ã –∏—â–µ–º "–∫–æ—Ä–Ω–∏", —á—Ç–æ–±—ã –ø–æ–π–º–∞—Ç—å —Å–ª–æ–≤–∞ —Ç–∏–ø–∞ "—Å—É–∫@", "—Å—É—É—É–∫–∞" –∏ —Ç.–¥.
        blacklist: [
            // üá∑üá∫ RU
            '—Ö—É–π', '—Ö —É –π', '–ø–∏–∑–¥', '–µ–±–∞–ª', '–µ–±–ª–∞–Ω', '–º—É–¥–∞–∫', '–≥–∞–Ω–¥', '—à–ª—é—Ö', '–±–ª—è', '—Å—É–∫–∞', '—Å —É –∫ –∞', '–∂–æ–ø–∞', '—Ç—Ä–∞—Ö',
            // üá∫üáø UZ
            'qotoq', 'qo\'toq', 'sik', 's i k', 'jalab', 'j a l a b', 'om', 'gandon', 'kotag', 'k o t a g', 'am',
            // üá∫üá∏ EN
            'fuck', 'shit', 'bitch', 'whore', 'dick', 'cock', 'pussy'
        ],

        check(name) {
            // 1. –ü—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
            const lower = name.toLowerCase();
            
            // 2. –°–æ–∑–¥–∞–µ–º "—á–∏—Å—Ç—É—é" –≤–µ—Ä—Å–∏—é –±–µ–∑ —Å–∏–º–≤–æ–ª–æ–≤ –∏ –ø—Ä–æ–±–µ–ª–æ–≤
            // (—á—Ç–æ–±—ã –ø–æ–π–º–∞—Ç—å "—Å.—É.–∫.–∞" –∏–ª–∏ "—Ö-—É-–π")
            const clean = lower.replace(/[^a-z–∞-—è0-9]/g, '');

            // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ø–∏—Å–æ–∫
            for (let badWord of this.blacklist) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –ª–∏ –ø–ª–æ—Ö–æ–µ —Å–ª–æ–≤–æ –≤–Ω—É—Ç—Ä–∏ –∏–º–µ–Ω–∏
                if (lower.includes(badWord) || clean.includes(badWord)) {
                    return false; // –ò–º—è –ü–õ–û–•–û–ï
                }
            }
            return true; // –ò–º—è –•–û–†–û–®–ï–ï
        }
    };
    
    let DB = null; 

    const Data = {
        currentKey: null,
        listener: null,
        isBusy: false,

        initNewData(userId) { 
            const newDB = JSON.parse(JSON.stringify(DefaultDB)); 
            newDB.achievements = GenAch(); 
            newDB.user.trainerRecords = {
                standard: { easy: 0, medium: 0, hard: 0 },
                sign:     { easy: 0, medium: 0, hard: 0 },
                square:   { easy: 0, medium: 0, hard: 0 }
            };
            newDB.user.lastSaveTime = Date.now();
            localStorage.setItem('MathData_' + userId, JSON.stringify(newDB)); 
        },

        load(userId) { 
            this.currentKey = 'MathData_' + userId; 
            const raw = localStorage.getItem(this.currentKey); 
            
            if (raw) {
                try {
                    // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–∞–º—è—Ç–∏
                    DB = JSON.parse(raw);
                    let sum = 0;
                    if (DB.subjects) {
                        Object.values(DB.subjects).forEach(s => { if(s.sec) sum += s.sec; });
                    }
                    if (sum > (DB.user.totalSec || 0)) DB.user.totalSec = sum;
                    // --- üõ°Ô∏è –ü–†–û–í–ï–†–ö–ê –¶–ï–õ–û–°–¢–ù–û–°–¢–ò –ú–û–ù–ï–¢ (–ê–ù–¢–ò-–ß–ò–¢) ---
                    
                    // 2. üõ°Ô∏è –ü–†–û–í–ï–†–ö–ê –ù–ê –ß–ò–¢–ï–†–°–¢–í–û (–ü–µ—Ä–µ–≤–æ–¥ —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥)
                    const now = Date.now();
                    if (DB.user.integrityKey) {
                        const expectedKey = btoa(DB.user.coins + "salt" + DB.user.level);
                        if (DB.user.integrityKey !== expectedKey) {
                            console.error("üö® –í–∑–ª–æ–º –¥–∞–Ω–Ω—ã—Ö –æ–±–Ω–∞—Ä—É–∂–µ–Ω!");
                            this.punish(); // –û–±–Ω—É–ª—è–µ–º –∑–∞ –ø–æ–¥–¥–µ–ª–∫—É –º–æ–Ω–µ—Ç
                            return;
                        }
                    }

                    // 3. –ß–∏—Å—Ç–∏–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø—Ä–µ–¥–º–µ—Ç–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å)
                    this.cleanSubjects();
                    console.log("‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã");

                } catch(e) { 
                    console.error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –±–∞–∑—ã:", e); 
                }
            }

            // 4. –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
            if (!DB || !DB.user) {
                console.log("üÜï –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è...");
                this.initNewData(userId);
                DB = JSON.parse(localStorage.getItem(this.currentKey));
            }

            // 5. üõ†Ô∏è –õ–ï–ß–ï–ù–ò–ï –ü–û–õ–ï–ô (–ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö)
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º, —á—Ç–æ–±—ã —Å—Ç–∞—Ä—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã –Ω–µ –ª–æ–º–∞–ª–∏—Å—å
            if (!DB.user.ownedTitles) DB.user.ownedTitles = [];
            if (!DB.user.ownedFrames) DB.user.ownedFrames = [];
            if (!DB.user.ownedSounds) DB.user.ownedSounds = ['standard'];
            if (!DB.user.activeBattles) DB.user.activeBattles = [];
            if (!DB.achievements || DB.achievements.length < 5) DB.achievements = GenAch();
            if (!DB.user.boosterExpiry) DB.user.boosterExpiry = 0;
            if (!DB.user.lastBoosterPurchase) DB.user.lastBoosterPurchase = "";
            
            // 6. üìä –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ò (–°—É–º–º–∞ –≤—Å–µ—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤)
            let subjectsSum = 0;
            if (DB.subjects) {
                // –°—á–∏—Ç–∞–µ–º —Å—É–º–º—É —Å–µ–∫—É–Ω–¥ –ø–æ –≤—Å–µ–º –ø—Ä–µ–¥–º–µ—Ç–∞–º
                Object.values(DB.subjects).forEach(s => {
                    if (s && typeof s.sec === 'number') subjectsSum += s.sec;
                });
            }

            // –ï—Å–ª–∏ —Å—É–º–º–∞ –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º –±–æ–ª—å—à–µ, —á–µ–º –æ–±—â–µ–µ –≤—Ä–µ–º—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ ‚Äî –∏—Å–ø—Ä–∞–≤–ª—è–µ–º
            if (subjectsSum > (DB.user.totalSec || 0)) {
                console.log("üõ†Ô∏è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞. –ù–æ–≤–æ–µ –æ–±—â–µ–µ –≤—Ä–µ–º—è:", subjectsSum);
                DB.user.totalSec = subjectsSum;
            }

            // 7. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            if (!DB.user.inventory) {
                DB.user.inventory = { shield: 0, booster: 0 };
            } else {
                if (DB.user.inventory.shield === undefined) DB.user.inventory.shield = 0;
                if (DB.user.inventory.booster === undefined) DB.user.inventory.booster = 0;
            }
            
            if (DB.user.isMotivationClaimed === undefined) DB.user.isMotivationClaimed = false;
            if (DB.user.isLogoRewardClaimed === undefined) DB.user.isLogoRewardClaimed = false;
            if (DB.user.isVersionRewardClaimed === undefined) DB.user.isVersionRewardClaimed = false;

            if (!DB.settings) {
                DB.settings = { sfx: true, notifications: false, notifyTime: "19:00" };
            }
            
            if (DB.user.coins === undefined) DB.user.coins = 0;
            if (!DB.user.lastSaveTime) DB.user.lastSaveTime = Date.now();

            // 8. –ö–≤–µ—Å—Ç—ã (–ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ —Ü–µ–ª–µ–π)
            if (!DB.user.dailyQuests || !DB.user.dailyQuests.targets) {
                DB.user.dailyQuests = {
                    date: "", studyMin: 0, mathSolved: 0, pvpDone: 0, claimed: [],
                    targets: { studyMin: 30, mathSolved: 20, pvpDone: 1 }
                };
            }

            // 9. –ü–æ–∂–∏–∑–Ω–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –º–µ–¥–∞–ª–µ–π
            if (DB.user.pvpWins === undefined) DB.user.pvpWins = 0;
            if (DB.user.pvpLosses === undefined) DB.user.pvpLosses = 0;
            if (DB.user.lifetimeMathSolved === undefined) DB.user.lifetimeMathSolved = 0;
            if (DB.user.lifetimeCoinsSpent === undefined) DB.user.lifetimeCoinsSpent = 0;
            if (DB.user.lifetimeStrictSec === undefined) DB.user.lifetimeStrictSec = 0;
            if (DB.user.lifetimeXP === undefined) DB.user.lifetimeXP = DB.user.xp || 0;
            
            if (!DB.user.monthlyGoal) DB.user.monthlyGoal = 40;
            if (!DB.user.lastWeeklyReportDate) DB.user.lastWeeklyReportDate = ""; 
            if (!DB.user.lastSpinDate) DB.user.lastSpinDate = ""; 
            if (!DB.user.lastNotifyDate) DB.user.lastNotifyDate = "";

            // 10. –ó–∞–ø—É—Å–∫–∞–µ–º –æ–Ω–ª–∞–π–Ω-—Å–ª—É—à–∞—Ç–µ–ª—å
            if(window.DB_Online) this.startListening(userId);
        },
            punish() {
                console.log("–ù–∞–∫–∞–∑–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ");
            },

            // üì° –£–ú–ù–´–ô –°–õ–£–®–ê–¢–ï–õ–¨ (–° –ó–ê–©–ò–¢–û–ô –î–ê–ù–ù–´–•)
            startListening(userId) {
            if (this.listener) this.listener(); 

            const docRef = window.DB_Online.doc(window.DB_Online.db, "users", userId);

            this.listener = window.DB_Online.onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const cloud = docSnap.data();
                        
                        // üõ°Ô∏è –ó–ê–©–ò–¢–ê –û–¢ "–ü–†–´–ñ–ö–û–í" –ü–†–ï–î–ú–ï–¢–û–í
                        // –ï—Å–ª–∏ –º—ã —Å–µ–π—á–∞—Å –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (—Ç–∞–π–º–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω –∏–ª–∏ —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏),
                        // –º—ã –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –º–æ–Ω–µ—Ç—ã –∏ –ø–æ–∫—É–ø–∫–∏, –Ω–æ –ù–ï —Ç—Ä–æ–≥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–µ–¥–º–µ—Ç–æ–≤.
                        if (Timer.active || (Date.now() - DB.user.lastSaveTime < 5000)) {
                            DB.user.coins = cloud.user.coins;
                            DB.user.inventory = cloud.user.inventory;
                            DB.user.ownedAvatars = cloud.user.ownedAvatars;
                            // –ü—Ä–µ–¥–º–µ—Ç—ã –ù–ï –¢–†–û–ì–ê–ï–ú, —á—Ç–æ–±—ã –æ–Ω–∏ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–ª–∏—Å—å
                            App.updateUI(); 
                            return; 
                        }

                        if (JSON.stringify(cloud) !== JSON.stringify(DB)) {
                            DB = cloud;
                            localStorage.setItem(this.currentKey, JSON.stringify(DB));
                            App.updateUI();
                        }
                    }
                });
        },

        stopListening() {
            if (this.listener) {
                this.listener();
                this.listener = null;
            }
        },
        cleanSubjects() {
            if (!DB || !DB.subjects) return;
            // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –ø—Ä–µ–¥–º–µ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ ALL_SUBJECTS (—É–±–∏—Ä–∞–µ–º –º—É—Å–æ—Ä)
            const validIds = ALL_SUBJECTS.map(s => s.id);
            const cleaned = {};
            
            Object.keys(DB.subjects).forEach(key => {
                if (validIds.includes(key)) {
                    cleaned[key] = DB.subjects[key];
                }
            });
            
            DB.subjects = cleaned;
            if (Object.keys(DB.subjects).length === 0) {
                DB.subjects['algebra'] = { name: '–ê–ª–≥–µ–±—Ä–∞', icon: '‚úñÔ∏è', sec: 0 };
            }
        },


        async save() {
            // –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è–º–∏ (—Ä–∞–∑ –≤ 2 —Å–µ–∫—É–Ω–¥—ã)
            const now = Date.now();
            if (this.lastSaveCall && now - this.lastSaveCall < 2000) return;
            this.lastSaveCall = now;

            if (!DB || !Auth.currentUser) return;

            // –ü–µ—Ä–µ—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏
            let totalFromSubjects = 0;
            if (DB.subjects) {
                Object.values(DB.subjects).forEach(s => {
                    if (s && s.sec) totalFromSubjects += s.sec;
                });
            }
            DB.user.totalSec = totalFromSubjects;

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞ –∑–∞—â–∏—Ç—ã
            DB.user.integrityKey = btoa(DB.user.coins + "salt" + DB.user.level);
            
            // ... –¥–∞–ª–µ–µ –∫–æ–¥ –∑–∞–ø–∏—Å–∏ –≤ LocalStorage –∏ Firebase

            localStorage.setItem(this.currentKey, JSON.stringify(DB));

            if (window.DB_Online) {
                const dbRef = window.DB_Online;
                const docRef = dbRef.doc(dbRef.db, "users", Auth.currentUser.id);
                try {
                    await dbRef.setDoc(docRef, DB, { merge: true });
                } catch (e) { console.error("Cloud Save Error", e); }
            }
        },

        
        export() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(DB)); const node = document.createElement('a'); node.setAttribute("href", dataStr); node.setAttribute("download", `${Auth.currentUser.name}_MathData.json`); document.body.appendChild(node); node.click(); node.remove(); },
        import(el) { const fr = new FileReader(); fr.onload = (e) => { try { DB = JSON.parse(e.target.result); this.save(); location.reload(); } catch(x) { alert("–û—à–∏–±–∫–∞ —Ñ–∞–π–ª–∞"); } }; fr.readAsText(el.files[0]); }
    };

    const Sync = {
        autoSync: false,

        init() {
            const saved = localStorage.getItem('autoSync');
            if (saved === 'true') {
                this.autoSync = true;
                document.getElementById('sync-status').innerText = '–í–∫–ª';
            }
        },

        toggleAuto() {
            this.autoSync = !this.autoSync;
            localStorage.setItem('autoSync', this.autoSync);
            document.getElementById('sync-status').innerText = this.autoSync ? '–í–∫–ª' : '–í—ã–∫–ª';
            App.toast(this.autoSync ? "‚òÅÔ∏è –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞" : "‚òÅÔ∏è –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞");
            
            if (this.autoSync && window.DB_Online && Auth.currentUser) {
                Data.save(); // —Å—Ä–∞–∑—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º
            }
        }
    };

    // --- WHITEBOARD & CALC ---
    const Whiteboard = {
        canvas: null, ctx: null, isDrawing: false,
        init() {
            this.canvas = document.getElementById('wb-canvas'); this.ctx = this.canvas.getContext('2d'); this.resize();
            const h = (e) => { e.preventDefault(); this.start(e.touches?e.touches[0]:e); };
            const m = (e) => { e.preventDefault(); this.draw(e.touches?e.touches[0]:e); };
            const e = () => this.stop();
            this.canvas.onmousedown = h; this.canvas.onmousemove = m; this.canvas.onmouseup = e; this.canvas.onmouseout = e;
            this.canvas.ontouchstart = h; this.canvas.ontouchmove = m; this.canvas.ontouchend = e;
        },
        open() { document.getElementById('wb-modal').classList.add('show'); this.resize(); },
        close() { document.getElementById('wb-modal').classList.remove('show'); },
        resize() { const p = this.canvas.parentElement; this.canvas.width = p.clientWidth; this.canvas.height = 350; this.ctx.lineCap = 'round'; this.ctx.lineWidth = 3; this.ctx.strokeStyle = '#2B3674'; },
        start(e) { this.isDrawing = true; this.ctx.beginPath(); const r = this.canvas.getBoundingClientRect(); this.ctx.moveTo(e.clientX - r.left, e.clientY - r.top); },
        draw(e) { if(!this.isDrawing) return; const r = this.canvas.getBoundingClientRect(); this.ctx.lineTo(e.clientX - r.left, e.clientY - r.top); this.ctx.stroke(); },
        stop() { this.isDrawing = false; },
        clear() { this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height); },
        toggle() { this.open(); SoundSys.play('click'); }
    };

    const Calc = { 
        current: '', 
        toggle() { document.getElementById('calc-modal').classList.toggle('show'); this.clear(); SoundSys.play('click'); }, 
        append(val) { if(this.current.length>15)return; this.current+=val; this.update(); SoundSys.play('click'); }, 
        clear() { this.current=''; this.update(); }, 
        solve() { 
            try { 
                // Simple security check (SAFE EVAL)
                if(/^[0-9+\-*/.() ]*$/.test(this.current)) {
                    this.current=new Function('return ' + this.current)().toString();
                } else {
                    this.current='Error';
                }
            } catch { this.current='Error'; } 
            this.update(); SoundSys.play('success'); 
        }, 
        update() { document.getElementById('calc-display').innerText=this.current||'0'; } 
    };

    // --- SUBJECT SYSTEM ---
    const SubjectSys = {
        render() {
            const list = document.getElementById('settings-subject-list'); if(!list) return;
            list.innerHTML = Object.keys(DB.subjects).map(key => { const s = DB.subjects[key]; return `<div class="subject-manage-row"><div class="subject-manage-info"><span style="font-size:20px;">${s.icon}</span> ${s.name}</div><button class="btn-delete" onclick="SubjectSys.delete('${key}')">‚úï</button></div>`; }).join('');
        },
        addPreset(icon, name) {
            const id = 'subj_' + Date.now(); 
            DB.subjects[id] = { name: name, icon: icon, sec: 0 };
            Data.save(); this.render(); App.renderSubjects(); App.toast(name + " –¥–æ–±–∞–≤–ª–µ–Ω!");
        },
        delete(key) {
            if(Object.keys(DB.subjects).length <= 1) return App.toast("–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–µ–¥–º–µ—Ç!");
            if(!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–µ–¥–º–µ—Ç?")) return;
            delete DB.subjects[key]; if(DB.user.subject === key) { DB.user.subject = Object.keys(DB.subjects)[0]; }
            Data.save(); this.render(); App.renderSubjects(); App.updateUI(); App.toast("–ü—Ä–µ–¥–º–µ—Ç —É–¥–∞–ª–µ–Ω");
        }
    };

    // --- DAILY REWARD SYSTEM ---
    const DailySys = {
        rewards: [10, 20, 30, 40, 50, 75, 100],

        // –ü–†–û–í–ï–†–ö–ê –ü–†–ò –í–•–û–î–ï
        async check() {
            const today = getUZDate(); // –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –ø–æ –¢–∞—à–∫–µ–Ω—Ç—É
            const last = DB.user.lastDailyClaim; // –ö–æ–≥–¥–∞ –∑–∞–±–∏—Ä–∞–ª –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑

            // –ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è —É–∂–µ –∑–∞–±–∏—Ä–∞–ª - –≤—ã—Ö–æ–¥–∏–º
            if (last === today) return;

            // –ü–†–û–í–ï–†–ö–ê –ù–ê –°–†–´–í –°–¢–†–ò–ö–ê
            if (last) {
                const d = new Date(); d.setDate(d.getDate() - 1);
                const yesterdayStr = getUZDate(d);

                if (last !== yesterdayStr && last !== today) {
                    // –ï—Å–ª–∏ –µ—Å—Ç—å —â–∏—Ç ‚Äî —Ç—Ä–∞—Ç–∏–º –µ–≥–æ
                    if (DB.user.inventory && DB.user.inventory.shield > 0) {
                        DB.user.inventory.shield--;
                        App.toast("üõ°Ô∏è –©–∏—Ç —Å–ø–∞—Å —Ç–≤–æ–π —Å—Ç—Ä–∏–∫!");
                    } else {
                        DB.user.dailyStreak = 0; 
                        App.toast("üî• –°—Ç—Ä–∏–∫ —Å–≥–æ—Ä–µ–ª!");
                    }
                }
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ –Ω–∞–≥—Ä–∞–¥—ã
            this.showModal();
        },

        showModal() {
            const modal = document.getElementById('daily-modal'); 
            const grid = document.getElementById('daily-grid'); 
            // –ò–Ω–¥–µ–∫—Å –Ω–∞–≥—Ä–∞–¥—ã (0..6)
            const currentDayIndex = DB.user.dailyStreak % 7;
            
            grid.innerHTML = this.rewards.map((r, i) => { 
                let cls = 'daily-day'; 
                if (i < currentDayIndex) cls += ' claimed'; // –ü—Ä–æ—à–ª—ã–µ –¥–Ω–∏
                if (i === currentDayIndex) cls += ' active'; // –¢–µ–∫—É—â–∏–π –¥–µ–Ω—å
                return `<div class="${cls}"><div class="daily-coin">üí∞</div><div>${r}</div></div>`; 
            }).join('');
            
            document.getElementById('daily-reward-amount').innerText = this.rewards[currentDayIndex]; 
            modal.classList.add('show'); 
            FX.confetti(); 
            SoundSys.play('win');
        },

    async claim() {
            App.toast("üì° –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Å—Ç–Ω–æ—Å—Ç–∏...");
            
            // 1. –ñ–¥–µ–º –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏
            await TimeGuard.verify();

            // 2. –ï—Å–ª–∏ TimeGuard —Å–∫–∞–∑–∞–ª, —á—Ç–æ –≤—Ä–µ–º—è –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –≤—Ä–µ—Ç
            if (!TimeGuard.isTimeValid) {
                // –í–ú–ï–°–¢–û –ü–†–û–°–¢–û–ô –û–®–ò–ë–ö–ò ‚Äî –°–†–ê–ó–£ –ù–ê–ö–ê–ó–´–í–ê–ï–ú
                Data.punish(); 
                return;
            }

            // –ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞, –≤—ã–ø–æ–ª–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥
            const currentDayIndex = DB.user.dailyStreak % 7;
            const reward = this.rewards[currentDayIndex];
            
            DB.user.coins += reward;
            DB.user.dailyStreak++;
            DB.user.lastDailyClaim = getUZDate(); // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —Å–¥–≤–∏–≥

            Data.save();
            App.updateUI();
            document.getElementById('daily-modal').classList.remove('show');
            SoundSys.play('coin');
            App.toast(`–ü–æ–ª—É—á–µ–Ω–æ: ${reward} –º–æ–Ω–µ—Ç!`);
        }
    };

    // --- DONATION & ONLINE ---
    const Donation = {
        // –í–°–¢–ê–í–¨ –°–Æ–î–ê –ù–û–ú–ï–†–ê –ö–ê–†–¢
        uzCard: "9860 1901 0789 6911 (Rustam M.)", 
        worldCard: "4916 9903 0189 0056 (Rustam M.)",
        
        payUz() { 
            // –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –ø–æ–∫–∞–∂–µ—Ç –æ–∫–Ω–æ —Å –Ω–æ–º–µ—Ä–æ–º –∫–∞—Ä—Ç—ã, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
            prompt("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ (Payme/Click):", this.uzCard);
            alert("–ü–æ—Å–ª–µ –ø–µ—Ä–µ–≤–æ–¥–∞ —Å–∫–∏–Ω—å —Å–∫—Ä–∏–Ω—à–æ—Ç –º–Ω–µ –≤ —Ç–≥ @rustambey708, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥!");
        },
        payWorld() { 
            prompt("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ (Visa):", this.worldCard);
            alert("–ü–æ—Å–ª–µ –ø–µ—Ä–µ–≤–æ–¥–∞ —Å–∫–∏–Ω—å —Å–∫—Ä–∏–Ω—à–æ—Ç –º–Ω–µ –≤ —Ç–≥ @rustambey708, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥!");
        },
        async enterCode() {
            const c = prompt("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥:"); 
            if(!c) return;
            const code = c.trim().toUpperCase();
            
            // 1. –ü–†–û–í–ï–†–ö–ê –õ–û–ö–ê–õ–¨–ù–û: –ë—Ä–∞–ª –ª–∏ —è –µ–≥–æ —É–∂–µ?
            if(DB.user.usedCodes && DB.user.usedCodes.includes(code)) {
                return App.toast("–í—ã —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –∫–æ–¥!");
            }

            // 2. –°–¢–ê–¢–ò–ß–ù–´–ï –ö–û–î–´
            const staticRewards = { 
                "START31":    { c: 30000, msg: "–ë–æ–Ω—É—Å –Ω–æ–≤–∏—á–∫–∞!" },
                "WELCOME271":  { c: 100, msg: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!" }
            };
            if (staticRewards[code]) {
                this.applyReward(code, staticRewards[code]);
                return;
            }

            // 3. –ü–†–û–í–ï–†–ö–ê –í –û–ë–õ–ê–ö–ï
            if (!window.DB_Online) return App.toast("–ù—É–∂–µ–Ω –∏–Ω—Ç–µ—Ä–Ω–µ—Ç!");
            App.toast("‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞...");

            try {
                const docRef = window.DB_Online.doc(window.DB_Online.db, "promo_codes", code);
                
                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Å—Ç–æ —á–∏—Ç–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å —Ç–∏–ø –∫–æ–¥–∞
                const snap = await window.DB_Online.getDoc(docRef);

                if (!snap.exists()) throw "–ö–æ–¥ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç";
                const data = snap.data();

                // --- –í–ê–†–ò–ê–ù–¢ –ê: –í–†–ï–ú–ï–ù–ù–´–ô –ö–û–î (–î–õ–Ø –í–°–ï–•) ---
                if (data.isTimeLimited) {
                    const now = new Date();
                    const expireDate = new Date(data.expiresAt);

                    if (now > expireDate) {
                        throw "‚è∞ –í—Ä–µ–º—è –¥–µ–π—Å—Ç–≤–∏—è –∫–æ–¥–∞ –∏—Å—Ç–µ–∫–ª–æ!";
                    }

                    // –ï—Å–ª–∏ –≤—Ä–µ–º—è –µ—Å—Ç—å - –≤—ã–¥–∞–µ–º –Ω–∞–≥—Ä–∞–¥—É –ë–ï–ó –∑–∞–ø–∏—Å–∏ –≤ –±–∞–∑—É (–Ω–µ —Å–∂–∏–≥–∞–µ–º –∫–æ–¥)
                    // –ó–∞–ø–∏—Å—å –≤ usedCodes –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –≤ applyReward
                    this.applyReward(code, {
                        c: data.coins,
                        vip: data.vip,
                        isKing: data.isKing,
                        msg: data.msg || "–í—Ä–µ–º–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å –ø–æ–ª—É—á–µ–Ω!"
                    });
                } 
                
                // --- –í–ê–†–ò–ê–ù–¢ –ë: –û–ë–´–ß–ù–´–ô –û–î–ù–û–†–ê–ó–û–í–´–ô –ö–û–î (–¢–†–ê–ù–ó–ê–ö–¶–ò–Ø) ---
                else {
                    if (data.isUsed) throw "–ö–æ–¥ —É–∂–µ –∫–µ–º-—Ç–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!";

                    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è "—Å–∂–∏–≥–∞–Ω–∏—è" –±–∏–ª–µ—Ç–∞
                    await window.DB_Online.runTransaction(window.DB_Online.db, async (transaction) => {
                        const sfDoc = await transaction.get(docRef);
                        if (!sfDoc.exists()) throw "–ö–æ–¥ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç";
                        if (sfDoc.data().isUsed) throw "–ö–æ–¥ —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!";

                        transaction.update(docRef, { 
                            isUsed: true,
                            usedBy: DB.user.name + ` (${Auth.currentUser.id})`,
                            usedAt: new Date().toISOString()
                        });
                    });

                    // –ï—Å–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ
                    this.applyReward(code, {
                        c: data.coins,
                        vip: data.vip,
                        isKing: data.isKing,
                        msg: data.msg
                    });
                }

            } catch (e) {
                console.error(e);
                alert("‚ùå " + (typeof e === 'string' ? e : "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"));
            }
        },

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è (—á—Ç–æ–±—ã –Ω–µ –ø–∏—Å–∞—Ç—å –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ 2 —Ä–∞–∑–∞)
        applyReward(code, reward) {
            DB.user.coins += reward.c;
            
            // –ï—Å–ª–∏ —ç—Ç–æ VIP –∫–æ–¥
            if (reward.vip) {
                if (!DB.user.ownedTitles) DB.user.ownedTitles = [];
                if (!DB.user.ownedTitles.includes('vip')) DB.user.ownedTitles.push('vip');
                DB.user.currentTitle = "VIP";
                App.toast("üíé –°—Ç–∞—Ç—É—Å VIP –ø–æ–ª—É—á–µ–Ω!");
            }
    // üëá –í–´–î–ê–ß–ê KING (–ö–æ—Ä–æ–Ω–∞ + –°—Ç–∞—Ç—É—Å LEGEND)
            if (reward.isKing) {
                DB.user.isKing = true;
                DB.user.isVip = true; 
                
                // –ï—Å–ª–∏ —Å–ø–∏—Å–∫–∞ –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ–º
                if (!DB.user.ownedTitles) DB.user.ownedTitles = [];
                
                // –î–∞—Ä–∏–º —Å—Ç–∞—Ç—É—Å LEGEND (—á—Ç–æ–±—ã –æ–Ω –±—ã–ª –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ)
                if (!DB.user.ownedTitles.includes('legend')) {
                    DB.user.ownedTitles.push('legend');
                }
                
                // –ò —Å—Ä–∞–∑—É –Ω–∞–¥–µ–≤–∞–µ–º
                DB.user.currentTitle = "LEGEND";
                
                App.toast("üëë –ö–û–†–û–õ–ï–í–°–ö–ò–ô –°–¢–ê–¢–£–° –ü–û–õ–£–ß–ï–ù!");
            }

            if(!DB.user.usedCodes) DB.user.usedCodes = [];
            DB.user.usedCodes.push(code);
            
            Data.save(); 
            App.updateUI(); 
            App.renderShop(); 
            
            FX.confetti(); 
            SoundSys.play('win'); 
            alert(`‚úÖ –£–°–ü–ï–®–ù–û!\n\n${reward.msg}\n–ù–∞—á–∏—Å–ª–µ–Ω–æ: +${reward.c} üí∞`);
        }
    };

    const Online = {
        async loadLeaderboard() {
        if (!window.DB_Online) {
            App.toast("‚ö†Ô∏è –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –æ–Ω–ª–∞–π–Ω-–±–∞–∑–µ");
            return;
        }

        const list = document.getElementById('leaderboard-list');
        const countEl = document.getElementById('total-players-count');
        list.innerHTML = '<div style="text-align:center; color:var(--text-light);">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

        try {
            const q = window.DB_Online.query(
                window.DB_Online.collection(window.DB_Online.db, "users"),
                window.DB_Online.orderBy("user.totalSec", "desc"),  // ‚Üê –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (—Å–µ–∫—É–Ω–¥–∞–º)
                window.DB_Online.limit(100)
            );

            const snap = await window.DB_Online.getDocs(q);
            countEl.innerText = `–í—Å–µ–≥–æ –∏–≥—Ä–æ–∫–æ–≤ –≤ –±–∞–∑–µ: ${snap.size}`;

            if (snap.empty) {
                list.innerHTML = '<div style="text-align:center; color:var(--text-light);">–¢–æ–ø –ø—É—Å—Ç üòî</div>';
                return;
            }
                list.innerHTML = '';
                let rank = 1;
                
                snap.forEach(doc => {
                    const data = doc.data();
                    const u = data.user || {};
                    if (!u.totalSec && u.totalSec !== 0) return;

                    const name = u.name || "–ò–≥—Ä–æ–∫";
                    const avatar = u.avatar || "üòé";
                    const frameClass = u.currentFrame ? `profile-img framed ${u.currentFrame}` : 'profile-img';
                    
                    // üëá –õ–û–ì–ò–ö–ê –û–ù–õ–ê–ô–ù–ê üëá
                    const now = Date.now();
                    const lastActive = u.lastActive || 0;
                    // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±—ã–ª–∞ –º–µ–Ω–µ–µ 5 –º–∏–Ω—É—Ç (300 000 –º—Å) –Ω–∞–∑–∞–¥
                    const isOnline = (now - lastActive) < 300000; 
                    
                    const onlineBadge = isOnline ? `
                        <div style="position:absolute; bottom:2px; right:2px; width:12px; height:12px; background:#00d26a; border:2px solid var(--surface); border-radius:50%; z-index:10; box-shadow:0 0 5px rgba(0,210,106,0.5);"></div>
                    ` : '';
                    // üëÜ üëÜ üëÜ üëÜ üëÜ üëÜ üëÜ

                    const hours = Math.floor(u.totalSec / 3600);
                    const minutes = Math.floor((u.totalSec % 3600) / 60);
                    const isMe = (Auth.currentUser && Auth.currentUser.id === doc.id);
                    const bgStyle = isMe ? "border: 2px solid var(--primary); background: rgba(108, 99, 255, 0.05);" : "";

                    const item = document.createElement('div');
                    item.className = 'user-list-item';
                    item.style.cssText = `justify-content: space-between; align-items: center; ${bgStyle}`;

                    item.innerHTML = `
                        <div style="display:flex; align-items:center; gap:12px;">
                            <div style="font-weight:bold; width:25px; text-align:center; color:var(--text-light);">#${rank}</div>
                            
                            <!-- –û–ë–ï–†–¢–ö–ê –ê–í–ê–¢–ê–†–ê –î–õ–Ø –û–ù–õ–ê–ô–ù –¢–û–ß–ö–ò -->
                            <div style="position:relative; width:45px; height:45px;">
                                <div class="${frameClass}" style="width:45px; height:45px; min-width:45px; font-size:24px; margin:0;">
                                    <div>${avatar}</div>
                                </div>
                                ${onlineBadge} <!-- –°—é–¥–∞ –≤—Å—Ç–∞–≤–∏—Ç—Å—è —Ç–æ—á–∫–∞, –µ—Å–ª–∏ —é–∑–µ—Ä –æ–Ω–ª–∞–π–Ω -->
                            </div>

                            <div>
                                <b style="display:block; max-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:14px;">
                                    ${u.isKing ? 'üëë ' : (u.isVip ? 'üíé ' : '')}${name}
                                </b>
                                <small style="font-size:10px; opacity:0.7;">Lvl ${u.level || 1} ‚Ä¢ ${u.currentTitle || '–£—á–∞—Å—Ç–Ω–∏–∫'}</small>
                            </div>
                        </div>
                        <b style="color:var(--primary); font-size:13px;">${hours}—á ${minutes}–º</b>
                    `;
                    list.appendChild(item);
                    rank++;
                });

            App.toast("üèÜ –¢–æ–ø –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —É—á—ë–±—ã –æ–±–Ω–æ–≤–ª—ë–Ω!");
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞:", e);
            list.innerHTML = '<div style="text-align:center; color:red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ üòî</div>';
            App.toast("‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º");
        }
    }
    };

    /* ==========================================
    APP CORE
    ========================================== */
    const Auth = {
        users: [], currentUser: null,
        avatars: ['üòé', 'üë©‚Äçüéì', 'üë®‚Äçüéì', 'üë±‚Äç‚ôÄÔ∏è', 'üë®', 'üßï', 'üßî', 'üê±', 'ü¶ä', '‚öΩ'],
        init() {
            let stored = localStorage.getItem('MathUsers');
            if (stored) {
                try {
                    const raw = JSON.parse(stored);
                    this.users = Array.isArray(raw) 
                        ? raw.filter(u => u && typeof u === 'object' && u.id && typeof u.id === 'string' && u.name)
                        : [];
                    if (this.users.length === 0 && raw.length > 0) {
                        localStorage.removeItem('MathUsers');
                    }
                } catch (e) {
                    localStorage.removeItem('MathUsers');
                }
            }

            this.renderUserList();
            this.renderAvatars();
            SoundSys.init();
            Whiteboard.init();
            PWA.init();
            MusicPlayer.init();

            // üëá –í–û–¢ –≠–¢–û–¢ –ë–õ–û–ö –í–°–¢–ê–í–õ–Ø–ï–ú –°–Æ–î–ê üëá
            window.addEventListener('click', () => {
                if (SoundSys.ctx && SoundSys.ctx.state === 'suspended') {
                    SoundSys.ctx.resume();
                }
            }, { once: true });
        },

        renderUserList() {
        const list = document.getElementById('user-list');
        if (!list) return;

        list.innerHTML = '';

        if (this.users.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:var(--text-light); padding:20px;">–ù–µ—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π!</div>';
            return;
        }

        // üî• –§–∏–ª—å—Ç—Ä—É–µ–º –∏ —á–∏—Å—Ç–∏–º –±–∏—Ç—ã–µ –∑–∞–ø–∏—Å–∏ –ø—Ä—è–º–æ –∑–¥–µ—Å—å
        this.users = this.users.filter(u => u && u.id && u.name && typeof u.id === 'string');

        this.users.forEach(u => {
            // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π ID
            const safeID = u.id ? u.id.toString().slice(0,8) + '...' : '–Ω–µ—Ç ID';

            const div = document.createElement('div');
            div.className = 'user-list-item';

            const infoDiv = document.createElement('div');
            infoDiv.style.cssText = "display:flex; align-items:center; gap:15px; flex-grow:1;";
            infoDiv.innerHTML = `
                <div class="user-avatar">${u.avatar || 'üòé'}</div>
                <div>
                    <div style="font-weight:bold">${u.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
                    <div style="font-size:12px; color:var(--text-light)">ID: ${safeID}</div>
                </div>`;

            infoDiv.onclick = () => this.login(u.id);

            const delBtn = document.createElement('button');
            delBtn.className = 'delete-user-btn';
            delBtn.innerHTML = '‚úï';
            delBtn.onclick = (e) => {
                e.stopPropagation();
                this.deleteUser(u.id, e);
            };

            div.appendChild(infoDiv);
            div.appendChild(delBtn);
            list.appendChild(div);
        });

        // –ï—Å–ª–∏ –ø–æ—Å–ª–µ —á–∏—Å—Ç–∫–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç ‚Äî –ø–æ–∫–∞–∂–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        if (this.users.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:var(--text-light); padding:20px;">–í—Å–µ –ø—Ä–æ—Ñ–∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π!</div>';
        }
    },
        deleteUser(id, event) {
            event.stopPropagation();
            if(!confirm("–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ—Ñ–∏–ª—å? –û–Ω –ø—Ä–æ–ø–∞–¥–µ—Ç —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –∏–∑ –¢–æ–ø–∞!")) return;
            
            this.users = this.users.filter(u => u.id !== id);
            localStorage.setItem('MathUsers', JSON.stringify(this.users));
            localStorage.removeItem('MathData_' + id);
            
            if (window.DB_Online) {
                const docRef = window.DB_Online.doc(window.DB_Online.db, "users", id);
                window.DB_Online.deleteDoc(docRef).catch(err => console.error(err));
            }
            
            this.renderUserList();
            App.toast("üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ");
        },

        renderAvatars() { 
            const el = document.getElementById('avatar-selector');
            if(el) el.innerHTML = this.avatars.map(a => 
                `<div class="avatar-option ${a===this.selectedAvatar?'selected':''}" onclick="Auth.selectAvatar('${a}')">${a}</div>`
            ).join(''); 
        },

        selectAvatar(a) { 
            this.selectedAvatar = a; 
            this.renderAvatars(); 
            SoundSys.play('click'); 
        },

        setGender(g) {
            this.selectedGender = g;
            document.querySelectorAll('.gender-btn').forEach(b => b.classList.remove('active'));
            const btns = document.querySelectorAll('.gender-btn');
            if(btns.length > 1) btns[g==='male'?0:1].classList.add('active');
        },

        showRegister() { 
            document.getElementById('login-view').style.display = 'none'; 
            document.getElementById('register-view').style.display = 'block'; 
            SoundSys.play('click'); 
        },

        showLogin() { 
            document.getElementById('login-view').style.display = 'block'; 
            document.getElementById('register-view').style.display = 'none'; 
            SoundSys.play('click'); 
        },

        createAccount() {
            // 1. –ü–†–û–í–ï–†–ö–ê –õ–ò–ú–ò–¢–ê (–ú–∞–∫—Å–∏–º—É–º 3 –∞–∫–∫–∞—É–Ω—Ç–∞)
            const MAX_ACCOUNTS = 2;
            
            if (this.users.length >= MAX_ACCOUNTS) {
                App.toast(`‚õî –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç: ${MAX_ACCOUNTS} –ø—Ä–æ—Ñ–∏–ª—è!`);
                alert(`–ù–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ —É–∂–µ —Å–æ–∑–¥–∞–Ω–æ ${MAX_ACCOUNTS} –ø—Ä–æ—Ñ–∏–ª—è.\n\n–ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π, —É–¥–∞–ª–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ —Å—Ç–∞—Ä—ã—Ö (–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫—Ä–µ—Å—Ç–∏–∫ ‚úï –≤ —Å–ø–∏—Å–∫–µ).`);
                return; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ
            }

            const inputField = document.getElementById('reg-name');
            const name = inputField.value.trim();
            
            // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–µ –∏–º—è
            if (!name) return App.toast('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –∏–º—è!');
            // üëá 3. –ó–ê–ü–†–ï–¢ –≠–ú–û–î–ó–ò –ò –°–ò–ú–í–û–õ–û–í üëá
            // –†–∞–∑—Ä–µ—à–∞–µ–º: a-z, –ê-–Ø, 0-9, –ø—Ä–æ–±–µ–ª, —Ç–æ—á–∫–∞, —Ç–∏—Ä–µ, –Ω–∏–∂–Ω–µ–µ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ
            const validChars = /^[a-zA-Z0-9–∞-—è–ê-–Ø—ë–Å\s._-]+$/;
            
            if (!validChars.test(name)) {
                return alert("‚õîÔ∏è –≠–º–æ–¥–∑–∏ –∏ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã –∑–∞–ø—Ä–µ—â–µ–Ω—ã!\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã.");
            }
            // 4. --- üõ°Ô∏è –ó–ê–©–ò–¢–ê –û–¢ –ú–ê–¢–ê ---
            if (!NameGuard.check(name)) {
                alert("‚õîÔ∏è –≠—Ç–æ –∏–º—è –∑–∞–ø—Ä–µ—â–µ–Ω–æ –ø–æ–ª–∏—Ç–∏–∫–æ–π —Å–æ–æ–±—â–µ—Å—Ç–≤–∞.\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–µ–∂–ª–∏–≤—ã–π –Ω–∏–∫–Ω–µ–π–º.");
                return;
            }
            // -------------------------
            // 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã –∏–º–µ–Ω–∏ 
            if (name.length < 2) return App.toast('‚ö†Ô∏è –ò–º—è —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ');
            // –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ
            const finalName = name.trim();
            // 6. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const user = {
                id: 'u' + Date.now(),
                name: name,
                avatar: this.selectedAvatar,
                gender: this.selectedGender
            };

            this.users.push(user);
            localStorage.setItem('MathUsers', JSON.stringify(this.users));

            // –°—Ä–∞–∑—É —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –≤ –æ–±–ª–∞—á–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
            Data.load(user.id);
            
            if(DB && DB.user) {
                DB.user.name = name;
                DB.user.avatar = this.selectedAvatar;
                Data.save();
            }
    this.login(user.id);
            
            // üî• –ó–ê–ü–£–°–ö–ê–ï–ú –¶–ï–ü–û–ß–ö–£: –°–û–ì–õ–ê–®–ï–ù–ò–ï -> –û–ë–£–ß–ï–ù–ò–ï
            setTimeout(() => {
                Tutorial.startFlow(); 
            }, 800);
        },
        async login(id) { 
            const user = this.users.find(u => u.id === id); 
            if (!user) return; 

            const loginCard = document.getElementById('login-view');
            const originalHTML = loginCard ? loginCard.innerHTML : "";
            
            if(loginCard) loginCard.innerHTML = `
                <div style="padding:40px; text-align:center;">
                    <div class="loader" style="margin:0 auto 20px auto; border-top-color:var(--primary);"></div>
                    <p style="font-weight:bold; color:var(--primary);">–û–±–ª–∞—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</p>
                    <p style="font-size:12px; opacity:0.6;">–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å</p>
                </div>`;

            try {
                // üëá –¶–ò–ö–õ –û–ñ–ò–î–ê–ù–ò–Ø –ë–ê–ó–´ (–¥–æ 5 —Å–µ–∫—É–Ω–¥) üëá
                let attempts = 0;
                while (!window.DB_Online && attempts < 10) {
                    console.log("‚è≥ –ë–∞–∑–∞ –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–∞, –∂–¥–µ–º 500–º—Å...");
                    await new Promise(res => setTimeout(res, 500)); // –ñ–¥–µ–º –ø–æ–ª—Å–µ–∫—É–Ω–¥—ã
                    attempts++;
                }

                const dbRef = window.DB_Online; 
                if (!dbRef) {
                    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.");
                }
                
                const docRef = dbRef.doc(dbRef.db, "users", id);
                const docSnap = await dbRef.getDoc(docRef);

                if (docSnap.exists()) {
                    DB = docSnap.data();
                    console.log("‚òÅÔ∏è –ü—Ä–æ—Ñ–∏–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –æ–±–ª–∞–∫–∞");
                } else {
                    console.log("üÜï –û–±–ª–∞—á–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π");
                    Data.load(id); 
                }

                // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤—Ö–æ–¥
                this.currentUser = user; 
                localStorage.setItem('LastUserId', id); 
                document.getElementById('auth-screen').classList.add('hidden'); 
                document.getElementById('app-container').style.display = 'block'; 
                
                App.initAfterLogin();
                Data.startListening(id);
                
            } catch (e) {
                console.error("Login Error:", e);
                if(loginCard) loginCard.innerHTML = originalHTML;
                this.renderUserList(); 
                alert("‚ùå –û—à–∏–±–∫–∞: " + e.message);
            }
        },

        logout() { 
            if(confirm("–í—ã–π—Ç–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è?")) { 
                if(window.Timer) Timer.stop(false);
                if (window.Data) Data.stopListening();            
                localStorage.removeItem('LastUserId'); 
                location.reload(); 
            } 
        },

        resetData() {
            if(confirm("–í–´ –£–í–ï–†–ï–ù–´? –í—Å—ë –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ –Ω–∞–≤—Å–µ–≥–¥–∞!")) {
                Data.initNewData(this.currentUser.id);
                alert("–î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã.");
                localStorage.removeItem('LastUserId');
                location.reload();
            }
        }
    };

    const Tutorial = {
        // 1. –ì–õ–ê–í–ù–´–ô –°–¢–ê–†–¢ (–¶–µ–ø–æ—á–∫–∞: –¢–µ—Ä–º—ã -> –¢—É—Ç–æ—Ä–∏–∞–ª)
        startFlow() {
            const termsModal = document.getElementById('terms-modal');
            const acceptBtn = document.getElementById('terms-accept-btn');

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ
            termsModal.classList.add('show');

            // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏
            acceptBtn.onclick = () => {
                termsModal.classList.remove('show');
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∞–º–æ –æ–±—É—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø–æ–ª—Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    this.start();
                }, 500);

                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫–µ –æ–±—ã—á–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ (–ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞—Ç—å –æ–∫–Ω–æ)
                // –≠—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –µ—Å–ª–∏ –æ–Ω –ø–æ—Ç–æ–º –æ—Ç–∫—Ä–æ–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫, —Ç—É—Ç–æ—Ä–∏–∞–ª –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è —Å–Ω–æ–≤–∞
                acceptBtn.onclick = () => termsModal.classList.remove('show');
            };
        },

        // 2. –ó–ê–ü–£–°–ö –°–õ–ê–ô–î–û–í
        start() {
            document.getElementById('tutorial-modal').classList.add('show');
        },

        next(slideNum) {
            document.querySelectorAll('.tutorial-slide').forEach(el => el.style.display = 'none');
            const slide = document.getElementById('tut-' + slideNum);
            if(slide) {
                slide.style.display = 'block';
                slide.style.animation = 'fadeIn 0.5s';
            }
        },

        close() {
            document.getElementById('tutorial-modal').classList.remove('show');
            FX.confetti(); 
            SoundSys.play('success');
        }
    };

    const Timer = {
        idleMinutes: 0, // –°—á–µ—Ç—á–∏–∫ –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è
        timerId: null,
        sec: 0,
        active: false,
        startTime: 0,
        lastKnownTime: 0,
        sessionDuration: 0,
        sessionCoins: 0,
        maxSessionTime: 60 * 60,
        maxIdleTime: 35 * 60 * 1000,
        lastActive: 0,
        wakeLock: null,
        useWakeLock: true,
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ä–µ–∂–∏–º–∞ –•–∞—Ä–¥–∫–æ—Ä
        isStrict: false,

        async requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    this.wakeLock = await navigator.wakeLock.request('screen');
                    // –ï—Å–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–Ω—è—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–µ—Ä–µ–∫–ª—é—á–∏–ª –≤–∫–ª–∞–¥–∫—É), –ø—Ä–æ–±—É–µ–º –≤–µ—Ä–Ω—É—Ç—å –µ—ë
                    this.wakeLock.addEventListener('release', () => {
                        if (this.active) this.requestWakeLock();
                    });
                }
            } catch (err) {}
        },

        releaseWakeLock() {
            if (this.wakeLock) { this.wakeLock.release(); this.wakeLock = null; }
        },

        preStart() {
            if (this.active) return;
            this.isStrict = false; // –í—Å–µ–≥–¥–∞ –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º
            this.start();
        },

        start() {
            this.active = true; 
            this.startTime = Date.now() - (this.sec * 1000);
            this.lastKnownTime = Date.now();
            this.lastActive = Date.now();
            this.sessionCoins = 0;
            this.idleMinutes = 0; 
            
            SoundSys.play('click');
            this.requestWakeLock();

            window.onmousedown = window.ontouchstart = () => { 
                this.idleMinutes = 0; 
            };
            // –ü–û–î–ü–ò–°–´–í–ê–ï–ú–°–Ø –ù–ê –°–û–ë–´–¢–ò–ï "–£–•–û–î–ê" –ò–ó –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
            document.addEventListener("visibilitychange", this.handleVisibility);

            window.onmousemove = window.onkeypress = window.ontouchstart = () => { 
                this.lastActive = Date.now(); 
            };

            if (this.ref) clearInterval(this.ref);
            
            this.ref = setInterval(() => {
                const now = Date.now();
                const expectedSec = Math.floor((now - this.startTime) / 1000);
                const diff = expectedSec - this.sec;

                if (diff > 0) {
                    

                    // –í–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –≤—ã–∫–ª—é—á–∞—Ç—å, –º—ã –ø—Ä–æ—Å—Ç–æ –±—É–¥–µ–º –ø—Ä–æ—Å–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 60 –º–∏–Ω—É—Ç
                    if (this.sessionDuration > 0 && this.sessionDuration % 3600 === 0) {
                        SoundSys.play('level_up'); // –ì—Ä–æ–º–∫–∏–π –∑–≤—É–∫ –¥–ª—è –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –≤–Ω–∏–º–∞–Ω–∏—è
                        App.toast("üëÆ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏, —á—Ç–æ —Ç—ã –µ—â–µ —É—á–∏—à—å—Å—è!");
                        MathGame.show(true);
                    }

                    // –ü—Ä–∏–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è –≤ —Ç—Ä–∏ –º–µ—Å—Ç–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ:
                    this.sec = expectedSec;
                    this.sessionDuration += diff;
                    
                    // 1. –í –æ–±—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å
                    DB.user.totalSec = (DB.user.totalSec || 0) + diff;
                    
                    // 2. –í –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç
                    if (DB.subjects && DB.user.subject && DB.subjects[DB.user.subject]) {
                        DB.subjects[DB.user.subject].sec = (DB.subjects[DB.user.subject].sec || 0) + diff;
                    }

                    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –º–µ–¥–∞–ª–∏ –•–∞—Ä–¥–∫–æ—Ä–∞
                    if (this.isStrict) {
                        DB.user.lifetimeStrictSec = (DB.user.lifetimeStrictSec || 0) + diff;
                    }

                    // üõ°Ô∏è –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–ê–Ø –ó–ê–©–ò–¢–ê –ü–†–ï–î–ú–ï–¢–ê
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º: —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –±–∞–∑–∞, —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç
                    if (DB && DB.subjects && DB.user.subject && DB.subjects[DB.user.subject]) {
                        DB.subjects[DB.user.subject].sec = (DB.subjects[DB.user.subject].sec || 0) + diff;
                    } else {
                        // –ï—Å–ª–∏ –ø—Ä–µ–¥–º–µ—Ç –ø—Ä–æ–ø–∞–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, —É–¥–∞–ª–µ–Ω —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞)
                        // –ú—ã –Ω–µ –¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é —É–ø–∞—Å—Ç—å, –∞ –ø—Ä–æ—Å—Ç–æ —Ñ–∏–∫—Å–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –≤ –∫–æ–Ω—Å–æ–ª—å
                        console.error("‚ö†Ô∏è –û—à–∏–±–∫–∞: –¢–µ–∫—É—â–∏–π –ø—Ä–µ–¥–º–µ—Ç '" + DB.user.subject + "' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ.");
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –≤—Ä–µ–º—è
                        const fallback = Object.keys(DB.subjects)[0];
                        if (fallback) DB.user.subject = fallback;
                    }

                    // –ö–í–ï–°–¢–´ (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –ø—Ä–∏–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ä–∞–∑ –≤ 60 —Å–µ–∫)
                    if (this.sec > 0 && this.sec % 60 === 0) {
                        QuestSys.update('studyMin', 1);
                    }

                    

                    if (this.sessionDuration >= this.maxSessionTime) { 
                        Notify.send("‚è±Ô∏è –í—Ä–µ–º—è –≤—ã—à–ª–æ!", "–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.");
                        this.forcePause("üëÆ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é!"); 
                        MathGame.show(true); 
                        return; 
                    }

                    // –ù–ê–ì–†–ê–î–ê –ú–û–ù–ï–¢–ê–ú–ò (–ú–∞–∫—Å 20, x2 –≤ —Ö–∞—Ä–¥–∫–æ—Ä–µ)
                    const prevMilestone = Math.floor((this.sec - diff) / 600);
                    const currentMilestone = Math.floor(this.sec / 600);
                    if (currentMilestone > prevMilestone) {
                        let totalReward = 0;
                        for (let i = prevMilestone + 1; i <= currentMilestone; i++) {
                            let rewardPerBlock = 5 + ((i - 1) * 2);
                            if (rewardPerBlock > 20) rewardPerBlock = 20; // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ
                            if (this.isStrict) rewardPerBlock *= 2; // –ë–æ–Ω—É—Å —Ö–∞—Ä–¥–∫–æ—Ä–∞
                            totalReward += rewardPerBlock;
                        }
                        DB.user.coins += totalReward;
                        this.sessionCoins += totalReward;
                        SoundSys.play('coin');
                        const coinEl = document.getElementById('coin-display'); 
                        if(coinEl) FX.floatText(coinEl.getBoundingClientRect().left, coinEl.getBoundingClientRect().top, `+${totalReward} üí∞`); 
                        Data.save(); 
                        App.updateUI(); 
                    }
                    // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞–≥–∞–∑–∏–Ω, –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å —Ç–∏–∫–∞–Ω—å–µ –±—É—Å—Ç–µ—Ä–∞
                    if (document.getElementById('shop').classList.contains('active')) {
                        this.renderShop(); 
                    }
                    this.lastKnownTime = now;
                }

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–∏—Ñ—Ä
                const timeString = new Date(this.sec * 1000).toISOString().substr(11, 8);
                const timerEl = document.getElementById('timer');
                if(timerEl) timerEl.innerText = timeString;
                const ecoEl = document.getElementById('eco-timer-display');
                if(ecoEl) ecoEl.innerText = timeString;
                if (this.sec % 120 === 0) { // –†–∞–∑ –≤ 2 –º–∏–Ω—É—Ç—ã
                Data.save(); 
                }

            }, 1000);
            
            document.getElementById('btn-start').innerText = "üî• –ò–î–ï–¢...";


            if (window.App) App.renderSubjects();
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ö–∞—Ä–¥–∫–æ—Ä–∞ –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã
            const strictToggle = document.getElementById('strict-mode-toggle');
            if (strictToggle) strictToggle.disabled = true;
        },

        

        forcePause(reason) {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∞–º –ø—Ä–æ—Ü–µ—Å—Å, –Ω–æ –Ω–µ –æ–±–Ω—É–ª—è–µ–º —Å–µ–∫—É–Ω–¥—ã
            if (this.ref) clearInterval(this.ref);
            this.active = false;
            this.releaseWakeLock();
            
            SoundSys.play('error'); 
            if (navigator.vibrate) navigator.vibrate([500, 200, 500]); 
            
            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ –°–¢–û–ü —Å—Ä–∞–±–æ—Ç–∞–ª–∞ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
            document.getElementById('btn-start').innerText = "üöÄ –ü–†–û–î–û–õ–ñ–ò–¢–¨";
            App.toast("üõë –ü–∞—É–∑–∞: " + reason);
        },

        stop(manual = true) {
            // 1. –ü–ï–†–í–´–ú –î–ï–õ–û–ú –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª, —á—Ç–æ–±—ã –æ–Ω –±–æ–ª—å—à–µ –Ω–µ –≤—ã–∑—ã–≤–∞–ª –æ—à–∏–±–∫–∏
            if (this.ref) {
                clearInterval(this.ref);
                this.ref = null;
            }
            
            this.active = false;
            this.isStrict = false;

            document.removeEventListener("visibilitychange", this.handleVisibility);
            this.releaseWakeLock();
            
            try { SoundSys.play('click'); } catch(e) {}

            // 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ DB –Ω–∞ –º–µ—Å—Ç–µ)
            if (this.sec > 2 && DB && DB.user) {
                const k = getUZDate(); 
                if (!DB.history) DB.history = {};
                DB.history[k] = (DB.history[k] || 0) + this.sec; 
                
                const currentSubName = (DB.subjects && DB.user.subject && DB.subjects[DB.user.subject]) 
                                        ? DB.subjects[DB.user.subject].name : '–£—á–µ–±–∞';

                const log = { 
                    date: new Date().toISOString(), 
                    subject: currentSubName, 
                    sec: this.sec, 
                    coins: this.sessionCoins || 0
                }; 
                if (!DB.sessions) DB.sessions = [];
                DB.sessions.unshift(log); 
                if (DB.sessions.length > 50) DB.sessions.pop(); 
                
                Data.save();
            }

            // 3. –ë–ï–ó–û–ü–ê–°–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï UI (–ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç)
            const timerEl = document.getElementById('timer');
            if (timerEl) {
                timerEl.style.color = "var(--text)";
                timerEl.classList.remove('timer-active-anim');
                timerEl.innerText = "00:00:00";
            }

            const btnStart = document.getElementById('btn-start');
            if (btnStart) btnStart.innerText = "üöÄ –°–¢–ê–†–¢";
            
            const strictToggle = document.getElementById('strict-mode-toggle');
            if (strictToggle) strictToggle.disabled = false;

            const mathModal = document.getElementById('math-modal');
            if (mathModal) mathModal.classList.remove('show');

            // –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–æ–≤
            this.sec = 0;
            this.sessionDuration = 0;
            this.sessionCoins = 0;
            this.idleMinutes = 0;

            // –ï—Å–ª–∏ –º—ã –Ω–µ –≤—ã—Ö–æ–¥–∏–º –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞ (manual === true), –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            if (manual && typeof App !== 'undefined') {
                App.updateUI(); 
                App.renderHistory();
                App.renderSubjects();
            }
        }
    };
    const QuestSys = {
        // 1. –°–ø–∏—Å–æ–∫ –∫–≤–µ—Å—Ç–æ–≤ (—Ü–µ–ª–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ checkDay)
        list: [
            { id: 'q1', title: '‚è±Ô∏è –í—Ä–µ–º—è —É—á–µ–±—ã', type: 'studyMin', baseTarget: 20, reward: 50 },
            { id: 'q2', title: 'üß† –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –º–æ–∑–≥–∞', type: 'mathSolved', baseTarget: 15, reward: 40 },
            { id: 'q3', title: '‚öîÔ∏è –î—É—ç–ª—å —Å –¥—Ä—É–≥–æ–º', type: 'pvpDone', baseTarget: 1, reward: 60 }
        ],

        // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–Ω—è –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ü–µ–ª–µ–π
        checkDay() {
            const today = getUZDate();
            if (DB.user.dailyQuests.date !== today) {
                const randomStudy = 20 + Math.floor(Math.random() * 21); // 20-40 –º–∏–Ω
                const randomMath = 15 + Math.floor(Math.random() * 21);  // 15-35 –ø—Ä–∏–º
                
                DB.user.dailyQuests = {
                    date: today,
                    studyMin: 0,
                    mathSolved: 0,
                    pvpDone: 0,
                    claimed: [],
                    targets: {
                        studyMin: randomStudy,
                        mathSolved: randomMath,
                        pvpDone: 1
                    }
                };
                Data.save();
            }
        },

        // 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        update(type, amount = 1) {
            this.checkDay();
            if (DB.user.dailyQuests[type] !== undefined) {
                DB.user.dailyQuests[type] += amount;
                Data.save();
                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
                const dash = document.getElementById('dashboard');
                if (dash && dash.classList.contains('active')) this.render();
            }
        },

        // 4. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤ HTML
        render() {
            const container = document.getElementById('quests-container');
            if (!container) return;

            this.checkDay();
            const targets = DB.user.dailyQuests.targets || { studyMin: 30, mathSolved: 20, pvpDone: 1 };

            container.innerHTML = this.list.map(q => {
                const current = DB.user.dailyQuests[q.type] || 0;
                const target = targets[q.type];
                const isClaimed = DB.user.dailyQuests.claimed.includes(q.id);
                const isDone = current >= target;
                const pct = Math.min(100, (current / target) * 100);

                // –§–û–†–ú–ò–†–£–ï–ú –ü–û–ù–Ø–¢–ù–´–ô –¢–ï–ö–°–¢ –¶–ï–õ–ò
                let questGoalText = "";
                const left = target - current;
                if (q.type === 'studyMin') {
                    questGoalText = isDone ? "‚úÖ –í—Ä–µ–º—è –≤—ã—à–ª–æ, –∑–∞–±–∏—Ä–∞–π!" : `–ü–æ—É—á–∏—Å—å –µ—â–µ ${left} –º–∏–Ω.`;
                } else if (q.type === 'mathSolved') {
                    questGoalText = isDone ? "‚úÖ –ú–æ–∑–≥ –ø—Ä–æ–∫–∞—á–∞–Ω!" : `–†–µ—à–∏ –µ—â–µ ${left} –ø—Ä–∏–º–µ—Ä–æ–≤ –≤ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–µ`;
                } else if (q.type === 'pvpDone') {
                    questGoalText = isDone ? "‚úÖ –ê—Ä–µ–Ω–∞ –ø—Ä–æ–π–¥–µ–Ω–∞!" : `–°—ã–≥—Ä–∞–π 1 –¥—É—ç–ª—å —Å –¥—Ä—É–≥–æ–º`;
                }

                return `
                    <div class="card" style="padding: 15px; margin-bottom: 10px; border-left: 4px solid ${isDone ? 'var(--success)' : 'var(--primary)'}">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: bold; font-size: 14px;">${q.title}</div>
                                <div style="font-size: 11px; color: var(--text-light); margin-top: 2px;">${questGoalText}</div>
                            </div>
                            <div style="font-weight: 800; color: var(--primary); font-size: 14px;">${current}/${target}</div>
                        </div>
                        
                        <!-- –®–∫–∞–ª–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ -->
                        <div style="height: 6px; background: rgba(0,0,0,0.05); border-radius: 3px; margin: 12px 0 8px 0; overflow: hidden;">
                            <div style="width: ${pct}%; height: 100%; background: ${isDone ? 'var(--success)' : 'var(--primary)'}; transition: 0.8s cubic-bezier(0.17, 0.67, 0.83, 0.67);"></div>
                        </div>

                        ${isDone && !isClaimed ? `
                            <button class="btn btn-primary" style="padding: 10px; font-size: 12px; width: 100%; margin-top: 5px; background: var(--success);" onclick="QuestSys.claim('${q.id}')">
                                üéÅ –ó–ê–ë–†–ê–¢–¨ –ù–ê–ì–†–ê–î–£ +${q.reward} üí∞
                            </button>
                        ` : ''}

                        ${isClaimed ? `
                            <div style="color: var(--success); font-size: 12px; font-weight: bold; text-align: center; padding: 5px; background: rgba(0,210,106,0.1); border-radius: 8px; margin-top: 5px;">
                                ‚≠ê –í–´–ü–û–õ–ù–ï–ù–û
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        },

        // 5. –§–£–ù–ö–¶–ò–Ø –ó–ê–ë–û–†–ê –ù–ê–ì–†–ê–î–´ (–ï—ë —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∞–ª–æ)
        claim(id) {
            const q = this.list.find(x => x.id === id);
            if (!q) return;

            this.checkDay();
            
            if (DB.user.dailyQuests.claimed.includes(id)) return;

            const current = DB.user.dailyQuests[q.type];
            const target = DB.user.dailyQuests.targets[q.type];

            if (current >= target) {
                DB.user.dailyQuests.claimed.push(id);
                DB.user.coins += q.reward;
                
                SoundSys.play('quest_done'); // –ù–∞—à –Ω–æ–≤—ã–π –∑–≤—É–∫
                FX.confetti();
                App.toast(`üéÅ –ù–∞–≥—Ä–∞–¥–∞: +${q.reward} üí∞`);
                
                Data.save();
                App.updateUI();
                this.render();
            } else {
                App.toast("‚ö†Ô∏è –ö–≤–µ—Å—Ç –µ—â–µ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω!");
            }
        }
    };
    const MathGame = { ans:0, show(isCheck=false) { const a=Math.floor(Math.random()*9)+2, b=Math.floor(Math.random()*9)+2; this.ans = a*b; document.getElementById('math-problem').innerText = `${a} x ${b} = ?`; document.getElementById('math-answer').value = ''; document.getElementById('modal-title').innerText = isCheck?"üëÆ –ü—Ä–æ–≤–µ—Ä–∫–∞":"üß† –ó–∞–¥–∞—á–∞"; document.getElementById('modal-msg').innerText = isCheck?"–í—ã –¥–æ–ª–≥–æ —É—á–∏–ª–∏—Å—å. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ.":""; document.getElementById('math-modal').classList.add('show'); document.getElementById('math-answer').focus(); }, check() { if(parseInt(document.getElementById('math-answer').value) === this.ans) { document.getElementById('math-modal').classList.remove('show'); Timer.start(); } else { document.getElementById('math-answer').style.borderColor='red'; SoundSys.play('error'); } } };

    const BattleSys = {
        bet: 50,
        currentCode: null,
        listener: null,
        myRole: null, // 'p1' –∏–ª–∏ 'p2'
        gameStarted: false, // –ß—Ç–æ–±—ã –∏–≥—Ä–∞ –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª–∞—Å—å –¥–≤–∞–∂–¥—ã
    genRandom() {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —á–∏—Å–ª–æ –æ—Ç 100 –¥–æ 999
            const rand = Math.floor(Math.random() * 900) + 100;
            document.getElementById('battle-code-input').value = rand;
        },
        openMenu() {
            if (!window.DB_Online) return App.toast("–ù—É–∂–µ–Ω –∏–Ω—Ç–µ—Ä–Ω–µ—Ç!");
            document.getElementById('battle-modal').classList.add('show');
            document.getElementById('battle-login-view').style.display = 'block';
            document.getElementById('battle-lobby-view').style.display = 'none';
            
            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏–π
            this.gameStarted = false;
            if (this.listener) this.listener(); // –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ä—É—é –ø—Ä–æ—Å–ª—É—à–∫—É
        },

        setBet(amount, btn) {
            this.bet = amount;
            document.querySelectorAll('#battle-modal .diff-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
        },

        // –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –í–•–û–î–ê
        async connect() {
            const rawCode = document.getElementById('battle-code-input').value.trim();
            if (rawCode.length < 3) return App.toast("–ö–æ–¥ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π!");
            const code = rawCode.replace(/\s/g, ''); 
            this.currentCode = code;

            // 1. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 4 —á–∞—Å–∞ (14,400,000 –º—Å)
            const lastBattle = DB.user.lastBattleTime || 0;
            const now = Date.now();
            const waitTime = 4 * 60 * 60 * 1000; 

            if (now - lastBattle < waitTime) {
                const remaining = waitTime - (now - lastBattle);
                const hours = Math.floor(remaining / (60 * 60 * 1000));
                const mins = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
                return alert(`üïí –ê—Ä–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∞! \n\n–°–ª–µ–¥—É—é—â–∏–π –±–æ–π —á–µ—Ä–µ–∑ ${hours}—á ${mins}–º–∏–Ω.`);
            }

            // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç–∞–≤–∫–∏ 15 –º–æ–Ω–µ—Ç
            this.bet = 15; 
            if (DB.user.coins < this.bet) return App.toast("–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 15 –º–æ–Ω–µ—Ç!");

            App.toast("‚è≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...");

            try {
                const docRef = window.DB_Online.doc(window.DB_Online.db, "battles_v2", code);
                const snap = await window.DB_Online.getDoc(docRef);

                // –°–¶–ï–ù–ê–†–ò–ô 1: –ö–û–ú–ù–ê–¢–´ –ù–ï–¢ -> –Ø –°–û–ó–î–ê–¢–ï–õ–¨ (P1)
                if (!snap.exists()) {
                    this.myRole = 'p1';
                    await this.createRoom(docRef);
                } 
                // –°–¶–ï–ù–ê–†–ò–ô 2: –ö–û–ú–ù–ê–¢–ê –ï–°–¢–¨ -> –Ø –ì–û–°–¢–¨ (P2)
                else {
                    const data = snap.data();
                    if (data.p2) return alert("‚õîÔ∏è –ö–æ–º–Ω–∞—Ç–∞ —É–∂–µ –ø–æ–ª–Ω–∞—è!");
                    
                    this.myRole = 'p2';
                    await this.joinRoom(docRef, data);
                }

                // –ü–û–°–õ–ï –í–•–û–î–ê –ò–õ–ò –°–û–ó–î–ê–ù–ò–Ø -> –í–ö–õ–Æ–ß–ê–ï–ú –†–ï–ñ–ò–ú –û–ñ–ò–î–ê–ù–ò–Ø
                this.showLobby();
                this.startListening(docRef);

            } catch (e) {
                console.error(e);
                App.toast("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
            }
        },

        async createRoom(docRef) {
            // –ú–û–ù–ï–¢–´ –¢–£–¢ –ù–ï –°–ù–ò–ú–ê–ï–ú! –°–Ω–∏–º–µ–º –∫–æ–≥–¥–∞ –Ω–∞—á–Ω–µ—Ç—Å—è –±–æ–π.
            await window.DB_Online.setDoc(docRef, {
                p1: DB.user.name,
                p1_id: Auth.currentUser.id,
                p1_score: -1,
                p2: null,
                p2_id: null,
                p2_score: -1,
                bet: 15, // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞–≤–∫–∞
                mode: Trainer.mode,
                diff: Trainer.difficulty,
                status: 'waiting',
                date: new Date().toISOString()
            });
        },

        async joinRoom(docRef, currentData) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –≤—Ö–æ–¥—è—â–µ–≥–æ 15 –º–æ–Ω–µ—Ç
            if (DB.user.coins < 15) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç –¥–ª—è —É—á–∞—Å—Ç–∏—è (–Ω—É–∂–Ω–æ 15)!");

            this.bet = 15;
            await window.DB_Online.updateDoc(docRef, {
                p2: DB.user.name,
                p2_id: Auth.currentUser.id,
                status: 'ready'
            });
        },


        showLobby() {
            document.getElementById('battle-login-view').style.display = 'none';
            document.getElementById('battle-lobby-view').style.display = 'block';
            document.getElementById('lobby-code-display').innerText = this.currentCode;

            // –°—Ä–∞–∑—É –ø–∏—à–µ–º —Å–µ–±—è
            if (this.myRole === 'p1') {
                document.getElementById('p1-name').innerText = DB.user.name + " (–í—ã)";
                document.getElementById('p2-name').innerText = "–û–∂–∏–¥–∞–Ω–∏–µ...";
            } else {
                document.getElementById('p1-name').innerText = "–°–æ–ø–µ—Ä–Ω–∏–∫"; // –ò–º—è –ø–æ–¥–≥—Ä—É–∑–∏—Ç—Å—è —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
                document.getElementById('p2-name').innerText = DB.user.name + " (–í—ã)";
            }
        },

        // –°–õ–£–®–ê–ï–ú –ò–ó–ú–ï–ù–ï–ù–ò–Ø (–ß–¢–û–ë–´ –£–í–ò–î–ï–¢–¨ –î–†–£–ì–ê –ò –ù–ê–ß–ê–¢–¨ –ò–ì–†–£)
        startListening(docRef) {
            this.listener = window.DB_Online.onSnapshot(docRef, (docSnap) => {
                if (!docSnap.exists()) return;
                const data = docSnap.data();

                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º–µ–Ω–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
                if (data.p1) document.getElementById('p1-name').innerText = data.p1 + (this.myRole === 'p1' ? " (–í—ã)" : "");
                if (data.p2) document.getElementById('p2-name').innerText = data.p2 + (this.myRole === 'p2' ? " (–í—ã)" : "");

                // üî• –ó–ê–ü–£–°–ö –ò–ì–†–´ (–ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å ready –∏ –º—ã –µ—â–µ –Ω–µ –Ω–∞—á–∞–ª–∏)
                if (data.status === 'ready' && !this.gameStarted) {
                    this.gameStarted = true; // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫
                    
                    // –ñ–¥–µ–º 1 —Å–µ–∫—É–Ω–¥—É –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã –∏ –∑–∞–ø—É—Å–∫–∞–µ–º
                    setTimeout(() => {
                        if (this.listener) this.listener(); // –û—Ç–∫–ª—é—á–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å
                        document.getElementById('battle-modal').classList.remove('show');
                        Trainer.startPVP(this.myRole, this.currentCode, data.bet, data.mode, data.diff);
                    }, 1000);
                }
            });
        },

        leaveLobby() {
            if (this.listener) this.listener();
            location.reload(); // –°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë
        }
    };

    const Trainer = { 
        lastAnswerTime: 0,
    
        // –î–æ–±–∞–≤–∏–ª–∏ —Ñ–ª–∞–≥ isLocked
        isLocked: false, // –§–ª–∞–≥ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        score: 0, time: 60, interval: null, 
        ans: 0, correctSign: '', difficulty: 'easy', mode: 'standard', 
        isLocked: false, // <--- –ù–û–í–û–ï: –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞

    // --- –î–£–≠–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        isDuel: false,
        duelRole: null, 
        duelBet: 0,
        duelCode: null, // <--- –ù–û–í–ê–Ø –ü–ï–†–ï–ú–ï–ù–ù–ê–Ø

        // –§–£–ù–ö–¶–ò–Ø –ó–ê–ü–£–°–ö–ê –î–£–≠–õ–ò
        

        // 1. –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞
        selectMode(mode, btn) {
            this.mode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            this.updateMenuRecordDisplay();
        },

        // 2. –í—ã–±–æ—Ä —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
        setDiff(diff, btn) {
            this.difficulty = diff;
            document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            this.updateMenuRecordDisplay();
        },

        updateMenuRecordDisplay() {
            const labels = { 'standard': '–ö–ª–∞—Å—Å–∏–∫–∞', 'sign': '–ù–∞–π–¥–∏ –∑–Ω–∞–∫', 'square': '–ö–≤–∞–¥—Ä–∞—Ç—ã' };
            // –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–±–æ–µ–≤
            if (DB && DB.user && DB.user.trainerRecords && DB.user.trainerRecords[this.mode]) {
                const rec = DB.user.trainerRecords[this.mode][this.difficulty] || 0;
                const el = document.getElementById('trainer-high-score');
                if(el) el.innerText = rec;
                const lbl = document.getElementById('record-mode-label');
                if(lbl) lbl.innerText = labels[this.mode];
            }
        },

        toggleMinus() {
            const input = document.getElementById('game-input');
            let val = input.value;
            if (val === '') input.value = '-';
            else if (val.startsWith('-')) input.value = val.substring(1);
            else input.value = '-' + val;
            input.focus();
        },

        init() { 
            this.unlockControls(); // <--- –õ–ï–ö–ê–†–°–¢–í–û
            document.getElementById('trainer-menu').style.display = 'block'; 
            document.getElementById('trainer-game').style.display = 'none'; 
            document.getElementById('trainer-result').style.display = 'none'; 
            this.updateMenuRecordDisplay();
        },

        start() {
            this.unlockControls(); // <--- –õ–ï–ö–ê–†–°–¢–í–û
            
            // ... (–≤–∞—à —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ score, time –∏ —Ç.–¥.)
            this.score = 0; 
            this.time = 60; 
            document.getElementById('trainer-menu').style.display = 'none'; 
            document.getElementById('trainer-game').style.display = 'block';
            document.getElementById('game-score').innerText = 0; 
            document.getElementById('game-time').innerText = 60;
            
            // ... (–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø–æ–¥ —Ä–µ–∂–∏–º) ...
            const inputArea = document.getElementById('input-area');
            const signArea = document.getElementById('sign-area');

            if (this.mode === 'sign') {
                inputArea.style.display = 'none';
                signArea.style.display = 'grid';
            } else {
                inputArea.style.display = 'block';
                signArea.style.display = 'none';
                const input = document.getElementById('game-input'); 
                input.value = ''; input.focus();
                input.onclick = () => input.focus();
                input.onkeypress = (e) => { if(e.key === 'Enter') this.check(); };
            }

            SoundSys.play('click'); 
            this.nextProblem(); 
            
            if(this.interval) clearInterval(this.interval);
            this.interval = setInterval(() => { 
                this.time--; 
                document.getElementById('game-time').innerText = this.time; 
                if(this.time <= 0) this.end(); 
            }, 1000);
        },

    fail(el) {
            if (this.isLocked) return;
            this.isLocked = true;

            SoundSys.play('error'); 
            el.classList.add('error-shake');
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ
            document.getElementById('input-area').classList.add('input-locked');
            document.getElementById('sign-area').classList.add('input-locked');

            this.time -= 5;
            if (this.time < 0) this.time = 0;
            document.getElementById('game-time').innerText = this.time;

            if (this.time <= 0) {
                this.end();
                return;
            }

            // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ 1.2 —Å–µ–∫
            setTimeout(() => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–¥–µ—Ç –ª–∏ –µ—â–µ –∏–≥—Ä–∞, –ø—Ä–µ–∂–¥–µ —á–µ–º —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                if (document.getElementById('trainer-game').style.display !== 'none') {
                    this.unlockControls();
                    // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è
                    if(el.tagName === 'INPUT') el.value = '';
                }
            }, 1200);
        },

        

        nextProblem() {
            // --- 1. –†–ï–ñ–ò–ú: –ù–ê–ô–î–ò –ó–ù–ê–ö üß© ---
            if (this.mode === 'sign') {
                const ops = ['+', '-', '*', '/'];
                const availableOps = this.difficulty === 'easy' ? ['+', '-', '*'] : ops;
                this.correctSign = availableOps[Math.floor(Math.random() * availableOps.length)];
                
                let a, b, res;
                let range = this.difficulty === 'easy' ? 10 : 20;

                if (this.correctSign === '/') {
                    b = Math.floor(Math.random() * 10) + 2; 
                    res = Math.floor(Math.random() * 10) + 2;
                    a = b * res; 
                } else if (this.correctSign === '*') {
                    a = Math.floor(Math.random() * 10) + 2;
                    b = Math.floor(Math.random() * 10) + 2;
                    res = a * b;
                } else {
                    a = Math.floor(Math.random() * range) + 2;
                    b = Math.floor(Math.random() * range) + 2;
                    if (this.correctSign === '+') res = a + b; else res = a - b;
                }
                document.getElementById('game-problem').innerText = `${a} ? ${b} = ${res}`;
            }

            // --- 2. –†–ï–ñ–ò–ú: –ö–í–ê–î–†–ê–¢–´ üü• ---
            else if (this.mode === 'square') {
                const isRoot = Math.random() > 0.5; 
                let maxBase = this.difficulty === 'easy' ? 10 : (this.difficulty === 'medium' ? 20 : 30);
                let base = Math.floor(Math.random() * (maxBase - 2)) + 2; 
                let square = base * base;

                if (isRoot) {
                    document.getElementById('game-problem').innerText = `‚àö${square}`;
                    this.ans = base;
                } else {
                    document.getElementById('game-problem').innerHTML = `${base}¬≤`;
                    this.ans = square;
                }
                document.getElementById('game-input').value = '';
            }

            // --- 3. –†–ï–ñ–ò–ú: –ö–õ–ê–°–°–ò–ö–ê üî¢ ---
            else {
                // –õ–µ–≥–∫–æ/–°—Ä–µ–¥–Ω–µ
                if (this.difficulty !== 'hard') {
                    let range = this.difficulty === 'easy' ? 20 : 50;
                    let multRange = this.difficulty === 'easy' ? 5 : 10;
                    let ops = this.difficulty === 'easy' ? ['+', '-'] : ['+', '-', '*'];
                    
                    const op = ops[Math.floor(Math.random() * ops.length)];
                    let a, b;

                    if (op === '*') {
                        a = Math.floor(Math.random() * multRange) + 2; 
                        b = Math.floor(Math.random() * multRange) + 2;
                    } else {
                        a = Math.floor(Math.random() * range) + 2;
                        b = Math.floor(Math.random() * range) + 2;
                    }

                    if(op === '+') this.ans = a + b; 
                    if(op === '-') this.ans = a - b; 
                    if(op === '*') this.ans = a * b;

                    let displayOp = op === '*' ? '√ó' : (op === '-' ? '‚àí' : '+');
                    document.getElementById('game-problem').innerText = `${a} ${displayOp} ${b}`; 
                }
                // –°–ª–æ–∂–Ω–æ (—Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º–∏ –∏ –¥–µ–ª–µ–Ω–∏–µ–º)
                else {
                    const ops = ['+', '-', '*', '/'];
                    const op = ops[Math.floor(Math.random() * ops.length)];
                    let limit = (op === '*' || op === '/') ? 12 : 30;
                    let absA = Math.floor(Math.random() * limit) + 1;
                    let absB = Math.floor(Math.random() * limit) + 1;
                    let signA = Math.random() < 0.5 ? -1 : 1; 
                    let signB = Math.random() < 0.5 ? -1 : 1;

                    if (op === '/') {
                        let res = Math.floor(Math.random() * 10) + 1;
                        let signRes = Math.random() < 0.5 ? -1 : 1;
                        absB = Math.floor(Math.random() * 10) + 2;
                        let bVal = absB * signB;
                        let resVal = res * signRes;
                        var a = bVal * resVal; var b = bVal;
                    } else {
                        var a = absA * signA; var b = absB * signB;
                    }

                    if (op === '+') this.ans = a + b;
                    if (op === '-') this.ans = a - b;
                    if (op === '*') this.ans = a * b;
                    if (op === '/') this.ans = a / b;

                    let displayB = b < 0 ? `(${b})` : b;
                    let displayOp = op === '*' ? '√ó' : (op === '/' ? '√∑' : (op === '-' ? '‚àí' : '+'));
                    document.getElementById('game-problem').innerText = `${a} ${displayOp} ${displayB}`;
                }
                document.getElementById('game-input').value = '';
            }
        },

        // --- –ü–†–û–í–ï–†–ö–ê –ß–ò–°–ï–õ (–ö–ª–∞—Å—Å–∏–∫–∞/–ö–≤–∞–¥—Ä–∞—Ç—ã) ---
        check() {
            
            if (this.isLocked) return; // –ï—Å–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ - –∏–≥–Ω–æ—Ä

            const inputEl = document.getElementById('game-input');
            const val = parseInt(inputEl.value); 
            
            if (isNaN(val)) return; // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç–æ–≥–æ –≤–≤–æ–¥–∞

            if(val === this.ans) {
                this.success(inputEl);
            } else { 
                this.fail(inputEl);
            }
        },

        // --- –ü–†–û–í–ï–†–ö–ê –ó–ù–ê–ö–û–í (–ù–∞–π–¥–∏ –∑–Ω–∞–∫) ---
        checkSign(sign) {
            if (this.isLocked) return; // –ï—Å–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ - –∏–≥–Ω–æ—Ä

            if(sign === this.correctSign) {
                const area = document.getElementById('sign-area');
                this.success(area);
            } else {
                // –ò—â–µ–º –∫–Ω–æ–ø–∫—É, –∫–æ—Ç–æ—Ä—É—é –Ω–∞–∂–∞–ª–∏ (–≤–∏–∑—É–∞–ª—å–Ω–æ –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –æ—à–∏–±–∫—É —Å–ª–æ–∂–Ω–æ –±–µ–∑ event, 
                // –ø–æ—ç—Ç–æ–º—É –ø–æ–¥—Å–≤–µ—Ç–∏–º –≤—Å—é –æ–±–ª–∞—Å—Ç—å –∑–Ω–∞–∫–æ–≤)
                const area = document.getElementById('sign-area');
                this.fail(area);
            }
        },

        // --- –£–°–ü–ï–• ---
        success(el) {
            this.score++; 
            DB.user.lifetimeMathSolved = (DB.user.lifetimeMathSolved || 0) + 1;
            document.getElementById('game-score').innerText = this.score; 
            SoundSys.play('success');
            QuestSys.update('mathSolved', 1);

            el.style.borderColor = 'var(--primary)'; 
            if(this.mode === 'sign') el.style.background = 'rgba(0, 255, 0, 0.1)';
            
            setTimeout(() => { 
                el.style.borderColor = ''; 
                el.style.background = '';
            }, 200);
            
            // XP
            let pts = 2;
            if(this.difficulty === 'medium') pts = 5;
            if(this.difficulty === 'hard') pts = 10;

            // –ê–Ω–∏–º–∞—Ü–∏—è XP (–µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –∏–º–µ–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã)
            if (el && el.getBoundingClientRect) {
                const rect = el.getBoundingClientRect(); 
                FX.floatText(rect.left + rect.width/2, rect.top, `+${pts} XP`, "#6C63FF");
            }
            
            this.nextProblem();
        },

        // --- üî• –ù–ê–ö–ê–ó–ê–ù–ò–ï –ó–ê –û–®–ò–ë–ö–£ üî• ---
        fail(el) {
            if (this.isLocked) return;
            this.isLocked = true; // 1. –ë–õ–û–ö–ò–†–£–ï–ú –í–í–û–î

            SoundSys.play('error'); 
            
            // 2. –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç (–¢—Ä—è—Å–∫–∞ + –ö—Ä–∞—Å–Ω—ã–π)
            el.classList.add('error-shake');
            
            // 3. –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –≤–∏–∑—É–∞–ª—å–Ω–æ
            document.getElementById('input-area').classList.add('input-locked');
            document.getElementById('sign-area').classList.add('input-locked');

            // 4. –®–¢–†–ê–§ –í–†–ï–ú–ï–ù–ò (-5 —Å–µ–∫—É–Ω–¥)
            this.time -= 5;
            if (this.time < 0) this.time = 0;
            document.getElementById('game-time').innerText = this.time;
            
            // –ê–Ω–∏–º–∞—Ü–∏—è —à—Ç—Ä–∞—Ñ–∞
            try {
                const rect = el.getBoundingClientRect();
                FX.floatText(rect.left + rect.width/2, rect.top, `-5 —Å–µ–∫`, "#ff4d4d");
            } catch(e){}

            // –ï—Å–ª–∏ –≤—Ä–µ–º—è –∫–æ–Ω—á–∏–ª–æ—Å—å –∏–∑-–∑–∞ —à—Ç—Ä–∞—Ñ–∞
            if (this.time <= 0) {
                this.end();
                return;
            }

            // 5. –†–ê–ó–ë–õ–û–ö–ò–†–û–í–ö–ê –ß–ï–†–ï–ó 1.2 –°–ï–ö–£–ù–î–´
            setTimeout(() => {
                this.isLocked = false;
                el.classList.remove('error-shake');
                document.getElementById('input-area').classList.remove('input-locked');
                document.getElementById('sign-area').classList.remove('input-locked');
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞, –µ—Å–ª–∏ —ç—Ç–æ –∏–Ω–ø—É—Ç
                if(el.tagName === 'INPUT') el.value = '';
            }, 1200);
        },

        end() {
            // 1. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
            clearInterval(this.interval); 
            document.getElementById('trainer-game').style.display = 'none'; 
            
            // 2. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–∞–≥—Ä–∞–¥—É (–ü–û –ù–û–í–û–ô –≠–ö–û–ù–û–ú–ò–ö–ï)
            // –ú–Ω–æ–∂–∏—Ç–µ–ª—å XP (—É—Ä–µ–∑–∞–Ω–Ω—ã–π)
            let mult = 2; // –õ–µ–≥–∫–æ = 2 XP –∑–∞ –æ—Ç–≤–µ—Ç
            if(this.difficulty === 'medium') mult = 5;
            if(this.difficulty === 'hard') mult = 10;

            const earnedXP = this.score * mult; 

            // –î–µ–ª–∏—Ç–µ–ª—å –º–æ–Ω–µ—Ç 
            // –õ–µ–≥–∫–æ/–°—Ä–µ–¥–Ω–µ: 1 –º–æ–Ω–µ—Ç–∞ –∑–∞ 10 –æ—Ç–≤–µ—Ç–æ–≤
            // –°–ª–æ–∂–Ω–æ: 1 –º–æ–Ω–µ—Ç–∞ –∑–∞ 5 –æ—Ç–≤–µ—Ç–æ–≤
            let div = (this.difficulty === 'hard') ? 5 : 10;
            const earnedCoins = Math.floor(this.score / div); 
            
            // 3. –í—ã–¥–∞–µ–º –Ω–∞–≥—Ä–∞–¥—É
            App.addXP(earnedXP);
            if(earnedCoins > 0) { 
                DB.user.coins += earnedCoins; 
                SoundSys.play('coin'); 
                App.toast(`ü™ô +${earnedCoins} üí∞`); 
            }

            // üî• 4. –ü–†–û–í–ï–†–ö–ê –î–£–≠–õ–ò (PVP)
            if (this.isDuel) {
                this.handleDuelEnd();
                this.isDuel = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –±–∏—Ç–≤—ã
                return; 
            }

            // 5. –û–ë–´–ß–ù–ê–Ø –ò–ì–†–ê: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            document.getElementById('trainer-result').style.display = 'block';

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–∞–∑—ã (–∑–∞—â–∏—Ç–∞ –æ—Ç —Å–±–æ–µ–≤)
            if (!DB.user.trainerRecords[this.mode]) {
                DB.user.trainerRecords[this.mode] = { easy:0, medium:0, hard:0 };
            }

            // –ë–µ—Ä–µ–º —Å—Ç–∞—Ä—ã–π —Ä–µ–∫–æ—Ä–¥
            const oldRec = DB.user.trainerRecords[this.mode][this.difficulty];

            // –ï—Å–ª–∏ –ø–æ–±–∏–ª–∏ —Ä–µ–∫–æ—Ä–¥ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –ø—Ä–∞–∑–¥–Ω—É–µ–º
            if(this.score > oldRec) {
                DB.user.trainerRecords[this.mode][this.difficulty] = this.score;
                SoundSys.play('win'); 
                App.toast(`üèÜ –ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥ –≤ "${this.mode}": ${this.score}!`); 
                FX.confetti(); 
            }

            // 6. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
            Data.save(); 
            App.updateUI();
            
            document.getElementById('result-score').innerText = this.score; 
            document.getElementById('result-xp').innerText = `+${earnedXP} XP`; 
            document.getElementById('result-coins').innerText = `+${earnedCoins} üí∞`;
        },
        // –í–Ω—É—Ç—Ä–∏ const Trainer = { ... }

        // --- REALTIME PVP ---
        pvpRole: null, 
        pvpCode: null,
        pvpListener: null,


        startPVP(role, code, bet, mode, diff) {
            // üîí –°–ü–ò–°–ê–ù–ò–ï –ú–û–ù–ï–¢ –ü–†–ò –†–ï–ê–õ–¨–ù–û–ú –°–¢–ê–†–¢–ï
            if (DB.user.coins < 15) {
                alert("–û—à–∏–±–∫–∞: –ú–æ–Ω–µ—Ç—ã –∫–æ–Ω—á–∏–ª–∏—Å—å –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º!");
                location.reload();
                return;
            }

            DB.user.coins -= 15; // –°–Ω–∏–º–∞–µ–º 15 –º–æ–Ω–µ—Ç
            Data.save();
            App.updateUI();

            this.pvpRole = role;
            this.pvpCode = code;
            this.duelBet = 15; 
            this.isDuel = true; 
            
            this.mode = mode || 'standard';
            this.difficulty = diff || 'easy';

            App.toast(`‚öîÔ∏è –ë–û–ô –ù–ê–ß–ê–õ–°–Ø! –°—Ç–∞–≤–∫–∞: 15 üí∞`);
            document.getElementById('battle-modal').classList.remove('show');
            this.start(); 
        },


        // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ end(), –µ—Å–ª–∏ isDuel = true
        async handleDuelEnd() {
            const score = this.score;
            DB.user.lastBattleTime = Date.now(); // –¢–≤–æ–π –ª–∏–º–∏—Ç 8 —á–∞—Å–æ–≤
            Data.save();

            document.getElementById('trainer-game').style.display = 'none';
            document.getElementById('trainer-result').style.display = 'block';
            document.getElementById('result-score').innerText = score;
            document.querySelector('#trainer-result h2').innerText = "–ñ–¥–µ–º —Å–æ–ø–µ—Ä–Ω–∏–∫–∞... ‚è≥";
            document.getElementById('result-coins').innerText = "–û—Å—Ç–∞–ª–æ—Å—å: 120—Å";

            const docRef = window.DB_Online.doc(window.DB_Online.db, "battles_v2", this.pvpCode);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–≤–æ–π —Å—á–µ—Ç
            const updateData = {};
            updateData[`${this.pvpRole}_score`] = score;
            await window.DB_Online.updateDoc(docRef, updateData);

            // --- –¢–ê–ô–ú-–ê–£–¢ (–ó–ê–©–ò–¢–ê) ---
            let timeLeft = 120;
            const timeoutInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('result-coins').innerText = `–û—Å—Ç–∞–ª–æ—Å—å: ${timeLeft}—Å`;
                
                if (timeLeft <= 0) {
                    clearInterval(timeoutInterval);
                    if (this.pvpListener) this.pvpListener();
                    this.claimTechnicalWin(); // –§—É–Ω–∫—Ü–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–±–µ–¥—ã
                }
            }, 1000);

            // –°–ª—É—à–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            this.pvpListener = window.DB_Online.onSnapshot(docRef, (docSnap) => {
                const data = docSnap.data();
                if (data.p1_score !== -1 && data.p2_score !== -1) {
                    clearInterval(timeoutInterval);
                    this.finishPVP(data);
                }
            });
        },

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Ö. –ø–æ–±–µ–¥—ã
        claimTechnicalWin() {
            alert("‚öîÔ∏è –°–æ–ø–µ—Ä–Ω–∏–∫ —Å–±–µ–∂–∞–ª! –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–±–µ–¥–∞!");
            DB.user.coins += this.duelBet * 2;
            DB.user.pvpWins = (DB.user.pvpWins || 0) + 1;
            
            document.querySelector('#trainer-result h2').innerText = "üèÜ –¢–ï–•. –ü–û–ë–ï–î–ê";
            document.getElementById('result-coins').innerText = "–°–æ–ø–µ—Ä–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–ª –±–æ–π";
            Data.save();
            App.updateUI();
        },

        // –§–∏–Ω–∞–ª: –æ–±–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∏
        finishPVP(data) {
            if (this.pvpListener) this.pvpListener(); // –í—ã–∫–ª—é—á–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å

            const myScore = (this.pvpRole === 'p1') ? data.p1_score : data.p2_score;
            const oppScore = (this.pvpRole === 'p1') ? data.p2_score : data.p1_score;
            const oppName = (this.pvpRole === 'p1') ? data.p2 : data.p1;

            let msg = "";
            
            if (myScore > oppScore) {
            msg = "üèÜ –ü–û–ë–ï–î–ê!";
            DB.user.coins += data.bet * 2;
            DB.user.pvpWins = (DB.user.pvpWins || 0) + 1; // +1 –∫ –ø–æ–±–µ–¥–∞–º
        } else if (myScore < oppScore) {
            msg = "üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ";
            DB.user.pvpLosses = (DB.user.pvpLosses || 0) + 1; // +1 –∫ –ø–æ—Ä–∞–∂–µ–Ω–∏—è–º
        }

            document.querySelector('#trainer-result h2').innerText = msg;
            document.getElementById('result-xp').innerText = `–¢—ã: ${myScore}`;
            document.getElementById('result-coins').innerText = `${oppName}: ${oppScore}`;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫—Ä–∞—Å–∏–≤—É—é –∫–Ω–æ–ø–∫—É –≤—ã—Ö–æ–¥–∞
            const btn = document.querySelector('#trainer-result button');
            btn.innerText = "–ó–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É –∏ –≤—ã–π—Ç–∏";
            
            Data.save();
            App.updateUI();
        },

        unlockControls() {
            this.isLocked = false;
            // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–ª–∞—Å—Å—ã –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
            document.getElementById('input-area').classList.remove('input-locked');
            document.getElementById('sign-area').classList.remove('input-locked');
            // –£–±–∏—Ä–∞–µ–º —Ç—Ä—è—Å–∫—É —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.error-shake').forEach(el => el.classList.remove('error-shake'));
        }
    };

    const AchievementSys = {
        check() {
            if (!DB || !DB.achievements) return;
            let changed = false;
            const now = new Date();
            const hour = now.getHours();

            DB.achievements.forEach(a => {
                if (a.unlocked) return;

                let currentVal = 0;
                switch(a.type) {
                    case 'total':       currentVal = DB.user.totalSec; break;
                    case 'lvl':         currentVal = DB.user.level; break;
                    case 'xp':          currentVal = DB.user.lifetimeXP || DB.user.xp; break;
                    case 'streak':      currentVal = DB.user.streak; break;
                    case 'coins_max':   currentVal = DB.user.coins; break;
                    case 'coins_spent': currentVal = DB.user.lifetimeCoinsSpent || 0; break;
                    case 'strict_time': currentVal = DB.user.lifetimeStrictSec || 0; break;
                    case 'pvp_wins':    currentVal = DB.user.pvpWins || 0; break;
                    case 'math_total':  currentVal = DB.user.lifetimeMathSolved || 0; break;
                    case 'themes_count':  currentVal = DB.user.ownedThemes ? DB.user.ownedThemes.length : 0; break;
                    case 'avatars_count': currentVal = DB.user.ownedAvatars ? DB.user.ownedAvatars.length : 0; break;
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫ (–µ—Å–ª–∏ —Ç–∞–π–º–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω)
                    case 'night_study': 
                        if (Timer.active && (hour >= 22 || hour < 4)) currentVal = 1; break;
                    case 'morning_study': 
                        if (Timer.active && (hour >= 5 && hour <= 8)) currentVal = 1; break;
                    case 'lunch_study': 
                        if (Timer.active && hour === 14) currentVal = 1; break;
                }

                if (currentVal >= a.max) {
                    a.unlocked = true;
                    changed = true;
                    App.toast(`üèÖ –ú–µ–¥–∞–ª—å: ${a.title}`);
                    SoundSys.play('level_up'); 
                    FX.confetti();
                }
            });

            if (changed) Data.save();
        },
    };
    const WeeklyReportSys = {
        check() {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 (–í—Å) - 6 (–°–±)
            if (dayOfWeek !== 1) return; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û –ø–æ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞–º

            const today = getUZDate();
            if (DB.user.lastWeeklyReportDate === today) return; // –°–µ–≥–æ–¥–Ω—è —É–∂–µ –≤–∏–¥–µ–ª–∏

            this.show();
        },

        show() {
            // 1. –°—á–∏—Ç–∞–µ–º –≤—Ä–µ–º—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π (–ü–Ω-–í—Å)
            let totalSec = 0;
            let subjectsTime = {};
            
            for (let i = 1; i <= 7; i++) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const key = getUZDate(d);
                const s = DB.history[key] || 0;
                totalSec += s;
            }

            // 2. –ò—â–µ–º —Å–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç –≤ —Å–µ—Å—Å–∏—è—Ö –∑–∞ –Ω–µ–¥–µ–ª—é
            DB.sessions.forEach(sess => {
                const sessDate = new Date(sess.date);
                const diffDays = (new Date() - sessDate) / (1000 * 60 * 60 * 24);
                if (diffDays <= 7) {
                    subjectsTime[sess.subject] = (subjectsTime[sess.subject] || 0) + sess.sec;
                }
            });

            let topSubject = "‚Äî";
            let maxS = 0;
            for (let name in subjectsTime) {
                if (subjectsTime[name] > maxS) {
                    maxS = subjectsTime[name];
                    topSubject = name;
                }
            }

            // 3. –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–º–∏
            const h = Math.floor(totalSec / 3600);
            const m = Math.floor((totalSec % 3600) / 60);

            document.getElementById('wr-time').innerText = `${h}—á ${m}–º`;
            document.getElementById('wr-subject').innerText = topSubject;
            document.getElementById('wr-xp').innerText = `+${Math.floor(totalSec / 60 * 10)} XP`;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ
            document.getElementById('weekly-modal').classList.add('show');
            
            // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ –ø–æ–∫–∞–∑–∞–ª–∏
            DB.user.lastWeeklyReportDate = getUZDate();
            Data.save();
            FX.confetti();
            SoundSys.play('win');
            // –ì—Ä–æ–º–∫–∏–π –∑–≤—É–∫-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            SoundSys.play('quest_done'); 
            if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]);

        }
    };

    const WheelSys = {
        isSpinning: false,
        prizes: [
            { name: "50 üí∞", val: 50, type: "coins", color: "#6C63FF" },
            { name: "10 üí∞", val: 10, type: "coins", color: "#FF7675" },
            { name: "100 XP", val: 100, type: "xp", color: "#00d26a" },
            { name: "üõ°Ô∏è –©–∏—Ç", val: 1, type: "shield", color: "#FFD700" },
            { name: "5 üí∞", val: 5, type: "coins", color: "#FF7675" },
            { name: "‚ö° –ë—É—Å—Ç–µ—Ä", val: 1, type: "booster", color: "#00E0D0" },
            { name: "20 üí∞", val: 20, type: "coins", color: "#6C63FF" },
            { name: "üíé 200 XP", val: 200, type: "xp", color: "#FFD700" }
        ],

        init() {
            const canvas = document.getElementById('wheel-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const arc = Math.PI / (this.prizes.length / 2);

            this.prizes.forEach((p, i) => {
                const angle = i * arc;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.moveTo(100, 100);
                ctx.arc(100, 100, 100, angle, angle + arc, false);
                ctx.fill();
                
                ctx.save();
                ctx.fillStyle = "white";
                ctx.shadowColor = "rgba(0,0,0,0.5)";
                ctx.shadowBlur = 4;
                
                ctx.translate(100 + Math.cos(angle + arc / 2) * 70, 100 + Math.sin(angle + arc / 2) * 70);
                ctx.rotate(angle + arc / 2 + Math.PI / 2);
                ctx.font = "bold 12px Arial"; // –ß—É—Ç—å –∫—Ä—É–ø–Ω–µ–µ
                ctx.fillText(p.name, -ctx.measureText(p.name).width / 2, 0);
                ctx.restore();
            });
        },

        open() {
            this.init();
            const today = getUZDate();
            const btn = document.getElementById('wheel-spin-btn');
            
            if (DB.user.lastSpinDate === today) {
                btn.innerText = "üí∏ –ö–†–£–¢–ò–¢–¨ (50 üí∞)";
                // –í–º–µ—Å—Ç–æ var(--text) –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç –∏–ª–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º primary —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é
                btn.style.background = "#FF7675"; 
                btn.style.color = "white";
            } else {
                btn.innerText = "üöÄ –ö–†–£–¢–ò–¢–¨ –ë–ï–°–ü–õ–ê–¢–ù–û";
                btn.style.background = "var(--primary)";
                btn.style.color = "white";
            }
            document.getElementById('wheel-modal').classList.add('show');
        },

        spin() {
            if (!TimeGuard.isTimeValid) return alert("‚ùå –ö–æ–ª–µ—Å–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ä–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ!");

            if (this.isSpinning) return;
            const today = getUZDate();
            const isPaid = DB.user.lastSpinDate === today;

            if (isPaid) {
                if (DB.user.coins < 50) return App.toast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!");
                DB.user.coins -= 50;
            }

            this.isSpinning = true;
            const canvas = document.getElementById('wheel-canvas');
            const randDeg = 1800 + Math.floor(Math.random() * 360);
            canvas.style.transform = `rotate(${randDeg}deg)`;

            SoundSys.play('click');

            setTimeout(() => {
                this.isSpinning = false;
                const actualDeg = randDeg % 360;
                const prizeIndex = Math.floor((360 - actualDeg) / (360 / this.prizes.length)) % this.prizes.length;
                const prize = this.prizes[prizeIndex];

                this.givePrize(prize);
                DB.user.lastSpinDate = today;
                Data.save();
                App.updateUI();
                
                // üëá –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–ù–û–ü–ö–ò üëá
                const btn = document.getElementById('wheel-spin-btn');
                if (btn) {
                    btn.innerText = "üí∏ –ö–†–£–¢–ò–¢–¨ (50 üí∞)";
                    btn.style.background = "#FF7675"; // –†–æ–∑–æ–≤—ã–π —Ü–≤–µ—Ç –¥–ª—è –ø–ª–∞—Ç–Ω—ã—Ö –∫—Ä—É—Ç–æ–∫
                }
            }, 4000);
        },

        givePrize(p) {
            if (p.type === 'coins') DB.user.coins += p.val;
            if (p.type === 'xp') App.addXP(p.val);
            if (p.type === 'shield') DB.user.inventory.shield = (DB.user.inventory.shield || 0) + 1;
            if (p.type === 'booster') DB.user.inventory.booster = (DB.user.inventory.booster || 0) + 1;

            App.toast(`üéâ –í—ã–∏–≥—Ä—ã—à: ${p.name}`);
            SoundSys.play('win');
            FX.confetti();
        }
    };

    const TimeGuard = {
        isTimeValid: false, // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—Ä–µ–º—è –ù–ï –≤–∞–ª–∏–¥–Ω–æ
        serverTime: null,

        async verify() {
            this.isTimeValid = true; // –¢–µ–ø–µ—Ä—å –≤—Ä–µ–º—è –≤—Å–µ–≥–¥–∞ "–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ"
        },

    };

    const SecretSys = {
        logoTaps: 0,
            versionClicks: 0, // –°—á–µ—Ç—á–∏–∫ –¥–ª—è –∫–æ–¥–æ–≤
        // –í—ã–∑–æ–≤ –æ–∫–Ω–∞ –≤–≤–æ–¥–∞ –∫–æ–¥–∞
        triggerPrompt() {
            this.versionClicks++;
            
            // –ú–∞–ª–µ–Ω—å–∫–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏—è—Ö
            if (this.versionClicks < 5) {
                App.toast(`–ï—â–µ ${5 - this.versionClicks}...`);
            }

            if (this.versionClicks === 5) {
                // –ù–∞–≥—Ä–∞–¥–∞ –∑–∞ –æ—Ç–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –∫–æ–¥–æ–≤
                if (!DB.user.isVersionRewardClaimed) {
                    DB.user.coins += 100;
                    DB.user.isVersionRewardClaimed = true;
                    Data.save();
                    App.updateUI();
                    App.toast("üí∞ –ú–µ–Ω—é –≤–∑–ª–æ–º–∞ –æ—Ç–∫—Ä—ã—Ç–æ: +100 –º–æ–Ω–µ—Ç!");
                    FX.confetti();
                }

                const code = prompt("–í–≤–µ–¥–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥:");
                if (code) this.checkCode(code);
                this.versionClicks = 0; 
            }
        },

        checkCode(input) {
            const code = input.toUpperCase().trim();
            
            if (code === 'MATRIX') {
                document.body.style.transition = "5s linear";
                document.body.style.transform = "skewX(5deg) rotateY(10deg)";
                App.toast("üï∂Ô∏è –°–∏—Å—Ç–µ–º–∞ –≤–∑–ª–æ–º–∞–Ω–∞...");
            }
            
            if (code === 'RAINBOW') {
                App.toast("üåà –†–µ–∂–∏–º –í–ï–ß–ï–†–ò–ù–ö–ò!");
                setInterval(() => {
                    const randomTheme = THEMES[Math.floor(Math.random() * THEMES.length)].id;
                    DB.user.theme = randomTheme;
                    App.updateUI();
                }, 1000);
            }

            if (code === 'GOLD') {
                DB.user.coins += 1000;
                Data.save();
                App.updateUI();
                App.toast("üí∞ –ß–∏—Ç—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã!");
            }
        },

        // 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ –ª–æ–≥–æ—Ç–∏–ø—É
        handleLogoClick() {
            this.logoTaps++;
            const logo = document.querySelector('.app-logo');
            if (logo) {
                logo.classList.add('logo-spin');
                setTimeout(() => logo.classList.remove('logo-spin'), 500);
            }

            if (this.logoTaps === 10) {
                this.showCredits();
                
                // –ù–∞–≥—Ä–∞–¥–∞ –∑–∞ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ –ø–∞—Å—Ö–∞–ª–∫–∏
                if (!DB.user.isLogoRewardClaimed) {
                    DB.user.coins += 100;
                    DB.user.isLogoRewardClaimed = true;
                    Data.save();
                    App.updateUI();
                    App.toast("üí∞ –ù–∞–≥—Ä–∞–¥–∞ –∑–∞ –ª—é–±–æ–ø—ã—Ç—Å—Ç–≤–æ: +100 –º–æ–Ω–µ—Ç!");
                    FX.confetti();
                    SoundSys.play('win');
                }
                this.logoTaps = 0;
            }
        },

        // 2. –°–µ–∫—Ä–µ—Ç–Ω—ã–µ –∫–æ–¥—ã (–≤–≤–æ–¥–∏—Ç—å –≤ –∫–æ–Ω—Å–æ–ª—å –∏–ª–∏ –≤ –ø–æ–ª–µ –∏–º–µ–Ω–∏)
        checkCode(input) {
            const code = input.toUpperCase();
            if (code === 'MATRIX') {
                document.body.style.filter = 'matrix(1, 2, -1, 1, 80, 80)'; // –®—É—Ç–æ—á–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
                App.toast("üï∂Ô∏è Welcome to the Matrix");
            }
            if (code === 'RAINBOW') {
                setInterval(() => {
                    DB.user.theme = THEMES[Math.floor(Math.random() * THEMES.length)].id;
                    App.updateUI();
                }, 1000);
                App.toast("üåà PARTY MODE!");
            }
        },

        showCredits() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ
            alert("üíé –í–´ –ù–ê–®–õ–ò –ü–ê–°–ö–ê–•–õ–ö–£ \n\n–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞: Rustam Mansurov\n–í–µ—Ä—Å–∏—è: 1.0 (PRO Edition)\n\n–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –Ω–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å–≤–æ–∏—Ö —Ü–µ–ª–µ–π!");
            FX.confetti();
            // –ó–∞–ø—É—Å–∫–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
            if (window.FX) FX.confetti();
            
            // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–∑–æ–≤ –∑–≤—É–∫–∞
            try {
                SoundSys.play('level_up'); // 'level_up' –∑–≤—É—á–∏—Ç —Ç–æ—Ä–∂–µ—Å—Ç–≤–µ–Ω–Ω–µ–µ –¥–ª—è —Ç–∏—Ç—Ä–æ–≤
            } catch(e) {
                console.log("–ó–≤—É–∫ –ø–æ–∫–∞ –Ω–µ –≥–æ—Ç–æ–≤");
            }
        },

        // –§—É–Ω–∫—Ü–∏—è –ø–∞—Å—Ö–∞–ª–∫–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ "–û –Ω–∞—Å"
        claimMotivationReward() {
            if (DB.user.isMotivationClaimed) {
                App.toast("üòä –¢—ã —É–∂–µ –∑–∞—Ä—è–∂–µ–Ω –Ω–∞ —É—Å–ø–µ—Ö!");
                return;
            }

            DB.user.coins += 100;
            DB.user.isMotivationClaimed = true; // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—É—é
            
            Data.save();
            App.updateUI();
            
            // –ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
            FX.confetti();
            SoundSys.play('win');
            App.toast("üí∞ –ü–∞—Å—Ö–∞–ª–∫–∞ –Ω–∞–π–¥–µ–Ω–∞! +100 –º–æ–Ω–µ—Ç –∑–∞ –≤–µ—Ä—É –≤ —Å–µ–±—è!");
        }
    };

    const App = {
        async init() { 
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
            if (!navigator.onLine) {
                document.body.innerHTML = this.getOfflineScreen();
                return;
            }

            Auth.init(); 
            InstallSys.init(); 
            TimeGuard.verify();

            // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ç–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
            window.addEventListener('online', () => location.reload());
            window.addEventListener('offline', () => {
                App.toast("‚ùå –°–≤—è–∑—å –ø–æ—Ç–µ—Ä—è–Ω–∞. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç –æ–Ω–ª–∞–π–Ω-—Ä–µ–∂–∏–º.");
                setTimeout(() => location.reload(), 2000);
            });

            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É
            document.addEventListener("visibilitychange", () => {
                if (!document.hidden && Auth.currentUser) {
                    Data.syncWithCloud(); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–±–ª–∞–∫–∞
                }
            });

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js?v=2').catch(err => console.log(err));
            }
        },

        async syncWithCloud() {
            if (!Auth.currentUser || !window.DB_Online) return;

            const docRef = window.DB_Online.doc(window.DB_Online.db, "users", Auth.currentUser.id);
            const docSnap = await window.DB_Online.getDoc(docRef);

            if (docSnap.exists()) {
                const cloud = docSnap.data();
                // –ñ–µ—Å—Ç–∫–æ –∑–∞–º–µ–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–±–ª–∞—á–Ω—ã–º–∏
                // (–¢–∞–∫ –∫–∞–∫ –º—ã —Ç–µ–ø–µ—Ä—å —Å—Ç—Ä–æ–≥–æ –æ–Ω–ª–∞–π–Ω, –æ–±–ª–∞–∫–æ ‚Äî —ç—Ç–æ –∏ –µ—Å—Ç—å –ø—Ä–∞–≤–¥–∞)
                DB = cloud;
                this.cleanSubjects();
                localStorage.setItem(this.currentKey, JSON.stringify(DB));
                App.updateUI();
                console.log("‚òÅÔ∏è –û–±–ª–∞—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
            }
        },
        getOfflineScreen() {
            return `
                <div style="background:#1e1e2e; color:white; height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:20px; font-family:sans-serif;">
                    <div style="font-size:80px; margin-bottom:20px;">üåê</div>
                    <h1>–û–π! –ù—É–∂–µ–Ω –∏–Ω—Ç–µ—Ä–Ω–µ—Ç</h1>
                    <p style="opacity:0.7;">MathBooster PRO —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç—Ä–æ–≥–æ –æ–Ω–ª–∞–π–Ω,<br>—á—Ç–æ–±—ã —Ç–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –≤—Å–µ–≥–¥–∞ –±—ã–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω.</p>
                    <button onclick="location.reload()" style="background:#6C63FF; color:white; border:none; padding:15px 30px; border-radius:12px; font-weight:bold; margin-top:20px;">–ü–û–ü–†–û–ë–û–í–ê–¢–¨ –°–ù–û–í–ê</button>
                </div>
            `;
        },


        async manualSync() {
            if (!window.DB_Online) return App.toast("‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ Firebase!");
            
            const btn = document.getElementById('manual-sync-btn');
            const statusText = document.querySelector('#last-sync-text').nextElementSibling;
            const dot = document.getElementById('sync-status-dot');

            // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞—á–∞–ª–∞
            btn.disabled = true;
            btn.innerText = "‚è≥ –ñ–¥–∏—Ç–µ...";
            dot.style.background = "#FFD700"; // –ñ–µ–ª—Ç—ã–π (–ø—Ä–æ—Ü–µ—Å—Å)
            dot.style.boxShadow = "0 0 10px #FFD700";
            statusText.innerText = "–°—Ç–∞—Ç—É—Å: –ó–∞–≥—Ä—É–∑–∫–∞...";

            try {
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤—ã–∑—ã–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                await Data.save();
                
                // –ò–º–∏—Ç–∏—Ä—É–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è —Å–æ–ª–∏–¥–Ω–æ—Å—Ç–∏ (0.8 —Å–µ–∫)
                await new Promise(r => setTimeout(r, 800));

                // –£—Å–ø–µ—Ö
                const now = new Date();
                const timeStr = now.getHours() + ":" + now.getMinutes().toString().padStart(2, '0');
                
                document.getElementById('last-sync-text').innerText = `–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: –≤ ${timeStr}`;
                statusText.innerText = "–°—Ç–∞—Ç—É—Å: –£—Å–ø–µ—à–Ω–æ!";
                statusText.style.color = "var(--success)";
                dot.style.background = "#00d26a"; // –ó–µ–ª–µ–Ω—ã–π
                dot.style.boxShadow = "0 0 10px #00d26a";
                
                App.toast("‚úÖ –î–∞–Ω–Ω—ã–µ –≤ –æ–±–ª–∞–∫–µ!");
                SoundSys.play('success');
            } catch (e) {
                console.error(e);
                statusText.innerText = "–°—Ç–∞—Ç—É—Å: –û—à–∏–±–∫–∞ —Å–µ—Ç–∏";
                statusText.style.color = "#FF4757";
                dot.style.background = "#FF4757"; // –ö—Ä–∞—Å–Ω—ã–π
                App.toast("‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏");
            } finally {
                btn.disabled = false;
                btn.innerText = "üîÑ –û–±–Ω–æ–≤–∏—Ç—å";
            }
        },
        setText(id, text) {
            const el = document.getElementById(id);
            if (el) {
                el.innerText = text;
            }
        },
    // --- –¶–ò–¢–ê–¢–ê –î–ù–Ø ---
        updateDailyQuote() {
            const quotes = [
                "–í—Ä–µ–º—è ‚Äî —ç—Ç–æ –º–∞—Ç–µ—Ä–∏–∞–ª, –∏–∑ –∫–æ—Ç–æ—Ä–æ–≥–æ —Å–¥–µ–ª–∞–Ω–∞ –∂–∏–∑–Ω—å.",
                "–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –≤ –∑–Ω–∞–Ω–∏—è –ø–ª–∞—Ç—è—Ç –ª—É—á—à–∏–µ –¥–∏–≤–∏–¥–µ–Ω–¥—ã.",
                "–¢—è–∂–µ–ª–æ –≤ —É—á–µ–Ω–∏–∏ ‚Äî –ª–µ–≥–∫–æ –≤ –±–æ—é. (–°—É–≤–æ—Ä–æ–≤)",
                "–ù–µ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–π –Ω–∞ –∑–∞–≤—Ç—Ä–∞ —Ç–æ, —á—Ç–æ –º–æ–∂–Ω–æ –≤—ã—É—á–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è.",
                "–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ ‚Äî —ç—Ç–æ —Ç–æ, —á—Ç–æ –æ—Å—Ç–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –∑–∞–±—ã—Ç–æ –≤—Å–µ, —á–µ–º—É —É—á–∏–ª–∏.",
                "–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ ‚Äî —ç—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –¥–µ–ª–∞—Ç—å —Ç–æ, —á—Ç–æ –Ω–µ —Ö–æ—á–µ—Ç—Å—è, —á—Ç–æ–±—ã –¥–æ—Å—Ç–∏—á—å —Ç–æ–≥–æ, —á—Ç–æ —Ö–æ—á–µ—Ç—Å—è.",
                "–°–¥–µ–ª–∞–π —Å–µ–≥–æ–¥–Ω—è —Ç–æ, —á—Ç–æ –¥—Ä—É–≥–∏–µ –Ω–µ —Ö–æ—Ç—è—Ç, –∑–∞–≤—Ç—Ä–∞ –±—É–¥–µ—à—å –∂–∏—Ç—å —Ç–∞–∫, –∫–∞–∫ –¥—Ä—É–≥–∏–µ –Ω–µ –º–æ–≥—É—Ç.",
                "–£—Å–ø–µ—Ö ‚Äî —ç—Ç–æ —Å—É–º–º–∞ –Ω–µ–±–æ–ª—å—à–∏—Ö —É—Å–∏–ª–∏–π, –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –∏–∑–æ –¥–Ω—è –≤ –¥–µ–Ω—å.",
                "–¢–≤–æ–π –º–æ–∑–≥ ‚Äî —ç—Ç–æ —Ç–≤–æ–π —Å–∞–º—ã–π –¥–æ—Ä–æ–≥–æ–π –∞–∫—Ç–∏–≤. –ö–∞—á–∞–π –µ–≥–æ!",
                "–ì–µ–Ω–∏–π ‚Äî —ç—Ç–æ 1% —Ç–∞–ª–∞–Ω—Ç–∞ –∏ 99% —Ç—Ä—É–¥–∞."
            ];

            const el = document.getElementById('daily-quote');
            if (el) {
                // –í—ã–±–∏—Ä–∞–µ–º —Ü–∏—Ç–∞—Ç—É –ø–æ –¥–Ω—é –º–µ—Å—è—Ü–∞ (—á—Ç–æ–±—ã —É –≤—Å–µ—Ö –±—ã–ª–∞ –æ–¥–Ω–∞ –∏ —Ç–∞ –∂–µ —Å–µ–≥–æ–¥–Ω—è)
                const dayIndex = new Date().getDate(); 
                const quote = quotes[dayIndex % quotes.length];
                el.innerText = `"${quote}"`;
            }
        },
        // –õ–ï–ì–ö–ò–ô –í–•–û–î (–ë–µ–∑ –ª–∞–≥–æ–≤)
        initAfterLogin() {
            QuestSys.render();
            this.updateUI();
            this.updateDailyQuote();
            this.renderMonthlyWidget();

            setTimeout(() => {
                this.renderSubjects();
                SubjectSys.render();
                if (window.Trainer) Trainer.init();
            }, 100);

            setTimeout(() => {
                this.renderHistory();
                if (window.DailySys) DailySys.check(); 
                if (window.AchievementSys) AchievementSys.check();
            }, 400);

            // –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            setTimeout(() => {
                if (DB && DB.settings && DB.settings.notifications && window.Notify) {
                    Notify.startDailyCheck();
                }
            }, 2000);
            const quoteEl = document.querySelector('#dashboard .text-light i') || document.querySelector('#dashboard .card div[style*="opacity: 0.8"]');

            if (quoteEl) {
            // –ë–µ—Ä–µ–º —Å–ª—É—á–∞–π–Ω—É—é
            const randomQuote = QUOTES[Math.floor(Math.random() * QUOTES.length)];
            quoteEl.innerText = `"${randomQuote}"`;
            }
            WeeklyReportSys.check();
            },
        copyId() {
            if (Auth.currentUser && Auth.currentUser.id) {
                navigator.clipboard.writeText(Auth.currentUser.id)
                    .then(() => App.toast("‚úÖ ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!"))
                    .catch(() => prompt("–°–∫–æ–ø–∏—Ä—É–π ID:", Auth.currentUser.id));
            }
            },
        changeNickname() {
            const COST = 500;
            if (DB.user.coins < COST) return App.toast(`‚ùå –ù—É–∂–Ω–æ ${COST} –º–æ–Ω–µ—Ç`);

            const newName = prompt(`–°–º–µ–Ω–∞ –Ω–∏–∫–∞ —Å—Ç–æ–∏—Ç ${COST} –º–æ–Ω–µ—Ç.\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è:`, DB.user.name);
            if (!newName) return;
            const cleanName = newName.trim();
            const validChars = /^[a-zA-Z0-9–∞-—è–ê-–Ø—ë–Å\s._-]+$/;
            if (!validChars.test(cleanName)) {
                return alert("‚õîÔ∏è –≠–º–æ–¥–∑–∏ –∏ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã –∑–∞–ø—Ä–µ—â–µ–Ω—ã!\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã.");
            }
            if (cleanName.length === 0 || cleanName.length > 12) return App.toast("–ò–º—è –æ—Ç 1 –¥–æ 12 —Å–∏–º–≤–æ–ª–æ–≤");
            if (window.NameGuard && !NameGuard.check(cleanName)) return alert("‚õîÔ∏è –ò–º—è –∑–∞–ø—Ä–µ—â–µ–Ω–æ.");

            if (confirm(`–°–º–µ–Ω–∏—Ç—å –Ω–∞ "${cleanName}" –∑–∞ ${COST} –º–æ–Ω–µ—Ç?`)) {
                DB.user.coins -= COST;
                DB.user.name = cleanName;
                Data.save();

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –Ω–∞ –≤—Ö–æ–¥–µ
                try {
                    let users = JSON.parse(localStorage.getItem('MathUsers') || '[]');
                    const index = users.findIndex(u => u.id === Auth.currentUser.id);
                    if (index !== -1) {
                        users[index].name = cleanName;
                        localStorage.setItem('MathUsers', JSON.stringify(users));
                        Auth.users = users;
                        Auth.currentUser.name = cleanName;
                    }
                } catch(e){}

                this.updateUI();
                SoundSys.play('coin');
                App.toast("‚úÖ –ù–∏–∫–Ω–µ–π–º –∏–∑–º–µ–Ω–µ–Ω!");
            }
        },

        toggleDarkMode(enabled) {
            DB.user.darkMode = enabled;
            if (enabled) document.body.classList.add('dark-mode');
            else document.body.classList.remove('dark-mode');
            localStorage.setItem('darkMode', enabled);
            Data.save();
            this.updateUI();
        },
        renderMonthlyWidget() {
            const goalHours = DB.user.monthlyGoal || 40;
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth(); // 0-11

            let totalMonthSec = 0;

            // –°—á–∏—Ç–∞–µ–º —Å—É–º–º—É –≤—Å–µ—Ö —Å–µ–∫—É–Ω–¥ –≤ DB.history –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
            for (let key in DB.history) {
                const date = new Date(key);
                if (date.getFullYear() === year && date.getMonth() === month) {
                    totalMonthSec += DB.history[key];
                }
            }

            const currentHours = Math.floor(totalMonthSec / 3600);
            const currentMins = Math.floor((totalMonthSec % 3600) / 60);
            const pct = Math.min(100, Math.floor((totalMonthSec / (goalHours * 3600)) * 100));

            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById('goal-text').innerText = `${currentHours}—á ${currentMins}–º / ${goalHours}—á`;
            document.getElementById('goal-pct').innerText = `${pct}%`;
            document.getElementById('goal-circle').setAttribute('stroke-dasharray', `${pct}, 100`);
        },

        editMonthlyGoal() {
            const newGoal = prompt("–£—Å—Ç–∞–Ω–æ–≤–∏ —Å–≤–æ—é —Ü–µ–ª—å –Ω–∞ –º–µ—Å—è—Ü (–≤ —á–∞—Å–∞—Ö):", DB.user.monthlyGoal);
            if (newGoal && !isNaN(newGoal) && newGoal > 0) {
                DB.user.monthlyGoal = parseInt(newGoal);
                Data.save();
                this.renderMonthlyWidget();
                App.toast("‚úÖ –¶–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞!");
                SoundSys.play('click');
            }
        },
        updateUI() {
            if(!DB) return;
            
            // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–º–µ–Ω–∞ –∫–ª–∞—Å—Å–æ–≤
            const newClass = `theme-${DB.user.theme} ${DB.user.darkMode ? 'dark-mode' : ''}`.trim();
            if (document.body.className !== newClass) document.body.className = newClass;
            
            const toggle = document.getElementById('dark-toggle');
            if (toggle) toggle.checked = DB.user.darkMode;

            const notifyToggle = document.getElementById('notify-toggle');
            if (notifyToggle && DB.settings) notifyToggle.checked = DB.settings.notifications;

            const rescueEl = document.getElementById('rescue-code-display');
            
            if (rescueEl && DB.user) {
                // 1. –ï—Å–ª–∏ –∫–æ–¥–∞ –µ—â–µ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞–µ–º –µ–≥–æ –æ–¥–∏–Ω —Ä–∞–∑ –∏ –Ω–∞–≤—Å–µ–≥–¥–∞
                if (!DB.user.rescueCode) {
                    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                    let code = '';
                    for (let i = 0; i < 8; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
                    
                    DB.user.rescueCode = code;
                    Data.save();

                    // 2. –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º –µ–≥–æ –≤ Firebase (—á—Ç–æ–±—ã –æ–Ω —Ç–∞–º –ª–µ–∂–∞–ª –≤–µ—á–Ω–æ)
                    if(window.DB_Online) {
                        const docRef = window.DB_Online.doc(window.DB_Online.db, "transfers", code);
                        window.DB_Online.setDoc(docRef, {
                            userId: Auth.currentUser.id,
                            data: DB,
                            isPermanent: true, // –ú–µ—Ç–∫–∞, —á—Ç–æ —ç—Ç–æ –≤–µ—á–Ω—ã–π –∫–æ–¥
                            updatedAt: new Date().toISOString()
                        }, { merge: true });
                    }
                }

                // 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–¥ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
                rescueEl.innerText = DB.user.rescueCode;
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤
            this.setText('coin-display', DB.user.coins);
            this.setText('streak-display', DB.user.streak);
            this.setText('header-name', DB.user.name || '–ò–≥—Ä–æ–∫');
            this.setText('header-avatar', DB.user.avatar || 'üòé');
            this.setText('profile-name-big', DB.user.name || '–ò–≥—Ä–æ–∫');
            this.setText('profile-avatar-big', DB.user.avatar || 'üòé');
            this.setText('streak-display', DB.user.dailyStreak);
            this.setText('profile-id-text', Auth.currentUser ? Auth.currentUser.id : "...");

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–∞ –ø–æ–¥ —Ç–∞–π–º–µ—Ä–æ–º
            const currentSub = DB.subjects[DB.user.subject];
            const titleEl = document.getElementById('subject-title');
            if (titleEl) {
                titleEl.innerText = currentSub ? currentSub.name : "–í—ã–±–µ—Ä–∏ –ø—Ä–µ–¥–º–µ—Ç";
            }

            // --- –°–¢–ê–¢–£–°–´ –ò –õ–ò–ì–ò (PRO) ---
            let currentLeague = LEAGUES[0];
            let nextLeague = null;

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é –∏ —Å–ª–µ–¥—É—é—â—É—é –ª–∏–≥–∏
            for (let i = 0; i < LEAGUES.length; i++) {
                if (DB.user.level >= LEAGUES[i].min) {
                    currentLeague = LEAGUES[i];
                    nextLeague = LEAGUES[i + 1] || null;
                }
            }
            
            // 1. –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞
            let statusText = currentLeague.name; 
            if (DB.user.currentTitle) {
                statusText = DB.user.currentTitle; // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∫—É–ø–ª–µ–Ω–Ω–æ–º—É —Ç–∏—Ç—É–ª—É
            }

            // 2. –†–∞—Å—á–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –ª–∏–≥–∏ (–≤ –ø—Ä–æ—Ñ–∏–ª–µ)
            const leagueProgressInfo = document.getElementById('league-progress-info');
            if (leagueProgressInfo) {
                if (nextLeague) {
                    const lvlsNeeded = nextLeague.min - DB.user.level;
                    leagueProgressInfo.innerText = `–î–æ —Å–ª–µ–¥—É—é—â–µ–π –ª–∏–≥–∏: ${lvlsNeeded} —É—Ä.`;
                } else {
                    leagueProgressInfo.innerText = `üèÜ –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ô –†–ê–ù–ì`;
                }
            }

            // 2. –î–æ–±–∞–≤–ª—è–µ–º –≠–º–æ–¥–∑–∏ –î–æ–Ω–∞—Ç–µ—Ä–∞ (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ö–æ—Ä–æ–ª—å > VIP)
            if (DB.user.isKing) {
                statusText = `üëë ${statusText}`; // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–æ–Ω—É
            } else if (DB.user.isVip) {
                statusText = `üíé ${statusText}`; // –î–æ–±–∞–≤–ª—è–µ–º –±—Ä–∏–ª–ª–∏–∞–Ω—Ç
            } 
            // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å–∞ –Ω–µ—Ç, –Ω–æ –µ—Å—Ç—å –∫—É–ø–ª–µ–Ω–Ω—ã–π —Ç–∏—Ç—É–ª - –¥–æ–±–∞–≤–∏–º –∑–≤–µ–∑–¥–æ—á–∫—É –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
            else if (DB.user.currentTitle) {
                statusText = `‚òÖ ${statusText}`;
            }

            // 3. –í—ã–≤–æ–¥–∏–º –Ω–∞ —ç–∫—Ä–∞–Ω
            this.setText('header-league', statusText);
            this.setText('profile-league-big', statusText);

            // –ë–ª–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π)
            const nBox = document.getElementById('notify-time-box');
            const nInput = document.getElementById('notify-time-input');
            const nToggle = document.getElementById('notify-toggle');

            if (DB.settings) {
                if (nToggle) nToggle.checked = DB.settings.notifications || false;
                if (nBox && nInput) {
                    nBox.style.display = DB.settings.notifications ? 'flex' : 'none';
                    nInput.value = DB.settings.notifyTime || "19:00";
                }
            }
            // –ê–≤–∞—Ç–∞—Ä–∫–∏ —Å —Ä–∞–º–∫–∞–º–∏
            const headerBox = document.getElementById('header-avatar-box');
            const pb = document.getElementById('profile-avatar-box');

            const applyStyles = (el) => {
                if (!el) return;
                el.className = 'profile-img'; 
                el.classList.add(currentLeague.color); 
                if (DB.user.currentFrame) {
                    el.classList.add('framed');
                    el.classList.add(DB.user.currentFrame);
                }
            };
            applyStyles(headerBox);
            applyStyles(pb);

            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    let subjectsSum = 0;
            if (DB && DB.subjects) {
                Object.values(DB.subjects).forEach(s => {
                    if (s && typeof s.sec === 'number') subjectsSum += s.sec;
                });
            }
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤ –ø–∞–º—è—Ç–∏
            DB.user.totalSec = subjectsSum;

            // üëá –í–û–ó–í–†–ê–©–ê–ï–ú –ü–ï–†–ï–ú–ï–ù–ù–£–Æ 'h', –ß–¢–û–ë–´ –ù–ï –ë–´–õ–û –û–®–ò–ë–ö–ò üëá
            const h = (DB.user.totalSec / 3600).toFixed(1);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —ç–∫—Ä–∞–Ω–µ
            this.setText('stat-total-time', h + '—á');
            this.setText('timer', new Date(Timer.sec * 1000).toISOString().substr(11, 8))        
            this.setText('stat-total-time', h + '—á');
            this.setText('prof-lvl', DB.user.level);
            this.setText('prof-xp', DB.user.xp);
            this.setText('prof-coins', DB.user.coins);
            
            const xpBar = document.getElementById('prof-xp-bar');
            if(xpBar) xpBar.style.width = (DB.user.xp/DB.user.nextXp*100)+'%';
            this.setText('xp-progress-text', `${DB.user.xp} / ${DB.user.nextXp} XP`);
            
            // –†–µ–Ω–¥–µ—Ä –Ω–∞–≥—Ä–∞–¥ (–µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç - —á–∏–Ω–∏–º)
            const achList = document.getElementById('ach-list');
            if (achList) {
                if (!DB.achievements || DB.achievements.length === 0) {
                    DB.achievements = GenAch();
                    Data.save();
                }
                achList.innerHTML = DB.achievements.map(a => {
                    let currentVal = 0;
                    if (a.type === 'total') currentVal = DB.user.totalSec;
                    else if (a.type === 'lvl') currentVal = DB.user.level;
                    else if (a.type === 'xp') currentVal = DB.user.lifetimeXP || DB.user.xp;
                    
                    const pct = Math.min(100, (currentVal / a.max) * 100);
                    const isUnlocked = a.unlocked || (pct >= 100);
                    return `<div class="ach-row ${isUnlocked ? 'unlocked' : ''}"><div class="ach-icon">${isUnlocked ? '‚úÖ' : a.icon}</div><div class="ach-info"><div class="ach-title"><span>${a.title}</span></div><div class="ach-desc">${a.desc}</div><div class="ach-bar-bg"><div class="ach-bar-fill" style="width:${pct}%; background:${isUnlocked?'#00d26a':'var(--primary)'}"></div></div><div style="font-size:10px;text-align:right;margin-top:2px;color:var(--text-light)">${Math.floor(currentVal)} / ${a.max}</div></div></div>`;
                }).join('');
            }
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∑–æ–ª–æ—Ç–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ –¥–ª—è –≤–µ—Ç–µ—Ä–∞–Ω–æ–≤
            const profileCard = document.querySelector('#profile .card');
            if (profileCard) {
                if (DB.user.streak >= 14) profileCard.classList.add('veteran-card');
                else profileCard.classList.remove('veteran-card');
            }
            // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –±—É—Å—Ç–µ—Ä–∞ –≤ —à–∞–ø–∫–µ –∏–ª–∏ –ø—Ä–æ—Ñ–∏–ª–µ
            const isBoosterActive = Date.now() < (DB.user.boosterExpiry || 0);
            const streakEl = document.getElementById('streak-display'); // –ò—â–µ–º –æ–≥–æ–Ω—å –≤ —à–∞–ø–∫–µ
            
            if (streakEl) {
                if (isBoosterActive) {
                    streakEl.parentElement.style.boxShadow = "0 0 10px #00E0D0";
                    streakEl.parentElement.style.borderColor = "#00E0D0";
                } else {
                    streakEl.parentElement.style.boxShadow = "";
                    streakEl.parentElement.style.borderColor = "";
                }
            }
            // –ë–ª–æ–∫ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –•–∞—Ä–¥–∫–æ—Ä–∞
            const strictToggle = document.getElementById('strict-mode-toggle');
            if (strictToggle) {
                // –ï—Å–ª–∏ —Ç–∞–π–º–µ—Ä –ù–ï –∞–∫—Ç–∏–≤–µ–Ω ‚Äî –∫–Ω–æ–ø–∫–∞ –î–û–õ–ñ–ù–ê –Ω–∞–∂–∏–º–∞—Ç—å—Å—è
                if (!Timer.active) {
                    strictToggle.disabled = false;
                } else {
                    strictToggle.disabled = true; // –ë–ª–æ–∫–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –≤–æ –≤—Ä–µ–º—è —É—á–µ–±—ã
                }
            }
        },
    // –í–Ω—É—Ç—Ä–∏ –æ–±—ä–µ–∫—Ç–∞ App:

        copyRescueCode() {
            const code = DB.user.rescueCode;
            if (!code) return;
            
            navigator.clipboard.writeText(code).then(() => {
                alert(`‚úÖ –ö–û–î –°–ö–û–ü–ò–†–û–í–ê–ù: ${code}\n\n–°—Ä–æ—á–Ω–æ –æ—Ç–ø—Ä–∞–≤—å –µ–≥–æ —Å–µ–±–µ –≤ –¢–µ–ª–µ–≥—Ä–∞–º (–≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ) –∏–ª–∏ –∑–∞–ø–∏—à–∏ –≤ –ó–∞–º–µ—Ç–∫–∏!\n\n–ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É–¥–∞–ª–∏—Ç—Å—è, –Ω–∞–∂–º–∏ "–£ –º–µ–Ω—è –µ—Å—Ç—å –∫–æ–¥" –∏ –≤–≤–µ–¥–∏ –µ–≥–æ.`);
            }).catch(() => {
                prompt("–°–∫–æ–ø–∏—Ä—É–π —ç—Ç–æ—Ç –∫–æ–¥ –∏ —Å–æ—Ö—Ä–∞–Ω–∏:", code);
            });
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –≤ –æ–±–ª–∞–∫–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å
            if(window.DB_Online) {
                const docRef = window.DB_Online.doc(window.DB_Online.db, "transfers", code);
                window.DB_Online.setDoc(docRef, {
                    userId: Auth.currentUser.id,
                    data: DB,
                    updatedAt: new Date().toISOString()
                }, { merge: true });
            }
        },
        // –ú–ê–ì–ê–ó–ò–ù (–û—Ç—Ä–∏—Å–æ–≤–∫–∞)
        renderShop() {
            // –¢–µ–º—ã
            const themeList = document.getElementById('theme-list');
            if (themeList) {
                themeList.innerHTML = THEMES.map(t => {
                    const owned = DB.user.ownedThemes.includes(t.id);
                    const active = DB.user.theme === t.id;
                    return `
                        <div class="shop-item ${active ? 'active' : ''}" onclick="App.buyTheme('${t.id}')">
                            <div style="font-size:24px; margin-bottom:5px;">${t.icon}</div>
                            <div style="font-weight:bold; font-size:12px;">${t.name}</div>
                            ${owned ? '' : `
                        <small class="shop-price-tag">${t.price} üí∞</small>`}
                        </div>`;
                }).join('');
            }
            // –ê–≤–∞—Ç–∞—Ä—ã
            const avatarList = document.getElementById('avatar-shop-list');
            if (avatarList) {
                // üîç –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ü–û –ü–û–õ–£
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–≤–∞—Ç–∞—Ä, –µ—Å–ª–∏ —É –Ω–µ–≥–æ –Ω–µ—Ç –º–µ—Ç–∫–∏ –ø–æ–ª–∞ (–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π) 
                // –ò–õ–ò –µ—Å–ª–∏ –µ–≥–æ –ø–æ–ª —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ø–æ–ª–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userGender = DB.user.gender || 'male'; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é male
                const filteredAvatars = SHOP_AVATARS.filter(a => !a.gender || a.gender === userGender);

                avatarList.innerHTML = filteredAvatars.map(a => {
                    const owned = DB.user.ownedAvatars.includes(a.id);
                    const active = DB.user.avatar === a.icon;
                    const priceClass = (DB.user.coins >= a.price) ? 'affordable' : '';
                    return `
                        <div class="shop-item ${active ? 'active' : ''}" onclick="App.buyAvatar('${a.id}')">
                            <div style="font-size: 32px; margin-bottom: 5px;">${a.icon}</div>
                            <div style="font-size: 11px; font-weight: bold; margin-bottom: 3px; line-height: 1.2;">${a.name}</div>
                            ${owned ? '<small style="color:var(--success); font-weight:bold;">‚úî –ï—Å—Ç—å</small>' : `<small class="shop-price-tag ${priceClass}">${a.price} üí∞</small>`}
                        </div>`;
                }).join('');
            }
            // –°—Ç–∞—Ç—É—Å—ã
            const titleList = document.getElementById('title-shop-list');
            if (titleList) {
                // –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –º–∞—Å—Å–∏–≤–∞
                const userTitles = DB.user.ownedTitles || [];
                
                titleList.innerHTML = SHOP_TITLES.map(t => {
                    const owned = userTitles.includes(t.id);
                    const active = DB.user.currentTitle === t.name;
                    const priceClass = (DB.user.coins >= t.price) ? 'affordable' : '';

                    // 1. –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–µ–Ω (–Ω–∞–¥–µ—Ç)
                    if (active) {
                        return `<div class="shop-item active" onclick="App.equipTitle(null)" style="border-color:var(--success);">
                            <div style="font-weight:bold; font-size:14px; margin-bottom:5px;">${t.name}</div>
                            <small style="color:var(--success);">–í—ã–±—Ä–∞–Ω–æ (–°–Ω—è—Ç—å)</small>
                        </div>`;
                    }
                    
                    // 2. –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å —É–∂–µ –∫—É–ø–ª–µ–Ω/–ø–æ–ª—É—á–µ–Ω (–º–æ–∂–Ω–æ –Ω–∞–¥–µ—Ç—å)
                    if (owned) {
                        return `<div class="shop-item" onclick="App.equipTitle('${t.name}')">
                            <div style="font-weight:bold; font-size:14px; margin-bottom:5px;">${t.name}</div>
                            <small style="color:var(--text-light);">–ù–∞–¥–µ—Ç—å</small>
                        </div>`;
                    }

                    // 3. –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –≠–ö–°–ö–õ–Æ–ó–ò–í–ù–´–ô (–¶–µ–Ω–∞ -1) - –ü–æ–∫—É–ø–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞
                    if (t.price === -1) {
                        return `<div class="shop-item" style="opacity:0.7; cursor:not-allowed; border: 1px dashed var(--accent);">
                            <div style="font-weight:bold; font-size:14px; margin-bottom:5px; color:var(--accent);">${t.name}</div>
                            <small style="color:var(--accent);">–¢–æ–ª—å–∫–æ –∑–∞ –¥–æ–Ω–∞—Ç</small>
                        </div>`;
                    }

                    // 4. –û–±—ã—á–Ω–∞—è –ø–æ–∫—É–ø–∫–∞ –∑–∞ –º–æ–Ω–µ—Ç—ã
                    return `<div class="shop-item" onclick="App.buyTitle('${t.id}')">
                        <div style="font-weight:bold; font-size:14px; margin-bottom:5px;">${t.name}</div>
                        <small class="shop-price-tag ${priceClass}">${t.price} üí∞</small>
                    </div>`;
                }).join('');
            }

            // –†–∞–º–∫–∏
    // –†–∞–º–∫–∏ (–í–ù–£–¢–†–ò renderShop)
            const frameList = document.getElementById('frame-shop-list');
            if (frameList) {
                const userFrames = DB.user.ownedFrames || [];
                frameList.innerHTML = SHOP_FRAMES.map(f => {
                    const owned = userFrames.includes(f.id);
                    const active = DB.user.currentFrame === f.css;
                    const priceClass = (DB.user.coins >= f.price) ? 'affordable' : '';
                    return `
                        <div class="shop-item ${active ? 'active' : ''}" onclick="App.buyFrame('${f.id}')" style="overflow: visible; padding-top: 25px;">
                            <div style="height:40px; width:40px; margin:0 auto 10px auto; border-radius:50%; background:#eee; position:relative;" class="${f.css}"></div>
                            <div style="font-weight:bold; font-size:12px;">${f.name}</div>
                            ${owned ? '' : `<small class="shop-price-tag ${priceClass}">${f.price} üí∞</small>`}
                        </div>`;
                }).join('');
            }
            // –ó–≤—É–∫–∏
            const soundList = document.getElementById('sound-shop-list');
            if (soundList) {
                const userSounds = DB.user.ownedSounds || ['standard'];
                soundList.innerHTML = SHOP_SOUNDS.map(s => {
                    const owned = userSounds.includes(s.id);
                    const active = DB.user.soundPack === s.id;
                    const priceClass = (DB.user.coins >= s.price) ? 'affordable' : '';
                    return `<div class="shop-item ${active ? 'active' : ''}" onclick="App.buySound('${s.id}')"><div style="font-size:24px;">üîä</div><div style="font-weight:bold; font-size:12px;">${s.name}</div>${owned ? '' : `<small class="shop-price-tag ${priceClass}">${s.price} üí∞</small>`}</div>`;
                }).join('');
            }
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ (–©–∏—Ç–æ–≤)
            const itemList = document.getElementById('item-shop-list');
            if (itemList) {
                itemList.innerHTML = SHOP_ITEMS.map(item => {
                    const count = (DB.user.inventory && DB.user.inventory[item.id]) || 0;
                    let actionText = `${item.price} üí∞`;
                    let isAffeat = (DB.user.coins >= item.price);

                    // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –±—É—Å—Ç–µ—Ä–∞
                    if (item.id === 'booster') {
                        const now = Date.now();
                        const expiry = DB.user.boosterExpiry || 0;
                        if (now < expiry) {
                            const diff = expiry - now;
                            const h = Math.floor(diff / (1000 * 60 * 60));
                            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                            actionText = `‚ö° ${h}—á ${m}–º`;
                            isAffeat = false; // –û—Ç–∫–ª—é—á–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Ü–µ–Ω—ã
                        }
                    }

                    return `
                        <div class="shop-item" onclick="App.buyItem('${item.id}', ${item.price})">
                            <div style="font-size: 32px;">${item.icon}</div>
                            <div style="font-weight:bold; font-size:12px;">${item.name}</div>
                            <div style="font-size:9px; color:var(--text-light); line-height:1.1; margin: 5px 0;">${item.desc}</div>
                            <div class="shop-price-tag ${isAffeat ? 'affordable' : ''}" style="font-size:11px;">${actionText}</div>
                            ${item.id === 'shield' && count > 0 ? `<div style="background:var(--primary); color:white; border-radius:10px; font-size:10px; margin-top:5px;">–ó–∞–ø–∞—Å: ${count}</div>` : ''}
                        </div>`;
                }).join('');
            }
        },

        // –§–£–ù–ö–¶–ò–ò –ü–û–ö–£–ü–û–ö
        buyTheme(id) {
            const t = THEMES.find(x=>x.id===id);
            if(DB.user.ownedThemes.includes(id)) { 
                DB.user.theme=id; Data.save(); this.updateUI(); this.renderShop(); SoundSys.play('click'); 
            } else if(DB.user.coins >= t.price && confirm(`–ö—É–ø–∏—Ç—å –∑–∞ ${t.price}?`)) {
                DB.user.coins -= t.price; 
                DB.user.lifetimeCoinsSpent = (DB.user.lifetimeCoinsSpent || 0) + t.price;
                DB.user.ownedThemes.push(id); DB.user.theme=id; Data.save(); this.updateUI(); this.renderShop(); SoundSys.play('success'); FX.confetti();
            } else { App.toast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç"); SoundSys.play('error'); }
        },
        buyAvatar(id) {
            const a = SHOP_AVATARS.find(x => x.id === id);
            if (DB.user.ownedAvatars.includes(id)) { 
                DB.user.avatar = a.icon; Data.save(); 
                // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞ –≤—Ö–æ–¥–µ
                try { let u=JSON.parse(localStorage.getItem('MathUsers')); u.find(x=>x.id===Auth.currentUser.id).avatar=a.icon; localStorage.setItem('MathUsers',JSON.stringify(u)); } catch(e){}
                this.updateUI(); this.renderShop(); SoundSys.play('click');
            } else if (DB.user.coins >= a.price) {
                if(confirm(`–ö—É–ø–∏—Ç—å "${a.name}"?`)) {
                    DB.user.coins -= a.price; 
                    DB.user.lifetimeCoinsSpent = (DB.user.lifetimeCoinsSpent || 0) + a.price;
                    DB.user.ownedAvatars.push(id); 
                    DB.user.avatar = a.icon; 
                    Data.save(); 
                    try { let u=JSON.parse(localStorage.getItem('MathUsers')); 
                    u.find(x=>x.id===Auth.currentUser.id).avatar=a.icon; localStorage.setItem('MathUsers',JSON.stringify(u)); } catch(e){}
                    this.updateUI(); 
                    this.renderShop(); 
                    SoundSys.play('success'); 
                    FX.confetti();
                }
            } else { App.toast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç"); SoundSys.play('error'); }
        },
        buyTitle(id) {
            const t = SHOP_TITLES.find(x => x.id === id);
            if (DB.user.ownedTitles.includes(id)) { this.equipTitle(t.name); } 
            else if (DB.user.coins >= t.price) {
                if (confirm(`–ö—É–ø–∏—Ç—å —Å—Ç–∞—Ç—É—Å "${t.name}"?`)) {
                    DB.user.coins -= t.price; 
                    DB.user.lifetimeCoinsSpent = (DB.user.lifetimeCoinsSpent || 0) + t.price;
                    DB.user.ownedTitles.push(id); this.equipTitle(t.name); FX.confetti();
                }
            } else { App.toast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç"); }
        },
        equipTitle(name) {
            DB.user.currentTitle = name; Data.save(); this.updateUI(); this.renderShop(); SoundSys.play('click');
        },
        buyFrame(id) {
            const f = SHOP_FRAMES.find(x => x.id === id);
            if (DB.user.ownedFrames.includes(id)) { DB.user.currentFrame = f.css; Data.save(); this.updateUI(); this.renderShop(); SoundSys.play('click'); } 
            else if (DB.user.coins >= f.price) {
                if (confirm(`–ö—É–ø–∏—Ç—å —Ä–∞–º–∫—É "${f.name}"?`)) {
                    DB.user.coins -= f.price; 
                    DB.user.lifetimeCoinsSpent = (DB.user.lifetimeCoinsSpent || 0) + f.price;

                    DB.user.ownedFrames.push(id); DB.user.currentFrame = f.css; Data.save(); this.updateUI(); this.renderShop(); SoundSys.play('success'); FX.confetti();
                }
            } else { App.toast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç"); }
        },
        buySound(id) {
            const s = SHOP_SOUNDS.find(x => x.id === id);
            if (DB.user.ownedSounds.includes(id)) { DB.user.soundPack = id; Data.save(); this.renderShop(); SoundSys.play('success'); App.toast(`–ó–≤—É–∫–∏: ${s.name}`); } 
            else if (DB.user.coins >= s.price) {
                if (confirm(`–ö—É–ø–∏—Ç—å –∑–≤—É–∫–∏ "${s.name}"?`)) {
                    DB.user.coins -= s.price;
                    DB.user.lifetimeCoinsSpent = (DB.user.lifetimeCoinsSpent || 0) + s.price;

                    DB.user.ownedSounds.push(id); DB.user.soundPack = id; Data.save(); this.renderShop(); SoundSys.play('win');
                }
            } else { App.toast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç"); }
        },
        async buyItem(id, price) {
            if (DB.user.coins < price) return App.toast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç");

            const today = getUZDate();

            // –û–°–û–ë–ê–Ø –õ–û–ì–ò–ö–ê –î–õ–Ø –ë–£–°–¢–ï–†–ê
            if (id === 'booster') {
                // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ (1 —Ä–∞–∑ –≤ –¥–µ–Ω—å)
                if (DB.user.lastBoosterPurchase === today) {
                    return alert("üö´ –ë—É—Å—Ç–µ—Ä –º–æ–∂–Ω–æ –ø–æ–∫—É–ø–∞—Ç—å —Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å!");
                }

                if (confirm(`–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –î–≤–æ–π–Ω–æ–π –û–ø—ã—Ç –Ω–∞ 24 —á–∞—Å–∞ –∑–∞ ${price} üí∞?`)) {
                    DB.user.coins -= price;
                    DB.user.lifetimeCoinsSpent = (DB.user.lifetimeCoinsSpent || 0) + price;
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É –ø–æ–∫—É–ø–∫–∏ (–ª–∏–º–∏—Ç)
                    DB.user.lastBoosterPurchase = today;
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è (—Å–µ–π—á–∞—Å + 24 —á–∞—Å–∞)
                    DB.user.boosterExpiry = Date.now() + (24 * 60 * 60 * 1000);
                    
                    App.toast("‚ö° –ë–£–°–¢–ï–† –ê–ö–¢–ò–í–ò–†–û–í–ê–ù –ù–ê 24 –ß–ê–°–ê!");
                    SoundSys.play('win');
                    FX.confetti();
                }
            } 
            // –õ–æ–≥–∏–∫–∞ –¥–ª—è –©–∏—Ç–∞ –∏ –¥—Ä—É–≥–∏—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤ (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å)
            else {
                if (confirm(`–ö—É–ø–∏—Ç—å ${id} –∑–∞ ${price} üí∞?`)) {
                    DB.user.coins -= price;
                    DB.user.lifetimeCoinsSpent = (DB.user.lifetimeCoinsSpent || 0) + price;
                    if (!DB.user.inventory) DB.user.inventory = {};
                    DB.user.inventory[id] = (DB.user.inventory[id] || 0) + 1;
                    App.toast("‚úÖ –ö—É–ø–ª–µ–Ω–æ");
                    SoundSys.play('win');
                }
            }

            Data.save();
            this.updateUI();
            this.renderShop();
        },
        addXP(n) { 
            const isBoosterActive = Date.now() < (DB.user.boosterExpiry || 0);
            let finalXP = isBoosterActive ? n * 2 : n;        
            
            DB.user.xp += n; 
            if (!DB.user.lifetimeXP) DB.user.lifetimeXP = 0;
            DB.user.lifetimeXP += n;

            if(DB.user.xp >= DB.user.nextXp){
                DB.user.level++; 
                DB.user.xp = DB.user.xp - DB.user.nextXp; 
                DB.user.nextXp = Math.floor(DB.user.nextXp * 1.2); 
                // –ü–†–û–í–ï–†–ö–ê –û–¢–ö–†–´–¢–ò–Ø –¢–ò–¢–£–õ–û–í –õ–ò–ì
                const leagueTitles = {
                    5:  { id: 'silver_rank', name: '–°–µ—Ä–µ–±—Ä—è–Ω—ã–π –í–æ–∏–Ω' },
                    10: { id: 'gold_rank',   name: '–ó–æ–ª–æ—Ç–æ–π –ú–∞–≥–∏—Å—Ç—Ä' },
                    20: { id: 'plat_rank',   name: '–ü–ª–∞—Ç–∏–Ω–æ–≤—ã–π –õ–æ—Ä–¥' },
                    35: { id: 'diam_rank',   name: '–ê–ª–º–∞–∑–Ω—ã–π –¢–∏—Ç–∞–Ω' },
                    50: { id: 'legend_rank', name: '–õ–ï–ì–ï–ù–î–ê' }
                };

                if (leagueTitles[DB.user.level]) {
                    const reward = leagueTitles[DB.user.level];
                    if (!DB.user.ownedTitles.includes(reward.id)) {
                        DB.user.ownedTitles.push(reward.id);
                        App.toast(`üéñÔ∏è –ù–æ–≤—ã–π —Ç–∏—Ç—É–ª: ${reward.name}`);
                    }
                }
                // üî• –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ê–Ø –ù–ê–ì–†–ê–î–ê: 50 –º–æ–Ω–µ—Ç + 10 –∑–∞ –∫–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å
                const reward = 50 + (DB.user.level * 10);
                DB.user.coins += reward;

                document.getElementById('lvl-up-new-level').innerText = DB.user.level;
                // –û–±–Ω–æ–≤–∏–º —Ç–µ–∫—Å—Ç –Ω–∞–≥—Ä–∞–¥—ã –≤ –º–æ–¥–∞–ª–∫–µ (–µ—Å–ª–∏ –µ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç —Å id="lvl-up-reward")
                const rewardEl = document.querySelector('#levelup-modal b'); 
                if(rewardEl) rewardEl.innerText = `+${reward} üí∞`;

                document.getElementById('levelup-modal').classList.add('show');
                FX.confetti(); SoundSys.play('level_up'); 
            } 
            Data.save(); this.updateUI(); AchievementSys.check();
        },

        switchTab(id, btn) {
            // üîí –ó–ê–©–ò–¢–ê –•–ê–†–î–ö–û–†–ê: –ù–µ –¥–∞–µ–º —É–π—Ç–∏ —Å –î–∞—à–±–æ—Ä–¥–∞, –µ—Å–ª–∏ –∏–¥–µ—Ç –∂–µ—Å—Ç–∫–∞—è —Å–µ—Å—Å–∏—è
            if (Timer.active && Timer.isStrict && id !== 'dashboard') {
                SoundSys.play('error');
                App.toast("üîí –í —Ä–µ–∂–∏–º–µ –•–ê–†–î–ö–û–† –Ω–µ–ª—å–∑—è —É—Ö–æ–¥–∏—Ç—å —Å —ç–∫—Ä–∞–Ω–∞!");
                return;
            }
            document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
            const sec = document.getElementById(id);
            if(sec) sec.classList.add('active');
        
            document.querySelectorAll('.nav-btn').forEach(x => x.classList.remove('active'));
            if(btn) btn.classList.add('active');
        
            // --- –õ–ï–ù–ò–í–ê–Ø –ó–ê–ì–†–£–ó–ö–ê ---
            if (id === 'dashboard') {
                this.renderMonthlyWidget();

                QuestSys.render(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–≤–µ—Å—Ç—ã
                setTimeout(() => this.renderSubjects(), 50); // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–º–µ—Ç—ã
            }
            
            if (id === 'trainer') setTimeout(() => Trainer.init(), 50);
            if (id === 'stats') setTimeout(() => { this.renderHistory(); this.renderStats(); }, 50);
            if (id === 'shop') this.renderShop();
            if (id === 'profile') this.updateUI();

            if (typeof ym !== 'undefined') ym(105919372, 'hit', '#' + id, { title: id.toUpperCase() });
        },
        
        renderStats() {
            const statsSection = document.getElementById('stats');
            if (!statsSection || !statsSection.classList.contains('active')) return;

            // 1. –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–´–ô –ü–ï–†–ï–°–ß–ï–¢ –í–°–ï–ì–û –í–†–ï–ú–ï–ù–ò (–°—É–º–º–∞ –≤—Å–µ—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤)
            let totalSec = 0;
            if (DB.subjects) {
                Object.values(DB.subjects).forEach(s => {
                    if (s && typeof s.sec === 'number') totalSec += s.sec;
                });
            }
            DB.user.totalSec = totalSec; // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –±–∞–∑–µ

            // 2. –†–ê–°–ß–ï–¢ –ó–ê –ù–ï–î–ï–õ–Æ –ò –ú–ï–°–Ø–¶ (–∏–∑ –∏—Å—Ç–æ—Ä–∏–∏)
            const currentTimestamp = new Date().getTime();
            let weekSec = 0, monthSec = 0;
            
            for (let i = 0; i < 30; i++) {
                const d = new Date(currentTimestamp - (i * 86400000));
                const key = getUZDate(d);
                const seconds = (DB.history && DB.history[key]) ? DB.history[key] : 0;
                monthSec += seconds;
                if (i < 7) weekSec += seconds; 
            }

            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ–∫—Å—Ç–∞
            const fmtTime = (s) => {
                const h = Math.floor(s / 3600);
                const m = Math.floor((s % 3600) / 60);
                return h > 0 ? `${h}—á ${m}–º` : `${m}–º`;
            };
            const estXP = (s) => Math.floor(s / 60) * 10;

            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Ä—Ö–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
            this.setText('stat-week-time', fmtTime(weekSec));
            this.setText('stat-week-xp', `~${estXP(weekSec)} XP`);
            this.setText('stat-month-time', fmtTime(monthSec));
            this.setText('stat-month-xp', `~${estXP(monthSec)} XP`);
            this.setText('stat-total-time', fmtTime(DB.user.totalSec));
            
            const totalXP = DB.user.lifetimeXP || DB.user.xp || 0; 
            this.setText('stat-total-xp', `${totalXP.toLocaleString()} XP`);

            // 3. –û–¢–†–ò–°–û–í–ö–ê –°–ü–ò–°–ö–ê –ü–†–ï–î–ú–ï–¢–û–í (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ html is not defined)
            const breakdownEl = document.getElementById('subject-breakdown');
            if (breakdownEl && DB.subjects) {
                let html = ''; // –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                const subjectsArray = Object.values(DB.subjects).sort((a, b) => b.sec - a.sec);

                html = subjectsArray.map(s => {
                    if (s.sec < 1) return '';
                    const h = (s.sec / 3600).toFixed(1);
                    return `
                    <div style="margin-bottom: 10px; background: var(--bg); padding: 12px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 20px;">${s.icon || 'üìö'}</span>
                            <div style="font-weight: bold; font-size: 14px;">${s.name}</div>
                        </div>
                        <div style="font-weight: 800; color: var(--primary);">${h} —á.</div>
                    </div>`;
                }).join('');

                if (html.trim() === '') {
                    breakdownEl.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-light); font-size:13px;">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö ‚è±Ô∏è</div>';
                } else {
                    breakdownEl.innerHTML = html;
                }
            }

            // 4. –°–ï–¢–ö–ê –ê–ö–¢–ò–í–ù–û–°–¢–ò (HEATMAP)
            const heatmap = document.getElementById('heatmap');
            if (heatmap) {
                let html = ''; // –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                for (let i = 0; i < 30; i++) {
                    const date = new Date(currentTimestamp - ((29 - i) * 86400000));
                    const key = getUZDate(date);
                    const sec = (DB.history && DB.history[key]) || 0;
                    const minutes = Math.round(sec / 60);
                    let color = 'var(--bg)';
                    if (minutes > 0) color = '#c6e48b'; 
                    if (minutes > 20) color = '#7bc96f'; 
                    if (minutes > 60) color = '#239a3b'; 
                    if (minutes > 120) color = '#196127';
                    const isToday = i === 29 ? 'border: 1px solid var(--primary);' : '';
                    html += `<div title="${key}: ${minutes} –º–∏–Ω" style="background:${color}; ${isToday} border-radius:4px; aspect-ratio:1/1;"></div>`;
                }
                heatmap.innerHTML = html;
            }

            // 5. –ì–†–ê–§–ò–ö–ò (Chart.js)
            requestAnimationFrame(() => {
                const subjectCtx = document.getElementById('subjectChart');
                if (subjectCtx) {
                    if (window.subjectChart instanceof Chart) { window.subjectChart.destroy(); }
                    const labels = [], data = [];
                    const colors = ['#6C63FF', '#FF7675', '#00d26a', '#FFD700', '#00E0D0', '#D60270', '#556B2F', '#FF8F66'];
                    Object.values(DB.subjects).forEach(s => { 
                        if (s.sec > 0) { 
                            labels.push(s.name); 
                            data.push(Math.round(s.sec / 60)); 
                        }
                    });
                    window.subjectChart = new Chart(subjectCtx, {
                        type: 'doughnut',
                        data: { 
                            labels: labels.length ? labels : ['–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'], 
                            datasets: [{ data: data.length ? data : [1], backgroundColor: data.length ? colors : ['#eee'], borderWidth: 0 }] 
                        },
                        options: { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } } }
                    });
                }
    // --- BAR CHART (–ù–ï–î–ï–õ–Ø - –ú–ò–ù–£–¢–´) ---
                const weekCtx = document.getElementById('weekChart');
                const totalWeekEl = document.getElementById('week-total-display');

                if (weekCtx) {
                    if (window.weekChart instanceof Chart) {
                        window.weekChart.destroy();
                        window.weekChart = null;
                    }

                    const days = [];
                    const data = [];
                    const backgroundColors = [];
                    let totalWeekMinutes = 0;
                    
                    // –ì—Ä–∞–¥–∏–µ–Ω—Ç—ã
                    const ctx = weekCtx.getContext("2d");
                    const gradientPurple = ctx.createLinearGradient(0, 0, 0, 400);
                    gradientPurple.addColorStop(0, '#6C63FF');
                    gradientPurple.addColorStop(1, 'rgba(108, 99, 255, 0.2)');

                    const gradientToday = ctx.createLinearGradient(0, 0, 0, 400);
                    gradientToday.addColorStop(0, '#FF7675');
                    gradientToday.addColorStop(1, 'rgba(255, 118, 117, 0.2)');

                    // –¶–∏–∫–ª –ø–æ –¥–Ω—è–º
                    for (let i = 6; i >= 0; i--) {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º currentTimestamp –∏–∑ –Ω–∞—á–∞–ª–∞ —Ñ—É–Ω–∫—Ü–∏–∏ renderStats
                        // –ï—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ: const currentTimestamp = new Date().getTime();
                        const d = new Date(currentTimestamp - (i * 86400000));
                        const dayName = ['–í—Å','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'][d.getDay()];
                        const key = getUZDate(d);
                        
                        const sec = (DB.history && DB.history[key]) || 0;
                        
                        // üî• –í–ê–ñ–ù–û: –î–µ–ª–∏–º –Ω–∞ 60 (–ú–∏–Ω—É—Ç—ã), –∞ –Ω–µ 3600
                        const minutes = Math.floor(sec / 60); 

                        days.push(dayName);
                        data.push(minutes);
                        totalWeekMinutes += minutes;

                        // –¶–≤–µ—Ç –¥–ª—è —Å–µ–≥–æ–¥–Ω—è
                        if (i === 0) backgroundColors.push(gradientToday);
                        else backgroundColors.push(gradientPurple);
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π —Å—á–µ—Ç—á–∏–∫
                    if (totalWeekEl) {
                        const h = Math.floor(totalWeekMinutes / 60);
                        const m = totalWeekMinutes % 60;
                        totalWeekEl.innerText = h > 0 ? `${h}—á ${m}–º` : `${m} –º–∏–Ω`;
                    }

                    window.weekChart = new Chart(weekCtx, {
                        type: 'bar',
                        data: {
                            labels: days,
                            datasets: [{
                                label: '–ú–∏–Ω—É—Ç—ã',
                                data: data,
                                backgroundColor: backgroundColors,
                                borderRadius: 6,
                                barPercentage: 0.6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    border: { display: false },
                                    grid: { color: 'rgba(0,0,0,0.05)' },
                                    ticks: { 
                                        font: { size: 10 },
                                        // üî• –ó–ê–ü–†–ï–©–ê–ï–ú –î–†–û–ë–ù–´–ï –ß–ò–°–õ–ê –ù–ê –®–ö–ê–õ–ï
                                        precision: 0 
                                    }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { font: { size: 11 } }
                                }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.raw + ' –º–∏–Ω';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
            // 3. –°–ï–¢–ö–ê –ê–ö–¢–ò–í–ù–û–°–¢–ò (HEATMAP)
            const heatmap = document.getElementById('heatmap');
            if (heatmap) {
                let html = ''; // <--- –í–û–¢ –≠–¢–ê –°–¢–†–û–ö–ê –ò–°–ü–†–ê–í–õ–Ø–ï–¢ –û–®–ò–ë–ö–£
                const currentTimestamp = new Date().getTime();
                
                for (let i = 0; i < 30; i++) {
                    const date = new Date(currentTimestamp - ((29 - i) * 86400000));
                    const key = getUZDate(date);
                    const sec = (DB.history && DB.history[key]) || 0;
                    const minutes = Math.round(sec / 60);
                    
                    let color = 'var(--bg)';
                    if (minutes > 0) color = '#c6e48b'; 
                    if (minutes > 20) color = '#7bc96f'; 
                    if (minutes > 60) color = '#239a3b'; 
                    if (minutes > 120) color = '#196127';
                    
                    const isToday = i === 29 ? 'border: 1px solid var(--primary);' : '';
                    html += `<div title="${key}: ${minutes} –º–∏–Ω" style="background:${color}; ${isToday} border-radius:4px; aspect-ratio:1/1;"></div>`;
                }
                heatmap.innerHTML = html;
            }
                //  3. –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û –ü–†–ï–î–ú–ï–¢–ê–ú 
            const breakdownEl = document.getElementById('subject-breakdown');
            
            if (breakdownEl && DB && DB.subjects) {
                let html = ''; // <--- –í–û–¢ –≠–¢–ê –°–¢–†–û–ö–ê –ò–°–ü–†–ê–í–õ–Ø–ï–¢ –û–®–ò–ë–ö–£ (–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è)

                const subjectsArray = Object.keys(DB.subjects).map(key => ({
                    id: key,
                    ...DB.subjects[key]
                }));
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                subjectsArray.sort((a, b) => (b.sec || 0) - (a.sec || 0));

                // –§–æ—Ä–º–∏—Ä—É–µ–º HTML-–∫–æ–¥ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞
                html = subjectsArray.map(s => {
                    if (!s.sec || s.sec < 1) return ''; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ

                    const totalHours = (s.sec / 3600).toFixed(1);
                    return `
                    <div style="margin-bottom: 10px; background: var(--bg); padding: 12px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 20px;">${s.icon || 'üìö'}</span>
                            <div style="font-weight: bold; font-size: 14px;">${s.name}</div>
                        </div>
                        <div style="font-weight: 800; color: var(--primary);">${totalHours} —á.</div>
                    </div>`;
                }).join('');

                // üëá –¢–ê –°–ê–ú–ê–Ø –ü–†–û–í–ï–†–ö–ê, –ì–î–ï –í–´–õ–ï–¢–ê–õ–ê –û–®–ò–ë–ö–ê üëá
                if (html.trim() === '') {
                    breakdownEl.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-light); font-size:13px;">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –í–∫–ª—é—á–∏ —Ç–∞–π–º–µ—Ä! ‚è±Ô∏è</div>';
                } else {
                    breakdownEl.innerHTML = html;
                }
            }

            });
        },

        renderSubjects() {
            const grid = document.getElementById('subjects-grid');
            if (!grid || !DB || !DB.subjects) return;

            // –ü—Ä–æ—Å—Ç–æ –±–µ—Ä–µ–º –∫–ª—é—á–∏ –∫–∞–∫ –æ–Ω–∏ –µ—Å—Ç—å
            const subjectsKeys = Object.keys(DB.subjects);

            grid.innerHTML = subjectsKeys.map(k => {
                const s = DB.subjects[k];
                const isActive = DB.user.subject === k;
                
                let cardStyle = `padding:15px; text-align:center; cursor:pointer; transition:0.2s; border:2px solid transparent;`;
                if (isActive) cardStyle += 'border-color:var(--primary); background:rgba(108,99,255,0.05);';
                else if (Timer.active) cardStyle += 'opacity: 0.3; filter: grayscale(1);';

                return `
                <div class="card" style="${cardStyle}" onclick="${Timer.active ? '' : `App.selectSubject('${k}')`}">
                    <div style="font-size:24px">${s.icon}</div>
                    <div style="font-weight:bold; font-size:12px; margin-top:5px;">${s.name}</div>
                </div>`;
            }).join('');

            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –§–æ–∫—É—Å–∞
            const titleEl = document.getElementById('subject-title');
            if (titleEl && DB.subjects[DB.user.subject]) {
                titleEl.innerText = DB.subjects[DB.user.subject].name;
            }
        },

        selectSubject(key) {
            
            SoundSys.play('click');
            
            // üîí –ó–ê–©–ò–¢–ê: –ï—Å–ª–∏ —Ç–∞–π–º–µ—Ä –∑–∞–ø—É—â–µ–Ω ‚Äî –∑–∞–ø—Ä–µ—â–∞–µ–º –º–µ–Ω—è—Ç—å –ø—Ä–µ–¥–º–µ—Ç
            if (Timer.active) {
                SoundSys.play('error');
                App.toast("‚õîÔ∏è –°–Ω–∞—á–∞–ª–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–∞–π–º–µ—Ä!");
                return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é
            }

            if (DB.subjects[key]) { 
                DB.user.subject = key; 
                Data.save(); 
                this.renderSubjects(); 
                this.updateUI(); 
                SoundSys.play('click');
            }
        },

        renderHistory() {
            const logContainer = document.getElementById('session-log');
            if (!logContainer || !DB || !DB.sessions) return;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Å—Ç–∏–ª–µ–π, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            logContainer.className = 'history-list';

            if (DB.sessions.length === 0) {
                logContainer.innerHTML = `
                    <div style="text-align:center; padding: 30px; color:var(--text-light); opacity:0.7;">
                        <div style="font-size: 40px; margin-bottom: 10px;">üìú</div>
                        <div>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞.<br>–ü–æ—É—á–∏—Å—å, —á—Ç–æ–±—ã –∑–¥–µ—Å—å –ø–æ—è–≤–∏–ª–∏—Å—å –∑–∞–ø–∏—Å–∏!</div>
                    </div>`;
                return;
            }

            logContainer.innerHTML = DB.sessions.map(s => {
                // 1. –†–∞—Å—á–µ—Ç –º–∏–Ω—É—Ç (–æ–∫—Ä—É–≥–ª—è–µ–º –≤–≤–µ—Ä—Ö, —á—Ç–æ–±—ã 10 —Å–µ–∫ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª–æ –∫–∞–∫ 0)
                let minutes = Math.floor(s.sec / 60);
                if (minutes < 1) minutes = "< 1"; // –ï—Å–ª–∏ –º–µ–Ω—å—à–µ –º–∏–Ω—É—Ç—ã

                // 2. –ö—Ä–∞—Å–∏–≤–∞—è –¥–∞—Ç–∞ (27 —è–Ω–≤, 14:30)
                const dateObj = new Date(s.date);
                const dateStr = dateObj.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
                const timeStr = dateObj.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

                // 3. –ò—â–µ–º –∏–∫–æ–Ω–∫—É –ø—Ä–µ–¥–º–µ—Ç–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
                let icon = '‚è±Ô∏è'; // –ò–∫–æ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                if (DB.subjects) {
                    // –ü—Ä–æ–±–µ–≥–∞–µ–º –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º, –∏—â–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∏–º–µ–Ω–∏
                    const foundKey = Object.keys(DB.subjects).find(k => DB.subjects[k].name === s.subject);
                    if (foundKey) icon = DB.subjects[foundKey].icon;
                }

                // 4. –ë–ª–æ–∫ —Å –º–æ–Ω–µ—Ç–∞–º–∏ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ > 0)
                const coinBadge = s.coins > 0 
                    ? `<div class="history-coins">+${s.coins} üí∞</div>` 
                    : '';

                return `
                <div class="history-card">
                    <div class="history-left">
                        <div class="history-icon">${icon}</div>
                        <div class="history-info">
                            <div>${s.subject}</div>
                            <div class="history-date">${dateStr} –≤ ${timeStr}</div>
                        </div>
                    </div>
                    <div class="history-right">
                        <div class="history-time">${minutes} –º–∏–Ω</div>
                        ${coinBadge}
                    </div>
                </div>`;
            }).join('');
        },

        shareApp() {
            const shareData = {
                title: 'MathBooster PRO üá∫üáø',
                text: '–Ø –∫–∞—á–∞—é –º–æ–∑–≥–∏ –≤ MathBooster! üß†\n–ó–∞—Ö–æ–¥–∏, –ø–æ–ø—Ä–æ–±—É–π –ø–æ–±–∏—Ç—å –º–æ–π —Ä–µ–∫–æ—Ä–¥! üèÜ',
                url: window.location.href
            };
            if (navigator.share) { navigator.share(shareData).catch((e) => console.log("–û—Ç–º–µ–Ω–∞")); } 
            else { navigator.clipboard.writeText(shareData.url + "\n\n" + shareData.text); alert("üîó –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!"); }
        },

        toggleEcoMode(enable) {
            const overlay = document.getElementById('eco-overlay');
            if (enable) { overlay.classList.add('active'); App.toast("üîã –≠–∫–æ-—Ä–µ–∂–∏–º –≤–∫–ª."); } 
            else { overlay.classList.remove('active'); }
        },

        toast(m) { 
            const container = document.getElementById('toast-container');
            if (container) {
                const t=document.createElement('div'); t.className='toast'; t.innerText=m; 
                container.appendChild(t); 
                setTimeout(()=>t.classList.add('show'),10); 
                setTimeout(()=>{t.classList.remove('show');t.remove()},3000); 
            }
        },
        // –°–µ–∫—Ä–µ—Ç–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤
        adminClicks: 0,

        

        
    };

    const Transfer = {
        async generateTransferID() {
            if (!Auth.currentUser) return App.toast("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç");
            
            // 1. –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
            const btn = document.querySelector("button[onclick*='generateTransferID']");
            const originalText = btn ? btn.innerText : "–°–æ–∑–¥–∞—Ç—å –∫–æ–¥";
            if(btn) btn.innerText = "‚è≥ –ñ–¥–∏—Ç–µ...";

            try {
                // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                if (DB && DB.user) {
                    DB.user.name = Auth.currentUser.name;
                    DB.user.id = Auth.currentUser.id;
                    Data.save(); // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                }

                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let id = '';
                for (let i = 0; i < 8; i++) id += chars.charAt(Math.floor(Math.random() * chars.length));

                // 2. –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ Firebase
                // –ï—Å–ª–∏ –∫–≤–æ—Ç–∞ –∫–æ–Ω—á–∏–ª–∞—Å—å, –æ—à–∏–±–∫–∞ –≤—ã–ª–µ—Ç–∏—Ç –ó–î–ï–°–¨
                const docRef = window.DB_Online.doc(window.DB_Online.db, "transfers", id);
                
                await window.DB_Online.setDoc(docRef, {
                    userId: Auth.currentUser.id,
                    data: DB,
                    createdAt: new Date().toISOString(),
                    expiresAt: new Date(Date.now() + 24*60*60*1000).toISOString()
                });

                // –£—Å–ø–µ—Ö
                const modal = document.getElementById('transfer-modal');
                const display = document.getElementById('transfer-code-display');
                if (modal && display) {
                    display.innerText = id;
                    modal.classList.add('show');
                } else {
                    prompt("–ö–æ–¥ –≥–æ—Ç–æ–≤:", id);
                }
                App.toast("‚úÖ –ö–æ–¥ —Å–æ–∑–¥–∞–Ω!");

            } catch (e) {
                console.error("Firebase Error:", e);
                
                // üî• –õ–û–í–ò–ú –û–®–ò–ë–ö–£ –õ–ò–ú–ò–¢–ê
                if (e.code === 'resource-exhausted' || e.message.includes('Quota')) {
                    alert("üõë –û–®–ò–ë–ö–ê –°–ï–†–í–ï–†–ê\n\n–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ª–∏–º–∏—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∏—Å—á–µ—Ä–ø–∞–Ω.\n–§—É–Ω–∫—Ü–∏—è –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç –∑–∞–≤—Ç—Ä–∞ –ø–æ—Å–ª–µ 13:00.");
                } else {
                    alert("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:\n" + e.message);
                }
            } finally {
                // üî• –í–û–ó–í–†–ê–©–ê–ï–ú –ö–ù–û–ü–ö–£ –û–ë–†–ê–¢–ù–û (–ß—Ç–æ–±—ã –Ω–µ –≤–∏—Å–µ–ª–∞ –≤–µ—á–Ω–æ)
                if(btn) btn.innerText = originalText;
            }
        },

        transferByID() {
            const inputID = prompt("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:");
            if (!inputID) return;
            const cleanID = inputID.trim().toUpperCase();

            App.toast("‚è≥ –ü–æ–∏—Å–∫ –¥–∞–Ω–Ω—ã—Ö...");

            const docRef = window.DB_Online.doc(window.DB_Online.db, "transfers", cleanID);

            window.DB_Online.getDoc(docRef).then(docSnap => {
                if (docSnap.exists()) {
                    const transferData = docSnap.data();
                    
                    // üî• –ü–†–û–í–ï–†–ö–ê –°–†–û–ö–ê –ì–û–î–ù–û–°–¢–ò
                    // –ï—Å–ª–∏ –∫–æ–¥ –ù–ï –≤–µ—á–Ω—ã–π –ò —É –Ω–µ–≥–æ –∏—Å—Ç–µ–∫ —Å—Ä–æ–∫
                    if (!transferData.isPermanent && transferData.expiresAt) {
                        if (new Date() > new Date(transferData.expiresAt)) {
                            alert("‚ùå –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —ç—Ç–æ–≥–æ –∫–æ–¥–∞ –∏—Å—Ç–µ–∫ (24 —á–∞—Å–∞).");
                            return;
                        }
                    }

                    // –ï—Å–ª–∏ –∫–æ–¥ –í–µ—á–Ω—ã–π ‚Äî –º—ã –µ–≥–æ –ù–ï —É–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                    // –ï—Å–ª–∏ –∫–æ–¥ –í—Ä–µ–º–µ–Ω–Ω—ã–π ‚Äî —É–¥–∞–ª—è–µ–º
                    const shouldDelete = !transferData.isPermanent;

                    DB = transferData.data;

                    // –õ–µ—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏
                    if (!DB.user.name || DB.user.name === "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π") {
                        let newName = prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è:", "–ò–≥—Ä–æ–∫");
                        DB.user.name = newName || "–ò–≥—Ä–æ–∫";
                    }
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞
                    let usersList = [];
                    try {
                        let stored = localStorage.getItem('MathUsers');
                        if (stored) usersList = JSON.parse(stored);
                    } catch (e) { usersList = []; }

                    usersList = usersList.filter(u => u.id !== DB.user.id);
                    
                    usersList.unshift({ 
                        id: DB.user.id, 
                        name: DB.user.name, 
                        avatar: DB.user.avatar || "üòé", 
                        gender: DB.user.gender || 'male' 
                    });

                    localStorage.setItem('MathUsers', JSON.stringify(usersList));
                    Data.currentKey = 'MathData_' + DB.user.id; 
                    localStorage.setItem(Data.currentKey, JSON.stringify(DB));

                    // –ï—Å–ª–∏ –∫–æ–¥ –±—ã–ª –≤—Ä–µ–º–µ–Ω–Ω—ã–π ‚Äî —É–¥–∞–ª—è–µ–º –µ–≥–æ, —á—Ç–æ–±—ã –Ω–∏–∫—Ç–æ –Ω–µ —É–∫—Ä–∞–ª
                    if (shouldDelete) {
                        window.DB_Online.deleteDoc(docRef).catch(() => {});
                    } else {
                        console.log("‚úÖ –í–µ—á–Ω—ã–π –∫–æ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω. –ù–µ —É–¥–∞–ª—è–µ–º.");
                    }

                    alert(`‚úÖ –£–°–ü–ï–®–ù–û!\n–ü—Ä–æ—Ñ–∏–ª—å "${DB.user.name}" –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.`);
                    setTimeout(() => location.reload(), 500);

                } else {
                    alert("‚ùå –ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω.\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–æ–¥–∞.");
                }
            }).catch(e => {
                console.error(e);
                alert("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.");
            });
        }
    };
    const InstallSys = {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≥–¥–µ –º—ã: –≤ –±—Ä–∞—É–∑–µ—Ä–µ –∏–ª–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
        init() {
            // –ï—Å–ª–∏ —ç—Ç–æ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ - —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É—Å—Ç–∞–Ω–æ–≤–∫–∏
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
            
            if (!isStandalone) {
                // –ú—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                const btn = document.getElementById('install-promo-card');
                if (btn) btn.style.display = 'block';
            }
        },

        // –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞
        startFlow() {
            if (!Auth.currentUser) return App.toast("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å!");

            // 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 8; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));

            // 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
            DB.user.name = Auth.currentUser.name;
            DB.user.avatar = Auth.currentUser.avatar;
            DB.user.id = Auth.currentUser.id;
            
            App.toast("‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...");

            // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –æ–±–ª–∞–∫–æ
            const docRef = window.DB_Online.doc(window.DB_Online.db, "transfers", code);
            window.DB_Online.setDoc(docRef, {
                userId: Auth.currentUser.id,
                data: DB,
                createdAt: new Date().toISOString(),
                expiresAt: new Date(Date.now() + 24*60*60*1000).toISOString()
            }).then(() => {
                // 4. –ö–û–ü–ò–†–£–ï–ú –ö–û–î
                navigator.clipboard.writeText(code).then(() => {
                    this.showInstruction();
                }).catch(() => {
                    // –ï—Å–ª–∏ –∞–≤—Ç–æ-–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ (—Ä–µ–¥–∫–æ)
                    prompt("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –≤—Ä—É—á–Ω—É—é:", code);
                    this.showInstruction();
                });
            }).catch(e => {
                console.error(e);
                App.toast("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
            });
        },

        // –§–£–ù–ö–¶–ò–Ø –ü–û–ö–ê–ó–ê –ò–ù–°–¢–†–£–ö–¶–ò–ò
        showInstruction() {
            const modal = document.getElementById('install-modal');
            const iosBlock = document.getElementById('ios-instruction');
            const androidBlock = document.getElementById('android-instruction');

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
            const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

            if (isIOS) {
                iosBlock.style.display = 'block';
                androidBlock.style.display = 'none';
            } else {
                // –î–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—á–∏—Ç–∞–µ–º —á—Ç–æ —ç—Ç–æ Android/PC
                iosBlock.style.display = 'none';
                androidBlock.style.display = 'block';
            }

            modal.classList.add('show');
            FX.confetti(); // –ü—Ä–∞–∑–¥–Ω–∏–∫, —á—Ç–æ –∫–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω
        }
    };
    const Notify = {
        isSupported: 'Notification' in window,
        checkInterval: null,

        messages: [
            { t: "üî• –°—Ç—Ä–∏–∫ –ø–æ–¥ —É–≥—Ä–æ–∑–æ–π!", b: "–¢–≤–æ–π –æ–≥–æ–Ω—å –º–æ–∂–µ—Ç –ø–æ–≥–∞—Å–Ω—É—Ç—å. –ü–æ—É—á–∏—Å—å —Ö–æ—Ç—è –±—ã 5 –º–∏–Ω—É—Ç!" },
            { t: "üß† –í—Ä–µ–º—è –ø—Ä–æ–∫–∞—á–∫–∏!", b: "–ú–æ–∑–≥ —Ç—Ä–µ–±—É–µ—Ç –∑–Ω–∞–Ω–∏–π. –¢–≤–æ–π –ª—é–±–∏–º—ã–π –ø—Ä–µ–¥–º–µ—Ç –∂–¥–µ—Ç —Ç–µ–±—è." },
            { t: "üëë –°—Ç–∞–Ω—å –ª–µ–≥–µ–Ω–¥–æ–π!", b: "–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –≤ –¢–æ–ø–µ –Ω–µ —Å–ø—è—Ç. –ü–æ—Ä–∞ –ø–æ–¥–Ω—è—Ç—å —É—Ä–æ–≤–µ–Ω—å!" },
            { t: "üìö –ü–ª–∞–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è?", b: "–ù–µ –∑–∞–±—É–¥—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∫–≤–µ—Å—Ç—ã –∏ –∑–∞–±—Ä–∞—Ç—å –º–æ–Ω–µ—Ç—ã." }
        ],

        async toggle(isChecked) {
            if (!this.isSupported) {
                alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.");
                document.getElementById('notify-toggle').checked = false;
                return;
            }

            if (isChecked) {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    if (!DB.settings) DB.settings = { sfx: true, notifications: false, notifyTime: "19:00" };
                    
                    DB.settings.notifications = true;
                    App.toast("‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã");
                    // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
                    DB.settings.notifications = true;
                    App.toast("‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã");
                    this.send("MathBooster PRO", "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã! üöÄ");
                    this.startDailyCheck();
                } else {
                    alert("–†–∞–∑—Ä–µ—à–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞/—Ç–µ–ª–µ—Ñ–æ–Ω–∞.");
                    document.getElementById('notify-toggle').checked = false;
                    DB.settings.notifications = false;
                }
            } else {
                DB.settings.notifications = false;
                App.toast("üîï –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω—ã");
            }
            Data.save();
        },

        send(title, body) {
            if (!DB.settings.notifications || Notification.permission !== 'granted') return;
            try {
                const options = { body: body, icon: 'icon-192.png', badge: 'icon-192.png', vibrate: [200, 100, 200] };
                if (navigator.serviceWorker && navigator.serviceWorker.ready) {
                    navigator.serviceWorker.ready.then(reg => reg.showNotification(title, options));
                } else {
                    new Notification(title, options);
                }
            } catch (e) { console.error("Notify Error:", e); }
        },

        startDailyCheck() {
            if (this.checkInterval) clearInterval(this.checkInterval);

            this.checkInterval = setInterval(() => {
                if (!DB.settings.notifications) return;

                const now = new Date();
                const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                
                // –°–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
                if (currentTime === DB.settings.notifyTime) {
                    const today = getUZDate();
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º: –Ω–µ —É—á–∏–ª—Å—è —Å–µ–≥–æ–¥–Ω—è –ò –µ—â–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ —Å–µ–≥–æ–¥–Ω—è –ø—É—à
                    if (DB.user.lastStudyDate !== today && DB.user.lastNotifyDate !== today) {
                        const msg = this.messages[Math.floor(Math.random() * this.messages.length)];
                        this.send(msg.t, msg.b);
                        
                        // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –¥–∞—Ç—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ localStorage (–∞ –Ω–µ –≤ —Å–µ—Å—Å–∏—é), —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å
                        DB.user.lastNotifyDate = today;
                        Data.save();
                    }
                }
            }, 60000); // –†–∞–∑ –≤ –º–∏–Ω—É—Ç—É
        },
        updateTime(val) {
            DB.settings.notifyTime = val;
            Data.save();
            App.toast(`üïí –í—Ä–µ–º—è –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ ${val}`);
        }
    };
    // –î–µ–ª–∞–µ–º —ç—Ç–∏ –æ–±—ä–µ–∫—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ HTML
        window.App = App;
        window.Auth = Auth;
        window.Timer = Timer;
        window.Trainer = Trainer;
        window.QuestSys = QuestSys;
        window.WheelSys = WheelSys;
        window.DailySys = DailySys;
        window.Donation = Donation;
        window.Transfer = Transfer;
        window.Whiteboard = Whiteboard;
        window.Calc = Calc;
        window.SecretSys = SecretSys;
        window.WeeklyReportSys = WeeklyReportSys;
        window.AchievementSys = AchievementSys;

        // === –£–ú–ù–´–ô –≠–ö–†–ê–ù –ó–ê–ì–†–£–ó–ö–ò ===
    window.onload = () => {
        const bar = document.getElementById('splash-bar');
        const screen = document.getElementById('splash-screen');
        const text = document.getElementById('splash-text');
        let progress = 0;

        // 1. –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        const loadingInterval = setInterval(() => {
            // –ü—Ä–∏–±–∞–≤–ª—è–µ–º –ø–æ —á—É—Ç—å-—á—É—Ç—å –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
            if (progress < 90) {
                progress += Math.random() * 1.5; // –°–ª—É—á–∞–π–Ω—ã–π —à–∞–≥ –æ—Ç 0 –¥–æ 1.5%
            }
            
            if (bar) bar.style.width = progress + "%";

            // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–∞
            if (progress > 10 && progress < 40) if (text) text.innerText = "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª–µ–π...";
            if (progress > 40 && progress < 70) if (text) text.innerText = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –æ–±–ª–∞–∫—É...";
            if (progress > 70 && progress < 90) if (text) text.innerText = "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏...";
        }, 50); // –ß–∞—Å—Ç–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (20 —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É) –¥–ª—è –∏–¥–µ–∞–ª—å–Ω–æ–π –ø–ª–∞–≤–Ω–æ—Å—Ç–∏

        // 2. –õ–æ–≥–∏–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–∏—Å—Ç–µ–º
        Auth.init();
        InstallSys.init();

        const startApp = async () => {
            const lastId = localStorage.getItem('LastUserId');
            
            try {
                if (lastId) {
                    // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ–π—Ç–∏ (—Ñ—É–Ω–∫—Ü–∏—è login —Å–∞–º–∞ –ø–æ–¥–æ–∂–¥–µ—Ç –±–∞–∑—É –≤–Ω—É—Ç—Ä–∏)
                    await Auth.login(lastId);
                }
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ-–≤—Ö–æ–¥–∞:", e);
            }

            // –ö–æ–≥–¥–∞ –≤—Å—ë –≥–æ—Ç–æ–≤–æ (–±–∞–∑–∞ –æ—Ç–≤–µ—Ç–∏–ª–∞ –∏ –ª–æ–≥–∏–Ω –ø—Ä–æ—à–µ–ª)
            clearInterval(loadingInterval); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–µ–¥–ª–µ–Ω–Ω—ã–π —Ç–∞–π–º–µ—Ä
            
            if (bar) bar.style.width = "100%"; // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –¥–æ–≤–æ–¥–∏–º –¥–æ –∫–æ–Ω—Ü–∞
            if (text) text.innerText = "–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω! üöÄ";

            // –ü–ª–∞–≤–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω
            setTimeout(() => {
                if (screen) {
                    screen.style.transition = "opacity 0.8s ease-out, visibility 0.8s";
                    screen.style.opacity = '0';
                    screen.style.visibility = 'hidden';
                    // –£–¥–∞–ª—è–µ–º –∏–∑ DOM —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ –∑–∞—Ç—É—Ö–∞–Ω–∏—è
                    setTimeout(() => screen.remove(), 1000);
                }
            }, 400);
        };

        startApp();
    };

    // ===== –ê–ù–¢–ò-–ê–§–ö: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 20 –º–∏–Ω—É—Ç =====
    let afkTimer = null;
    let afkPromptActive = false;
    const AFK_INTERVAL = 35 * 60 * 1000; // 35 –º–∏–Ω—É—Ç
    const PROMPT_TIMEOUT = 30 * 1000;    // 30 —Å–µ–∫—É–Ω–¥ –Ω–∞ –æ—Ç–≤–µ—Ç

    function startAfkCheck() {
        if (afkTimer) clearTimeout(afkTimer);
        afkTimer = setTimeout(showAfkPrompt, AFK_INTERVAL);
    }

    function stopAfkCheck() {
        if (afkTimer) {
            clearTimeout(afkTimer);
            afkTimer = null;
        }
        afkPromptActive = false;
        hideAfkPrompt();
    }

    function showAfkPrompt() {
        if (afkPromptActive || !Timer.isRunning) return;
        afkPromptActive = true;

        const prompt = document.createElement('div');
        prompt.id = 'afk-prompt';
        prompt.style.cssText = `
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--surface);
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            z-index: 999;
            text-align: center;
            max-width: 90vw;
        `;
        prompt.innerHTML = `
            <p style="margin:0 0 10px; font-weight:bold;">–ü—Ä–æ–¥–æ–ª–∂–∞–µ—à—å —É—á–∏—Ç—å—Å—è? üòä</p>
            <p style="margin:0 0 15px; font-size:14px;">–ù–∞–∂–º–∏ "–î–∞" –≤ —Ç–µ—á–µ–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥</p>
            <button onclick="confirmAfk()" class="btn btn-primary" style="margin-right:10px;">–î–∞, –ø—Ä–æ–¥–æ–ª–∂–∞—é!</button>
            <button onclick="pauseAfk()" class="btn btn-outline">–Ø –æ—Ç–æ—à—ë–ª</button>
        `;
        document.body.appendChild(prompt);

        setTimeout(() => {
            if (afkPromptActive) pauseAfk();
        }, PROMPT_TIMEOUT);
    }

    function confirmAfk() {
        afkPromptActive = false;
        hideAfkPrompt();
        startAfkCheck();
        App.toast("–ö—Ä—É—Ç–æ! –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º üí™");
    }

    function pauseAfk() {
        afkPromptActive = false;
        hideAfkPrompt();
        Timer.pause();
        App.toast("–¢–∞–π–º–µ—Ä –Ω–∞ –ø–∞—É–∑–µ. –í–æ–∑–æ–±–Ω–æ–≤–∏ –∫–æ–≥–¥–∞ –≤–µ—Ä–Ω—ë—à—å—Å—è!");
    }

    function hideAfkPrompt() {
        const prompt = document.getElementById('afk-prompt');
        if (prompt) prompt.remove();
    }

    // –ü–æ–¥–∫–ª—é—á–∞–µ–º –∫ —Ç–∞–π–º–µ—Ä—É (–µ—Å–ª–∏ —É —Ç–µ–±—è Timer ‚Äî –æ–±—ä–µ–∫—Ç)
    if (typeof Timer !== 'undefined') {
        const originalStart = Timer.start;
        Timer.start = function() {
            originalStart?.apply(this, arguments);
            startAfkCheck();
        };

        const originalPause = Timer.pause;
        Timer.pause = function() {
            originalPause?.apply(this, arguments);
            stopAfkCheck();
        };

        const originalStop = Timer.stop;
        Timer.stop = function() {
            originalStop?.apply(this, arguments);
            stopAfkCheck();
        };
    }

    // ===== –ü–†–ï–î–ú–ï–¢–´: –ü–ï–†–ï–ú–ï–©–ï–ù–ò–ï –û–î–ù–ò–ú –ö–õ–ò–ö–û–ú ‚Äî –§–ò–ù–ê–õ–¨–ù–´–ô –í–ê–†–ò–ê–ù–¢ =====

    // –í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã
    // üìö –ö–ê–¢–ê–õ–û–ì –í–°–ï–• –ü–†–ï–î–ú–ï–¢–û–í (–≠—Ç–∞–ª–æ–Ω)
    const ALL_SUBJECTS = [
        { id: 'algebra', name: '–ê–ª–≥–µ–±—Ä–∞', icon: '‚úñÔ∏è' },
        { id: 'geometry', name: '–ì–µ–æ–º–µ—Ç—Ä–∏—è', icon: 'üìê' },
        { id: 'calculus', name: '–ú–∞—Ç. –∞–Ω–∞–ª–∏–∑', icon: '‚à´' },
        { id: 'arithmetic', name: '–ê—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞', icon: 'üî¢' },
        { id: 'combinatorics', name: '–ö–æ–º–±–∏–Ω–∞—Ç–æ—Ä–∏–∫–∞', icon: 'üîÄ' },
        { id: 'statistics', name: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', icon: 'üìä' },
        { id: 'trigonometry', name: '–¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è', icon: 'üìè' },
        { id: 'stereometry', name: '–°—Ç–µ—Ä–µ–æ–º–µ—Ç—Ä–∏—è', icon: 'üßä' },
        { id: 'physics', name: '–§–∏–∑–∏–∫–∞', icon: '‚öõÔ∏è' },
        { id: 'chemistry', name: '–•–∏–º–∏—è', icon: 'üß™' },
        { id: 'biology', name: '–ë–∏–æ–ª–æ–≥–∏—è', icon: 'üß¨' },
        { id: 'history', name: '–ò—Å—Ç–æ—Ä–∏—è', icon: 'üè∫' },
        { id: 'lit', name: '–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', icon: 'üìñ' },
        { id: 'eng', name: '–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫', icon: 'üåê' }
    ];

    // –ó–∞—â–∏—Ç–∞ –æ—Ç null (—Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ!)
    if (!DB) DB = {};
    if (!DB.subjects) DB.subjects = {};

    // –û—á–∏—Å—Ç–∫–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö –∫–ª—é—á–µ–π (—Ñ–∏–∫—Å Firebase)
    function cleanSubjects() {
        if (!DB.subjects) return;
        Object.keys(DB.subjects).forEach(key => {
            if (!key || key.trim() === '') {
                delete DB.subjects[key];
                console.log("–£–¥–∞–ª—ë–Ω –ø—É—Å—Ç–æ–π –∫–ª—é—á:", key);
            }
        });
    }

    function updateSubjectLists() {
        const myGrid = document.getElementById('my-subjects-list');
        const availGrid = document.getElementById('available-subjects-list');
        if (!myGrid || !availGrid) return;

        myGrid.innerHTML = '';
        availGrid.innerHTML = '';

        // 1. –ú–û–ò –ü–†–ï–î–ú–ï–¢–´ (–ë–µ–∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏)
        Object.keys(DB.subjects).forEach(id => {
            const s = DB.subjects[id];
            const div = document.createElement('div');
            div.className = 'subject-item added';
            // –ï—Å–ª–∏ —Ç–∞–π–º–µ—Ä –∑–∞–ø—É—â–µ–Ω ‚Äî –±–ª–æ–∫–∏—Ä—É–µ–º –Ω–∞–∂–∞—Ç–∏—è
            if (Timer.active) div.style.opacity = "0.5";

            div.innerHTML = `<div class="icon">${s.icon}</div><div class="name">${s.name}</div>`;
            div.onclick = () => { if(!Timer.active) moveSubject(id, true); };
            myGrid.appendChild(div);
        });

        // 2. –î–û–°–¢–£–ü–ù–´–ï (–ë–µ—Ä–µ–º –∏–∑ ALL_SUBJECTS —Ç–µ, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –ú–æ–∏—Ö)
        ALL_SUBJECTS.forEach(template => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —Ç–∞–∫–æ–≥–æ –∏–º–µ–Ω–∏ –≤ –ú–æ–∏—Ö –ø—Ä–µ–¥–º–µ—Ç–∞—Ö
            const isInMy = Object.values(DB.subjects).some(m => m.name.toLowerCase() === template.name.toLowerCase());
            
            if (!isInMy) {
                const div = document.createElement('div');
                div.className = 'subject-item';
                if (Timer.active) div.style.opacity = "0.5";

                div.innerHTML = `<div class="icon">${template.icon}</div><div class="name">${template.name}</div>`;
                div.onclick = () => { if(!Timer.active) moveSubject(template.id, false); };
                availGrid.appendChild(div);
            }
        });
    }

    // 2. –ü–ï–†–ï–ú–ï–©–ï–ù–ò–ï –ü–†–ï–î–ú–ï–¢–ê (–î–û–ë–ê–í–ò–¢–¨ / –£–î–ê–õ–ò–¢–¨)
    // 1. –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è (–î–æ–±–∞–≤–∏—Ç—å/–£–¥–∞–ª–∏—Ç—å)
    function moveSubject(id, isAlreadyAdded) {
        if (Timer.active) return App.toast("‚õîÔ∏è –°–Ω–∞—á–∞–ª–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–∞–π–º–µ—Ä!");

        // 1. –†–∞–±–æ—Ç–∞–µ–º —Å–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
        if (isAlreadyAdded) {
            if (Object.keys(DB.subjects).length <= 1) return App.toast("–ú–∏–Ω–∏–º—É–º 1 –ø—Ä–µ–¥–º–µ—Ç!");
            delete DB.subjects[id]; // –£–¥–∞–ª—è–µ–º –∫–ª—é—á –ø–æ–ª–Ω–æ—Å—Ç—å—é
            if (DB.user.subject === id) DB.user.subject = Object.keys(DB.subjects)[0];
        } else {
            const template = ALL_SUBJECTS.find(s => s.id === id);
            if (template) {
                // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–≥–æ –ø–æ ID –∏–∑ —ç—Ç–∞–ª–æ–Ω–∞
                DB.subjects[id] = { name: template.name, icon: template.icon, sec: 0 };
            }
        }

        // 2. –§–∏–∫—Å–∏—Ä—É–µ–º –≤—Ä–µ–º—è –∏–∑–º–µ–Ω–µ–Ω–∏—è, —á—Ç–æ–±—ã –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å Snapshot (–∏–∑ –®–∞–≥–∞ 1)
        DB.user.lastSaveTime = Date.now();

        // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º
        Data.save();
        updateSubjectLists();
        App.renderSubjects();
        App.updateUI();
    }

    function updateSubjectLists() {
        const myGrid = document.getElementById('my-subjects-list');
        const availGrid = document.getElementById('available-subjects-list');
        if (!myGrid || !availGrid) return;

        myGrid.innerHTML = '';
        availGrid.innerHTML = '';

        // –°–ø–∏—Å–æ–∫ ID, –∫–æ—Ç–æ—Ä—ã–µ —É –Ω–∞—Å —É–∂–µ –µ—Å—Ç—å
        const ownedIds = Object.keys(DB.subjects);

        // –†–µ–Ω–¥–µ—Ä–∏–º –ú–û–ò (—Ç–µ, —á—Ç–æ –≤ –±–∞–∑–µ)
        ownedIds.forEach(id => {
            const s = DB.subjects[id];
            const div = document.createElement('div');
            div.className = 'subject-item added';
            div.innerHTML = `<div class="icon">${s.icon}</div><div class="name">${s.name}</div>`;
            div.onclick = () => moveSubject(id, true);
            myGrid.appendChild(div);
        });

        // –†–µ–Ω–¥–µ—Ä–∏–º –î–û–°–¢–£–ü–ù–´–ï (—Ç–µ –∏–∑ ALL_SUBJECTS, –∫–æ—Ç–æ—Ä—ã—Ö –ù–ï–¢ –≤ ownedIds)
        ALL_SUBJECTS.forEach(subj => {
            if (!ownedIds.includes(subj.id)) {
                const div = document.createElement('div');
                div.className = 'subject-item';
                div.innerHTML = `<div class="icon">${subj.icon}</div><div class="name">${subj.name}</div>`;
                div.onclick = () => moveSubject(subj.id, false);
                availGrid.appendChild(div);
            }
        });
    }

    // 2. –§—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Å–ø–∏—Å–∫–æ–≤ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
    function updateSubjectLists() {
        const myGrid = document.getElementById('my-subjects-list');
        const availGrid = document.getElementById('available-subjects-list');
        if (!myGrid || !availGrid) return;

        myGrid.innerHTML = '';
        availGrid.innerHTML = '';

        // 1. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ ID, –∫–æ—Ç–æ—Ä—ã–µ —Å–µ–π—á–∞—Å –µ—Å—Ç—å –≤ "–ú–æ–∏—Ö –ø—Ä–µ–¥–º–µ—Ç–∞—Ö"
        const myIds = Object.keys(DB.subjects);

        // 2. –†–∏—Å—É–µ–º "–ú–æ–∏ –ø—Ä–µ–¥–º–µ—Ç—ã"
        myIds.forEach(id => {
            const s = DB.subjects[id];
            if (!s) return;

            const div = document.createElement('div');
            div.className = 'subject-item added';
            div.innerHTML = `<div class="icon">${s.icon}</div><div class="name">${s.name}</div>`;
            
            // –ü—Ä–∏ –∫–ª–∏–∫–µ ‚Äî —É–¥–∞–ª—è–µ–º (isAlreadyAdded = true)
            div.onclick = () => moveSubject(id, true);
            myGrid.appendChild(div);
        });

        // 3. –†–∏—Å—É–µ–º "–î–æ—Å—Ç—É–ø–Ω—ã–µ"
        // –ë–µ—Ä–µ–º –í–ï–°–¨ —Å–ø–∏—Å–æ–∫ ALL_SUBJECTS –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º: –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã—Ö –ù–ï–¢ –≤ myIds
        ALL_SUBJECTS.forEach(template => {
            if (!myIds.includes(template.id)) {
                const div = document.createElement('div');
                div.className = 'subject-item';
                div.innerHTML = `<div class="icon">${template.icon}</div><div class="name">${template.name}</div>`;
                
                // –ü—Ä–∏ –∫–ª–∏–∫–µ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º (isAlreadyAdded = false)
                div.onclick = () => moveSubject(template.id, false);
                availGrid.appendChild(div);
            }
        });
    }

    // 3. –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ (–ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ)
    // –û–Ω–∞ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Å—Ç–∞—Ä—ã–µ "–∫—Ä–∏–≤—ã–µ" ID –∏ –æ—Å—Ç–∞–≤–∏—Ç —Ç–æ–ª—å–∫–æ —á–∏—Å—Ç—ã–µ –∏–∑ ALL_SUBJECTS
    Data.cleanSubjects = function() {
        if (!DB || !DB.subjects) return;

        const newCleanSubjects = {};
        const currentKeys = Object.keys(DB.subjects);

        currentKeys.forEach(key => {
            const s = DB.subjects[key];
            if (!s || !s.name) return;

            // –ò—â–µ–º, –∫–∞–∫–æ–º—É ID –∏–∑ —ç—Ç–∞–ª–æ–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —ç—Ç–æ—Ç –ø—Ä–µ–¥–º–µ—Ç
            const template = ALL_SUBJECTS.find(t => t.name.trim().toLowerCase() === s.name.trim().toLowerCase());
            
            if (template) {
                // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Äî –ø–µ—Ä–µ–Ω–æ—Å–∏–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ID
                if (newCleanSubjects[template.id]) {
                    newCleanSubjects[template.id].sec += (s.sec || 0);
                } else {
                    newCleanSubjects[template.id] = { 
                        name: template.name, 
                        icon: template.icon, 
                        sec: s.sec || 0 
                    };
                }
            }
        });

        // –ï—Å–ª–∏ –ø–æ—Å–ª–µ —á–∏—Å—Ç–∫–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç ‚Äî –¥–∞–µ–º –ê–ª–≥–µ–±—Ä—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if (Object.keys(newCleanSubjects).length === 0) {
            newCleanSubjects['algebra'] = { name: '–ê–ª–≥–µ–±—Ä–∞', icon: '‚úñÔ∏è', sec: 0 };
        }

        DB.subjects = newCleanSubjects;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª –≤ –Ω–æ–≤–æ–º —Å–ø–∏—Å–∫–µ
        if (!DB.subjects[DB.user.subject]) {
            DB.user.subject = Object.keys(DB.subjects)[0];
        }
    };

    function updateSubjectLists() {
        const myGrid = document.getElementById('my-subjects-list');
        const availGrid = document.getElementById('available-subjects-list');
        if (!myGrid || !availGrid) return;

        myGrid.innerHTML = '';
        availGrid.innerHTML = '';

        // 1. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ú–û–ò–• –ü–†–ï–î–ú–ï–¢–û–í
        // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –ø—Ä–µ–¥–º–µ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª—å–Ω–æ –∑–∞–ø–∏—Å–∞–Ω—ã –≤ DB.subjects
        const myKeys = Object.keys(DB.subjects);
        
        myKeys.forEach(id => {
            const s = DB.subjects[id];
            if (!s) return;

            const div = document.createElement('div');
            div.className = 'subject-item added';
            if (Timer.active) div.style.opacity = "0.5";

            div.innerHTML = `
                <div class="icon">${s.icon}</div>
                <div class="name">${s.name}</div>
            `;
            
            // –ü–µ—Ä–µ–¥–∞–µ–º true, —Ç–∞–∫ –∫–∞–∫ –ø—Ä–µ–¥–º–µ—Ç —É–∂–µ –≤ —Å–ø–∏—Å–∫–µ "–ú–æ–∏"
            div.onclick = () => moveSubject(id, true);
            myGrid.appendChild(div);
        });

        // 2. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –î–û–°–¢–£–ü–ù–´–• –ü–†–ï–î–ú–ï–¢–û–í
        // –ë–µ—Ä–µ–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ ALL_SUBJECTS –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã—Ö –ù–ï–¢ –≤ myKeys
        ALL_SUBJECTS.forEach(template => {
            if (!myKeys.includes(template.id)) {
                const div = document.createElement('div');
                div.className = 'subject-item';
                if (Timer.active) div.style.opacity = "0.5";

                div.innerHTML = `
                    <div class="icon">${template.icon}</div>
                    <div class="name">${template.name}</div>
                `;
                
                // –ü–µ—Ä–µ–¥–∞–µ–º false, —Ç–∞–∫ –∫–∞–∫ –ø—Ä–µ–¥–º–µ—Ç–∞ –µ—â–µ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ "–ú–æ–∏"
                div.onclick = () => moveSubject(template.id, false);
                availGrid.appendChild(div);
            }
        });
    }


    function updatePresets() {
        const presetGrid = document.querySelector('.preset-grid');
        if (!presetGrid) return;

        presetGrid.innerHTML = ''; // –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–µ—Å–µ—Ç—ã

        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –ø—Ä–µ—Å–µ—Ç—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –º–æ–∏—Ö –ø—Ä–µ–¥–º–µ—Ç–∞—Ö
        const availablePresets = [
            { emoji: 'üìñ', name: '–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞' },
            { emoji: '‚öõÔ∏è', name: '–§–∏–∑–∏–∫–∞' },
            { emoji: 'üß™', name: '–•–∏–º–∏—è' },
            { emoji: 'üß¨', name: '–ë–∏–æ–ª–æ–≥–∏—è' },
            { emoji: 'üè∫', name: '–ò—Å—Ç–æ—Ä–∏—è' },
            { emoji: 'üåê', name: '–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫' }
        ];

        availablePresets.forEach(p => {
            const id = p.name.toLowerCase().replace(/[^a-z–∞-—è0-9]/gi, '-');
            if (!DB.subjects[id]) {
                const div = document.createElement('div');
                div.className = 'subject-item';
                div.innerHTML = `<div class="icon">${p.emoji}</div><div class="name">${p.name}</div>`;
                div.addEventListener('click', () => moveFromPreset(p.emoji, p.name));
                div.style.cursor = 'pointer';
                presetGrid.appendChild(div);
            }
        });
    }
    // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
    function moveSubject(id, isInMyList) {
        if (!DB || !DB.subjects) {
            App.toast("–î–∞–Ω–Ω—ã–µ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã");
            return;
        }

        let toastText = '';

        if (isInMyList) {
            if (DB.subjects[id]) {
                delete DB.subjects[id];
                toastText = `–ü–µ—Ä–µ–º–µ—â—ë–Ω –≤ –¥–æ—Å—Ç—É–ø–Ω—ã–µ`;
            }
        } else {
            const subj = ALL_SUBJECTS.find(s => s.id === id);
            if (subj && !DB.subjects[id]) {
                DB.subjects[id] = { name: subj.name, icon: subj.icon, sec: 0 };
                toastText = `–ü–µ—Ä–µ–º–µ—â—ë–Ω –≤ –º–æ–∏ –ø—Ä–µ–¥–º–µ—Ç—ã`;
            }
        }

        Data.save();

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–ø–∏—Å–∫–æ–≤
        setTimeout(() => {
            updateSubjectLists();
            updatePresets(); // ‚Üê –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ—Å–µ—Ç–æ–≤
            if (App && App.renderSubjects) App.renderSubjects();
        }, 0);

        if (toastText) App.toast(toastText);
    }

    // –ó–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –ø—Ä–æ—Ñ–∏–ª—è
    document.addEventListener('DOMContentLoaded', updateSubjectLists);

    // –í–∞–∂–Ω–æ! –í—ã–∑–æ–≤ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è (–¥–æ–±–∞–≤—å —ç—Ç–æ –≤ Auth.login –∏–ª–∏ initAfterLogin)
    if (typeof Auth !== 'undefined' && Auth.login) {
        const originalLogin = Auth.login;
        Auth.login = function(...args) {
            originalLogin.apply(Auth, args);
            setTimeout(() => {
                updateSubjectLists();
                console.log("–°–ø–∏—Å–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞");
            }, 500); // 0.5 —Å–µ–∫ ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —á—Ç–æ–±—ã DB –∑–∞–≥—Ä—É–∑–∏–ª—Å—è
        };
    }

    // ===== –ü–ï–†–ï–ú–ï–©–ï–ù–ò–ï –ò–ó –ü–†–ï–°–ï–¢–ê –í "–ú–û–ò –ü–†–ï–î–ú–ï–¢–´" =====

    // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∏–∑ –ø—Ä–µ—Å–µ—Ç–∞
    function moveFromPreset(emoji, name) {
        const id = name.toLowerCase().replace(/[^a-z–∞-—è0-9]/gi, '-');

        if (DB.subjects[id]) {
            App.toast("–ü—Ä–µ–¥–º–µ—Ç —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω");
            return;
        }

        DB.subjects[id] = { name: name, icon: emoji, sec: 0 };
        Data.save();

        App.toast(`–ü–µ—Ä–µ–º–µ—â—ë–Ω: ${name}`);

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Å–ø–∏—Å–∫–∏
        updateSubjectLists();
        updatePresets(); // ‚Üê –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ—Å–µ—Ç—ã

        if (App && App.renderSubjects) App.renderSubjects();
    }
    // –û—á–∏—Å—Ç–∫–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö/–Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –∫–ª—é—á–µ–π –≤ subjects (–∑–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–∫–∏ Firebase)
    function cleanSubjects() {
        if (!DB || !DB.subjects) return;

        const keys = Object.keys(DB.subjects);
        keys.forEach(key => {
            if (!key || key.trim() === '' || key === 'undefined' || key === 'null') {
                delete DB.subjects[key];
                console.log("–£–¥–∞–ª—ë–Ω –ø—É—Å—Ç–æ–π/–Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π –∫–ª—é—á:", key);
            }
        });
    }
    function cleanEmptyKeys() {
        if (!DB || !DB.subjects) return;

        const keys = Object.keys(DB.subjects);
        keys.forEach(key => {
            if (!key || key.trim() === '' || key === 'undefined' || key === 'null') {
                delete DB.subjects[key];
                console.log("–£–¥–∞–ª—ë–Ω –ø—É—Å—Ç–æ–π –∫–ª—é—á subjects:", key);
            }
        });
    }


    // –†—É—á–Ω–æ–π –ø–µ—Ä–µ–Ω–æ—Å –ø–æ –∫–æ–¥—É (–∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç)
    function manualQRTransfer() {
        const code = document.getElementById('manual-qr-code').value.trim();
        if (!code) return App.toast("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥");
        Transfer.pasteCode(code);
        document.querySelector('.modal.show').remove();
    }
    Transfer.pasteCode = function(code) {
        if (!code || code.trim() === '') {
            App.toast("‚ùå –ö–æ–¥ –ø—É—Å—Ç–æ–π");
            return;
        }

        try {
            // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
            const cleanedCode = code.trim().replace(/\s+/g, '');

            // –î–µ–∫–æ–¥–∏—Ä—É–µ–º base64 ‚Üí —Ç–µ–∫—Å—Ç ‚Üí JSON
            const decoded = atob(cleanedCode);
            const jsonText = decodeURIComponent(escape(decoded));
            const imported = JSON.parse(jsonText);

            if (imported && imported.user && imported.subjects) {
                DB = imported;
                Data.save();
                App.toast("‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—ë–Ω!");
                setTimeout(() => location.reload(), 1500); // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫
            } else {
                App.toast("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö");
            }
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞:", e);
            App.toast("‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫–æ–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω–æ–≤–æ.");
        }
    };



    </script>

    <!-- ECO MODE OVERLAY -->
    <div id="eco-overlay" onclick="App.toggleEcoMode(false)">
        <div class="eco-floater">
            <div id="eco-timer-display">00:00:00</div>
            <div class="eco-text">
                üîã –†–µ–∂–∏–º —ç–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–∂–µ–Ω–∏—è<br>
                –¢–∞–π–º–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç<br>
                –ù–∞–∂–º–∏, —á—Ç–æ–±—ã —Ä–∞–∑–±—É–¥–∏—Ç—å
            </div>
        </div>
    </div>

    <!-- TUTORIAL MODAL (–û–±—É—á–µ–Ω–∏–µ –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤) -->
    <div id="tutorial-modal" class="modal" style="z-index: 20000; background: rgba(0,0,0,0.95);">
        <div class="modal-content" style="text-align: center; max-width: 340px; background: linear-gradient(145deg, #1e1e2e, #2d2d44); color: white; border: 1px solid rgba(255,255,255,0.1); padding: 30px 20px;">
            
            <!-- –°–ª–∞–π–¥ 1: –§–∏–ª–æ—Å–æ—Ñ–∏—è -->
            <div class="tutorial-slide" id="tut-1">
                <div style="font-size: 60px; margin-bottom: 20px;">‚è≥</div>
                <h2 style="margin-bottom: 15px;">–í—Ä–µ–º—è = –û–ø—ã—Ç</h2>
                <p style="font-size: 14px; line-height: 1.6; opacity: 0.9; margin-bottom: 25px;">
                    –í –∂–∏–∑–Ω–∏ –Ω–µ—Ç –ø–æ–ª–æ—Å–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞, –∏ —ç—Ç–æ –¥–µ–º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç. <br>
                    <b>MathBooster –∏—Å–ø—Ä–∞–≤–∏—Ç —ç—Ç–æ.</b><br><br>
                    –ú—ã –±—É–¥–µ–º —Å—á–∏—Ç–∞—Ç—å –∫–∞–∂–¥—ã–π —á–∞—Å, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–ª –≤ —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è.
                </p>
                <button class="btn btn-primary" onclick="Tutorial.next(2)" style="width: 100%; box-shadow: 0 5px 15px rgba(108, 99, 255, 0.4);">–ü–æ–Ω—è—Ç–Ω–æ üëá</button>
            </div>

            <!-- –°–ª–∞–π–¥ 2: –ú–µ—Ö–∞–Ω–∏–∫–∞ -->
            <div class="tutorial-slide" id="tut-2" style="display: none;">
                <div style="font-size: 60px; margin-bottom: 20px;">‚è±Ô∏è</div>
                <h2 style="margin-bottom: 15px;">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</h2>
                <p style="font-size: 14px; line-height: 1.6; opacity: 0.9; margin-bottom: 25px;">
                    1. –°–∞–¥–∏—à—å—Å—è –∑–∞ —É—Ä–æ–∫–∏ ‚Äî <b>–≤–∫–ª—é—á–∞–π —Ç–∞–π–º–µ—Ä</b>.<br>
                    2. –¢–≤–æ–µ –≤—Ä–µ–º—è –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ <b>XP</b> (–û–ø—ã—Ç) –∏ <b>Coins</b> (–ú–æ–Ω–µ—Ç—ã).<br>
                    3. –ß–µ–º –±–æ–ª—å—à–µ —É—á–∏—à—å—Å—è, —Ç–µ–º –≤—ã—à–µ —Ç–≤–æ–π –†–∞–Ω–≥.
                </p>
                <button class="btn btn-primary" onclick="Tutorial.next(3)" style="width: 100%;">–î–∞–ª—å—à–µ üëá</button>
            </div>

            <!-- –°–ª–∞–π–¥ 3: –ú–æ—Ç–∏–≤–∞—Ü–∏—è -->
            <div class="tutorial-slide" id="tut-3" style="display: none;">
                <div style="font-size: 60px; margin-bottom: 20px;">üèÜ</div>
                <h2 style="margin-bottom: 15px;">–°—Ç–∞–Ω—å –õ–µ–≥–µ–Ω–¥–æ–π</h2>
                <p style="font-size: 14px; line-height: 1.6; opacity: 0.9; margin-bottom: 25px;">
                    –¢—Ä–∞—Ç—å –º–æ–Ω–µ—Ç—ã –Ω–∞ –∫—Ä—É—Ç—ã–µ —Ç–µ–º—ã –∏ –∞–≤–∞—Ç–∞—Ä—ã.<br>
                    –°–æ—Ä–µ–≤–Ω—É–π—Å—è —Å –¥—Ä—É–∑—å—è–º–∏.<br>
                    –î–æ–∫–∞–∂–∏, —á—Ç–æ —Ç—ã —Å–∞–º—ã–π –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã–π!
                </p>
                <button class="btn btn-primary" onclick="Tutorial.close()" style="width: 100%; background: #00d26a; box-shadow: 0 5px 15px rgba(0, 210, 106, 0.4);">–ù–∞—á–∞—Ç—å –ø—É—Ç—å üöÄ</button>
            </div>

        </div>
    </div>

    <!-- BATTLE MODAL (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π UI) -->
    <div id="battle-modal" class="modal" style="z-index: 12000;">
        <div class="modal-content" style="text-align: center; position: relative;">
            
            <!-- –ö–ù–û–ü–ö–ê –ó–ê–ö–†–´–¢–¨ (–ö—Ä–µ—Å—Ç–∏–∫) -->
            <button onclick="document.getElementById('battle-modal').classList.remove('show')" 
                    style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; color: var(--text-light); cursor: pointer;">
                ‚úï
            </button>

            <h2 style="color: #FF4B2B; margin-top: 0;">‚öîÔ∏è –ê—Ä–µ–Ω–∞ PVP</h2>
            
            <!-- –≠–ö–†–ê–ù 1: –í–•–û–î / –°–û–ó–î–ê–ù–ò–ï -->
            <div id="battle-login-view">
                <p style="color: var(--text-light); font-size: 13px; margin-bottom: 20px;">
                    –í–≤–µ–¥–∏ –∫–æ–¥ –¥—Ä—É–≥–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π —Å–≤–æ–π:
                </p>

                <!-- –ì—Ä—É–ø–ø–∞ –≤–≤–æ–¥–∞ –∫–æ–¥–∞ -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <input type="number" id="battle-code-input" class="input-field" placeholder="123" style="text-align: center; font-size: 24px; font-weight: bold; letter-spacing: 3px; margin: 0;">
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞ -->
                    <button class="btn btn-outline" onclick="BattleSys.genRandom()" style="width: auto; padding: 0 15px; border-color: var(--primary); color: var(--primary);">
                        üé≤ –°–æ–∑–¥–∞—Ç—å
                    </button>
                </div>
                
                <p style="font-weight: bold; color: var(--gold); margin: 15px 0;">–°—Ç–∞–≤–∫–∞: 15 üí∞</p>


                <button class="btn btn-primary" onclick="BattleSys.connect()" style="width: 100%; padding: 15px; font-size: 18px; box-shadow: 0 5px 15px rgba(255, 75, 43, 0.3);">
                    üöÄ –í –ë–û–ô
                </button>
            </div>

            <!-- –≠–ö–†–ê–ù 2: –õ–û–ë–ë–ò (–û–ñ–ò–î–ê–ù–ò–ï) -->
            <div id="battle-lobby-view" style="display: none;">
                <div class="loader" style="margin: 20px auto; border-top-color: #FF4B2B;"></div>
                <h3>–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...</h3>
                
                <div style="background: rgba(0,0,0,0.05); padding: 15px; border-radius: 10px; margin-top: 20px; text-align: left;">
                    <div style="margin-bottom: 5px;">üî¥ –ò–≥—Ä–æ–∫ 1: <b id="p1-name">...</b></div>
                    <div>üîµ –ò–≥—Ä–æ–∫ 2: <b id="p2-name">...</b></div>
                </div>
                
                <p style="font-size: 12px; color: var(--text-light); margin-top: 15px;">–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã: <b id="lobby-code-display" style="font-size: 16px; color: var(--text);">---</b></p>

                <button class="btn btn-outline" onclick="BattleSys.leaveLobby()" style="margin-top: 20px; color: #FF4B2B; border-color: #FF4B2B;">
                    ‚ùå –í—ã–π—Ç–∏
                </button>
            </div>
        </div>
    </div>

    <script>
        // üõ°Ô∏è –ó–ê–©–ò–¢–ê –û–¢ –ö–û–ü–ò–†–û–í–ê–ù–ò–Ø
        document.addEventListener('contextmenu', event => event.preventDefault()); // –ë–ª–æ–∫ –ø—Ä–∞–≤–æ–π –∫–Ω–æ–ø–∫–∏

        document.onkeydown = function(e) {
            // –ë–ª–æ–∫ F12
            if (e.keyCode == 123) return false;
            
            // –ë–ª–æ–∫ Ctrl+U (–ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–¥–∞)
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false;
            
            // –ë–ª–æ–∫ Ctrl+Shift+I (–ö–æ–Ω—Å–æ–ª—å)
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false;
        }
    </script>
    <!-- TRANSFER CODE MODAL (–û–∫–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∞) -->
    <div id="transfer-modal" class="modal" style="z-index: 20000;">
        <div class="modal-content" style="text-align: center;">
            <h2 style="margin-bottom: 10px;">üì¶ –ü–µ—Ä–µ–Ω–æ—Å</h2>
            <p style="color: var(--text-light); font-size: 13px;">–í–≤–µ–¥–∏ —ç—Ç–æ—Ç –∫–æ–¥ –Ω–∞ –Ω–æ–≤–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ:</p>
            
            <div id="transfer-code-display" style="background: #f0f0f0; color: #333; font-family: monospace; font-size: 32px; font-weight: bold; padding: 15px; border-radius: 10px; margin: 20px 0; border: 2px dashed var(--primary); user-select: all;">
                ---
            </div>

            <button class="btn btn-primary" onclick="document.getElementById('transfer-modal').classList.remove('show')" style="width: 100%;">
                –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    </div>
    <div id="weekly-modal" class="modal" style="z-index: 25000;">
        <div class="modal-content" style="background: linear-gradient(135deg, var(--surface), #fff9e6); border: 3px solid #FFD700;">
            <h2 style="color: #DAA520; margin-bottom: 5px;">üìä –ò—Ç–æ–≥–∏ –Ω–µ–¥–µ–ª–∏</h2>
            <p style="font-size: 12px; color: var(--text-light); margin-bottom: 20px;">–¢–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞ –ø—Ä–æ—à–ª—ã–µ 7 –¥–Ω–µ–π</p>
            
            <div class="grid" style="grid-template-columns: 1fr; gap: 10px; margin-bottom: 20px;">
                <div class="stat-pill" style="background: white; border: 1px solid #eee;">
                    <div class="stat-label">–ß–∏—Å—Ç–æ–µ –≤—Ä–µ–º—è</div>
                    <div class="stat-val" id="wr-time" style="font-size: 24px;">0—á 0–º</div>
                </div>
                <div class="stat-pill" style="background: white; border: 1px solid #eee;">
                    <div class="stat-label">–õ—é–±–∏–º—ã–π –ø—Ä–µ–¥–º–µ—Ç</div>
                    <div class="stat-val" id="wr-subject" style="color: var(--primary);">‚Äî</div>
                </div>
                <div class="stat-pill" style="background: white; border: 1px solid #eee;">
                    <div class="stat-label">–û–ø—ã—Ç–∞ –ø–æ–ª—É—á–µ–Ω–æ</div>
                    <div class="stat-val" id="wr-xp" style="color: var(--success);">+0 XP</div>
                </div>
            </div>

            <p style="font-size: 13px; font-style: italic; margin-bottom: 20px;">"–¢—ã –º–æ–ª–æ–¥–µ—Ü! –ù–æ–≤–∞—è –Ω–µ–¥–µ–ª—è ‚Äî –Ω–æ–≤—ã–µ —Ä–µ–∫–æ—Ä–¥—ã. üöÄ"</p>
            
            <button class="btn btn-primary" style="background: #FFD700; color: #333; border: none;" onclick="document.getElementById('weekly-modal').classList.remove('show')">–ü–æ–≥–Ω–∞–ª–∏ –≤ –Ω–æ–≤—É—é –Ω–µ–¥–µ–ª—é! ‚ö°</button>
        </div>
    </div>
    <div id="wheel-modal" class="modal" style="z-index: 26000;">
        <div class="modal-content" style="max-width: 350px; text-align: center;">
            <h2 style="margin-bottom: 10px;">üé° –ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã</h2>
            <p style="font-size: 12px; color: var(--text-light); margin-bottom: 20px;">–ò—Å–ø—ã—Ç–∞–π —Å–≤–æ—é —É–¥–∞—á—É —Å–µ–≥–æ–¥–Ω—è!</p>
            
            <!-- –°–∞–º–æ –ö–æ–ª–µ—Å–æ -->
            <div id="wheel-container" style="position: relative; width: 200px; height: 200px; margin: 0 auto 20px auto;">
                <div id="wheel-pointer" style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 20px; height: 30px; background: #FF4757; clip-path: polygon(50% 100%, 0 0, 100% 0); z-index: 10;"></div>
                <canvas id="wheel-canvas" width="200" height="200" style="width: 100%; height: 100%; transition: transform 4s cubic-bezier(0.15, 0, 0.15, 1);"></canvas>
            </div>

            <button id="wheel-spin-btn" class="btn btn-primary" style="width: 100%;" onclick="WheelSys.spin()">üöÄ –ö–†–£–¢–ò–¢–¨ –ë–ï–°–ü–õ–ê–¢–ù–û</button>
            <button class="btn btn-outline" style="margin-top: 10px; width: 100%; border: none;" onclick="document.getElementById('wheel-modal').classList.remove('show')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    </body>
    </html>

