<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <!-- –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –º–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ iPhone (—á–µ–ª–∫–∞) -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MathBooster PRO</title>
    
    <!-- PWA –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
<link id="manifest-link" rel="manifest" href="">
<meta name="theme-color" content="#6C63FF">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes"> <!-- ‚Üê –Ω–æ–≤–∞—è -->
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MathBooster">

<!-- –ò–∫–æ–Ω–∫–∏ -->
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ QR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- YANDEX METRIKA -->
    <script type="text/javascript" >
       
       (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
       m[i].l=1*new Date();
       for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
       k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
       (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

       ym(105919372, "init", { // <-- –í–°–¢–ê–í–¨ –°–í–û–ô ID –°–ß–ï–¢–ß–ò–ö–ê
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true
       });
       
    </script>

    <!-- FIREBASE (–ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // üî• –í–°–¢–ê–í–¨ –°–Æ–î–ê –ö–û–ù–§–ò–ì –ò–ó FIREBASE CONSOLE üî•
        const firebaseConfig = {
  	  apiKey: "AIzaSyAK4kX2dl93WlpEFLg_eGvpvoeAAF935tQ",
  	  authDomain: "mathbooster-pro.firebaseapp.com",
  	  projectId: "mathbooster-pro",
  	  storageBucket: "mathbooster-pro.firebasestorage.app",
  	  messagingSenderId: "990295839020",
  	  appId: "1:990295839020:web:ba5bb8cfa471c2c4a89c89",
  	  measurementId: "G-8N8MYJPCHR"
	};

        try {
            if (firebaseConfig.apiKey) {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                // –î–µ–ª–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–º –≥–ª–æ–±–∞–ª—å–Ω–æ
                window.DB_Online = { db, doc, setDoc, getDoc, collection, getDocs, query, orderBy, limit };
                console.log("‚úÖ Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω —É—Å–ø–µ—à–Ω–æ");
            } else {
                console.log("‚ö†Ô∏è Firebase –∫–æ–Ω—Ñ–∏–≥ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –†–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º.");
            }
        } catch(e) { 
            console.error("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Firebase:", e); 
        }
    </script>
    
    <style>
        @supports (padding: max(0px)) {
    body.zen-active {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
    }
}
        /* === –ë–ê–ó–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï === */
        :root {
            --primary: #6C63FF;
            --bg: #F4F7FE;
            --surface: #FFFFFF;
            --text: #2B3674;
            --text-light: #707EAE;
            --shadow: 0 10px 30px rgba(112, 144, 176, 0.12);
            --radius: 24px;
            --accent: #FF7675;
            --gold: #FFD700;
            --success: #00d26a;
            
            /* Safe Areas for iPhone X+ */
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        /* === –¢–ï–ú–´ –û–§–û–†–ú–õ–ï–ù–ò–Ø === */
        body.theme-gold { --primary: #FFD700; --bg: #1E1E2E; --surface: #2D2D44; --text: #FFFFFF; --text-light: #B8B8D1; --shadow: 0 10px 30px rgba(255, 215, 0, 0.3); }
        body.dark-mode.theme-gold { --primary: #FFEA80; }
        body.theme-standard { --primary: #6C63FF; --bg: #F4F7FE; --surface: #FFFFFF; --text: #2B3674; }
        body.theme-math { --primary: #00E0D0; --bg: #E0F7FA; --surface: #FFFFFF; --text: #006064; --text-light: #4DD0E1; --shadow: 0 10px 30px rgba(0, 224, 208, 0.2); }
        body.theme-neon { --primary: #D60270; --bg: #0B0014; --surface: #180028; --text: #DE05F8; --text-light: #9B4F96; }
        body.theme-pantone { --primary: #FF8F66; --bg: #FFF5EE; --surface: #FFFFFF; --text: #5D4037; --text-light: #8D6E63; --shadow: 0 10px 30px rgba(255, 143, 102, 0.2); }
        body.theme-forest { --primary: #556B2F; --bg: #F5F5DC; --surface: #FFFFF0; --text: #3E2723; --text-light: #6D4C41; --shadow: 0 10px 30px rgba(85, 107, 47, 0.15); }
        body.dark-mode {
    --bg: #1A1A2E;
    --surface: #16213E;
    --text: #EAEAEA;
    --text-light: #8892B0;
    --shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

/* –ö–æ–º–±–∏–Ω–∞—Ü–∏–∏: —Ç—ë–º–Ω—ã–π —Ä–µ–∂–∏–º + –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ç–µ–º–∞ (–∞–∫—Ü–µ–Ω—Ç –æ—Å—Ç–∞—ë—Ç—Å—è, —Ñ–æ–Ω —Ç—ë–º–Ω—ã–π) */
body.dark-mode.theme-standard { --primary: #8B7EFF; }
body.dark-mode.theme-math { --primary: #00F5E0; }
body.dark-mode.theme-pantone { --primary: #FFB399; }
body.dark-mode.theme-forest { --primary: #8FBC8F; }
body.dark-mode.theme-neon { --primary: #FF69B4; }
body.dark-mode.theme-gold { --primary: #FFD700; --bg: #1E1E1E; --surface: #2A2A2A; --text-light: #D4AF37; }
body.dark-mode.theme-dark { --primary: #9D7EFF; } /* –µ—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–¥–µ–ª—å–Ω–∞—è "dark" —Ç–µ–º–∞ */
        
        body.theme-dark {
    --primary: #7B73FF;
    --bg: #1E1E2E;
    --surface: #27293D;
    --text: #EAEAEA;
    --text-light: #A0A0B0;
    --shadow: 0 10px 30px rgba(0,0,0,0.4);
}

/* –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –∫–æ–º–±–æ —Å –¥—Ä—É–≥–∏–º–∏ —Ç–µ–º–∞–º–∏ –≤ —Ç—ë–º–Ω–æ–º —Ä–µ–∂–∏–º–µ */
body.theme-dark.theme-standard { --primary: #8B7EFF; }
body.theme-dark.theme-math { --primary: #00F5E0; }
body.theme-dark.theme-pantone { --primary: #FFAB91; }
body.theme-dark.theme-gold { --primary: #FFD700; --bg: #1E1E1E; --surface: #2A2A2A; }
        
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            -webkit-tap-highlight-color: transparent; 
            outline: none; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            transition: 0.3s; 
            min-height: 100vh; 
            overflow-x: hidden; 
            user-select: none;
            -webkit-user-select: none;
            /* –û—Ç—Å—Ç—É–ø—ã –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ —á–µ–ª–∫–∏ */
            padding-top: calc(var(--safe-top) + 10px);
            padding-bottom: calc(90px + var(--safe-bottom)); 
        }

        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 0 20px; 
            transition: 0.5s; 
        }

        /* === LOGO === */
        .app-logo {
            width: 80px; 
            height: 80px; 
            object-fit: contain; 
            margin-bottom: 10px;
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.1));
        }

        /* === ZEN MODE === */
        body.zen-active { 
            overflow: hidden; 
            padding: 0; 
        }
        body.zen-active .nav, 
        body.zen-active .header-card, 
        body.zen-active .section:not(#dashboard) { 
            display: none !important; 
        }
        body.zen-active .container { 
            padding: 0; 
            max-width: 100%; 
            height: 100vh; 
        }
        body.zen-active #dashboard .grid { 
            display: flex; 
            height: 100vh; 
            width: 100%; 
        }
        body.zen-active #dashboard .card:not(.zen-target) { 
            display: none !important; 
        }
        body.zen-active .zen-target {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;     /* –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Ü–µ–Ω—Ç—Ä */
    align-items: center;         /* –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Ü–µ–Ω—Ç—Ä */
    padding: 0;
    margin: 0;
    background: var(--bg);
    text-align: center;
}
        body.zen-active #timer {
    font-size: 18vw;              /* –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–º–µ—Ä */
    min-font-size: 60px;          /* –º–∏–Ω–∏–º—É–º –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
    max-font-size: 120px;         /* –º–∞–∫—Å–∏–º—É–º –Ω–∞ –±–æ–ª—å—à–∏—Ö */
    line-height: 1;
    margin: 0 0 20px 0;
    padding: 0;
    color: var(--text);
    text-shadow: 0 5px 20px rgba(0,0,0,0.3);
}
       /* –ö–æ–Ω—Ç—Ä–æ–ª—ã –ø–æ–¥ —Ç–∞–π–º–µ—Ä–æ–º ‚Äî —Ç–æ–∂–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É */
body.zen-active .zen-controls {
    position: static;             /* —É–±–∏—Ä–∞–µ–º fixed, —á—Ç–æ–±—ã –Ω–µ —Å–¥–≤–∏–≥–∞–ª–æ—Å—å */
    margin-top: 20px;
    width: 90%;
    max-width: 400px;
}

/* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã body –≤ Zen */
body.zen-active {
    padding: 0 !important;
    margin: 0;
    overflow: hidden;
}
        
        /* === UI ELEMENTS === */
        #auth-screen { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: var(--bg); 
            z-index: 5000; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
            transition: 0.4s; 
            overflow-y: auto; 
            padding-top: var(--safe-top); 
        }
        #auth-screen.hidden { opacity: 0; pointer-events: none; transform: scale(1.1); }
        
        .auth-card { background: var(--surface); padding: 40px; border-radius: 30px; box-shadow: var(--shadow); width: 100%; max-width: 400px; text-align: center; margin: auto; }
        .avatar-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0; }
        .avatar-option { font-size: 30px; padding: 10px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; background: var(--bg); transition: 0.2s; }
        .avatar-option.selected { border-color: var(--primary); background: rgba(0,0,0,0.05); }
        
        .user-list-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--bg); border-radius: 15px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; text-align: left; }
        .user-list-item:hover { transform: translateX(5px); border: 1px solid var(--primary); }
        .user-avatar { font-size: 24px; width: 40px; height: 40px; background: var(--surface); border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        .header-card { background: var(--surface); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .profile-mini { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .profile-img { width: 50px; height: 50px; background: var(--bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; border: 4px solid transparent; transition: 0.3s; }
        
        /* LEAGUES */
        .league-bronze { border-color: #CD7F32; }
        .league-silver { border-color: #C0C0C0; }
        .league-gold { border-color: #FFD700; box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        .league-diamond { border-color: #b9f2ff; box-shadow: 0 0 15px rgba(185, 242, 255, 0.6); }
        .league-legend { border-color: #ff4d4d; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 77, 77, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0); } }

        .currency-block { display:flex; gap:15px; align-items:center; }
        .currency-item { display:flex; align-items:center; gap:5px; font-weight:bold; font-size:14px; background:var(--bg); padding:5px 12px; border-radius:12px; }
        
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .stat-pill { background: var(--bg); padding: 10px; border-radius: 15px; text-align: center; }
        .stat-val { font-weight: 800; font-size: 16px; color: var(--primary); }
        .stat-label { font-size: 10px; color: var(--text-light); text-transform: uppercase; font-weight: bold; }

        /* FIXED BOTTOM NAV FOR MOBILE */
        .nav { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: var(--surface); z-index: 1000;
            display: flex; gap: 8px; overflow-x: auto; 
            padding: 10px 10px calc(10px + var(--safe-bottom)) 10px; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            scrollbar-width: none; 
        }
        .nav::-webkit-scrollbar { display: none; }
        .nav-btn { background: var(--bg); border: none; padding: 12px 20px; border-radius: 18px; color: var(--text-light); font-weight: 700; cursor: pointer; transition: 0.2s; white-space: nowrap; flex-shrink: 0; font-size: 15px; }
        .nav-btn.active { background: var(--primary); color: white; transform: scale(1.05); box-shadow: 0 5px 15px rgba(108, 99, 255, 0.3); }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .card { background: var(--surface); padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow); transition: 0.2s; }
        .btn { padding: 15px; border-radius: 15px; border: none; font-weight: bold; cursor: pointer; width: 100%; transition: 0.2s; font-size: 16px; display:flex; justify-content:center; align-items:center; gap:5px; -webkit-tap-highlight-color: transparent; }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--text-light); color: var(--text-light); }
        .input-field { width: 100%; padding: 15px; border-radius: 15px; border: 2px solid var(--bg); background: var(--bg); color: var(--text); font-size: 16px; margin-bottom: 15px; outline: none; -webkit-appearance: none; }
        .timer-display { font-size: 72px; font-weight: 800; color: var(--text); text-align: center; margin: 15px 0; font-variant-numeric: tabular-nums; transition: 0.3s; }
        
        .achievements-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; }
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; }
        .shop-item { padding: 15px; border-radius: 15px; background: var(--bg); cursor: pointer; text-align: center; border: 2px solid transparent; transition: 0.2s; position:relative; overflow:hidden;}
        .shop-item:active { transform: scale(0.95); }
        .shop-item.active { border-color: var(--primary); background: rgba(0,0,0,0.03); box-shadow: var(--shadow); }
        .shop-price-tag { font-size:12px; font-weight:bold; margin-top:5px; color:var(--text-light); }
        .shop-price-tag.affordable { color: var(--primary); }

        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 6000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); padding: 20px; }
        .modal.show { display: flex; animation: popIn 0.3s; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-content { background: var(--surface); padding: 30px; border-radius: 25px; text-align: center; width: 100%; max-width: 400px; box-shadow: var(--shadow); max-height: 80vh; overflow-y: auto; }
        
        #toast-container { position: fixed; bottom: calc(90px + var(--safe-bottom)); left: 50%; transform: translateX(-50%); z-index: 9999; pointer-events: none; width: max-content; }
        .toast { background: var(--surface); color: var(--text); padding: 12px 25px; border-radius: 50px; font-weight: bold; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-top: 10px; opacity: 0; transform: translateY(20px); transition: 0.4s; border: 2px solid var(--primary); text-align: center; }
        .toast.show { opacity: 1; transform: translateY(0); }

        .stat-detail-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-detail-card { background: var(--bg); padding: 12px; border-radius: 15px; text-align: center; }
        .stat-detail-title { font-size: 10px; color: var(--text-light); font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
        .stat-detail-value { font-size: 18px; font-weight: 800; color: var(--primary); }
        .stat-detail-sub { font-size: 10px; color: var(--text-light); margin-top: 2px; }

        .trainer-box { text-align: center; padding: 20px; }
        .trainer-problem { font-size: 42px; font-weight: 800; color: var(--primary); margin: 20px 0; font-family: monospace; white-space: nowrap; }
        .trainer-stats { display: flex; justify-content: space-around; margin-bottom: 20px; font-size: 18px; font-weight: bold; color: var(--text-light); }
        .trainer-input { font-size: 32px; text-align: center; font-weight: bold; letter-spacing: 2px; background: var(--surface); border-color: var(--text-light); }

        .daily-grid { display: flex; justify-content: center; gap: 8px; margin: 20px 0; }
        .daily-day { width: 45px; height: 65px; border-radius: 12px; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; opacity: 0.5; transition: 0.3s; }
        .daily-day.active { opacity: 1; border: 2px solid var(--primary); background: var(--surface); transform: scale(1.15); box-shadow: var(--shadow); }
        .daily-day.claimed { opacity: 1; background: var(--primary); color: white; }
        .daily-coin { font-size: 18px; margin-bottom: 4px; }

        .subject-manage-grid { display: flex; flex-direction: column; gap: 10px; max-height: 300px; overflow-y: auto; margin-bottom: 20px; }
        .subject-manage-row { display: flex; justify-content: space-between; align-items: center; background: var(--bg); padding: 12px 15px; border-radius: 15px; }
        .subject-manage-info { display: flex; align-items: center; gap: 10px; font-weight: bold; }
        .btn-delete { width: 32px; height: 32px; border-radius: 50%; border: none; background: #FF7675; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: 0.2s; }
        .btn-delete:hover { transform: scale(1.1); }
        
        .preset-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin-top: 10px; }
        .preset-btn { padding: 12px; border: 2px solid var(--bg); background: var(--surface); border-radius: 12px; cursor: pointer; font-size: 12px; font-weight: bold; display: flex; flex-direction: column; align-items: center; gap: 5px; transition: 0.2s; color: var(--text); }
        .preset-btn:hover { border-color: var(--primary); background: rgba(108, 99, 255, 0.05); }

        /* CALCULATOR */
        .calc-box { width: 95%; max-width: 320px; }
        .calc-display { background: var(--bg); padding: 20px; font-size: 32px; text-align: right; border-radius: 15px; margin-bottom: 15px; font-family: monospace; font-weight: bold; color: var(--text); overflow: hidden; white-space: nowrap; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .calc-btn { padding: 15px; font-size: 22px; border-radius: 12px; border: none; background: var(--bg); color: var(--text); cursor: pointer; transition: 0.1s; font-weight: bold; touch-action: manipulation; }
        .calc-btn:active { transform: scale(0.9); background: rgba(0,0,0,0.1); }
        .calc-btn.op { color: var(--primary); background: rgba(108, 99, 255, 0.1); }
        .calc-btn.eq { background: var(--primary); color: white; grid-column: span 2; }
        .calc-btn.clr { color: #FF7675; }

        /* WHITEBOARD */
        .canvas-box { background: white; border-radius: 15px; cursor: crosshair; touch-action: none; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); width: 100%; border: 2px solid var(--bg); }
        .whiteboard-controls { display: flex; gap: 10px; margin-top: 10px; }

        /* SESSION LOG */
        .session-log { max-height: 250px; overflow-y: auto; }
        .session-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 13px; }
        .session-row:last-child { border-bottom: none; }
        .session-info { display: flex; flex-direction: column; }
        .session-date { font-size: 10px; color: var(--text-light); }
        .session-coins { color: var(--gold); font-weight: bold; background: rgba(255, 215, 0, 0.1); padding: 2px 8px; border-radius: 8px; }

        /* FX */
        .float-text { position: fixed; pointer-events: none; animation: floatUp 1s forwards; font-weight: 800; z-index: 9999; text-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 18px; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-50px) scale(1.3); opacity: 0; } }
        .confetti-piece { position: fixed; width: 10px; height: 10px; z-index: 9999; pointer-events: none; animation: fall linear forwards; }
        @keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotate(720deg); opacity: 0; } }

        /* ACHIEVEMENTS LIST */
        .ach-list { display: flex; flex-direction: column; gap: 10px; }
        .ach-row { display: flex; align-items: center; gap: 15px; background: var(--bg); padding: 15px; border-radius: 15px; transition: 0.2s; border: 2px solid transparent; }
        .ach-row.unlocked { background: var(--surface); border-color: var(--success); box-shadow: var(--shadow); }
        .ach-icon { font-size: 28px; width: 50px; height: 50px; background: rgba(0,0,0,0.05); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .ach-row.unlocked .ach-icon { background: var(--success); color: white; }
        .ach-info { flex-grow: 1; }
        .ach-title { font-weight: bold; font-size: 14px; margin-bottom: 3px; display: flex; justify-content: space-between; }
        .ach-desc { font-size: 12px; color: var(--text-light); margin-bottom: 8px; }
        .ach-bar-bg { width: 100%; height: 6px; background: rgba(0,0,0,0.1); border-radius: 3px; overflow: hidden; }
        .ach-bar-fill { height: 100%; background: var(--primary); transition: 0.5s; }
        .ach-row.unlocked .ach-bar-fill { background: var(--success); }

        /* GENDER & DATE PICKER */
        .reg-group { text-align: left; margin-bottom: 15px; }
        .reg-label { font-size: 12px; color: var(--text-light); margin-bottom: 5px; font-weight: bold; }
        .gender-switch { display: flex; gap: 10px; }
        .gender-btn { flex: 1; padding: 10px; border: 2px solid var(--bg); background: var(--bg); border-radius: 12px; cursor: pointer; font-weight: bold; color: var(--text-light); }
        .gender-btn.active { border-color: var(--primary); color: var(--primary); background: rgba(108, 99, 255, 0.05); }

        /* DIFFICULTY BUTTONS */
        .diff-switch { display: flex; gap: 5px; justify-content: center; margin-bottom: 20px; }
        .diff-btn { padding: 8px 15px; border: 2px solid var(--bg); background: var(--surface); border-radius: 10px; cursor: pointer; font-size: 12px; font-weight: bold; color: var(--text-light); }
        .diff-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* MUSIC WIDGET */
        .music-widget { display: flex; align-items: center; justify-content: space-between; background: var(--bg); padding: 10px 15px; border-radius: 15px; margin-bottom: 15px; }
        .music-info { display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 13px; color: var(--text); }
        .visualizer { display: flex; gap: 2px; align-items: flex-end; height: 15px; }
        .bar { width: 3px; background: var(--primary); animation: equalizer 1s infinite; }
        @keyframes equalizer { 0% { height: 5px; } 50% { height: 15px; } 100% { height: 5px; } }

        @media (max-width: 600px) {
            .stat-detail-grid { grid-template-columns: 1fr; }
            .header-card { flex-direction: column; align-items: flex-start; gap: 15px; }
            .currency-block { width: 100%; justify-content: space-between; }
            .nav-btn { padding: 10px 15px; font-size: 13px; }
            .preset-grid { grid-template-columns: repeat(3, 1fr); }
            .auth-card { padding: 30px 20px; }
        }

/* === –ê–î–ê–ü–¢–ê–¶–ò–Ø –ü–û–î –¢–ï–õ–ï–§–û–ù ‚Äî –ì–õ–ê–í–ù–û–ï === */
body {
    -webkit-text-size-adjust: 100%;
    word-break: break-word; /* –¥–ª–∏–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ –ø–µ—Ä–µ–Ω–æ—Å—è—Ç—Å—è */
    overflow-wrap: anywhere;
}

/* –í—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∏ –∫–Ω–æ–ø–∫–∏ */
.card, .btn, .input-field, .modal-content, .nav-btn {
    word-wrap: break-word;
    overflow-wrap: anywhere;
}

/* –¢–µ–∫—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —á–∞—Å—Ç–æ –≤—ã–ª–µ–∑–∞–ª–∏ */
.trainer-problem {
    font-size: 9vw; /* –≤–º–µ—Å—Ç–æ 42px ‚Äî —Ç–µ–ø–µ—Ä—å –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è */
    word-break: break-all;
    padding: 10px;
}

/* –¢–∞–π–º–µ—Ä –≤ Zen-—Ä–µ–∂–∏–º–µ */
body.zen-active #timer {
    font-size: 16vw; /* –±—ã–ª–æ 18vw ‚Äî —á—É—Ç—å –º–µ–Ω—å—à–µ, —á—Ç–æ–±—ã –≤–ª–µ–∑–∞–ª */
}

/* –ö–Ω–æ–ø–∫–∏ –≤ –Ω–∏–∂–Ω–µ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
.nav {
    padding: 10px 5px calc(10px + var(--safe-bottom));
    gap: 5px;
}
.nav-btn {
    padding: 10px 12px;
    font-size: 12px;
    min-width: 60px;
}

/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ‚Äî —á—Ç–æ–±—ã –≥—Ä–∞—Ñ–∏–∫–∏ –Ω–µ –≤—ã–ª–µ–∑–∞–ª–∏ */
#subjectChart, #weekChart {
    max-height: 250px;
}

/* –ú–æ–¥–∞–ª–∫–∏ */
.modal-content {
    margin: 20px;
    max-width: calc(100vw - 40px);
}

/* –£–º–µ–Ω—å—à–∞–µ–º —à—Ä–∏—Ñ—Ç—ã –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
@media (max-width: 380px) {
    .timer-display { font-size: 60px; }
    .trainer-problem { font-size: 8vw; }
    .nav-btn { font-size: 11px; padding: 10px 8px; }
    h2 { font-size: 22px; }
    h3 { font-size: 18px; }
}

/* === SPLASH SCREEN STYLES === */
#splash-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg); /* –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π —Ü–≤–µ—Ç –±—Ä–µ–Ω–¥–∞: #6C63FF */
    z-index: 99999; /* –°–∞–º—ã–π –≤–µ—Ä—Ö–Ω–∏–π —Å–ª–æ–π */
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    transition: opacity 0.5s ease-out, visibility 0.5s;
}

#splash-screen.hidden {
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
}

.splash-logo {
    width: 120px;
    height: 120px;
    margin-bottom: 20px;
    animation: bounce 2s infinite;
    filter: drop-shadow(0 10px 20px rgba(108, 99, 255, 0.3));
}

.splash-title {
    font-size: 24px;
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 30px;
    letter-spacing: 1px;
}

/* –ö—Ä—É—Ç–∏–ª–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ */
.loader {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(108, 99, 255, 0.2);
    border-top: 4px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

    </style>
</head>
<body>

<!-- SPLASH SCREEN ‚Äî —É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è -->
<div id="splash-screen" style="
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: var(--bg); /* ‚Üê —Ñ–æ–Ω –±–µ—Ä—ë—Ç—Å—è –∏–∑ —Ç–µ–∫—É—â–µ–π —Ç–µ–º—ã (–Ω–∏–∫–∞–∫–æ–π —Ä–∞–∑–Ω–∏—Ü—ã –≤ —Ü–≤–µ—Ç–µ) */
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    transition: opacity 0.8s ease-out;
">
    <img src="logo.png" alt="MathBooster" style="
        width: clamp(140px, 40vw, 220px); /* ‚Üê –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–º–µ—Ä: –æ—Ç 140px –¥–æ 220px */
        height: auto;
        max-width: 80vw;
        animation: float 3s infinite ease-in-out;
        filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3));
    ">
    <h1 style="
        color: var(--text);
        margin-top: 30px;
        font-size: clamp(32px, 8vw, 48px);
        font-weight: 800;
        letter-spacing: 2px;
        text-align: center;
    ">
        MATH BOOSTER
    </h1>
    <p style="
        color: var(--text);
        margin-top: 10px;
        font-size: clamp(16px, 4vw, 20px);
    ">
        PRO
    </p>
</div>

<style>
/* –ê–Ω–∏–º–∞—Ü–∏—è –ª–æ–≥–æ ‚Äî –ø–ª–∞–≤–Ω–æ–µ "–ø–ª–∞–≤–∞–Ω–∏–µ" –≤–≤–µ—Ä—Ö-–≤–Ω–∏–∑ */
@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-12px); }
}
</style>

<script>
// –ü–ª–∞–≤–Ω–æ–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ splash —á–µ—Ä–µ–∑ 1.8 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
window.addEventListener('load', () => {
    setTimeout(() => {
        const splash = document.getElementById('splash-screen');
        if (splash) {
            splash.style.opacity = '0';
            setTimeout(() => splash.remove(), 800);
        }
    }, 1800); // 1.8 —Å–µ–∫—É–Ω–¥—ã –ø–æ–∫–∞–∑–∞
});
</script>

<!-- PWA Manifest Generation (–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è) -->
<script>
    const manifest = {
    "name": "MathBooster PRO",
    "short_name": "MathBooster",
    "start_url": "/",  // ‚Üê —Ñ–∏–∫—Å
    "display": "standalone",
    "background_color": "#F4F7FE",
    "theme_color": "#6C63FF",
    "orientation": "portrait",
    "icons": [
        { "src": "icon-192.png", "sizes": "192x192", "type": "image/png" },
        { "src": "icon-512.png", "sizes": "512x512", "type": "image/png" }
    ]
};
    const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
    document.getElementById('manifest-link').setAttribute('href', URL.createObjectURL(blob));
</script>

<!-- AUTH SCREEN -->
<div id="auth-screen">
    <div class="auth-card" id="login-view">
        <img src="logo.png" alt="Logo" class="app-logo"> <!-- –ó–¥–µ—Å—å -->
        <h2 style="margin-bottom: 5px; color: var(--primary);">MathBooster PRO</h2>
        <p style="color: var(--text-light); font-size: 14px; margin-bottom: 20px;">–¢–≤–æ–π –ø—É—Ç—å –∫ –∑–Ω–∞–Ω–∏—è–º</p>
        <div id="user-list"></div>
        <button class="btn btn-primary" onclick="Auth.showRegister()" style="margin-top: 10px;">+ –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
    </div>

    <div class="auth-card" id="register-view" style="display: none;">
        <h2>–ù–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
        <div class="avatar-grid" id="avatar-selector"></div>
        
        <!-- –í–û–¢ –°–ê–ú–ê–Ø –í–ê–ñ–ù–ê–Ø –°–¢–†–û–ö–ê. –ë–ï–ó ID="reg-name" –ù–ò–ß–ï–ì–û –ù–ï –†–ê–ë–û–¢–ê–ï–¢ -->
        <input type="text" id="reg-name" class="input-field" placeholder="–í–∞—à–µ –∏–º—è..." maxlength="12">
        <!-- ----------------------------------------------------------- -->

        <div class="reg-group" style="margin:15px 0;">
            <div style="font-size:12px; color:var(--text-light); margin-bottom:5px;">–ü–æ–ª</div>
            <div style="display:flex; gap:10px;">
                <button class="btn gender-btn active" onclick="Auth.setGender('male')" style="border:2px solid var(--bg);">üë® –ü–∞—Ä–µ–Ω—å</button>
                <button class="btn gender-btn" onclick="Auth.setGender('female')" style="border:2px solid var(--bg);">üë© –î–µ–≤—É—à–∫–∞</button>
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn btn-outline" onclick="Auth.showLogin()">–ù–∞–∑–∞–¥</button>
            <button class="btn btn-primary" onclick="Auth.createAccount()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>
</div>

<!-- MAIN APP -->
<div class="container" id="app-container" style="display: none;"> 
    <div class="header-card">
        <div class="profile-mini" onclick="App.switchTab('profile')">
            <div class="profile-img" id="header-avatar-box"><div id="header-avatar">üòé</div></div>
            <div>
                <div style="font-weight: bold; font-size: 18px;" id="header-name">–ò–≥—Ä–æ–∫</div>
                <div style="font-size: 12px; color: var(--text-light);" id="header-league">–ù–æ–≤–∏—á–æ–∫</div>
            </div>
        </div>
        <div class="currency-block">
            <div class="currency-item"><span>üí∞</span> <span id="coin-display">0</span></div>
            <div class="currency-item" style="color:#FF7675;"><span>üî•</span> <span id="streak-display">0</span></div>
        </div>
    </div>

    <nav class="nav">
        <button class="nav-btn active" onclick="App.switchTab('dashboard', this)">‚è±Ô∏è –£—á–µ–±–∞</button>
        <button class="nav-btn" onclick="App.switchTab('trainer', this)">üß† –¢—Ä–µ–Ω–∞–∂–µ—Ä</button>
        <button class="nav-btn" onclick="App.switchTab('stats', this)">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        <button class="nav-btn" onclick="App.switchTab('leaderboard', this)">üèÜ –¢–æ–ø</button>
        <button class="nav-btn" onclick="App.switchTab('shop', this)">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
        <button class="nav-btn" onclick="App.switchTab('achievements', this)">üèÖ –ù–∞–≥—Ä–∞–¥—ã</button>
        <button class="nav-btn" onclick="App.switchTab('settings', this)">‚öôÔ∏è –û–ø—Ü–∏–∏</button>
    </nav>

    <!-- 1. DASHBOARD -->
    <section id="dashboard" class="section active">
        <div class="grid">
            <div class="card zen-target" style="text-align: center; position: relative;">
                <!-- TOOLS -->
                <div style="position: absolute; top: 15px; right: 15px; display:flex; gap:5px;">
                    <button onclick="Whiteboard.toggle()" style="background: transparent; border: none; font-size: 24px; cursor: pointer; opacity: 0.5;" title="–ß–µ—Ä–Ω–æ–≤–∏–∫">‚úèÔ∏è</button>
                    <button onclick="Calc.toggle()" style="background: transparent; border: none; font-size: 24px; cursor: pointer; opacity: 0.5;" title="–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä">üßÆ</button>
                    <button onclick="App.toggleZen()" style="background: transparent; border: none; font-size: 24px; cursor: pointer; opacity: 0.5;" title="–†–µ–∂–∏–º ZEN">üßò</button>
                </div>
                
                <h3 style="color: var(--text-light); font-size: 12px; text-transform: uppercase;">–§–æ–∫—É—Å</h3>
                <h2 id="subject-title" style="font-size: 28px; color: var(--primary); margin-bottom: 10px;">–ê–ª–≥–µ–±—Ä–∞</h2>
                
                <div id="timer" class="timer-display">00:00:00</div>
                <div style="font-size: 13px; color: var(--text-light); margin-bottom: 15px;">
                    1 –º–æ–Ω–µ—Ç–∞ üí∞ –∑–∞ –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
                </div>
                
                <!-- SESSION GOAL -->
                <input type="text" id="session-goal" class="input-field" placeholder="üéØ –¶–µ–ª—å –Ω–∞ —Å–µ—Å—Å–∏—é (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)..." style="text-align: center; font-size: 14px; padding: 10px;">

                <div class="zen-controls" style="position: relative; width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                    <button id="btn-start" class="btn btn-primary" onclick="Timer.preStart()">üöÄ –°–¢–ê–†–¢</button>
                    <button class="btn btn-outline" onclick="Timer.stop()">‚èπ –°–¢–û–ü</button>
                </div>
                
                <!-- EXIT ZEN BTN (Hidden by default) -->
                <button class="btn btn-outline" style="margin-top:20px; display:none;" id="exit-zen-btn" onclick="App.toggleZen()">–í—ã–π—Ç–∏ –∏–∑ Zen</button>
            </div>
            
            <div class="card">
                <h3>üéß Lo-Fi –†–∞–¥–∏–æ</h3>
                <div class="music-widget">
                    <div class="music-info">
                        <span style="font-size: 20px;">üéµ</span>
                        <span>Chill Study Beats</span>
                    </div>
                    <div class="visualizer" id="music-vis" style="opacity: 0;">
                        <div class="bar" style="animation-duration: 0.5s"></div>
                        <div class="bar" style="animation-duration: 0.7s"></div>
                        <div class="bar" style="animation-duration: 0.4s"></div>
                        <div class="bar" style="animation-duration: 0.6s"></div>
                    </div>
                    <button id="music-btn" class="btn btn-primary" style="width: auto; padding: 5px 15px; font-size: 12px;" onclick="MusicPlayer.toggle()">‚ñ∂</button>
                </div>
                <!-- FIXED AUDIO SOURCE -->
                <audio id="lofi-stream" crossorigin="anonymous" preload="none">
                    <source src="https://lofi.stream.laut.fm/lofi" type="audio/mpeg">
                    <source src="https://stream.zeno.fm/f3wvbbqmdg8uv" type="audio/mpeg">
                </audio>
                
                <h3 style="margin-top: 20px;">üìö –ü—Ä–µ–¥–º–µ—Ç—ã</h3>
                <div id="subjects-grid" style="display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:15px; justify-items:center;"></div>            </div>
        </div>
    </section>

    <!-- 2. TRAINER -->
    <section id="trainer" class="section">
        <div class="card" id="trainer-menu" style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 60px; margin-bottom: 20px;">üß†</div>
            <h2>–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –°–ø—Ä–∏–Ω—Ç</h2>
            <p style="color: var(--text-light); margin: 10px 0 20px;">–†–µ—à–∏ –∫–∞–∫ –º–æ–∂–Ω–æ –±–æ–ª—å—à–µ –ø—Ä–∏–º–µ—Ä–æ–≤ –∑–∞ 60 —Å–µ–∫—É–Ω–¥.</p>
            
            <div class="diff-switch">
                <div class="diff-btn active" onclick="Trainer.setDiff('easy', this)">–õ–µ–≥–∫–æ</div>
                <div class="diff-btn" onclick="Trainer.setDiff('medium', this)">–°—Ä–µ–¥–Ω–µ</div>
                <div class="diff-btn" onclick="Trainer.setDiff('hard', this)">–°–ª–æ–∂–Ω–æ</div>
            </div>

            <div class="stat-pill" style="display: inline-block; margin-bottom: 30px;">
                <span class="stat-label">–í–∞—à –†–µ–∫–æ—Ä–¥</span><br>
                <span class="stat-val" style="font-size: 24px;" id="trainer-high-score">0</span>
            </div>
            <br>
            <button class="btn btn-primary" style="font-size: 20px; padding: 15px 40px;" onclick="Trainer.start()">–ù–∞—á–∞—Ç—å –ò–≥—Ä—É üöÄ</button>
        </div>

        <div class="card" id="trainer-game" style="display: none; text-align: center;">
            <div class="trainer-stats">
                <div>‚è≥ <span id="game-time">60</span>s</div>
                <div>‚úÖ <span id="game-score">0</span></div>
            </div>
            <div class="trainer-problem" id="game-problem" style="word-break:break-all;">2 x 2</div>            <input type="number" id="game-input" class="input-field trainer-input" placeholder="?">
            <div style="font-size: 12px; color: var(--text-light); margin-top: 10px;">–ù–∞–∂–º–∏ Enter —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å</div>
            <button class="btn btn-outline" style="margin-top: 20px;" onclick="Trainer.end()">–ó–∞–∫–æ–Ω—á–∏—Ç—å</button>
        </div>

        <div class="card" id="trainer-result" style="display: none; text-align: center;">
            <h2>–í—Ä–µ–º—è –≤—ã—à–ª–æ! üèÅ</h2>
            <div style="margin: 30px 0;">
                <div style="font-size: 14px; color: var(--text-light);">–í–∞—à —Å—á–µ—Ç</div>
                <div style="font-size: 48px; font-weight: bold; color: var(--primary);" id="result-score">0</div>
            </div>
            <div class="grid" style="margin-bottom: 20px;">
                <div class="stat-pill">
                    <div class="stat-val" id="result-xp">+0 XP</div>
                </div>
                <div class="stat-pill">
                    <div class="stat-val" id="result-coins">+0 üí∞</div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="Trainer.init()">–°—ã–≥—Ä–∞—Ç—å –µ—â–µ —Ä–∞–∑</button>
        </div>
    </section>

    <!-- 3. STATS -->
    <section id="stats" class="section">
        <div class="card" style="margin-bottom: 20px;">
            <h3>üìä –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
            <div class="stat-detail-grid">
                <div class="stat-detail-card">
                    <div class="stat-detail-title">–ó–∞ –Ω–µ–¥–µ–ª—é</div>
                    <div class="stat-detail-value" id="stat-week-time">0—á</div>
                    <div class="stat-detail-sub" id="stat-week-xp">0 XP</div>
                </div>
                <div class="stat-detail-card">
                    <div class="stat-detail-title">–ó–∞ –º–µ—Å—è—Ü</div>
                    <div class="stat-detail-value" id="stat-month-time">0—á</div>
                    <div class="stat-detail-sub" id="stat-month-xp">0 XP</div>
                </div>
                <div class="stat-detail-card">
                    <div class="stat-detail-title">–í—Å–µ –≤—Ä–µ–º—è</div>
                    <div class="stat-detail-value" id="stat-total-time">0—á</div>
                    <div class="stat-detail-sub" id="stat-total-xp">0 XP</div>
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h3>üî• –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (30 –¥–Ω–µ–π)</h3>
                <div id="heatmap" style="display:grid; grid-template-columns:repeat(7,1fr); gap:5px; margin-top:15px;"></div>            </div>
            <div class="card">
                <h3>üìú –ñ—É—Ä–Ω–∞–ª –∑–∞–Ω—è—Ç–∏–π</h3>
                <div id="session-log" class="session-log"></div>
            </div>
            <div class="card">
                <h3>–ò—Å—Ç–æ—Ä–∏—è (–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è)</h3>
                <div style="height: 200px;"><canvas id="weekChart"></canvas></div>
            </div>
            <div class="card">
                <h3>üß© –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</h3>
                <div style="height: 250px; position: relative;">
                    <canvas id="subjectChart"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- 4. LEADERBOARD -->
    <section id="leaderboard" class="section">
        <div class="card">
            <h3>üèÜ –ì–ª–æ–±–∞–ª—å–Ω—ã–π –¢–æ–ø</h3>
            <p style="font-size:12px; color:var(--text-light); margin-bottom:15px;">–ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ (—Ç—Ä–µ–±—É–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç)</p>
            <div id="total-players-count" style="text-align:center; font-weight:bold; color:var(--primary); margin-bottom:10px;"></div>
            <button class="btn btn-primary" onclick="Online.loadLeaderboard()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            <div id="leaderboard-list" style="margin-top:15px; display:flex; flex-direction:column; gap:10px;">
                <div style="text-align:center; color:gray;">–ù–∞–∂–º–∏ –æ–±–Ω–æ–≤–∏—Ç—å...</div>
            </div>
        </div>
    </section>

    <!-- 5. SHOP -->
    <section id="shop" class="section">
        <div class="card">
            <h3>üé® –¢–µ–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</h3>
            <p style="color: var(--text-light); font-size: 13px; margin-bottom: 15px;">–ü–æ–∫—É–ø–∞–π—Ç–µ –Ω–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –∑–∞ üí∞ –º–æ–Ω–µ—Ç—ã!</p>
            <div id="theme-list" class="shop-grid"></div>
        </div>
        <div class="card" style="margin-top: 20px;">
            <h3>üòé –ê–≤–∞—Ç–∞—Ä—ã</h3>
            <p style="color: var(--text-light); font-size: 13px; margin-bottom: 15px;">–í—ã–¥–µ–ª–∏—Ç–µ—Å—å –∏–∑ —Ç–æ–ª–ø—ã!</p>
            <div id="avatar-shop-list" class="shop-grid"></div>
        </div>
    </section>

    <!-- 6. SETTINGS & DONATION -->
    <section id="settings" class="section">
        <div class="card" style="margin-top: 20px; text-align: center; cursor: pointer;" onclick="document.getElementById('about-modal').classList.add('show')">
            <h3>‚ÑπÔ∏è –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</h3>
            <p style="color: var(--text-light); font-size: 12px;">–í–µ—Ä—Å–∏—è 1.9 PRO ‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</p>
        </div>

        <div style="background:linear-gradient(135deg, #FFD700, #FFA500); padding:20px; border-radius:20px; color:#333; margin:20px 0; text-align:center; position:relative; overflow:hidden; box-shadow:0 10px 20px rgba(255,215,0,0.3);">
            <div style="font-size:40px; margin-bottom:5px;">üíé</div>
            <h3 style="margin:0; font-weight:800; text-transform:uppercase;">Premium</h3>
            <p style="font-size:12px; margin:5px 0;">–ü–æ–¥–¥–µ—Ä–∂–∏ –ø—Ä–æ–µ–∫—Ç –∏ –ø–æ–ª—É—á–∏ –±–æ–Ω—É—Å—ã!</p>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px;">
                <button class="btn" style="background:white; color:#2B3674; font-size:12px;" onclick="Donation.payUz()">üá∫üáø UZB (Humo)</button>
                <button class="btn" style="background:#2B3674; color:white; font-size:12px;" onclick="Donation.payWorld()">üåç World (Visa)</button>
            </div>
            <button class="btn" style="background:rgba(255,255,255,0.3); color:white; margin-top:10px;" onclick="Donation.enterCode()">üîë –í–≤–µ—Å—Ç–∏ –∫–æ–¥</button>
        </div>

        
<div class="card">
    <h3>‚öôÔ∏è –û–ø—Ü–∏–∏ –∏ –ø–µ—Ä–µ–Ω–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</h3>
    
    <!-- –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--bg); padding: 15px; border-radius: 15px;">
        <span>üîä –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã</span>
        <input type="checkbox" id="sfx-toggle" onchange="SoundSys.toggleSFX(this.checked)" checked style="transform: scale(1.5);">
    </div>
    
<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; background: var(--bg); padding: 15px; border-radius: 15px;">
    <span>üåô –¢—ë–º–Ω—ã–π —Ä–µ–∂–∏–º</span>
    <input type="checkbox" id="dark-toggle" onchange="App.toggleDarkMode(this.checked)" style="transform: scale(1.5);">
</div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏ -->
    <div style="margin-bottom: 20px;">
        <h4 style="margin-bottom: 10px;">üìö –ü—Ä–µ–¥–º–µ—Ç—ã</h4>
        <div id="settings-subject-list" class="subject-manage-grid"></div>
        <div class="preset-grid" style="margin-top:10px;">
            <button class="preset-btn" onclick="SubjectSys.addPreset('üìñ','–õ–∏—Ç-—Ä–∞')">üìñ</button>
            <button class="preset-btn" onclick="SubjectSys.addPreset('‚öõÔ∏è','–§–∏–∑–∏–∫–∞')">‚öõÔ∏è</button>
            <button class="preset-btn" onclick="SubjectSys.addPreset('üß™','–•–∏–º–∏—è')">üß™</button>
            <button class="preset-btn" onclick="SubjectSys.addPreset('üß¨','–ë–∏–æ')">üß¨</button>
            <button class="preset-btn" onclick="SubjectSys.addPreset('üè∫','–ò—Å—Ç–æ—Ä–∏—è')">üè∫</button>
            <button class="preset-btn" onclick="SubjectSys.addPreset('üåê','–ê–Ω–≥–ª')">üåê</button>
        </div>
    </div>
    
    <!-- –ù–æ–≤—ã–π —á–∏—Å—Ç—ã–π —Ä–∞–∑–¥–µ–ª –ø–µ—Ä–µ–Ω–æ—Å–∞ -->
    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--bg);">
        <h4 style="margin-bottom: 15px;">üì¶ –ü–µ—Ä–µ–Ω–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</h4>
        <div style="display: flex; flex-direction: column; gap: 12px;">
            <button class="btn btn-primary" onclick="Transfer.showQR()">
                üì± –ü–µ—Ä–µ–Ω–æ—Å —á–µ—Ä–µ–∑ QR-–∫–æ–¥
            </button>
            
            <button class="btn btn-outline" onclick="Sync.toggleAuto()" style="margin-top: 10px;">
                ‚òÅÔ∏è –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –æ–±–ª–∞–∫–æ–º: <span id="sync-status">–í—ã–∫–ª</span>
            </button>
        </div>
        <p style="font-size: 12px; color: var(--text-light); margin-top: 15px; text-align: center;">
            QR-–∫–æ–¥ ‚Äî –±—ã—Å—Ç—Ä–æ–µ –ø–µ—Ä–µ–Ω–æ—Å–∞ –Ω–∞ –¥—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ<br>
            –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è ‚Äî –ø—Ä–æ–≥—Ä–µ—Å—Å –≤–µ–∑–¥–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        </p>
    </div>
    
    <!-- –°–±—Ä–æ—Å -->
    <button class="btn btn-outline" style="margin-top: 40px; border-color: #FF7675; color: #FF7675;" onclick="Auth.resetData()">
        üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
    </button>
</div>
    </section>
    
    <!-- 7. ACHIEVEMENTS -->
    <section id="achievements" class="section">
        <div class="card">
            <h3>üèÖ –ù–∞–≥—Ä–∞–¥—ã</h3>
            <div id="ach-list" class="ach-list"></div>
        </div>
    </section>
    
    <!-- PROFILE -->
    <section id="profile" class="section">
        <div class="card" style="text-align: center;">
            <div class="profile-img" id="profile-avatar-box" style="width: 80px; height: 80px; margin: 0 auto; font-size: 40px; border-width: 6px;">
                <div id="profile-avatar-big">üòé</div>
            </div>
            <h2 style="margin-top: 10px;" id="profile-name-big">–ò–≥—Ä–æ–∫</h2>
            <div style="color: var(--primary); font-weight: bold; margin-bottom: 20px; font-size: 18px;" id="profile-league-big">ü•â –ë—Ä–æ–Ω–∑–æ–≤–∞—è –õ–∏–≥–∞</div>
            
            <div class="stats-row">
                <div class="stat-pill"><div class="stat-val" id="prof-lvl">1</div><div class="stat-label">–£—Ä–æ–≤–µ–Ω—å</div></div>
                <div class="stat-pill"><div class="stat-val" id="prof-xp">0</div><div class="stat-label">–û–ø—ã—Ç</div></div>
                <div class="stat-pill"><div class="stat-val" id="prof-coins">0</div><div class="stat-label">–ú–æ–Ω–µ—Ç—ã</div></div>
            </div>
            <div style="margin-top: 20px; text-align: left;">
                <p style="font-size: 12px; color: var(--text-light); margin-bottom: 5px;">
                    –ü—Ä–æ–≥—Ä–µ—Å—Å —É—Ä–æ–≤–Ω—è: 
                    <span id="xp-progress-text" style="float:right; font-weight:bold;">0 / 500 XP</span>
                </p>
                <div style="height: 10px; background: rgba(0,0,0,0.1); border-radius: 5px; overflow: hidden;">
                    <div id="prof-xp-bar" style="height: 100%; width: 0%; background: var(--primary);"></div>
                </div>
            </div>
            <button class="btn btn-outline" style="margin-top: 30px; border-color: #FF7675; color: #FF7675;" onclick="Auth.logout()">üö™ –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
        </div>
    </section>
</div>

<!-- MODALS -->
<div id="calc-modal" class="modal">
    <div class="modal-content calc-box">
        <div id="calc-display" class="calc-display">0</div>
        <div class="calc-grid">
            <button class="calc-btn" style="color:#FF7675" onclick="Calc.clear()">C</button>
            <button class="calc-btn" onclick="Calc.append('(')">(</button>
            <button class="calc-btn" onclick="Calc.append(')')">)</button>
            <button class="calc-btn op" onclick="Calc.append('/')">√∑</button>
            <button class="calc-btn" onclick="Calc.append('7')">7</button>
            <button class="calc-btn" onclick="Calc.append('8')">8</button>
            <button class="calc-btn" onclick="Calc.append('9')">9</button>
            <button class="calc-btn op" onclick="Calc.append('*')">√ó</button>
            <button class="calc-btn" onclick="Calc.append('4')">4</button>
            <button class="calc-btn" onclick="Calc.append('5')">5</button>
            <button class="calc-btn" onclick="Calc.append('6')">6</button>
            <button class="calc-btn op" onclick="Calc.append('-')">-</button>
            <button class="calc-btn" onclick="Calc.append('1')">1</button>
            <button class="calc-btn" onclick="Calc.append('2')">2</button>
            <button class="calc-btn" onclick="Calc.append('3')">3</button>
            <button class="calc-btn op" onclick="Calc.append('+')">+</button>
            <button class="calc-btn" onclick="Calc.append('0')">0</button>
            <button class="calc-btn" onclick="Calc.append('.')">.</button>
            <button class="calc-btn eq" style="grid-column:span 2; background:var(--primary); color:white;" onclick="Calc.solve()">=</button>
        </div>
        <button class="btn btn-outline" style="margin-top: 15px; width: 100%;" onclick="Calc.toggle()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<div id="wb-modal" class="modal">
    <div class="modal-content" style="width:95%;">
        <h3>–ß–µ—Ä–Ω–æ–≤–∏–∫</h3>
        <div style="border:2px solid var(--text-light); border-radius:15px; overflow:hidden;">
            <canvas id="wb-canvas" class="canvas-box" height="350"></canvas>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn btn-outline" style="color:#FF7675;" onclick="Whiteboard.clear()">–û—á–∏—Å—Ç–∏—Ç—å</button>
            <button class="btn btn-primary" onclick="Whiteboard.close()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<div id="daily-modal" class="modal">
    <div class="modal-content" style="background:linear-gradient(135deg,var(--surface),var(--bg)); border:2px solid var(--gold);">
        <h2 style="color:var(--gold);">üéÅ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ë–æ–Ω—É—Å!</h2>
        <div class="daily-grid" id="daily-grid"></div>
        <div style="margin:20px 0; font-size:40px;">üí∞ <span id="daily-reward-amount">10</span></div>
        <button class="btn btn-primary" style="background:var(--gold); color:#333;" onclick="DailySys.claim()">–ó–∞–±—Ä–∞—Ç—å –ù–∞–≥—Ä–∞–¥—É</button>
    </div>
</div>

<div id="ach-details-box" class="modal">
    <div class="modal-content">
        <h2 id="ach-title"></h2>
        <p id="ach-desc" style="color:var(--text-light); margin-bottom:10px;"></p>
        <div id="ach-status" style="font-weight:bold;"></div>
        <button class="btn btn-primary" style="margin-top:20px;" onclick="document.getElementById('ach-details-box').classList.remove('show')">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<!-- ABOUT MODAL -->
<div id="about-modal" class="modal">
    <div class="modal-content">
        <div style="font-size: 60px; margin-bottom: 10px;">üíé</div>
        <h2 style="color: var(--primary);">MathBooster PRO</h2>
        <div style="background: var(--bg); display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; color: var(--text-light); margin: 10px 0;">v1.9 PRO</div>
        <p style="margin: 20px 0; line-height: 1.6;">–õ—É—á—à–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏ —É—á–µ–±—ã.</p>
        <div style="text-align: left; background: var(--bg); padding: 15px; border-radius: 15px; font-size: 13px; margin: 15px 0;">
            <div>üë®‚Äçüíª <b>–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫:</b> –ú–∞–Ω—Å—É—Ä–æ–≤ –†—É—Å—Ç–∞–º –£–∫—Ç–∞–º–æ–≤–∏—á</div>
            <div style="margin-top: 8px;">üíæ <b>–î–∞–Ω–Ω—ã–µ:</b> –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ</div>
        </div>
        <button class="btn btn-primary" style="margin-top: 20px;" onclick="App.switchTab('about'); document.getElementById('about-modal').classList.remove('show')">üìñ –ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ –Ω–∞—Å</button>
        <button class="btn btn-outline" style="margin-top: 10px;" onclick="document.getElementById('about-modal').classList.remove('show')">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<div id="toast-container"></div>

<script>
/* ==========================================
   0. FX SYSTEM
   ========================================== */
const FX = {
    floatText(x, y, text, color) {
        const el = document.createElement('div'); el.className = 'float-text';
        el.style.left = x + 'px'; el.style.top = y + 'px'; el.style.color = color || '#FFD700'; el.innerText = text;
        document.body.appendChild(el); setTimeout(() => el.remove(), 1000);
    },
    confetti() {
        for(let i=0; i<30; i++) {
            const el = document.createElement('div'); el.className = 'confetti-piece';
            el.style.left = Math.random() * 100 + 'vw'; el.style.background = ['#FFD700', '#FF7675', '#6C63FF', '#00d26a'][Math.floor(Math.random()*4)];
            el.style.animationDuration = (Math.random() * 2 + 2) + 's'; document.body.appendChild(el); setTimeout(() => el.remove(), 4000);
        }
    }
};

/* ==========================================
   0. PWA & SOUND
   ========================================== */
const PWA = {
    prompt: null,
    init() {
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); this.prompt = e;
            document.getElementById('btn-install').style.display = 'block';
        });
    },
    install() {
        if(this.prompt) {
            this.prompt.prompt();
            this.prompt.userChoice.then(() => {
                document.getElementById('btn-install').style.display = 'none'; this.prompt = null;
            });
        }
    }
};

const MusicPlayer = {
    playing: false,
    audio: null,
    
    init() { 
        this.audio = document.getElementById('lofi-stream'); 
        this.audio.addEventListener('ended', () => this.reset());
        this.audio.addEventListener('error', (e) => {
            App.toast("‚ùå –û—à–∏–±–∫–∞ —Ä–∞–¥–∏–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
            this.reset();
        });
    },

    reset() {
        this.playing = false;
        const btn = document.getElementById('music-btn');
        const vis = document.getElementById('music-vis');
        if(btn) btn.innerText = "‚ñ∂";
        if(vis) vis.style.opacity = "0";
    },

    toggle() {
        if(!this.audio) this.init();
        
        const btn = document.getElementById('music-btn');
        const vis = document.getElementById('music-vis');
        
        if(this.playing) {
            this.audio.pause();
            this.reset();
        } else {
            const playPromise = this.audio.play();
            if (playPromise !== undefined) {
                btn.innerText = "‚è≥";
                playPromise.then(_ => {
                    this.playing = true;
                    btn.innerText = "‚è∏";
                    vis.style.opacity = "1";
                })
                .catch(error => {
                    console.error("Audio Play Error:", error);
                    App.toast("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å —Ä–∞–¥–∏–æ");
                    this.reset();
                });
            }
        }
    }
};

const SoundSys = {
    ctx: null, enabled: true,
    init() { try { const AudioContext = window.AudioContext || window.webkitAudioContext; this.ctx = new AudioContext(); } catch(e) {} },
    toggleSFX(val) { this.enabled = val; DB.settings.sfx = val; Data.save(); if(val) this.play('click'); },
    play(type) {
        if(!this.enabled || !this.ctx) return; if(this.ctx.state === 'suspended') this.ctx.resume();
        const t = this.ctx.currentTime; const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
        osc.connect(gain); gain.connect(this.ctx.destination);
        if(type === 'click') { osc.type = 'sine'; osc.frequency.setValueAtTime(800, t); osc.frequency.exponentialRampToValueAtTime(1200, t+0.1); gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.001, t+0.1); osc.start(t); osc.stop(t+0.1); }
        else if(type === 'coin') { osc.type = 'sine'; osc.frequency.setValueAtTime(1200, t); osc.frequency.exponentialRampToValueAtTime(1800, t+0.3); gain.gain.setValueAtTime(0.1, t); gain.gain.linearRampToValueAtTime(0, t+0.5); osc.start(t); osc.stop(t+0.5); }
        else if(type === 'success') { this.beep(523.25, t, 0.1); this.beep(659.25, t+0.1, 0.1); this.beep(783.99, t+0.2, 0.2); }
        else if(type === 'error') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, t); osc.frequency.linearRampToValueAtTime(100, t+0.3); gain.gain.setValueAtTime(0.1, t); gain.gain.linearRampToValueAtTime(0, t+0.3); osc.start(t); osc.stop(t+0.3); }
        else if(type === 'win') { this.beep(523.25, t, 0.15); this.beep(523.25, t+0.15, 0.15); this.beep(523.25, t+0.30, 0.15); this.beep(659.25, t+0.45, 0.4); }
    },
    beep(freq, time, dur) { const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain(); osc.connect(gain); gain.connect(this.ctx.destination); osc.type = 'triangle'; osc.frequency.setValueAtTime(freq, time); gain.gain.setValueAtTime(0.1, time); gain.gain.linearRampToValueAtTime(0, time+dur); osc.start(time); osc.stop(time+dur); }
};

/* ==========================================
   1. DATA & CONFIG
   ========================================= */
const GenAch = () => {
    const list = []; let id = 1; const add = (title, desc, max, icon, type, sub=null) => list.push({id: id++, title, desc, max, icon, type, sub, unlocked:false});
    add("–ü–µ—Ä–≤—ã–π —à–∞–≥", "1 –º–∏–Ω—É—Ç–∞ —É—á–µ–±—ã", 60, "üå±", "total"); add("–†–∞–∑–º–∏–Ω–∫–∞", "15 –º–∏–Ω—É—Ç", 900, "ü§∏", "total"); add("–ß–∞—Å —Å–∏–ª—ã", "1 —á–∞—Å", 3600, "üïê", "total"); add("–°–ø—Ä–∏–Ω—Ç–µ—Ä", "5 —á–∞—Å–æ–≤", 18000, "üèÉ", "total"); add("–ú–∞—Ä–∞—Ñ–æ–Ω–µ—Ü", "10 —á–∞—Å–æ–≤", 36000, "üëü", "total"); add("–°—É—Ç–∫–∏", "24 —á–∞—Å–∞", 86400, "üåô", "total"); add("–ù–µ–¥–µ–ª—è", "50 —á–∞—Å–æ–≤", 180000, "üìÜ", "total"); add("–ü—Ä–æ—Ñ–∏", "100 —á–∞—Å–æ–≤", 360000, "üéì", "total"); add("–≠–∫—Å–ø–µ—Ä—Ç", "250 —á–∞—Å–æ–≤", 900000, "üíº", "total"); add("–ì—É—Ä—É", "500 —á–∞—Å–æ–≤", 1800000, "üßò", "total"); add("–ú—É–¥—Ä–µ—Ü", "1000 —á–∞—Å–æ–≤", 3600000, "üßô‚Äç‚ôÇÔ∏è", "total"); add("–õ–µ–≥–µ–Ω–¥–∞", "2000 —á–∞—Å–æ–≤", 7200000, "üëë", "total"); add("–¢–∏—Ç–∞–Ω", "5000 —á–∞—Å–æ–≤", 18000000, "üóø", "total"); add("–í–µ—á–Ω–æ—Å—Ç—å", "10000 —á–∞—Å–æ–≤", 36000000, "‚ö°", "total");
    [2, 5, 10, 15, 20, 30, 40, 50, 75, 100].forEach(l => add(`–£—Ä–æ–≤–µ–Ω—å ${l}`, `–î–æ—Å—Ç–∏–≥–Ω–∏ ${l} —É—Ä–æ–≤–Ω—è`, l, "üÜô", "lvl"));
    add("–ù–∞—á–∞–ª–æ –ø—É—Ç–∏", "–ó–∞—Ä–∞–±–æ—Ç–∞–π 100 XP", 100, "‚≠ê", "xp"); add("–û–ø—ã—Ç–Ω—ã–π", "–ó–∞—Ä–∞–±–æ—Ç–∞–π 1000 XP", 1000, "üåü", "xp"); add("–ú–∞—à–∏–Ω–∞ XP", "–ó–∞—Ä–∞–±–æ—Ç–∞–π 10.000 XP", 10000, "ü§ñ", "xp"); add("–ú–∏–ª–ª–∏–æ–Ω–µ—Ä", "–ó–∞—Ä–∞–±–æ—Ç–∞–π 1.000.000 XP", 1000000, "üíé", "xp");
    return list;
};

const DefaultDB = { 
    user: { 
        darkMode: false,
        xp:0, level:1, nextXp:500, totalSec:0, subject:'algebra', theme:'standard', 
        avatar:'üòé', gender:'male', coins:0, streak:0, lastStudyDate:null, 
        dailyStreak:0, lastDailyClaim:null, ownedThemes:['standard'], ownedAvatars:[], 
        trainerRecord:0, usedCodes:[] 
    }, 
    settings: { sfx:true }, 

    
    // üëá –í–û–¢ –ó–î–ï–°–¨ –ú–´ –î–û–ë–ê–í–ò–õ–ò –í–°–ï –ù–û–í–´–ï –ü–†–ï–î–ú–ï–¢–´ üëá
    subjects: { 
        algebra: {name:'–ê–ª–≥–µ–±—Ä–∞', icon:'‚úñÔ∏è', sec:0}, 
        geometry: {name:'–ì–µ–æ–º–µ—Ç—Ä–∏—è', icon:'üìê', sec:0},
        calculus: {name:'–ú–∞—Ç. –∞–Ω–∞–ª–∏–∑', icon:'‚à´', sec:0},
        arithmetic: {name:'–ê—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞', icon:'üî¢', sec:0},
        combinatorics: {name:'–ö–æ–º–±–∏–Ω–∞—Ç–æ—Ä–∏–∫–∞', icon:'üîÄ', sec:0},
        statistics: {name:'–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', icon:'üìä', sec:0},
        trigonometry: {name:'–¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è', icon:'üìè', sec:0},
        stereometry: {name:'–°—Ç–µ—Ä–µ–æ–º–µ—Ç—Ä–∏—è—è', icon:'üßä', sec:0}
    }, 
    history:{}, sessions:[], achievements:[] 
};


const AVATARS = [
    {id:'lion',icon:'ü¶Å',price:50}, 
    {id:'robot',icon:'ü§ñ',price:100}, 
    {id:'alien',icon:'üëΩ',price:150}, 
    {id:'dragon',icon:'üê≤',price:300}, 
    {id:'wizard',icon:'üßô‚Äç‚ôÇÔ∏è',price:300}, 
    {id:'king',icon:'üëë',price:500}
];

const THEMES = [
    { id: 'standard', name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç', icon: 'üíú', price: 0 },
    { id: 'dark', name: '–¢–µ–º–Ω–∞—è', icon: 'üåô', price: 10 },
    { id: 'pantone', name: '–ü–µ—Ä—Å–∏–∫', icon: 'üçë', price: 100 },
    { id: 'forest', name: '–õ–µ—Å', icon: 'üå≤', price: 150 },
    { id: 'neon', name: '–ù–µ–æ–Ω', icon: 'ü¶Ñ', price: 500 },
    { id: 'math', name: 'MathBooster', icon: 'üíé', price: 600 },
    { id: 'gold', name: '–ó–æ–ª–æ—Ç–æ', icon: 'ü•á', price: 1000 }
];

const SHOP_AVATARS = [
    { id: 'ninja', icon: 'ü¶Å', name: '–õ–µ–≤', price: 50 }, 
    { id: 'cyborg', icon: 'üëæ', name: '–ú–æ–Ω—Å—Ç—Ä', price: 100 }, 
    { id: 'alien', icon: 'üëΩ', name: '–ü—Ä–∏—à–µ–ª–µ—Ü', price: 150 }, 
    { id: 'dragon', icon: 'üê≤', name: '–î—Ä–∞–∫–æ–Ω', price: 200 }, 
    { id: 'vampire', icon: 'üßõ‚Äç‚ôÄÔ∏è', name: '–í–∞–º–ø–∏—Ä—à–∞', price: 200 },
    { id: 'fairy', icon: 'üßö‚Äç‚ôÄÔ∏è', name: '–§–µ—è', price: 250 },
    { id: 'wizard', icon: 'üßô‚Äç‚ôÇÔ∏è', name: '–ú–∞–≥', price: 250 }, 
    { id: 'mermaid', icon: 'üßú‚Äç‚ôÄÔ∏è', name: '–†—É—Å–∞–ª–∫–∞', price: 300 },
    { id: 'ghost', icon: 'üëª', name: '–ü—Ä–∏–∑—Ä–∞–∫', price: 300 }, 
    { id: 'crown', icon: 'üëë', name: '–ö–æ—Ä–æ–ª—å', price: 500 }, 
    { id: 'queen', icon: 'üë∏', name: '–ö–æ—Ä–æ–ª–µ–≤–∞', price: 500 },
    { id: 'brain', icon: 'üß†', name: '–ì–µ–Ω–∏–π', price: 1000 }
];

const LEAGUES = [{ min: 0, name: "ü•â –ë—Ä–æ–Ω–∑–æ–≤–∞—è –õ–∏–≥–∞", color: "league-bronze" }, { min: 1000, name: "ü•à –°–µ—Ä–µ–±—Ä—è–Ω–∞—è –õ–∏–≥–∞", color: "league-silver" }, { min: 5000, name: "ü•á –ó–æ–ª–æ—Ç–∞—è –õ–∏–≥–∞", color: "league-gold" }, { min: 15000, name: "üíé –ê–ª–º–∞–∑–Ω–∞—è –õ–∏–≥–∞", color: "league-diamond" }, { min: 50000, name: "üëë –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è –õ–∏–≥–∞", color: "league-legend" }];

let DB = null; 
const Data = {
    currentKey: null,
    initNewData(userId) { const newDB = JSON.parse(JSON.stringify(DefaultDB)); newDB.achievements = GenAch(); localStorage.setItem('MathData_' + userId, JSON.stringify(newDB)); },
    load(userId) { 
        this.currentKey = 'MathData_' + userId; const raw = localStorage.getItem(this.currentKey); 
        if (raw) { 
            const loaded = JSON.parse(raw);
            if(loaded.user) { 
                DB = loaded; 
                if(DB.user.coins === undefined) DB.user.coins = 0;
                if(DB.user.gender === undefined) DB.user.gender = 'male';
                if(DB.user.dob === undefined) DB.user.dob = '';
                if(DB.user.ownedAvatars === undefined) DB.user.ownedAvatars = [];
                if(DB.user.avatar === null && Auth.currentUser) DB.user.avatar = Auth.currentUser.avatar;
                if(DB.settings.sfx === undefined) DB.settings.sfx = true;
                if(DB.user.dailyStreak === undefined) { DB.user.dailyStreak = 0; DB.user.lastDailyClaim = null; }
                if(DB.sessions === undefined) DB.sessions = []; 
                if(DB.user.usedCodes === undefined) DB.user.usedCodes = [];
                
                // Cloud Sync
                if(window.DB_Online) {
                    this.syncWithCloud(userId);
                }
            } else { this.initNewData(userId); DB = JSON.parse(localStorage.getItem(this.currentKey)); }
        } else { this.initNewData(userId); DB = JSON.parse(localStorage.getItem(this.currentKey)); } 
    },
    async syncWithCloud(userId) {
        try {
            const docRef = window.DB_Online.doc(window.DB_Online.db, "users", userId);
            const docSnap = await window.DB_Online.getDoc(docRef);
            if(docSnap.exists()) {
                const cloudData = docSnap.data();
                // Basic conflict resolution: take cloud if more playtime
                if(cloudData.user.totalSec > DB.user.totalSec) {
                    DB = cloudData;
                    this.save();
                }
            }
        } catch(e) {}
    },
        save() {
        if (this.currentKey && DB) localStorage.setItem(this.currentKey, JSON.stringify(DB));
        
        // –û–±–ª–∞—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è ‚Äî —Ç–µ–ø–µ—Ä—å —Å –∏–º–µ–Ω–µ–º!
        if (window.DB_Online && Auth.currentUser) {
            const docRef = window.DB_Online.doc(window.DB_Online.db, "users", Auth.currentUser.id);
            
            // –Ø–≤–Ω–æ –±–µ—Ä—ë–º –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –∏–º—è –∏–∑ Auth
            const currentName = Auth.currentUser.name || DB.user.name || "–ò–≥—Ä–æ–∫";

            window.DB_Online.setDoc(docRef, {
                user: {
                    ...DB.user,
                    name: currentName,  // ‚Üê‚Üê‚Üê –≤—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –∏–º—è
                    avatar: DB.user.avatar || "üòé",
                    level: DB.user.level || 1,
                    xp: DB.user.xp || 0
                },
                subjects: DB.subjects,
                history: DB.history,
                sessions: DB.sessions
            }, { merge: true }).catch(e => console.log(e));
        }
    },
    export() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(DB)); const node = document.createElement('a'); node.setAttribute("href", dataStr); node.setAttribute("download", `${Auth.currentUser.name}_MathData.json`); document.body.appendChild(node); node.click(); node.remove(); },
    import(el) { const fr = new FileReader(); fr.onload = (e) => { try { DB = JSON.parse(e.target.result); this.save(); location.reload(); } catch(x) { alert("–û—à–∏–±–∫–∞ —Ñ–∞–π–ª–∞"); } }; fr.readAsText(el.files[0]); }
};

const Sync = {
    autoSync: false,

    init() {
        const saved = localStorage.getItem('autoSync');
        if (saved === 'true') {
            this.autoSync = true;
            document.getElementById('sync-status').innerText = '–í–∫–ª';
        }
    },

    toggleAuto() {
        this.autoSync = !this.autoSync;
        localStorage.setItem('autoSync', this.autoSync);
        document.getElementById('sync-status').innerText = this.autoSync ? '–í–∫–ª' : '–í—ã–∫–ª';
        App.toast(this.autoSync ? "‚òÅÔ∏è –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞" : "‚òÅÔ∏è –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞");
        
        if (this.autoSync && window.DB_Online && Auth.currentUser) {
            Data.save(); // —Å—Ä–∞–∑—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º
        }
    }
};

// --- WHITEBOARD & CALC ---
const Whiteboard = {
    canvas: null, ctx: null, isDrawing: false,
    init() {
        this.canvas = document.getElementById('wb-canvas'); this.ctx = this.canvas.getContext('2d'); this.resize();
        const h = (e) => { e.preventDefault(); this.start(e.touches?e.touches[0]:e); };
        const m = (e) => { e.preventDefault(); this.draw(e.touches?e.touches[0]:e); };
        const e = () => this.stop();
        this.canvas.onmousedown = h; this.canvas.onmousemove = m; this.canvas.onmouseup = e; this.canvas.onmouseout = e;
        this.canvas.ontouchstart = h; this.canvas.ontouchmove = m; this.canvas.ontouchend = e;
    },
    open() { document.getElementById('wb-modal').classList.add('show'); this.resize(); },
    close() { document.getElementById('wb-modal').classList.remove('show'); },
    resize() { const p = this.canvas.parentElement; this.canvas.width = p.clientWidth; this.canvas.height = 350; this.ctx.lineCap = 'round'; this.ctx.lineWidth = 3; this.ctx.strokeStyle = '#2B3674'; },
    start(e) { this.isDrawing = true; this.ctx.beginPath(); const r = this.canvas.getBoundingClientRect(); this.ctx.moveTo(e.clientX - r.left, e.clientY - r.top); },
    draw(e) { if(!this.isDrawing) return; const r = this.canvas.getBoundingClientRect(); this.ctx.lineTo(e.clientX - r.left, e.clientY - r.top); this.ctx.stroke(); },
    stop() { this.isDrawing = false; },
    clear() { this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height); },
    toggle() { this.open(); SoundSys.play('click'); }
};

const Calc = { 
    current: '', 
    toggle() { document.getElementById('calc-modal').classList.toggle('show'); this.clear(); SoundSys.play('click'); }, 
    append(val) { if(this.current.length>15)return; this.current+=val; this.update(); SoundSys.play('click'); }, 
    clear() { this.current=''; this.update(); }, 
    solve() { 
        try { 
            // Simple security check (SAFE EVAL)
            if(/^[0-9+\-*/.() ]*$/.test(this.current)) {
                this.current=new Function('return ' + this.current)().toString();
            } else {
                this.current='Error';
            }
        } catch { this.current='Error'; } 
        this.update(); SoundSys.play('success'); 
    }, 
    update() { document.getElementById('calc-display').innerText=this.current||'0'; } 
};

// --- SUBJECT SYSTEM ---
const SubjectSys = {
    render() {
        const list = document.getElementById('settings-subject-list'); if(!list) return;
        list.innerHTML = Object.keys(DB.subjects).map(key => { const s = DB.subjects[key]; return `<div class="subject-manage-row"><div class="subject-manage-info"><span style="font-size:20px;">${s.icon}</span> ${s.name}</div><button class="btn-delete" onclick="SubjectSys.delete('${key}')">‚úï</button></div>`; }).join('');
    },
    addPreset(icon, name) {
        const id = 'subj_' + Date.now(); 
        DB.subjects[id] = { name: name, icon: icon, sec: 0 };
        Data.save(); this.render(); App.renderSubjects(); App.toast(name + " –¥–æ–±–∞–≤–ª–µ–Ω!");
    },
    delete(key) {
        if(Object.keys(DB.subjects).length <= 1) return App.toast("–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–µ–¥–º–µ—Ç!");
        if(!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–µ–¥–º–µ—Ç?")) return;
        delete DB.subjects[key]; if(DB.user.subject === key) { DB.user.subject = Object.keys(DB.subjects)[0]; }
        Data.save(); this.render(); App.renderSubjects(); App.updateUI(); App.toast("–ü—Ä–µ–¥–º–µ—Ç —É–¥–∞–ª–µ–Ω");
    }
};

// --- DAILY REWARD SYSTEM ---
const DailySys = {
    rewards: [10, 20, 30, 40, 50, 75, 100],
    check() {
        const today = new Date().toISOString().split('T')[0]; const last = DB.user.lastDailyClaim;
        if (last !== today) { if (last) { const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); const yesterdayStr = yesterday.toISOString().split('T')[0]; if (last !== yesterdayStr) DB.user.dailyStreak = 0; } this.showModal(); }
    },
    showModal() {
        const modal = document.getElementById('daily-modal'); const grid = document.getElementById('daily-grid'); const currentDayIndex = DB.user.dailyStreak % 7;
        grid.innerHTML = this.rewards.map((r, i) => { let cls = 'daily-day'; if (i < currentDayIndex) cls += ' claimed'; if (i === currentDayIndex) cls += ' active'; return `<div class="${cls}"><div class="daily-coin">üí∞</div><div>${r}</div></div>`; }).join('');
        document.getElementById('daily-reward-amount').innerText = this.rewards[currentDayIndex]; modal.classList.add('show'); FX.confetti(); SoundSys.play('win');
    },
    claim() {
        const currentDayIndex = DB.user.dailyStreak % 7; const reward = this.rewards[currentDayIndex];
        DB.user.coins += reward; DB.user.dailyStreak++; DB.user.lastDailyClaim = new Date().toISOString().split('T')[0];
        if (currentDayIndex === 6) { App.addXP(500); App.toast("üéâ –ù–µ–¥–µ–ª—è –ø—Ä–æ–π–¥–µ–Ω–∞! +500 XP"); FX.confetti(); }
        Data.save(); App.updateUI(); document.getElementById('daily-modal').classList.remove('show'); SoundSys.play('coin'); App.toast(`–ü–æ–ª—É—á–µ–Ω–æ: ${reward} –º–æ–Ω–µ—Ç!`);
    }
};

// --- DONATION & ONLINE ---
const Donation = {
    // –í–°–¢–ê–í–¨ –°–Æ–î–ê –ù–û–ú–ï–†–ê –ö–ê–†–¢
    uzCard: "9860 1901 0789 6911 (Rustam M.)", 
    worldCard: "4916 9903 0189 0056 (Rustam M.)",
    
    payUz() { 
        // –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –ø–æ–∫–∞–∂–µ—Ç –æ–∫–Ω–æ —Å –Ω–æ–º–µ—Ä–æ–º –∫–∞—Ä—Ç—ã, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
        prompt("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ (Payme/Click):", this.uzCard);
        alert("–ü–æ—Å–ª–µ –ø–µ—Ä–µ–≤–æ–¥–∞ —Å–∫–∏–Ω—å —Å–∫—Ä–∏–Ω—à–æ—Ç –º–Ω–µ –≤ —Ç–≥ @rustambey708, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥!");
    },
    payWorld() { 
        prompt("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ (Visa):", this.worldCard);
        alert("–ü–æ—Å–ª–µ –ø–µ—Ä–µ–≤–æ–¥–∞ —Å–∫–∏–Ω—å —Å–∫—Ä–∏–Ω—à–æ—Ç –º–Ω–µ –≤ —Ç–≥ @rustambey708, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥!");
    },
    enterCode() {
        const c = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥:"); if(!c) return;
        const code = c.trim().toUpperCase();
        if(DB.user.usedCodes && DB.user.usedCodes.includes(code)) return App.toast("–≠—Ç–æ—Ç –∫–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω!");
        
        // –í–ê–®–ò –°–ï–ö–†–ï–¢–ù–´–ï –ö–û–î–´ (–ü—Ä–∏–¥—É–º—ã–≤–∞–π—Ç–µ –∏ —Ä–∞–∑–¥–∞–≤–∞–π—Ç–µ)
        const rewards = { 
            "START":{c:100,msg:"–ë–æ–Ω—É—Å –Ω–æ–≤–∏—á–∫–∞!"}, 
            "HUMO":{c:5000,msg:"–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏–∑ –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω–∞! üá∫üáø"}, 
            "VISA":{c:5000,msg:"Thanks for support! üåç"},
            "ADMIN":{c:1000000,msg:"GOD MODE ON"} 
        };
        
        if(rewards[code]) {
            DB.user.coins += rewards[code].c;
            if(!DB.user.usedCodes) DB.user.usedCodes = [];
            DB.user.usedCodes.push(code);
            Data.save(); App.updateUI(); FX.confetti(); SoundSys.play('win'); 
            alert(`‚úÖ –ö–û–î –ü–†–ò–ù–Ø–¢!\n\n${rewards[code].msg}\n–ù–∞—á–∏—Å–ª–µ–Ω–æ: ${rewards[code].c} –º–æ–Ω–µ—Ç`);
        } else { 
            SoundSys.play('error');
            App.toast("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥"); 
        }
    }
};

const Online = {
    async loadLeaderboard() {
        if (!window.DB_Online) {
            App.toast("‚ö†Ô∏è –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –æ–Ω–ª–∞–π–Ω-–±–∞–∑–µ");
            return;
        }

        const list = document.getElementById('leaderboard-list');
        const countEl = document.getElementById('total-players-count');
        list.innerHTML = '<div style="text-align:center; color:var(--text-light);">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

        try {
            const q = window.DB_Online.query(
                window.DB_Online.collection(window.DB_Online.db, "users"),
                window.DB_Online.orderBy("user.xp", "desc"),
                window.DB_Online.limit(20)
            );
            const snap = await window.DB_Online.getDocs(q);

            countEl.innerText = `–í—Å–µ–≥–æ –∏–≥—Ä–æ–∫–æ–≤ –≤ –±–∞–∑–µ: ${snap.size}`;

            if (snap.empty) {
                list.innerHTML = '<div style="text-align:center; color:var(--text-light);">–¢–æ–ø –ø—É—Å—Ç üòî</div>';
                return;
            }

            list.innerHTML = '';
            let rank = 1;
            snap.forEach(doc => {
                const data = doc.data();
                const u = data.user || {};

                // –ó–∞—â–∏—Ç–∞ –æ—Ç undefined
                const name = u.name || Auth.currentUser?.name || "–ò–≥—Ä–æ–∫";                
                const level = u.level || 1;
                const xp = u.xp || 0;
                const avatar = u.avatar || "üòé";

                const item = document.createElement('div');
                item.className = 'user-list-item';
                item.style.justifyContent = 'space-between';
                item.innerHTML = `
                    <div style="display:flex; align-items:center; gap:15px;">
                        <div style="font-size:24px;">${avatar}</div>
                        <div>
                            <b>#${rank} ${name}</b><br>
                            <small>–£—Ä–æ–≤–µ–Ω—å ${level} ‚Ä¢ ${xp.toLocaleString()} XP</small>
                        </div>
                    </div>
                    <b style="color:var(--primary);">${xp.toLocaleString()} XP</b>
                `;
                list.appendChild(item);
                rank++;
            });

            App.toast("üèÜ –¢–æ–ø –æ–±–Ω–æ–≤–ª—ë–Ω!");
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞:", e);
            list.innerHTML = '<div style="text-align:center; color:red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ üòî</div>';
            App.toast("‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º");
        }
    }
};

/* ==========================================
   APP CORE
   ========================================== */
const Auth = {
    users: [], currentUser: null,
    avatars: ['üë®‚ÄçüöÄ', 'üë©‚ÄçüöÄ', 'üë©‚Äçüî¨', 'üë®‚Äçüî¨', 'ü§ñ', 'ü¶ä', 'ü¶â', 'üë©‚Äçüè´', 'üë®‚Äçüè´', 'üë©‚Äçüéì'],
    selectedAvatar: 'üòé', selectedGender: 'male',

    init() { 
        const stored = localStorage.getItem('MathUsers'); 
        if (stored) this.users = JSON.parse(stored); 
        this.renderUserList(); 
        this.renderAvatars(); 
        SoundSys.init(); 
        Whiteboard.init(); 
        PWA.init(); 
        MusicPlayer.init(); 
    },

    renderUserList() { 
        const list = document.getElementById('user-list'); 
        list.innerHTML = ''; 
        if (this.users.length === 0) { 
            list.innerHTML = '<div style="text-align:center; color:var(--text-light); padding:20px;">–ù–µ—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π!</div>'; 
            return; 
        } 
        this.users.forEach(u => { 
            const div = document.createElement('div'); 
            div.className = 'user-list-item'; 
            div.innerHTML = `<div class="user-avatar">${u.avatar}</div><div><div style="font-weight:bold">${u.name}</div><div style="font-size:12px; color:var(--text-light)">ID: ${u.id.substr(0,8)}...</div></div>`; 
            div.onclick = () => this.login(u.id); 
            list.appendChild(div); 
        }); 
    },

    renderAvatars() { 
        document.getElementById('avatar-selector').innerHTML = this.avatars.map(a => 
            `<div class="avatar-option ${a===this.selectedAvatar?'selected':''}" onclick="Auth.selectAvatar('${a}')">${a}</div>`
        ).join(''); 
    },

    selectAvatar(a) { 
        this.selectedAvatar = a; 
        this.renderAvatars(); 
        SoundSys.play('click'); 
    },

    setGender(g) {
        this.selectedGender = g;
        document.querySelectorAll('.gender-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.gender-btn')[g==='male'?0:1].classList.add('active');
    },

    showRegister() { 
        document.getElementById('login-view').style.display = 'none'; 
        document.getElementById('register-view').style.display = 'block'; 
        SoundSys.play('click'); 
    },

    showLogin() { 
        document.getElementById('login-view').style.display = 'block'; 
        document.getElementById('register-view').style.display = 'none'; 
        SoundSys.play('click'); 
    },

        createAccount() {
        const inputField = document.getElementById('reg-name');
        if (!inputField) return alert("–û—à–∏–±–∫–∞: –ø–æ–ª–µ –∏–º–µ–Ω–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ");
        const name = inputField.value.trim();
        if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è!');

        const user = {
            id: 'u' + Date.now(),
            name: name,
            avatar: this.selectedAvatar,
            gender: this.selectedGender
        };

        this.users.push(user);
        localStorage.setItem('MathUsers', JSON.stringify(this.users));

        // ‚Üê‚Üê‚Üê –î–û–ë–ê–í–¨ –≠–¢–ò –°–¢–†–û–ö–ò
        // –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî —Å—Ä–∞–∑—É —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –≤ DB (–¥–ª—è –æ–±–ª–∞–∫–∞)
        Data.load(user.id); // –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—É—é –±–∞–∑—É
        DB.user.name = name; // —è–≤–Ω–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –∏–º—è
        Data.save(); // —Å–æ—Ö—Ä–∞–Ω—è–µ–º (–≤–∫–ª—é—á–∞—è –æ–±–ª–∞–∫–æ)

        this.login(user.id);
    },

    login(id) { 
        const user = this.users.find(u => u.id === id); 
        if (!user) return; 
        this.currentUser = user; 
        Data.load(user.id); 
        
        document.getElementById('auth-screen').classList.add('hidden'); 
        document.getElementById('app-container').style.display = 'block'; 
        
        const savedAvatar = DB.user.avatar || user.avatar;
        App.setText('header-avatar', savedAvatar);
        App.setText('header-name', user.name);
        App.setText('profile-avatar-big', savedAvatar);
        App.setText('profile-name-big', user.name);
        
        SoundSys.play('success'); 
        App.initAfterLogin();  // <-- –í–∞–∂–Ω–æ!
        DailySys.check(); 
    },

    logout() { 
        if(confirm("–í—ã–π—Ç–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è?")) { 
            Timer.stop(false); 
            location.reload(); 
        } 
    },

    resetData() {
        if(confirm("–í–´ –£–í–ï–†–ï–ù–´? –í—Å—ë –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ –Ω–∞–≤—Å–µ–≥–¥–∞!")) {
            Data.initNewData(this.currentUser.id);
            alert("–î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã.");
            location.reload();
        }
    }
};

const Timer = {
    ref: null, sec: 0, active: false, lastActive: 0, sessionDuration: 0, sessionCoins: 0, maxSessionTime: 30 * 60, maxIdleTime: 15 * 60 * 1000,
    wakeLock: null,
    
    async requestWakeLock() {
        try { if ('wakeLock' in navigator) this.wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
    },
    releaseWakeLock() {
        if (this.wakeLock) { this.wakeLock.release(); this.wakeLock = null; }
    },

    preStart() { if(this.active) return; this.start(); },
    start() {
        this.active = true; this.lastActive = Date.now(); this.sessionDuration = 0; this.sessionCoins = 0; SoundSys.play('click');
        this.requestWakeLock();
        
        window.onmousemove = window.onkeypress = () => { this.lastActive = Date.now(); };
        this.ref = setInterval(() => {
            const now = Date.now();
            if (now - this.lastActive > this.maxIdleTime) { this.forcePause("üõë –¢–∞–π–º–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ 15 –º–∏–Ω—É—Ç."); return; }
            if (this.sessionDuration >= this.maxSessionTime) { this.forcePause("üëÆ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é! –†–µ—à–∏—Ç–µ –ø—Ä–∏–º–µ—Ä."); MathGame.show(true); return; }
            this.sec++; this.sessionDuration++; DB.user.totalSec++; DB.subjects[DB.user.subject].sec++;
            if(this.sec % 600 === 0) { DB.user.coins++; this.sessionCoins++; SoundSys.play('coin'); const coinEl = document.getElementById('coin-display'); const rect = coinEl.getBoundingClientRect(); FX.floatText(rect.left, rect.top, "+1 üí∞"); Data.save(); App.updateUI(); } 
            if(this.sec%60===0) Data.save(); App.updateUI();
        }, 1000);
        document.getElementById('btn-start').innerText = "üî• –ò–î–ï–¢..."; document.getElementById('timer').style.color = "var(--primary)";
    },
    forcePause(reason) { this.stop(false); App.toast(reason); },
    stop(manual=true) {
        if(!this.active && manual) return;
        clearInterval(this.ref); this.active = false; window.onmousemove = window.onkeypress = null; SoundSys.play('click');
        this.releaseWakeLock();

        if(manual && this.sec > 60) {
            App.addXP(Math.floor(this.sec/60)*10);
            
            // GOAL CHECK
            const goal = document.getElementById('session-goal').value.trim();
            if(goal && confirm(`–í—ã –≤—ã–ø–æ–ª–Ω–∏–ª–∏ —Ü–µ–ª—å: "${goal}"?`)) {
                App.addXP(50);
                App.toast("üéØ –¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞! +50 XP");
                SoundSys.play('win');
            }
            document.getElementById('session-goal').value = ""; // reset
        }
        
        const k = new Date().toISOString().split('T')[0]; DB.history[k] = (DB.history[k]||0) + this.sec; 
        if(this.sessionDuration > 5) { const log = { date: new Date().toISOString(), subject: DB.subjects[DB.user.subject].name, sec: this.sessionDuration, coins: this.sessionCoins }; DB.sessions.unshift(log); if(DB.sessions.length > 50) DB.sessions.pop(); }
        if(this.sessionDuration > 300) { const today = new Date().toISOString().split('T')[0]; const last = DB.user.lastStudyDate; if(last !== today) { const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); const yesterdayStr = yesterday.toISOString().split('T')[0]; if(last === yesterdayStr) { DB.user.streak++; App.toast("üî• –°—Ç—Ä–∏–∫ —É–≤–µ–ª–∏—á–µ–Ω!"); } else { DB.user.streak = 1; App.toast("üî• –°—Ç—Ä–∏–∫ –Ω–∞—á–∞—Ç!"); } DB.user.lastStudyDate = today; SoundSys.play('success'); FX.confetti(); } }
        if(manual) this.sec=0;
        document.getElementById('btn-start').innerText = "üöÄ –°–¢–ê–†–¢"; document.getElementById('timer').style.color = "var(--text)"; Data.save(); App.updateUI(); App.renderHistory(); 
    }
};

const MathGame = { ans:0, show(isCheck=false) { const a=Math.floor(Math.random()*9)+2, b=Math.floor(Math.random()*9)+2; this.ans = a*b; document.getElementById('math-problem').innerText = `${a} x ${b} = ?`; document.getElementById('math-answer').value = ''; document.getElementById('modal-title').innerText = isCheck?"üëÆ –ü—Ä–æ–≤–µ—Ä–∫–∞":"üß† –ó–∞–¥–∞—á–∞"; document.getElementById('modal-msg').innerText = isCheck?"–í—ã –¥–æ–ª–≥–æ —É—á–∏–ª–∏—Å—å. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ.":""; document.getElementById('math-modal').classList.add('show'); document.getElementById('math-answer').focus(); }, check() { if(parseInt(document.getElementById('math-answer').value) === this.ans) { document.getElementById('math-modal').classList.remove('show'); Timer.start(); } else { document.getElementById('math-answer').style.borderColor='red'; SoundSys.play('error'); } } };

const Trainer = {
    score: 0, time: 60, interval: null, ans: 0, difficulty: 'easy',
    setDiff(diff, btn) {
        this.difficulty = diff;
        document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    },
    init() { document.getElementById('trainer-menu').style.display = 'block'; document.getElementById('trainer-game').style.display = 'none'; document.getElementById('trainer-result').style.display = 'none'; document.getElementById('trainer-high-score').innerText = DB.user.trainerRecord || 0; },
    start() {
        this.score = 0; this.time = 60; document.getElementById('trainer-menu').style.display = 'none'; document.getElementById('trainer-game').style.display = 'block';
        document.getElementById('game-score').innerText = 0; document.getElementById('game-time').innerText = 60;
        SoundSys.play('click'); this.nextProblem(); const input = document.getElementById('game-input'); input.value = ''; input.focus();
        input.onkeypress = (e) => { if(e.key === 'Enter') this.check(); };
        this.interval = setInterval(() => { this.time--; document.getElementById('game-time').innerText = this.time; if(this.time <= 0) this.end(); }, 1000);
    },
    nextProblem() {
        const ops = this.difficulty === 'hard' ? ['+','-','*','/'] : (this.difficulty === 'medium' ? ['+','-','*'] : ['+','-']);
        const op = ops[Math.floor(Math.random() * ops.length)];
        
        let range = 10;
        if(this.difficulty === 'medium') range = 50;
        if(this.difficulty === 'hard') range = 100;
        
        let a, b;
        
        if (op === '*') {
            let multRange = this.difficulty === 'hard' ? 20 : 10;
            a = Math.floor(Math.random() * multRange) + 2; 
            b = Math.floor(Math.random() * multRange) + 2;
        } else if (op === '/') {
             b = Math.floor(Math.random() * 10) + 2;
             a = b * (Math.floor(Math.random() * 10) + 2);
        } else {
            a = Math.floor(Math.random() * range) + 1;
            b = Math.floor(Math.random() * range) + 1;
        }

        if(op === '+') this.ans = a + b; 
        if(op === '-') this.ans = a - b; 
        if(op === '*') this.ans = a * b;
        if(op === '/') this.ans = a / b;

        let problemStr = `${a} ${op === '*' ? '√ó' : (op === '/' ? '√∑' : op)} ${b}`;
        document.getElementById('game-problem').innerText = problemStr; document.getElementById('game-input').value = '';
    },
    check() {
        const val = parseInt(document.getElementById('game-input').value); const inputEl = document.getElementById('game-input');
        if(val === this.ans) {
            this.score++; document.getElementById('game-score').innerText = this.score; SoundSys.play('success');
            inputEl.style.borderColor = 'var(--primary)'; setTimeout(() => inputEl.style.borderColor = 'var(--bg)', 200);
            
            // Points based on diff
            let pts = 10; if(this.difficulty==='medium') pts=20; if(this.difficulty==='hard') pts=30;
            const rect = inputEl.getBoundingClientRect(); FX.floatText(rect.left + 50, rect.top - 30, `+${pts} XP`, "#6C63FF");
            this.nextProblem();
        } else { SoundSys.play('error'); inputEl.style.borderColor = 'red'; inputEl.value = ''; }
    },
    end() {
        clearInterval(this.interval); document.getElementById('trainer-game').style.display = 'none'; document.getElementById('trainer-result').style.display = 'block';
        
        let mult = 10; if(this.difficulty==='medium') mult=20; if(this.difficulty==='hard') mult=30;
        const earnedXP = this.score * mult; 
        const earnedCoins = Math.floor(this.score / (this.difficulty === 'hard' ? 2 : 5)); 
        
        App.addXP(earnedXP);
        if(earnedCoins > 0) { DB.user.coins += earnedCoins; SoundSys.play('coin'); App.toast(`ü™ô +${earnedCoins} üí∞`); }
        if(this.score > DB.user.trainerRecord) { DB.user.trainerRecord = this.score; SoundSys.play('win'); App.toast("üèÜ –ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥!"); FX.confetti(); }
        Data.save(); App.updateUI();
        document.getElementById('result-score').innerText = this.score; document.getElementById('result-xp').innerText = `+${earnedXP} XP`; document.getElementById('result-coins').innerText = `+${earnedCoins} üí∞`;
    },
    stop() { clearInterval(this.interval); this.init(); }
};

const App = {
    async init() { Auth.init(); },
    
    // –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø (–ó–∞—â–∏—Ç–∞ –æ—Ç —Ç–≤–æ–µ–π –æ—à–∏–±–∫–∏)
       setText(id, text) {
        const el = document.getElementById(id);
        if (el) {
            el.innerText = text;
        } else {
            console.warn(`–≠–ª–µ–º–µ–Ω—Ç —Å id="${id}" –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –Ω–æ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ`);
        }
    },
    
    initAfterLogin() {
        this.updateUI();
        this.renderSubjects();
        SubjectSys.render();
        Trainer.init();
        this.renderHistory();
        this.updateUI(); // —á—Ç–æ–±—ã –∫–ª–∞—Å—Å—ã –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å
        // –ï—Å–ª–∏ –µ—Å—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏ ‚Äî –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å App.renderStats();
    },

toggleDarkMode(enabled) {
        DB.user.darkMode = enabled;
        if (enabled) {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }
        localStorage.setItem('darkMode', enabled);
        Data.save();
        this.updateUI();
    },

    updateUI() {
        if(!DB) return;
document.body.className = `theme-${DB.user.theme} ${DB.user.darkMode ? 'dark-mode' : ''}`.trim();
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è
        const toggle = document.getElementById('dark-toggle');
        if (toggle) toggle.checked = DB.user.darkMode;

        // –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –º—ã —Ö–æ—Ç–∏–º –≤–∏–¥–µ—Ç—å
        const newSubjects = {
            algebra: {name:'–ê–ª–≥–µ–±—Ä–∞', icon:'‚úñÔ∏è', sec:0},
            geometry: {name:'–ì–µ–æ–º–µ—Ç—Ä–∏—è', icon:'üìê', sec:0},
            calculus: {name:'–ú–∞—Ç. –∞–Ω–∞–ª–∏–∑', icon:'‚à´', sec:0},
            arithmetic: {name:'–ê—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞', icon:'üî¢', sec:0},
            combinatorics: {name:'–ö–æ–º–±–∏–Ω–∞—Ç–æ—Ä–∏–∫–∞', icon:'üîÄ', sec:0},
            statistics: {name:'–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', icon:'üìä', sec:0},
            trigonometry: {name:'–¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è', icon:'üìè', sec:0},
            stereometry: {name:'–°—Ç–µ—Ä–µ–æ–º–µ—Ç—Ä–∏—è', icon:'üßä', sec:0}
        };
        let changed = false;
        for (let key in newSubjects) {
            if (!DB.subjects[key]) {
                DB.subjects[key] = newSubjects[key];
                changed = true;
            }
        }
        if (changed) Data.save();


        this.setText('coin-display', DB.user.coins);
        this.setText('streak-display', DB.user.streak);
        this.setText('header-name', DB.user.name || '–ò–≥—Ä–æ–∫');
        this.setText('header-avatar', DB.user.avatar || 'üòé');

document.body.className = `theme-${DB.user.theme} ${DB.user.darkMode ? 'dark-mode' : ''}`.trim();

        // –õ–∏–≥–∏
        let cl = LEAGUES[0]; 
        for(let l of LEAGUES) { if(DB.user.xp >= l.min) cl = l; }
        
        this.setText('header-league', cl.name);
        this.setText('profile-league-big', cl.name);
        
        const headerBox = document.getElementById('header-avatar-box');
        if(headerBox) headerBox.className = `profile-img ${cl.color}`;
        
        const pb = document.getElementById('profile-avatar-box');
        if(pb) pb.className = `profile-img ${cl.color}`;

        // –ú–ê–ì–ê–ó–ò–ù –¢–ï–ú
        const themeList = document.getElementById('theme-list');
        if (themeList) {
            themeList.innerHTML = THEMES.map(t => {
                const owned = DB.user.ownedThemes.includes(t.id), active = DB.user.theme === t.id;
                return `<div class="shop-item ${active?'active':''}" onclick="App.buyTheme('${t.id}')"><div>${t.icon}</div><div>${t.name}</div>${owned?'':'<small>'+t.price+'üí∞</small>'}</div>`
            }).join('');
        }

        // –ú–ê–ì–ê–ó–ò–ù –ê–í–ê–¢–ê–†–û–í
        const avatarList = document.getElementById('avatar-shop-list');
        if (avatarList) {
            avatarList.innerHTML = AVATARS.map(a => {
                const owned = DB.user.ownedAvatars.includes(a.id), active = DB.user.avatar === a.icon;
                return `<div class="shop-item ${active?'active':''}" onclick="App.buyAvatar('${a.id}')"><div>${a.icon}</div>${owned?'':'<small>'+a.price+'üí∞</small>'}</div>`
            }).join('');
        }
        
        // –î–û–°–¢–ò–ñ–ï–ù–ò–Ø
        const achList = document.getElementById('ach-list');
        if (achList && DB.achievements) {
            achList.innerHTML = DB.achievements.map(a => {
                let currentVal = 0;
                if (a.type === 'total') currentVal = DB.user.totalSec;
                else if (a.type === 'lvl') currentVal = DB.user.level;
                else if (a.type === 'xp') currentVal = DB.user.xp;

                const pct = Math.min(100, (currentVal / a.max) * 100);
                const unlocked = pct >= 100;

                return `<div class="ach-row ${unlocked ? 'unlocked' : ''}">
                    <div class="ach-icon">${unlocked ? '‚úÖ' : a.icon}</div>
                    <div class="ach-info">
                        <div class="ach-title">${a.title}</div>
                        <div class="ach-desc">${a.desc}</div>
                        <div class="ach-bar-bg"><div class="ach-bar-fill" style="width:${pct}%"></div></div>
                        <small>${currentVal} / ${a.max}</small>
                    </div>
                </div>`;
            }).join('');
        }

        // –°–¢–ê–¢–ò–°–¢–ò–ö–ê
        const h = (DB.user.totalSec/3600).toFixed(1);
        this.setText('timer', new Date(Timer.sec * 1000).toISOString().substr(11, 8));
        this.setText('stat-total-time', h + '—á');
        this.setText('prof-lvl', DB.user.level);
        this.setText('prof-xp', DB.user.xp);
        this.setText('prof-coins', DB.user.coins);
        
        const xpBar = document.getElementById('prof-xp-bar');
        if(xpBar) xpBar.style.width = (DB.user.xp/DB.user.nextXp*100)+'%';
        
        this.setText('xp-progress-text', `${DB.user.xp} / ${DB.user.nextXp} XP`);
    },

    buyTheme(id) {
        const t = THEMES.find(x=>x.id===id);
        if(DB.user.ownedThemes.includes(id)) { 
            DB.user.theme=id; Data.save(); App.updateUI(); 
        } else if(DB.user.coins >= t.price && confirm(`–ö—É–ø–∏—Ç—å –∑–∞ ${t.price}?`)) {
            DB.user.coins -= t.price; DB.user.ownedThemes.push(id); DB.user.theme=id; Data.save(); App.updateUI(); SoundSys.play('success');
        } else { App.toast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç"); }
    },
    buyAvatar(id) {
        const a = AVATARS.find(x=>x.id===id);
        if(DB.user.ownedAvatars.includes(id)) { 
            DB.user.avatar=a.icon; Data.save(); App.updateUI(); 
        } else if(DB.user.coins >= a.price && confirm(`–ö—É–ø–∏—Ç—å –∑–∞ ${a.price}?`)) {
            DB.user.coins -= a.price; DB.user.ownedAvatars.push(id); DB.user.avatar=a.icon; Data.save(); App.updateUI(); SoundSys.play('success');
        } else { App.toast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç"); }
    },
    addXP(n) { 
        DB.user.xp+=n; 
        if(DB.user.xp >= DB.user.nextXp){
            DB.user.level++; DB.user.xp=0; DB.user.nextXp=Math.floor(DB.user.nextXp*1.2); 
            alert("LEVEL UP!"); FX.confetti();
        } 
        Data.save(); this.updateUI(); 
    },
    switchTab(id, btn) {
        document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
        const sec = document.getElementById(id);
        if(sec) sec.classList.add('active');
       
        document.querySelectorAll('.nav-btn').forEach(x => x.classList.remove('active'));
        if(btn) btn.classList.add('active');
       
        if (id === 'stats') {
            this.renderStats();
        }
    },
    
    renderStats(){
        const ctx = document.getElementById('weekChart');
        if(window.myChart) window.myChart.destroy();
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–∞–Ω–≤–∞—Å–∞
        if (ctx) {
            window.myChart = new Chart(ctx, {type:'bar', data:{labels:['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'], datasets:[{label:'–ß–∞—Å—ã',data:[0,0,0,0,0,0,0],backgroundColor:'#6C63FF'}]}});
        }
    },
       renderSubjects() {
        const grid = document.getElementById('subjects-grid');
        if (!grid || !DB || !DB.subjects) return;

        grid.innerHTML = Object.keys(DB.subjects).map(k => {
            const s = DB.subjects[k];
            const isActive = DB.user.subject === k;
            return `
                <div onclick="App.selectSubject('${k}')"
                     class="card"
                     style="padding:15px; text-align:center; cursor:pointer; 
                            ${isActive ? 'border:2px solid var(--primary); background:rgba(108,99,255,0.1);' : 'border:2px solid transparent;'}">
                    <div style="font-size:24px">${s.icon}</div>
                    <div style="font-weight:bold; font-size:12px; margin-top:5px;">${s.name}</div>
                </div>`;
        }).join('');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ –¥–∞—à–±–æ—Ä–¥–µ
        const currentSub = DB.subjects[DB.user.subject];
        if (currentSub && document.getElementById('subject-title')) {
            document.getElementById('subject-title').innerText = currentSub.name;
        }
    },

    selectSubject(key) {
        if (DB.subjects[key]) {
            DB.user.subject = key;
            Data.save();
            this.renderSubjects();
            this.updateUI();
            App.toast("–ü—Ä–µ–¥–º–µ—Ç: " + DB.subjects[key].name);
        }
    },

        renderHistory() {
        // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª—è–µ—Ç –∂—É—Ä–Ω–∞–ª –∑–∞–Ω—è—Ç–∏–π –≤ —Ä–∞–∑–¥–µ–ª–µ "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"
        const logContainer = document.getElementById('session-log');
        if (!logContainer || !DB || !DB.sessions) return;

        logContainer.innerHTML = '';
        DB.sessions.forEach(s => {
            const row = document.createElement('div');
            row.className = 'session-row';
            row.innerHTML = `
                <div class="session-info">
                    <div>${s.subject}</div>
                    <div class="session-date">${new Date(s.date).toLocaleDateString('ru-RU')}</div>
                </div>
                <div>
                    <span style="color:var(--text-light);">${Math.floor(s.sec/60)} –º–∏–Ω</span>
                    ${s.coins > 0 ? `<span class="session-coins">+${s.coins} üí∞</span>` : ''}
                </div>
            `;
            logContainer.appendChild(row);
        });

        // –ï—Å–ª–∏ —Å–µ—Å—Å–∏–π –Ω–µ—Ç ‚Äî –ø–æ–∫–∞–∂–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        if (DB.sessions.length === 0) {
            logContainer.innerHTML = '<div style="text-align:center; color:var(--text-light); padding:20px;">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>';
        }
    },

            renderStats() {
        // –î–∞—ë–º –≤—Ä–µ–º—è, —á—Ç–æ–±—ã –≤–∫–ª–∞–¥–∫–∞ —Å—Ç–∞–ª–∞ –≤–∏–¥–∏–º–æ–π –∏ canvas –ø–æ—è–≤–∏–ª—Å—è –≤ DOM
        setTimeout(() => {
            // –ü–∏—Ä–æ–≥ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
            const subjectCtx = document.getElementById('subjectChart');
            if (subjectCtx) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —á–∞—Ä—Ç –∏ –º–æ–∂–Ω–æ –ª–∏ –µ–≥–æ —É–Ω–∏—á—Ç–æ–∂–∏—Ç—å
                if (window.subjectChart && typeof window.subjectChart.destroy === 'function') {
                    window.subjectChart.destroy();
                }

                const labels = [];
                const data = [];
                const colors = ['#6C63FF', '#00E0D0', '#FF8F66', '#556B2F', '#D60270', '#FF7675', '#00d26a', '#FFD700'];

                if (DB.subjects) {
                    Object.values(DB.subjects).forEach(s => {
                        if (s.sec > 0) {
                            labels.push(s.name);
                            data.push(Math.round(s.sec / 60));
                        }
                    });
                }

                window.subjectChart = new Chart(subjectCtx, {
                    type: 'doughnut',
                    data: {
                        labels: labels.length ? labels : ['–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'],
                        datasets: [{
                            data: data.length ? data : [1],
                            backgroundColor: colors,
                            borderWidth: 3,
                            borderColor: 'var(--bg)'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }

            // –ë–∞—Ä-—á–∞—Ä—Ç –Ω–µ–¥–µ–ª–∏
            const weekCtx = document.getElementById('weekChart');
            if (weekCtx) {
                if (window.weekChart && typeof window.weekChart.destroy === 'function') {
                    window.weekChart.destroy();
                }

                const days = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
                const data = [];
                for (let i = 0; i < 7; i++) {
                    const d = new Date();
                    d.setDate(d.getDate() - d.getDay() + 1 + i);
                    const key = d.toISOString().split('T')[0];
                    data.push(Math.round(((DB.history && DB.history[key]) || 0) / 3600 * 10) / 10);
                }

                window.weekChart = new Chart(weekCtx, {
                    type: 'bar',
                    data: {
                        labels: days,
                        datasets: [{
                            label: '–ß–∞—Å—ã —É—á—ë–±—ã',
                            data: data,
                            backgroundColor: 'var(--primary)',
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }

                           // –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ‚Äî heatmap –∑–∞ 30 –¥–Ω–µ–π (–∫–≤–∞–¥—Ä–∞—Ç–∏–∫–∏)
        const heatmap = document.getElementById('heatmap');
        if (heatmap) {
            const today = new Date();
            const start = new Date(today);
            start.setDate(today.getDate() - 29); // 30 –¥–Ω–µ–π –Ω–∞–∑–∞–¥

            // –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏: –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ = 0
            const firstDayOffset = start.getDay() === 0 ? 6 : start.getDay() - 1;

            let html = '';
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ –∫–ª–µ—Ç–∫–∏ –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
            for (let i = 0; i < firstDayOffset; i++) {
                html += '<div style="background:var(--bg); border-radius:4px; aspect-ratio:1/1;"></div>';
            }

            for (let i = 0; i < 30; i++) {
                const date = new Date(start);
                date.setDate(start.getDate() + i);
                const key = date.toISOString().split('T')[0];
                const sec = (DB.history && DB.history[key]) || 0;
                const minutes = Math.round(sec / 60);
                const intensity = sec === 0 ? 0 : Math.min(4, Math.ceil(minutes / 30)); // –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω = —É—Ä–æ–≤–µ–Ω—å

                const colors = ['var(--bg)', '#c6e48b', '#7bc96f', '#239a3b', '#196127'];
                const title = minutes > 0 ? `${minutes} –º–∏–Ω ‚Äî ${date.toLocaleDateString('ru-RU')}` : '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏';

                html += `<div title="${title}" style="background:${colors[intensity]}; border-radius:4px; aspect-ratio:1/1; display:flex; align-items:flex-end; justify-content:center; padding-bottom:2px; font-size:9px; color:var(--text); font-weight:bold;">
                    ${minutes > 0 ? minutes : ''}
                </div>`;
            }

            heatmap.innerHTML = html;
        }

        }, 200); // –∑–∞–¥–µ—Ä–∂–∫–∞ 200–º—Å ‚Äî —á—Ç–æ–±—ã canvas —Ç–æ—á–Ω–æ –±—ã–ª –≤–∏–¥–∏–º—ã–º
    },
    
    toggleZen() { 
        document.body.classList.toggle('zen-active'); 
        const btn = document.getElementById('exit-zen-btn');
        if(btn) btn.style.display = document.body.classList.contains('zen-active') ? 'inline-block' : 'none'; 
    },
    toast(m) { 
        const container = document.getElementById('toast-container');
        if (container) {
            const t=document.createElement('div'); t.className='toast'; t.innerText=m; 
            container.appendChild(t); 
            setTimeout(()=>t.classList.add('show'),10); 
            setTimeout(()=>{t.classList.remove('show');t.remove()},3000); 
        }
    }    
};



const Transfer = {
    copyCode() {
        if (!DB || !Auth.currentUser) {
            App.toast("‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è");
            return;
        }
        const json = JSON.stringify(DB);
        const compressed = btoa(unescape(encodeURIComponent(json)));
        
        navigator.clipboard.writeText(compressed).then(() => {
            App.toast("‚úÖ –ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä!");
        }).catch(() => {
            prompt("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤—Ä—É—á–Ω—É—é:", compressed);
        });
    },

    pasteCode() {
        const code = prompt("–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –ø–µ—Ä–µ–Ω–æ—Å–∞:");
        if (!code) return;
        try {
            const decoded = decodeURIComponent(escape(atob(code.trim())));
            const imported = JSON.parse(decoded);
            if (imported.user && imported.subjects) {
                DB = imported;
                Data.save();
                App.toast("‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—ë–Ω!");
                setTimeout(() => location.reload(), 1000);
            } else {
                App.toast("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö");
            }
        } catch (e) {
            App.toast("‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫–æ–¥–∞");
            console.error(e);
        }
    },

            showQR() {
        if (!DB || !Auth.currentUser) {
            App.toast("‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è QR-–∫–æ–¥–∞");
            return;
        }

        const json = JSON.stringify(DB);
        const compressed = btoa(unescape(encodeURIComponent(json)));

        const modal = document.createElement('div');
        modal.className = 'modal show';
        modal.innerHTML = `
            <div class="modal-content" style="text-align:center; max-width:90vw; padding:20px;">
                <h3 style="margin-bottom:15px;">üì± QR-–∫–æ–¥ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞</h3>
                <p style="color:var(--text-light); font-size:14px; margin-bottom:25px;">
                    –£–≤–µ–ª–∏—á—å—Ç–µ —è—Ä–∫–æ—Å—Ç—å —ç–∫—Ä–∞–Ω–∞ –¥–æ –º–∞–∫—Å–∏–º—É–º–∞<br>–î–µ—Ä–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ 15-30 —Å–º
                </p>
                <canvas id="qrcode-canvas" style="width:400px; height:400px; margin:0 auto 25px; background:white; border-radius:15px; padding:30px; box-shadow:0 10px 30px rgba(0,0,0,0.2);"></canvas>
                <div id="qr-status" style="font-size:14px; margin-bottom:15px; color:var(--text-light);">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...</div>
                <button class="btn btn-outline" onclick="this.closest('.modal').remove()">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button class="btn btn-primary" onclick="Transfer.saveQRAsImage()" style="margin-top:10px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å QR –∫–∞–∫ –∫–∞—Ä—Ç–∏–Ω–∫—É</button>
            </div>
        `;
        document.body.appendChild(modal);

        setTimeout(() => {
            const canvas = document.getElementById('qrcode-canvas');
            const statusEl = document.getElementById('qr-status');

            if (!canvas) {
                statusEl.innerText = "–û—à–∏–±–∫–∞: canvas –Ω–µ –Ω–∞–π–¥–µ–Ω";
                statusEl.style.color = "red";
                return;
            }

            try {
                new QRious({
                    element: canvas,
                    size: 400,  // –ë–æ–ª—å—à–æ–π —Ä–∞–∑–º–µ—Ä –¥–ª—è –ª—ë–≥–∫–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                    value: compressed,
                    background: '#FFFFFF',
                    foreground: '#2B3674',
                    level: 'H'  // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –æ—à–∏–±–æ–∫
                });

                statusEl.innerText = "–ì–æ—Ç–æ–≤–æ! –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É (–∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É)";
                statusEl.style.color = "var(--success)";
            } catch (err) {
                console.error("QR error:", err);
                statusEl.innerText = "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR";
                statusEl.style.color = "red";
            }
        }, 200);
    },

    saveQRAsImage() {
        const canvas = document.getElementById('qrcode-canvas');
        if (canvas) {
            const link = document.createElement('a');
            link.download = 'MathBooster_Transfer_QR.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            App.toast("‚úÖ QR —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –≥–∞–ª–µ—Ä–µ—é! –¢–µ–ø–µ—Ä—å —Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —Å —Ñ–æ—Ç–æ");
        } else {
            App.toast("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
        }
    }
};

window.addEventListener('keydown', function(e) {
    if(e.key === "Escape" && document.body.classList.contains('zen-active')) {
        App.toggleZen();
    }
});

/* === SPLASH SCREEN LOGIC === */
window.onload = () => {
    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    Auth.init();

    // 2. –£–±–∏—Ä–∞–µ–º —Å–ø–ª—ç—à-—Å–∫—Ä–∏–Ω —á–µ—Ä–µ–∑ –∑–∞–¥–µ—Ä–∂–∫—É (—á—Ç–æ–±—ã –ª–æ–≥–æ —É—Å–ø–µ–ª–æ –ø–æ–∫–∞–∑–∞—Ç—å—Å—è)
    setTimeout(() => {
        const splash = document.getElementById('splash-screen');
        if(splash) {
            splash.classList.add('hidden');
            // –£–¥–∞–ª—è–µ–º –∏–∑ DOM –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
            setTimeout(() => splash.remove(), 500);
        }
    }, 2000); // 2000 –º—Å = 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ–∫–∞–∑–∞ –ª–æ–≥–æ—Ç–∏–ø–∞
};
</script>
</body>
</html>
