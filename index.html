<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <!-- –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –º–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ iPhone (—á–µ–ª–∫–∞) -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MathBooster PRO</title>
    
    <!-- PWA –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
<link id="manifest-link" rel="manifest" href="">
<meta name="theme-color" content="#6C63FF">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes"> <!-- ‚Üê –Ω–æ–≤–∞—è -->
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MathBooster">

<!-- –ò–∫–æ–Ω–∫–∏ -->
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ QR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   
    <!-- YANDEX METRIKA -->
    <script type="text/javascript" >
       (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
       m[i].l=1*new Date();
       for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
       k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
       (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

       ym(105919372, "init", { // <-- –í–°–¢–ê–í–¨ –°–í–û–ô ID –°–ß–ï–¢–ß–ò–ö–ê
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true
       });
       
    </script>
<noscript><div><img src="https://mc.yandex.ru/watch/XXXXXXXX" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

    <!-- FIREBASE (–ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // üî• –í–°–¢–ê–í–¨ –°–Æ–î–ê –ö–û–ù–§–ò–ì –ò–ó FIREBASE CONSOLE üî•
        const firebaseConfig = {
  	  apiKey: "AIzaSyAK4kX2dl93WlpEFLg_eGvpvoeAAF935tQ",
  	  authDomain: "mathbooster-pro.firebaseapp.com",
  	  projectId: "mathbooster-pro",
  	  storageBucket: "mathbooster-pro.firebasestorage.app",
  	  messagingSenderId: "990295839020",
  	  appId: "1:990295839020:web:ba5bb8cfa471c2c4a89c89",
  	  measurementId: "G-8N8MYJPCHR"
	};

        try {
            if (firebaseConfig.apiKey) {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                // –î–µ–ª–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–º –≥–ª–æ–±–∞–ª—å–Ω–æ
                window.DB_Online = { db, doc, setDoc, getDoc, collection, getDocs, query, orderBy, limit };
                console.log("‚úÖ Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω —É—Å–ø–µ—à–Ω–æ");
            } else {
                console.log("‚ö†Ô∏è Firebase –∫–æ–Ω—Ñ–∏–≥ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –†–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º.");
            }
        } catch(e) { 
            console.error("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Firebase:", e); 
        }
    </script>
    
    <style>
        @supports (padding: max(0px)) {
    body.zen-active {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
    }
}
        /* === –ë–ê–ó–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï === */
        :root {
            --primary: #6C63FF;
            --bg: #F4F7FE;
            --surface: #FFFFFF;
            --text: #2B3674;
            --text-light: #707EAE;
            --shadow: 0 10px 30px rgba(112, 144, 176, 0.12);
            --radius: 24px;
            --accent: #FF7675;
            --gold: #FFD700;
            --success: #00d26a;
            
            /* Safe Areas for iPhone X+ */
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        /* === –¢–ï–ú–´ –û–§–û–†–ú–õ–ï–ù–ò–Ø === */
        body.theme-gold { --primary: #FFD700; --bg: #1E1E2E; --surface: #2D2D44; --text: #FFFFFF; --text-light: #B8B8D1; --shadow: 0 10px 30px rgba(255, 215, 0, 0.3); }
        body.dark-mode.theme-gold { --primary: #FFEA80; }
        body.theme-standard { --primary: #6C63FF; --bg: #F4F7FE; --surface: #FFFFFF; --text: #2B3674; }
        body.theme-math { --primary: #00E0D0; --bg: #E0F7FA; --surface: #FFFFFF; --text: #006064; --text-light: #4DD0E1; --shadow: 0 10px 30px rgba(0, 224, 208, 0.2); }
        body.theme-neon { --primary: #D60270; --bg: #0B0014; --surface: #180028; --text: #DE05F8; --text-light: #9B4F96; }
        body.theme-pantone { --primary: #FF8F66; --bg: #FFF5EE; --surface: #FFFFFF; --text: #5D4037; --text-light: #8D6E63; --shadow: 0 10px 30px rgba(255, 143, 102, 0.2); }
        body.theme-forest { --primary: #556B2F; --bg: #F5F5DC; --surface: #FFFFF0; --text: #3E2723; --text-light: #6D4C41; --shadow: 0 10px 30px rgba(85, 107, 47, 0.15); }
        body.theme-magma {  --primary: #FF3333; --bg: #000000; --surface: #121212; --text: #FFFFFF; --text-light: #888888; --shadow: 0 0 25px rgba(255, 51, 51, 0.4); 
}

/* –ü—Ä–∏–º–µ–Ω–∏–º —Å–≤–µ—á–µ–Ω–∏–µ –∫ –∫–Ω–æ–ø–∫–∞–º –≤ —ç—Ç–æ–π —Ç–µ–º–µ */
body.theme-magma .btn-primary, 
body.theme-magma .nav-btn.active,
body.theme-magma .daily-day.active {
    box-shadow: 0 0 15px rgba(255, 51, 51, 0.6);
    border: 1px solid #FF3333;
}
        body.dark-mode {
    --bg: #1A1A2E;
    --surface: #16213E;
    --text: #EAEAEA;
    --text-light: #8892B0;
    --shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

/* –ö–æ–º–±–∏–Ω–∞—Ü–∏–∏: —Ç—ë–º–Ω—ã–π —Ä–µ–∂–∏–º + –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ç–µ–º–∞ (–∞–∫—Ü–µ–Ω—Ç –æ—Å—Ç–∞—ë—Ç—Å—è, —Ñ–æ–Ω —Ç—ë–º–Ω—ã–π) */
body.dark-mode.theme-standard { --primary: #8B7EFF; }
body.dark-mode.theme-math { --primary: #00F5E0; }
body.dark-mode.theme-pantone { --primary: #FFB399; }
body.dark-mode.theme-forest { --primary: #8FBC8F; }
body.dark-mode.theme-neon { --primary: #FF69B4; }
body.dark-mode.theme-gold { --primary: #FFD700; --bg: #1E1E1E; --surface: #2A2A2A; --text-light: #D4AF37; }
body.dark-mode.theme-dark { --primary: #9D7EFF; } 
body.dark-mode.theme-magma { --bg: #000000; --surface: #121212; --primary: #FF3333;
}        
        body.theme-dark {
    --primary: #7B73FF;
    --bg: #1E1E2E;
    --surface: #27293D;
    --text: #EAEAEA;
    --text-light: #A0A0B0;
    --shadow: 0 10px 30px rgba(0,0,0,0.4);
}

/* –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –∫–æ–º–±–æ —Å –¥—Ä—É–≥–∏–º–∏ —Ç–µ–º–∞–º–∏ –≤ —Ç—ë–º–Ω–æ–º —Ä–µ–∂–∏–º–µ */
body.theme-dark.theme-standard { --primary: #8B7EFF; }
body.theme-dark.theme-math { --primary: #00F5E0; }
body.theme-dark.theme-pantone { --primary: #FFAB91; }
body.theme-dark.theme-gold { --primary: #FFD700; --bg: #1E1E1E; --surface: #2A2A2A; }
       /* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ –≤—Ö–æ–¥–∞ */
.delete-user-btn {
    background: #ff4d4d;
    color: white;
    border: none;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 10px;
    font-size: 14px;
    flex-shrink: 0;
}
.delete-user-btn:active {
    transform: scale(0.9);
} 
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            -webkit-tap-highlight-color: transparent; 
            outline: none; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            transition: 0.3s; 
            min-height: 100vh; 
            overflow-x: hidden; 
            user-select: none;
            -webkit-user-select: none;
            /* –û—Ç—Å—Ç—É–ø—ã –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ —á–µ–ª–∫–∏ */
            padding-top: calc(var(--safe-top) + 10px);
            padding-bottom: calc(90px + var(--safe-bottom)); 
        }

        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 0 20px; 
            transition: 0.5s; 
        }

        /* === LOGO === */
        .app-logo {
            width: 80px; 
            height: 80px; 
            object-fit: contain; 
            margin-bottom: 10px;
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.1));
        }

        
        
        /* === UI ELEMENTS === */
        #auth-screen { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: var(--bg); 
            z-index: 5000; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
            transition: 0.4s; 
            overflow-y: auto; 
            padding-top: var(--safe-top); 
        }
        #auth-screen.hidden { opacity: 0; pointer-events: none; transform: scale(1.1); }
        
        .auth-card { background: var(--surface); padding: 40px; border-radius: 30px; box-shadow: var(--shadow); width: 100%; max-width: 400px; text-align: center; margin: auto; }
        .avatar-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0; }
        .avatar-option { font-size: 30px; padding: 10px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; background: var(--bg); transition: 0.2s; }
        .avatar-option.selected { border-color: var(--primary); background: rgba(0,0,0,0.05); }
        
        .user-list-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--bg); border-radius: 15px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; text-align: left; }
        .user-list-item:hover { transform: translateX(5px); border: 1px solid var(--primary); }
        .user-avatar { font-size: 24px; width: 40px; height: 40px; background: var(--surface); border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        .header-card { background: var(--surface); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .profile-mini { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .profile-img { width: 50px; height: 50px; background: var(--bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; border: 4px solid transparent; transition: 0.3s; }
        
        /* LEAGUES */
        .league-bronze { border-color: #CD7F32; }
        .league-silver { border-color: #C0C0C0; }
        .league-gold { border-color: #FFD700; box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        .league-platinum { border-color: #E5E4E2; box-shadow: 0 0 12px rgba(229, 228, 226, 0.8); }
        .league-diamond { border-color: #b9f2ff; box-shadow: 0 0 15px rgba(185, 242, 255, 0.6); }
        .league-legend { border-color: #ff4d4d; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 77, 77, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0); } }

        .currency-block { display:flex; gap:15px; align-items:center; }
        .currency-item { display:flex; align-items:center; gap:5px; font-weight:bold; font-size:14px; background:var(--bg); padding:5px 12px; border-radius:12px; }
        
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .stat-pill { background: var(--bg); padding: 10px; border-radius: 15px; text-align: center; }
        .stat-val { font-weight: 800; font-size: 16px; color: var(--primary); }
        .stat-label { font-size: 10px; color: var(--text-light); text-transform: uppercase; font-weight: bold; }

        /* FIXED BOTTOM NAV FOR MOBILE */
        .nav { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: var(--surface); z-index: 1000;
            display: flex; gap: 8px; overflow-x: auto; 
            padding: 10px 10px calc(10px + var(--safe-bottom)) 10px; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            scrollbar-width: none; 
        }
        .nav::-webkit-scrollbar { display: none; }
        .nav-btn { background: var(--bg); border: none; padding: 12px 20px; border-radius: 18px; color: var(--text-light); font-weight: 700; cursor: pointer; transition: 0.2s; white-space: nowrap; flex-shrink: 0; font-size: 15px; }
        .nav-btn.active { background: var(--primary); color: white; transform: scale(1.05); box-shadow: 0 5px 15px rgba(108, 99, 255, 0.3); }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .card { background: var(--surface); padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow); transition: 0.2s; }
        .btn { padding: 15px; border-radius: 15px; border: none; font-weight: bold; cursor: pointer; width: 100%; transition: 0.2s; font-size: 16px; display:flex; justify-content:center; align-items:center; gap:5px; -webkit-tap-highlight-color: transparent; }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--text-light); color: var(--text-light); }
        .input-field { width: 100%; padding: 15px; border-radius: 15px; border: 2px solid var(--bg); background: var(--bg); color: var(--text); font-size: 16px; margin-bottom: 15px; outline: none; -webkit-appearance: none; }
        .timer-display { font-size: 72px; font-weight: 800; color: var(--text); text-align: center; margin: 15px 0; font-variant-numeric: tabular-nums; transition: 0.3s; }
        
        .achievements-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; }
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; }
        .shop-item { padding: 15px; border-radius: 15px; background: var(--bg); cursor: pointer; text-align: center; border: 2px solid transparent; transition: 0.2s; position:relative; overflow:hidden;}
        .shop-item:active { transform: scale(0.95); }
        .shop-item.active { border-color: var(--primary); background: rgba(0,0,0,0.03); box-shadow: var(--shadow); }
        .shop-price-tag { font-size:12px; font-weight:bold; margin-top:5px; color:var(--text-light); }
        .shop-price-tag.affordable { color: var(--primary); }

        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 6000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); padding: 20px; }
        .modal.show { display: flex; animation: popIn 0.3s; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-content { background: var(--surface); padding: 30px; border-radius: 25px; text-align: center; width: 100%; max-width: 400px; box-shadow: var(--shadow); max-height: 80vh; overflow-y: auto; }
        
        #toast-container { position: fixed; bottom: calc(90px + var(--safe-bottom)); left: 50%; transform: translateX(-50%); z-index: 9999; pointer-events: none; width: max-content; }
        .toast { background: var(--surface); color: var(--text); padding: 12px 25px; border-radius: 50px; font-weight: bold; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-top: 10px; opacity: 0; transform: translateY(20px); transition: 0.4s; border: 2px solid var(--primary); text-align: center; }
        .toast.show { opacity: 1; transform: translateY(0); }

        .stat-detail-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-detail-card { background: var(--bg); padding: 12px; border-radius: 15px; text-align: center; }
        .stat-detail-title { font-size: 10px; color: var(--text-light); font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
        .stat-detail-value { font-size: 18px; font-weight: 800; color: var(--primary); }
        .stat-detail-sub { font-size: 10px; color: var(--text-light); margin-top: 2px; }

        .trainer-box { text-align: center; padding: 20px; }
        .trainer-problem { font-size: 42px; font-weight: 800; color: var(--primary); margin: 20px 0; font-family: monospace; white-space: nowrap; }
        .trainer-stats { display: flex; justify-content: space-around; margin-bottom: 20px; font-size: 18px; font-weight: bold; color: var(--text-light); }
        .trainer-input { font-size: 32px; text-align: center; font-weight: bold; letter-spacing: 2px; background: var(--surface); border-color: var(--text-light); }

        .daily-grid { display: flex; justify-content: center; gap: 8px; margin: 20px 0; }
        .daily-day { width: 45px; height: 65px; border-radius: 12px; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; opacity: 0.5; transition: 0.3s; }
        .daily-day.active { opacity: 1; border: 2px solid var(--primary); background: var(--surface); transform: scale(1.15); box-shadow: var(--shadow); }
        .daily-day.claimed { opacity: 1; background: var(--primary); color: white; }
        .daily-coin { font-size: 18px; margin-bottom: 4px; }

.subject-manage-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 12px;
}

.subject-item {
    padding: 12px;
    border-radius: 12px;
    background: var(--surface);
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid var(--primary);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.subject-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.2);
}

/* –£–±–∏—Ä–∞–µ–º –ª—é–±–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ ‚Äî —Ç–µ–ø–µ—Ä—å –í–°–Å –æ–¥–∏–Ω–∞–∫–æ–≤–æ */
.subject-item.added {
    /* –ü—É—Å—Ç–æ ‚Äî –Ω–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π, —á—Ç–æ–±—ã "–ú–æ–∏" –∏ "–î–æ—Å—Ç—É–ø–Ω—ã–µ" –≤—ã–≥–ª—è–¥–µ–ª–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ */
}

.subject-item .icon {
    font-size: 28px;
    margin-bottom: 6px;
}
.subject-item .name {
    font-size: 13px;
    font-weight: 600;
}        .subject-manage-row { display: flex; justify-content: space-between; align-items: center; background: var(--bg); padding: 12px 15px; border-radius: 15px; }
        .subject-manage-info { display: flex; align-items: center; gap: 10px; font-weight: bold; }
        .btn-delete { width: 32px; height: 32px; border-radius: 50%; border: none; background: #FF7675; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: 0.2s; }
        .btn-delete:hover { transform: scale(1.1); }
        
        .preset-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin-top: 10px; }
        .preset-btn {
    padding: 12px;
    border-radius: 12px;
    background: var(--surface);
    border: 2px solid var(--primary);
    color: var(--text);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-size: 16px;
}

.preset-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    background: rgba(var(--primary-rgb), 0.1);
}

.preset-btn::before {
    font-size: 24px;
    content: attr(data-emoji); /* –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å data-–∞—Ç—Ä–∏–±—É—Ç */
}

        /* CALCULATOR */
        .calc-box { width: 95%; max-width: 320px; }
        .calc-display { background: var(--bg); padding: 20px; font-size: 32px; text-align: right; border-radius: 15px; margin-bottom: 15px; font-family: monospace; font-weight: bold; color: var(--text); overflow: hidden; white-space: nowrap; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .calc-btn { padding: 15px; font-size: 22px; border-radius: 12px; border: none; background: var(--bg); color: var(--text); cursor: pointer; transition: 0.1s; font-weight: bold; touch-action: manipulation; }
        .calc-btn:active { transform: scale(0.9); background: rgba(0,0,0,0.1); }
        .calc-btn.op { color: var(--primary); background: rgba(108, 99, 255, 0.1); }
        .calc-btn.eq { background: var(--primary); color: white; grid-column: span 2; }
        .calc-btn.clr { color: #FF7675; }

        /* WHITEBOARD */
        .canvas-box { background: white; border-radius: 15px; cursor: crosshair; touch-action: none; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); width: 100%; border: 2px solid var(--bg); }
        .whiteboard-controls { display: flex; gap: 10px; margin-top: 10px; }

        /* SESSION LOG */
        .session-log { max-height: 250px; overflow-y: auto; }
        .session-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 13px; }
        .session-row:last-child { border-bottom: none; }
        .session-info { display: flex; flex-direction: column; }
        .session-date { font-size: 10px; color: var(--text-light); }
        .session-coins { color: var(--gold); font-weight: bold; background: rgba(255, 215, 0, 0.1); padding: 2px 8px; border-radius: 8px; }

        /* FX */
        .float-text { position: fixed; pointer-events: none; animation: floatUp 1s forwards; font-weight: 800; z-index: 9999; text-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 18px; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-50px) scale(1.3); opacity: 0; } }
        .confetti-piece { position: fixed; width: 10px; height: 10px; z-index: 9999; pointer-events: none; animation: fall linear forwards; }
        @keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotate(720deg); opacity: 0; } }

        /* ACHIEVEMENTS LIST */
        .ach-list { display: flex; flex-direction: column; gap: 10px; }
        .ach-row { display: flex; align-items: center; gap: 15px; background: var(--bg); padding: 15px; border-radius: 15px; transition: 0.2s; border: 2px solid transparent; }
        .ach-row.unlocked { background: var(--surface); border-color: var(--success); box-shadow: var(--shadow); }
        .ach-icon { font-size: 28px; width: 50px; height: 50px; background: rgba(0,0,0,0.05); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .ach-row.unlocked .ach-icon { background: var(--success); color: white; }
        .ach-info { flex-grow: 1; }
        .ach-title { font-weight: bold; font-size: 14px; margin-bottom: 3px; display: flex; justify-content: space-between; }
        .ach-desc { font-size: 12px; color: var(--text-light); margin-bottom: 8px; }
        .ach-bar-bg { width: 100%; height: 6px; background: rgba(0,0,0,0.1); border-radius: 3px; overflow: hidden; }
        .ach-bar-fill { height: 100%; background: var(--primary); transition: 0.5s; }
        .ach-row.unlocked .ach-bar-fill { background: var(--success); }

        /* GENDER & DATE PICKER */
        .reg-group { text-align: left; margin-bottom: 15px; }
        .reg-label { font-size: 12px; color: var(--text-light); margin-bottom: 5px; font-weight: bold; }
        .gender-switch { display: flex; gap: 10px; }
        .gender-btn { flex: 1; padding: 10px; border: 2px solid var(--bg); background: var(--bg); border-radius: 12px; cursor: pointer; font-weight: bold; color: var(--text-light); }
        .gender-btn.active { border-color: var(--primary); color: var(--primary); background: rgba(108, 99, 255, 0.05); }

        /* DIFFICULTY BUTTONS */
        .diff-switch { display: flex; gap: 5px; justify-content: center; margin-bottom: 20px; }
        .diff-btn { padding: 8px 15px; border: 2px solid var(--bg); background: var(--surface); border-radius: 10px; cursor: pointer; font-size: 12px; font-weight: bold; color: var(--text-light); }
        .diff-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* MUSIC WIDGET */
        .music-widget { display: flex; align-items: center; justify-content: space-between; background: var(--bg); padding: 10px 15px; border-radius: 15px; margin-bottom: 15px; }
        .music-info { display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 13px; color: var(--text); }
        .visualizer { display: flex; gap: 2px; align-items: flex-end; height: 15px; }
        .bar { width: 3px; background: var(--primary); animation: equalizer 1s infinite; }
        @keyframes equalizer { 0% { height: 5px; } 50% { height: 15px; } 100% { height: 5px; } }

        @media (max-width: 600px) {
            .stat-detail-grid { grid-template-columns: 1fr; }
            .header-card { flex-direction: column; align-items: flex-start; gap: 15px; }
            .currency-block { width: 100%; justify-content: space-between; }
            .nav-btn { padding: 10px 15px; font-size: 13px; }
            .preset-grid { grid-template-columns: repeat(3, 1fr); }
            .auth-card { padding: 30px 20px; }
        }

/* === –ê–î–ê–ü–¢–ê–¶–ò–Ø –ü–û–î –¢–ï–õ–ï–§–û–ù ‚Äî –ì–õ–ê–í–ù–û–ï === */
body {
    -webkit-text-size-adjust: 100%;
    word-break: break-word; /* –¥–ª–∏–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ –ø–µ—Ä–µ–Ω–æ—Å—è—Ç—Å—è */
    overflow-wrap: anywhere;
}

/* –í—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∏ –∫–Ω–æ–ø–∫–∏ */
.card, .btn, .input-field, .modal-content, .nav-btn {
    word-wrap: break-word;
    overflow-wrap: anywhere;
}

/* –¢–µ–∫—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —á–∞—Å—Ç–æ –≤—ã–ª–µ–∑–∞–ª–∏ */
.trainer-problem {
    font-size: 9vw; /* –≤–º–µ—Å—Ç–æ 42px ‚Äî —Ç–µ–ø–µ—Ä—å –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è */
    word-break: break-all;
    padding: 10px;
}

/* –¢–∞–π–º–µ—Ä –≤ Zen-—Ä–µ–∂–∏–º–µ */
body.zen-active #timer {
    font-size: 16vw; /* –±—ã–ª–æ 18vw ‚Äî —á—É—Ç—å –º–µ–Ω—å—à–µ, —á—Ç–æ–±—ã –≤–ª–µ–∑–∞–ª */
}

/* –ö–Ω–æ–ø–∫–∏ –≤ –Ω–∏–∂–Ω–µ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
.nav {
    padding: 10px 5px calc(10px + var(--safe-bottom));
    gap: 5px;
}
.nav-btn {
    padding: 10px 12px;
    font-size: 12px;
    min-width: 60px;
}

/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ‚Äî —á—Ç–æ–±—ã –≥—Ä–∞—Ñ–∏–∫–∏ –Ω–µ –≤—ã–ª–µ–∑–∞–ª–∏ */
#subjectChart, #weekChart {
    max-height: 250px;
}

/* –ú–æ–¥–∞–ª–∫–∏ */
.modal-content {
    margin: 20px;
    max-width: calc(100vw - 40px);
}

/* –£–º–µ–Ω—å—à–∞–µ–º —à—Ä–∏—Ñ—Ç—ã –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
@media (max-width: 380px) {
    .timer-display { font-size: 60px; }
    .trainer-problem { font-size: 8vw; }
    .nav-btn { font-size: 11px; padding: 10px 8px; }
    h2 { font-size: 22px; }
    h3 { font-size: 18px; }
}

/* === SPLASH SCREEN STYLES === */
#splash-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg); /* –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π —Ü–≤–µ—Ç –±—Ä–µ–Ω–¥–∞: #6C63FF */
    z-index: 99999; /* –°–∞–º—ã–π –≤–µ—Ä—Ö–Ω–∏–π —Å–ª–æ–π */
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    transition: opacity 0.5s ease-out, visibility 0.5s;
}

#splash-screen.hidden {
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
}

.splash-logo {
    width: 120px;
    height: 120px;
    margin-bottom: 20px;
    animation: bounce 2s infinite;
    filter: drop-shadow(0 10px 20px rgba(108, 99, 255, 0.3));
}

.splash-title {
    font-size: 24px;
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 30px;
    letter-spacing: 1px;
}

/* –ö—Ä—É—Ç–∏–ª–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ */
.loader {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(108, 99, 255, 0.2);
    border-top: 4px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

/* === ECO MODE (OLED SAVER) === */
#eco-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: #000000;
    z-index: 99999;
    display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: #333; /* –û—á–µ–Ω—å —Ç—É—Å–∫–ª—ã–π —Ç–µ–∫—Å—Ç */
    font-family: monospace;
    touch-action: manipulation;
}

#eco-overlay.active {
    display: flex;
}

.eco-text {
    font-size: 14px;
    margin-top: 20px;
    opacity: 0.3;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–≤–∏–∂–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ –≤—ã–≥–æ—Ä–∞–ª —ç–∫—Ä–∞–Ω */
@keyframes drift {
    0% { transform: translate(0, 0); }
    25% { transform: translate(10px, 10px); }
    50% { transform: translate(-10px, 20px); }
    75% { transform: translate(-20px, -10px); }
    100% { transform: translate(0, 0); }
}

.eco-floater {
    animation: drift 60s infinite linear;
    text-align: center;
}

#eco-timer-display {
    font-size: 80px;
    font-weight: bold;
    color: #1a1a1a; /* –û—á–µ–Ω—å —Ç–µ–º–Ω—ã–π —Å–µ—Ä—ã–π, —á—Ç–æ–±—ã –µ–¥–≤–∞ —Å–≤–µ—Ç–∏–ª—Å—è */
}

@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

    </style>
</head>
<body>

<!-- SPLASH SCREEN ‚Äî —É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è -->
<div id="splash-screen" style="
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: var(--bg); /* ‚Üê —Ñ–æ–Ω –±–µ—Ä—ë—Ç—Å—è –∏–∑ —Ç–µ–∫—É—â–µ–π —Ç–µ–º—ã (–Ω–∏–∫–∞–∫–æ–π —Ä–∞–∑–Ω–∏—Ü—ã –≤ —Ü–≤–µ—Ç–µ) */
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    transition: opacity 0.8s ease-out;
">
    <img src="logo.png" alt="MathBooster" style="
        width: clamp(140px, 40vw, 220px); /* ‚Üê –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–º–µ—Ä: –æ—Ç 140px –¥–æ 220px */
        height: auto;
        max-width: 80vw;
        animation: float 3s infinite ease-in-out;
        filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3));
    ">
    <h1 style="
        color: var(--text);
        margin-top: 30px;
        font-size: clamp(32px, 8vw, 48px);
        font-weight: 800;
        letter-spacing: 2px;
        text-align: center;
    ">
        MATH BOOSTER
    </h1>
    <p style="
        color: var(--text);
        margin-top: 10px;
        font-size: clamp(16px, 4vw, 20px);
    ">
        PRO
    </p>
</div>

<style>
/* –ê–Ω–∏–º–∞—Ü–∏—è –ª–æ–≥–æ ‚Äî –ø–ª–∞–≤–Ω–æ–µ "–ø–ª–∞–≤–∞–Ω–∏–µ" –≤–≤–µ—Ä—Ö-–≤–Ω–∏–∑ */
@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-12px); }
}
</style>

<script>
// –ü–ª–∞–≤–Ω–æ–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ splash —á–µ—Ä–µ–∑ 1.8 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
window.addEventListener('load', () => {
    setTimeout(() => {
        const splash = document.getElementById('splash-screen');
        if (splash) {
            splash.style.opacity = '0';
            setTimeout(() => splash.remove(), 800);
        }
    }, 1800); // 1.8 —Å–µ–∫—É–Ω–¥—ã –ø–æ–∫–∞–∑–∞
});
</script>

<!-- PWA Manifest Generation (–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è) -->
<script>
    const manifest = {
    "name": "MathBooster PRO",
    "short_name": "MathBooster",
    "start_url": "/",  // ‚Üê —Ñ–∏–∫—Å
    "display": "standalone",
    "background_color": "#F4F7FE",
    "theme_color": "#6C63FF",
    "orientation": "portrait",
    "icons": [
        { "src": "icon-192.png", "sizes": "192x192", "type": "image/png" },
        { "src": "icon-512.png", "sizes": "512x512", "type": "image/png" }
    ]
};
    const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
    document.getElementById('manifest-link').setAttribute('href', URL.createObjectURL(blob));
</script>

<!-- AUTH SCREEN -->
<div id="auth-screen">
    <div class="auth-card" id="login-view">

        <img src="logo.png" alt="Logo" class="app-logo"> <!-- –ó–¥–µ—Å—å -->
        <h2 style="margin-bottom: 5px; color: var(--primary);">MathBooster PRO</h2>
        <p style="color: var(--text-light); font-size: 14px; margin-bottom: 20px;">–¢–≤–æ–π –ø—É—Ç—å –∫ –∑–Ω–∞–Ω–∏—è–º</p>
        <div id="user-list"></div>
        <button class="btn btn-primary" onclick="Auth.showRegister()" style="margin-top: 10px;">+ –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
<button class="btn" onclick="Transfer.transferByID()" style="margin-top: 15px; background: white; border: 2px dashed var(--primary); color: var(--primary); font-weight: bold; width: 100%; padding: 15px; animation: pulse-btn 2s infinite;">
    üì• –£ –º–µ–Ω—è –µ—Å—Ç—å –∫–æ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
</button>

<style>
@keyframes pulse-btn {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}
</style>
    </div>

    <div class="auth-card" id="register-view" style="display: none;">
        <h2>–ù–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
        <div class="avatar-grid" id="avatar-selector"></div>
        
        <!-- –í–û–¢ –°–ê–ú–ê–Ø –í–ê–ñ–ù–ê–Ø –°–¢–†–û–ö–ê. –ë–ï–ó ID="reg-name" –ù–ò–ß–ï–ì–û –ù–ï –†–ê–ë–û–¢–ê–ï–¢ -->
        <input type="text" id="reg-name" class="input-field" placeholder="–í–∞—à–µ –∏–º—è..." maxlength="12">
        <!-- ----------------------------------------------------------- -->

        <div class="reg-group" style="margin:15px 0;">
            <div style="font-size:12px; color:var(--text-light); margin-bottom:5px;">–ü–æ–ª</div>
            <div style="display:flex; gap:10px;">
                <button class="btn gender-btn active" onclick="Auth.setGender('male')" style="border:2px solid var(--bg);">üë® –ü–∞—Ä–µ–Ω—å</button>
                <button class="btn gender-btn" onclick="Auth.setGender('female')" style="border:2px solid var(--bg);">üë© –î–µ–≤—É—à–∫–∞</button>
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn btn-outline" onclick="Auth.showLogin()">–ù–∞–∑–∞–¥</button>
            <button class="btn btn-primary" onclick="Auth.createAccount()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>
</div>

<!-- MAIN APP -->
<div class="container" id="app-container" style="display: none;"> 
    <div class="header-card">
        <div class="profile-mini" onclick="App.switchTab('profile')">
            <div class="profile-img" id="header-avatar-box"><div id="header-avatar">üòé</div></div>
            <div>
                <div style="font-weight: bold; font-size: 18px;" id="header-name">–ò–≥—Ä–æ–∫</div>
                <div style="font-size: 12px; color: var(--text-light);" id="header-league">–ù–æ–≤–∏—á–æ–∫</div>
            </div>
        </div>
        <div class="currency-block">
            <div class="currency-item"><span>üí∞</span> <span id="coin-display">0</span></div>
            <div class="currency-item" style="color:#FF7675;"><span>üî•</span> <span id="streak-display">0</span></div>
        </div>
    </div>

    <nav class="nav">
        <button class="nav-btn active" onclick="App.switchTab('dashboard', this)">‚è±Ô∏è –£—á–µ–±–∞</button>
        <button class="nav-btn" onclick="App.switchTab('trainer', this)">üß† –¢—Ä–µ–Ω–∞–∂–µ—Ä</button>
        <button class="nav-btn" onclick="App.switchTab('stats', this)">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        <button class="nav-btn" onclick="App.switchTab('leaderboard', this)">üèÜ –¢–æ–ø</button>
        <button class="nav-btn" onclick="App.switchTab('shop', this)">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
        <button class="nav-btn" onclick="App.switchTab('achievements', this)">üèÖ –ù–∞–≥—Ä–∞–¥—ã</button>
        <button class="nav-btn" onclick="App.switchTab('settings', this)">‚öôÔ∏è –û–ø—Ü–∏–∏</button>
    </nav>

    <!-- 1. DASHBOARD -->
    <section id="dashboard" class="section active">
        <div class="grid">
            <div class="card zen-target" style="text-align: center; position: relative;">
                <!-- TOOLS -->
                <div style="position: absolute; top: 15px; right: 15px; display:flex; gap:5px;">
                    <button onclick="Whiteboard.toggle()" style="background: transparent; border: none; font-size: 24px; cursor: pointer; opacity: 0.5;" title="–ß–µ—Ä–Ω–æ–≤–∏–∫">‚úèÔ∏è</button>
                    <button onclick="Calc.toggle()" style="background: transparent; border: none; font-size: 24px; cursor: pointer; opacity: 0.5;" title="–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä">üßÆ</button>
                    <button onclick="App.toggleEcoMode(true)" style="background: transparent; border: none; font-size: 24px; cursor: pointer; opacity: 0.5;" title="–≠–∫–æ —Ä–µ–∂–∏–º (—á–µ—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω)">üîã</button>
                </div>
                
                <h3 style="color: var(--text-light); font-size: 12px; text-transform: uppercase;">–§–æ–∫—É—Å</h3>
                <h2 id="subject-title" style="font-size: 28px; color: var(--primary); margin-bottom: 10px;">–ê–ª–≥–µ–±—Ä–∞</h2>
                
                <div id="timer" class="timer-display">00:00:00</div>
                <div style="font-size: 13px; color: var(--text-light); margin-bottom: 15px;">
                    1 –º–æ–Ω–µ—Ç–∞ üí∞ –∑–∞ –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
                </div>
                
                <!-- SESSION GOAL -->
                <input type="text" id="session-goal" class="input-field" placeholder="üéØ –¶–µ–ª—å –Ω–∞ —Å–µ—Å—Å–∏—é (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)..." style="text-align: center; font-size: 14px; padding: 10px;">

                <div class="zen-controls" style="position: relative; width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                    <button id="btn-start" class="btn btn-primary" onclick="Timer.preStart()">üöÄ –°–¢–ê–†–¢</button>
                    <button class="btn btn-outline" onclick="Timer.stop()">‚èπ –°–¢–û–ü</button>
                </div>
            </div>
            
            <div class="card">
                <h3>üéß Lo-Fi –†–∞–¥–∏–æ</h3>
                <div class="music-widget">
                    <div class="music-info">
                        <span style="font-size: 20px;">üéµ</span>
                        <span>Chill Study Beats</span>
                    </div>
                    <div class="visualizer" id="music-vis" style="opacity: 0;">
                        <div class="bar" style="animation-duration: 0.5s"></div>
                        <div class="bar" style="animation-duration: 0.7s"></div>
                        <div class="bar" style="animation-duration: 0.4s"></div>
                        <div class="bar" style="animation-duration: 0.6s"></div>
                    </div>
                    <button id="music-btn" class="btn btn-primary" style="width: auto; padding: 5px 15px; font-size: 12px;" onclick="MusicPlayer.toggle()">‚ñ∂</button>
                </div>
                <!-- FIXED AUDIO SOURCE -->
                <audio id="lofi-stream" crossorigin="anonymous" preload="none">
                    <source src="https://lofi.stream.laut.fm/lofi" type="audio/mpeg">
                    <source src="https://stream.zeno.fm/f3wvbbqmdg8uv" type="audio/mpeg">
                </audio>
                
                <h3 style="margin-top: 20px;">üìö –ü—Ä–µ–¥–º–µ—Ç—ã</h3>
                <div id="subjects-grid" style="display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:15px; justify-items:center;"></div>            </div>
        </div>
    </section>

<!-- 8. ABOUT SECTION (–ù–æ–≤—ã–π –∫—Ä–∞—Å–∏–≤—ã–π —Ä–∞–∑–¥–µ–ª) -->
    <section id="about" class="section">
        
        <!-- –®–∞–ø–∫–∞ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º -->
        <div class="card" style="background: linear-gradient(135deg, #6C63FF, #4834d4); color: white; text-align: center; padding: 40px 20px; position: relative; overflow: hidden; border: none;">
            <!-- –î–µ–∫–æ—Ä –Ω–∞ —Ñ–æ–Ω–µ -->
            <div style="position: absolute; top: -20px; right: -20px; font-size: 150px; opacity: 0.1;">üöÄ</div>
            
            <img src="logo.png" alt="MathBooster" style="width: 80px; height: 80px; background: white; border-radius: 20px; padding: 5px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); margin-bottom: 15px;">
            
            <h2 style="font-size: 28px; margin: 0; font-weight: 800;">MathBooster PRO</h2>
            <div style="opacity: 0.8; font-size: 14px; margin-top: 5px;">v1.0 ‚Ä¢ UZ Edition üá∫üáø</div>
        </div>

        <!-- –ú–∏—Å—Å–∏—è -->
        <div class="card" style="margin-top: 20px;">
            <h3>üéØ –ù–∞—à–∞ –º–∏—Å—Å–∏—è</h3>
            <p style="color: var(--text-light); line-height: 1.6; margin-top: 10px;">
                –£—á–µ–±–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–∫—É—á–Ω–æ–π. –ú—ã –≤–µ—Ä–∏–º, —á—Ç–æ <b>–≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è</b> ‚Äî —ç—Ç–æ –∫–ª—é—á –∫ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏. 
                <br><br>
                MathBooster –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç —á–∞—Å—ã –∑–∞ —É—á–µ–±–Ω–∏–∫–∞–º–∏ –≤ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—É—é RPG-–∏–≥—Ä—É, –≥–¥–µ —Ç—ã –∫–∞—á–∞–µ—à—å —Å–≤–æ–π –º–æ–∑–≥ —Ç–∞–∫ –∂–µ, –∫–∞–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –≤ –∏–≥—Ä–∞—Ö.
            </p>
        </div>

        <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Ñ–∏—à–µ–∫ -->
        <div class="grid" style="margin-top: 20px; grid-template-columns: 1fr 1fr;">
            <div class="card" style="text-align: center; padding: 15px;">
                <div style="font-size: 30px; margin-bottom: 10px;">‚è≥</div>
                <div style="font-weight: bold; font-size: 14px;">–¢–∞–π–º-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç</div>
                <div style="font-size: 11px; color: var(--text-light);">–§–æ–∫—É—Å –±–µ–∑ –æ—Ç–≤–ª–µ—á–µ–Ω–∏–π</div>
            </div>
            <div class="card" style="text-align: center; padding: 15px;">
                <div style="font-size: 30px; margin-bottom: 10px;">üí∞</div>
                <div style="font-weight: bold; font-size: 14px;">–≠–∫–æ–Ω–æ–º–∏–∫–∞</div>
                <div style="font-size: 11px; color: var(--text-light);">–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π —É–º–æ–º</div>
            </div>
            <div class="card" style="text-align: center; padding: 15px;">
                <div style="font-size: 30px; margin-bottom: 10px;">üìä</div>
                <div style="font-weight: bold; font-size: 14px;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                <div style="font-size: 11px; color: var(--text-light);">–°–ª–µ–¥–∏ –∑–∞ —Ä–æ—Å—Ç–æ–º</div>
            </div>
            <div class="card" style="text-align: center; padding: 15px;">
                <div style="font-size: 30px; margin-bottom: 10px;">üèÜ</div>
                <div style="font-weight: bold; font-size: 14px;">–°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ</div>
                <div style="font-size: 11px; color: var(--text-light);">–ë—É–¥—å –ø–µ—Ä–≤—ã–º –≤ —Ç–æ–ø–µ</div>
            </div>
        </div>

        <!-- –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ -->
        <div class="card" style="margin-top: 20px;">
            <h3>üë®‚Äçüíª –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫</h3>
            <div style="display: flex; align-items: center; gap: 15px; margin-top: 15px;">
                <div style="width: 60px; height: 60px; background: #eee; border-radius: 50%; font-size: 30px; display: flex; align-items: center; justify-content: center;">üë®‚Äçüíª</div>
                <div>
                    <div style="font-weight: bold; font-size: 16px;">–ú–∞–Ω—Å—É—Ä–æ–≤ –†—É—Å—Ç–∞–º –£–∫—Ç–∞–º–æ–≤–∏—á</div>
                    <div style="color: var(--text-light); font-size: 12px;">Math Teacher</div>
                    <div style="color: var(--primary); font-size: 12px; font-weight: bold; margin-top: 3px;">Bukhara, Uzbekistan</div>
                </div>
            </div>
            <p style="margin-top: 15px; font-size: 13px; color: var(--text-light);">
                "–Ø —Å–æ–∑–¥–∞–ª —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, —á—Ç–æ–±—ã –¥–æ–∫–∞–∑–∞—Ç—å: —É—á–∏—Ç—å—Å—è –º–æ–∂–Ω–æ —Å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º. –°–ø–∞—Å–∏–±–æ, —á—Ç–æ –≤—ã —Å –Ω–∞–º–∏!"
            </p>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –¢–µ–ª–µ–≥—Ä–∞–º -->
            <a href="https://t.me/rustambey708" target="_blank" style="text-decoration: none;">
                <button class="btn" style="background: #0088cc; color: white; margin-top: 15px; width: 100%;">
                    ‚úàÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram
                </button>
            </a>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥ -->
        <button class="btn btn-outline" style="margin-top: 30px; margin-bottom: 30px;" onclick="App.switchTab('settings')">
            ‚¨ÖÔ∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        </button>
    </section>

    <!-- 2. TRAINER -->
    <section id="trainer" class="section">
        <div class="card" id="trainer-menu" style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 60px; margin-bottom: 20px;">üß†</div>
            <h2>–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –°–ø—Ä–∏–Ω—Ç</h2>
            <p style="color: var(--text-light); margin: 10px 0 20px;">–†–µ—à–∏ –∫–∞–∫ –º–æ–∂–Ω–æ –±–æ–ª—å—à–µ –ø—Ä–∏–º–µ—Ä–æ–≤ –∑–∞ 60 —Å–µ–∫—É–Ω–¥.</p>
            
            <div class="diff-switch">
                <div class="diff-btn active" onclick="Trainer.setDiff('easy', this)">–õ–µ–≥–∫–æ</div>
                <div class="diff-btn" onclick="Trainer.setDiff('medium', this)">–°—Ä–µ–¥–Ω–µ</div>
                <div class="diff-btn" onclick="Trainer.setDiff('hard', this)">–°–ª–æ–∂–Ω–æ</div>
            </div>

            <div class="stat-pill" style="display: inline-block; margin-bottom: 30px;">
                <span class="stat-label">–í–∞—à –†–µ–∫–æ—Ä–¥</span><br>
                <span class="stat-val" style="font-size: 24px;" id="trainer-high-score">0</span>
            </div>
            <br>
            <button class="btn btn-primary" style="font-size: 20px; padding: 15px 40px;" onclick="Trainer.start()">–ù–∞—á–∞—Ç—å –ò–≥—Ä—É üöÄ</button>
        </div>

        <div class="card" id="trainer-game" style="display: none; text-align: center;">
            <div class="trainer-stats">
                <div>‚è≥ <span id="game-time">60</span>s</div>
                <div>‚úÖ <span id="game-score">0</span></div>
            </div>
            <div class="trainer-problem" id="game-problem" style="word-break:break-all;">2 x 2</div>           
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫–∏ –º–∏–Ω—É—Å–∞ -->
<div style="display: flex; gap: 10px; justify-content: center; align-items: center; max-width: 300px; margin: 0 auto;">
    
    <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ (–∏–∑–º–µ–Ω–∏–ª–∏ —Ç–∏–ø –Ω–∞ tel –¥–ª—è –ª—É—á—à–µ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã) -->
    <input type="tel" id="game-input" class="input-field trainer-input" placeholder="?" style="margin-bottom: 0;">
    
    <!-- –ö–Ω–æ–ø–∫–∞ +/- -->
    <button class="btn btn-outline" onclick="Trainer.toggleMinus()" style="width: 60px; height: 60px; padding: 0; font-size: 20px; border-width: 2px;" title="–ü–æ—Å—Ç–∞–≤–∏—Ç—å –º–∏–Ω—É—Å">+/-</button>

</div>

<div style="font-size: 12px; color: var(--text-light); margin-top: 15px;">–ù–∞–∂–º–∏ Enter —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å</div>
            <button class="btn btn-outline" style="margin-top: 20px;" onclick="Trainer.end()">–ó–∞–∫–æ–Ω—á–∏—Ç—å</button>
        </div>

        <div class="card" id="trainer-result" style="display: none; text-align: center;">
            <h2>–í—Ä–µ–º—è –≤—ã—à–ª–æ! üèÅ</h2>
            <div style="margin: 30px 0;">
                <div style="font-size: 14px; color: var(--text-light);">–í–∞—à —Å—á–µ—Ç</div>
                <div style="font-size: 48px; font-weight: bold; color: var(--primary);" id="result-score">0</div>
            </div>
            <div class="grid" style="margin-bottom: 20px;">
                <div class="stat-pill">
                    <div class="stat-val" id="result-xp">+0 XP</div>
                </div>
                <div class="stat-pill">
                    <div class="stat-val" id="result-coins">+0 üí∞</div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="Trainer.init()">–°—ã–≥—Ä–∞—Ç—å –µ—â–µ —Ä–∞–∑</button>
        </div>
    </section>

    <!-- 3. STATS -->
    <section id="stats" class="section">
        <div class="card" style="margin-bottom: 20px;">
            <h3>üìä –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
            <div class="stat-detail-grid">
                <div class="stat-detail-card">
                    <div class="stat-detail-title">–ó–∞ –Ω–µ–¥–µ–ª—é</div>
                    <div class="stat-detail-value" id="stat-week-time">0—á</div>
                    <div class="stat-detail-sub" id="stat-week-xp">0 XP</div>
                </div>
                <div class="stat-detail-card">
                    <div class="stat-detail-title">–ó–∞ –º–µ—Å—è—Ü</div>
                    <div class="stat-detail-value" id="stat-month-time">0—á</div>
                    <div class="stat-detail-sub" id="stat-month-xp">0 XP</div>
                </div>
                <div class="stat-detail-card">
                    <div class="stat-detail-title">–í—Å–µ –≤—Ä–µ–º—è</div>
                    <div class="stat-detail-value" id="stat-total-time">0—á</div>
                    <div class="stat-detail-sub" id="stat-total-xp">0 XP</div>
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h3>üî• –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (30 –¥–Ω–µ–π)</h3>
                <div id="heatmap" style="display:grid; grid-template-columns:repeat(7,1fr); gap:5px; margin-top:15px;"></div>            </div>
            <div class="card">
                <h3>üìú –ñ—É—Ä–Ω–∞–ª –∑–∞–Ω—è—Ç–∏–π</h3>
                <div id="session-log" class="session-log"></div>
            </div>
            <div class="card">
                <h3>–ò—Å—Ç–æ—Ä–∏—è (–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è)</h3>
                <div style="height: 200px;"><canvas id="weekChart"></canvas></div>
            </div>
            <div class="card">
                <h3>üß© –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</h3>
                <div style="height: 250px; position: relative;">
                    <canvas id="subjectChart"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- 4. LEADERBOARD -->
    <section id="leaderboard" class="section">
        <div class="card">
            <h3>üèÜ –ì–ª–æ–±–∞–ª—å–Ω—ã–π –¢–æ–ø</h3>
            <p style="font-size:12px; color:var(--text-light); margin-bottom:15px;">–ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ (—Ç—Ä–µ–±—É–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç)</p>
            <div id="total-players-count" style="text-align:center; font-weight:bold; color:var(--primary); margin-bottom:10px;"></div>
            <button class="btn btn-primary" onclick="Online.loadLeaderboard()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            <div id="leaderboard-list" style="margin-top:15px; display:flex; flex-direction:column; gap:10px;">
                <div style="text-align:center; color:gray;">–ù–∞–∂–º–∏ –æ–±–Ω–æ–≤–∏—Ç—å...</div>
            </div>
        </div>
    </section>

    <!-- 5. SHOP -->
    <section id="shop" class="section">
        <div class="card">
            <h3>üé® –¢–µ–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</h3>
            <p style="color: var(--text-light); font-size: 13px; margin-bottom: 15px;">–ü–æ–∫—É–ø–∞–π—Ç–µ –Ω–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –∑–∞ üí∞ –º–æ–Ω–µ—Ç—ã!</p>
            <div id="theme-list" class="shop-grid"></div>
        </div>
        <div class="card" style="margin-top: 20px;">
            <h3>üòé –ê–≤–∞—Ç–∞—Ä—ã</h3>
            <p style="color: var(--text-light); font-size: 13px; margin-bottom: 15px;">–í—ã–¥–µ–ª–∏—Ç–µ—Å—å –∏–∑ —Ç–æ–ª–ø—ã!</p>
            <div id="avatar-shop-list" class="shop-grid"></div>
        </div>
    </section>

    <!-- 6. SETTINGS & DONATION -->
    <section id="settings" class="section">
        <!-- –ö–Ω–æ–ø–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ) -->
<div id="install-promo-card" class="card" style="background: linear-gradient(135deg, #00d26a, #00b894); color: white; display: none; margin-bottom: 20px; cursor: pointer;" onclick="InstallSys.startFlow()">
    <div style="display: flex; align-items: center; gap: 15px;">
        <div style="font-size: 30px;">üì≤</div>
        <div>
            <div style="font-weight: bold; font-size: 16px;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</div>
            <div style="font-size: 12px; opacity: 0.9;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ —É–±—Ä–∞—Ç—å —Ä–∞–º–∫–∏</div>
        </div>
    </div>
</div>
        <div class="card" style="margin-top: 20px; text-align: center; cursor: pointer;" onclick="document.getElementById('about-modal').classList.add('show')">
            <h3>‚ÑπÔ∏è –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</h3>
            <p style="color: var(--text-light); font-size: 12px;">–í–µ—Ä—Å–∏—è 1.0 PRO </p>
        </div>

<!-- –ö–∞—Ä—Ç–æ—á–∫–∞ Premium —Å –ü—Ä–∞–π—Å-–ª–∏—Å—Ç–æ–º -->
<div style="background:linear-gradient(135deg, #FFD700, #FFA500); padding:20px; border-radius:20px; color:#333; margin:20px 0; text-align:center; position:relative; overflow:hidden; box-shadow:0 10px 20px rgba(255,215,0,0.3);">
    
    <div style="font-size:40px; margin-bottom:5px;">üíé</div>
    <h3 style="margin:0; font-weight:800; text-transform:uppercase; color: #2B3674;">Premium</h3>
    <p style="font-size:12px; margin:5px 0;">–ü–æ–¥–¥–µ—Ä–∂–∏ –ø—Ä–æ–µ–∫—Ç –∏ —Å—ç–∫–æ–Ω–æ–º—å –≤—Ä–µ–º—è!</p>

    <!-- üëá –ù–û–í–´–ô –ü–†–ê–ô–° –õ–ò–°–¢ üëá -->
    <div style="background: rgba(255,255,255,0.9); border-radius: 12px; padding: 12px; margin: 15px 0; color: #333; font-size: 13px; text-align: left; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
        <div style="font-weight: bold; margin-bottom: 8px; text-align: center; color: #2B3674; text-transform: uppercase; font-size: 11px; letter-spacing: 1px;">–ü—Ä–∞–π—Å-–ª–∏—Å—Ç (UZS)</div>
        
        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #eee;">
            <span>300 üí∞</span> <b>5 000 UZS</b>
        </div>
        
        <!-- –í—ã–¥–µ–ª—è–µ–º –•–ò–¢ –ø—Ä–æ–¥–∞–∂ -->
        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #eee; background: rgba(255, 215, 0, 0.25); border-radius: 6px; margin: 2px -6px; padding-left: 6px; padding-right: 6px;">
            <span style="font-weight:800; color:#2B3674;">1 000 üí∞</span> <b style="color: #d35400;">15 000 UZS üî•</b>
        </div>
        
        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #eee;">
            <span>3 000 üí∞</span> <b>35 000 UZS</b>
        </div>
        
        <div style="display: flex; justify-content: space-between; padding: 6px 0;">
            <span>5 000 üí∞</span> <b>50 000 UZS üëë</b>
        </div>
    </div>
    <!-- üëÜ –ö–û–ù–ï–¶ –ü–†–ê–ô–° –õ–ò–°–¢–ê üëÜ -->

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px;">
        <button class="btn" style="background:white; color:#2B3674; font-size:12px; font-weight:bold;" onclick="Donation.payUz()">üá∫üáø UZB (Humo)</button>
        <button class="btn" style="background:#2B3674; color:white; font-size:12px; font-weight:bold;" onclick="Donation.payWorld()">üåç World (Visa)</button>
    </div>
    <button class="btn" style="background:rgba(255,255,255,0.3); color:white; margin-top:10px; font-weight:bold;" onclick="Donation.enterCode()">üîë –í–≤–µ—Å—Ç–∏ –∫–æ–¥</button>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ –≤—ã–∑–æ–≤–∞ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è -->
<div class="card" style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="document.getElementById('terms-modal').classList.add('show')">
    <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 20px;">‚öñÔ∏è</span>
        <span style="font-weight: bold; font-size: 14px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ</span>
    </div>
    <div style="color: var(--text-light);">‚ûú</div>
</div>
        
<div class="card">
    <h3>‚öôÔ∏è –û–ø—Ü–∏–∏ –∏ –ø–µ—Ä–µ–Ω–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</h3>
    
    <!-- –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--bg); padding: 15px; border-radius: 15px;">
        <span>üîä –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã</span>
        <input type="checkbox" id="sfx-toggle" onchange="SoundSys.toggleSFX(this.checked)" checked style="transform: scale(1.5);">
    </div>
    
<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; background: var(--bg); padding: 15px; border-radius: 15px;">
    <span>üåô –¢—ë–º–Ω—ã–π —Ä–µ–∂–∏–º</span>
    <input type="checkbox" id="dark-toggle" onchange="App.toggleDarkMode(this.checked)" style="transform: scale(1.5);">
</div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏ -->
    <div style="margin-bottom: 20px;">
    <h4 style="margin-bottom: 10px;">üìö –ú–æ–∏ –ø—Ä–µ–¥–º–µ—Ç—ã</h4>
    <div id="my-subjects-list" class="subject-manage-grid"></div>

    <h4 style="margin-top: 30px; margin-bottom: 10px;">–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</h4>
    <div id="available-subjects-list" class="subject-manage-grid"></div>
</div>

<div class="preset-grid" style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px;">
    <div class="subject-item" onclick="moveFromPreset('üìñ', '–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞')">
        <div class="icon">üìñ</div>
        <div class="name">–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞</div>
    </div>

    <div class="subject-item" onclick="moveFromPreset('‚öõÔ∏è', '–§–∏–∑–∏–∫–∞')">
        <div class="icon">‚öõÔ∏è</div>
        <div class="name">–§–∏–∑–∏–∫–∞</div>
    </div>

    <div class="subject-item" onclick="moveFromPreset('üß™', '–•–∏–º–∏—è')">
        <div class="icon">üß™</div>
        <div class="name">–•–∏–º–∏—è</div>
    </div>

    <div class="subject-item" onclick="moveFromPreset('üß¨', '–ë–∏–æ–ª–æ–≥–∏—è')">
        <div class="icon">üß¨</div>
        <div class="name">–ë–∏–æ–ª–æ–≥–∏—è</div>
    </div>

    <div class="subject-item" onclick="moveFromPreset('üè∫', '–ò—Å—Ç–æ—Ä–∏—è')">
        <div class="icon">üè∫</div>
        <div class="name">–ò—Å—Ç–æ—Ä–∏—è</div>
    </div>

    <div class="subject-item" onclick="moveFromPreset('üåê', '–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫')">
        <div class="icon">üåê</div>
        <div class="name">–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫</div>
    </div>
</div>
    
    <!-- –ù–æ–≤—ã–π —á–∏—Å—Ç—ã–π —Ä–∞–∑–¥–µ–ª –ø–µ—Ä–µ–Ω–æ—Å–∞ -->
    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--bg);">
    <h4 style="margin-bottom: 15px;">üì¶ –ü–µ—Ä–µ–Ω–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</h4>
    <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
        <button class="btn btn-primary" onclick="Transfer.generateTransferID()">
            –°–æ–∑–¥–∞—Ç—å –∫–æ–¥ –ø–µ—Ä–µ–Ω–æ—Å–∞ (8 —Å–∏–º–≤–æ–ª–æ–≤)
        </button>
        <button class="btn btn-outline" onclick="Transfer.transferByID()">
            –í–≤–µ—Å—Ç–∏ –∫–æ–¥ —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        </button>
    </div>
    <p style="font-size: 12px; color: var(--text-light); margin-top: 15px; text-align: center;">
        –ö–æ–¥ –¥–µ–π—Å—Ç–≤—É–µ—Ç 24 —á–∞—Å–∞. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞ –Ω–æ–≤–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.
    </p>
</div>
    
    <!-- –°–±—Ä–æ—Å -->
    <button class="btn btn-outline" style="margin-top: 40px; border-color: #FF7675; color: #FF7675;" onclick="Auth.resetData()">
        üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
    </button>
</div>
    </section>
    
    <!-- 7. ACHIEVEMENTS -->
    <section id="achievements" class="section">
        <div class="card">
            <h3>üèÖ –ù–∞–≥—Ä–∞–¥—ã</h3>
            <div id="ach-list" class="ach-list"></div>
        </div>
    </section>
    
    <!-- PROFILE -->
    <section id="profile" class="section">
        <div class="card" style="text-align: center;">
            <div class="profile-img" id="profile-avatar-box" style="width: 80px; height: 80px; margin: 0 auto; font-size: 40px; border-width: 6px;">
                <div id="profile-avatar-big">üòé</div>
            </div>
            <h2 style="margin-top: 10px;" id="profile-name-big">–ò–≥—Ä–æ–∫</h2>
            <div style="color: var(--primary); font-weight: bold; margin-bottom: 20px; font-size: 18px;" id="profile-league-big">ü•â –ë—Ä–æ–Ω–∑–æ–≤–∞—è –õ–∏–≥–∞</div>
            
            <div class="stats-row">
                <div class="stat-pill"><div class="stat-val" id="prof-lvl">1</div><div class="stat-label">–£—Ä–æ–≤–µ–Ω—å</div></div>
                <div class="stat-pill"><div class="stat-val" id="prof-xp">0</div><div class="stat-label">–û–ø—ã—Ç</div></div>
                <div class="stat-pill"><div class="stat-val" id="prof-coins">0</div><div class="stat-label">–ú–æ–Ω–µ—Ç—ã</div></div>
            </div>
            <div style="margin-top: 20px; text-align: left;">
                <p style="font-size: 12px; color: var(--text-light); margin-bottom: 5px;">
                    –ü—Ä–æ–≥—Ä–µ—Å—Å —É—Ä–æ–≤–Ω—è: 
                    <span id="xp-progress-text" style="float:right; font-weight:bold;">0 / 500 XP</span>
                </p>
                <div style="height: 10px; background: rgba(0,0,0,0.1); border-radius: 5px; overflow: hidden;">
                    <div id="prof-xp-bar" style="height: 100%; width: 0%; background: var(--primary);"></div>
                </div>
            </div>
            <button class="btn btn-outline" style="margin-top: 30px; border-color: #FF7675; color: #FF7675;" onclick="Auth.logout()">üö™ –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
        </div>
    </section>
</div>

<!-- MODALS -->
<div id="calc-modal" class="modal">
    <div class="modal-content calc-box">
        <div id="calc-display" class="calc-display">0</div>
        <div class="calc-grid">
            <button class="calc-btn" style="color:#FF7675" onclick="Calc.clear()">C</button>
            <button class="calc-btn" onclick="Calc.append('(')">(</button>
            <button class="calc-btn" onclick="Calc.append(')')">)</button>
            <button class="calc-btn op" onclick="Calc.append('/')">√∑</button>
            <button class="calc-btn" onclick="Calc.append('7')">7</button>
            <button class="calc-btn" onclick="Calc.append('8')">8</button>
            <button class="calc-btn" onclick="Calc.append('9')">9</button>
            <button class="calc-btn op" onclick="Calc.append('*')">√ó</button>
            <button class="calc-btn" onclick="Calc.append('4')">4</button>
            <button class="calc-btn" onclick="Calc.append('5')">5</button>
            <button class="calc-btn" onclick="Calc.append('6')">6</button>
            <button class="calc-btn op" onclick="Calc.append('-')">-</button>
            <button class="calc-btn" onclick="Calc.append('1')">1</button>
            <button class="calc-btn" onclick="Calc.append('2')">2</button>
            <button class="calc-btn" onclick="Calc.append('3')">3</button>
            <button class="calc-btn op" onclick="Calc.append('+')">+</button>
            <button class="calc-btn" onclick="Calc.append('0')">0</button>
            <button class="calc-btn" onclick="Calc.append('.')">.</button>
            <button class="calc-btn eq" style="grid-column:span 2; background:var(--primary); color:white;" onclick="Calc.solve()">=</button>
        </div>
        <button class="btn btn-outline" style="margin-top: 15px; width: 100%;" onclick="Calc.toggle()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<div id="wb-modal" class="modal">
    <div class="modal-content" style="width:95%;">
        <h3>–ß–µ—Ä–Ω–æ–≤–∏–∫</h3>
        <div style="border:2px solid var(--text-light); border-radius:15px; overflow:hidden;">
            <canvas id="wb-canvas" class="canvas-box" height="350"></canvas>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn btn-outline" style="color:#FF7675;" onclick="Whiteboard.clear()">–û—á–∏—Å—Ç–∏—Ç—å</button>
            <button class="btn btn-primary" onclick="Whiteboard.close()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<div id="daily-modal" class="modal">
    <div class="modal-content" style="background:linear-gradient(135deg,var(--surface),var(--bg)); border:2px solid var(--gold);">
        <h2 style="color:var(--gold);">üéÅ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ë–æ–Ω—É—Å!</h2>
        <div class="daily-grid" id="daily-grid"></div>
        <div style="margin:20px 0; font-size:40px;">üí∞ <span id="daily-reward-amount">10</span></div>
        <button class="btn btn-primary" style="background:var(--gold); color:#333;" onclick="DailySys.claim()">–ó–∞–±—Ä–∞—Ç—å –ù–∞–≥—Ä–∞–¥—É</button>
    </div>
</div>

<div id="ach-details-box" class="modal">
    <div class="modal-content">
        <h2 id="ach-title"></h2>
        <p id="ach-desc" style="color:var(--text-light); margin-bottom:10px;"></p>
        <div id="ach-status" style="font-weight:bold;"></div>
        <button class="btn btn-primary" style="margin-top:20px;" onclick="document.getElementById('ach-details-box').classList.remove('show')">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<!-- ABOUT MODAL -->
<div id="about-modal" class="modal">
    
    <div class="modal-content" style="padding: 0; overflow: hidden; max-width: 350px;">
        
        <!-- –í–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å -->
        <div style="background: linear-gradient(135deg, #6C63FF, #8B7EFF); padding: 30px 20px; color: white;">
            <div style="width: 60px; height: 60px; background: white; border-radius: 18px; margin: 0 auto 15px auto; display: flex; align-items: center; justify-content: center; font-size: 32px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                üíé
            </div>
            <h2 style="margin: 0; font-size: 22px; font-weight: 800;">MathBooster</h2>
            <div style="opacity: 0.9; font-weight: 500; font-size: 14px;">PRO Edition</div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div style="padding: 25px;">
            
            <!-- –ë–µ–π–¥–∂–∏–∫–∏ -->
            <div style="display: flex; justify-content: center; gap: 8px; margin-bottom: 20px;">
                <span style="background: rgba(108, 99, 255, 0.1); color: var(--primary); padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: bold;">v1.0</span>
                <span style="background: rgba(0, 210, 106, 0.1); color: #00d26a; padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: bold;">Release</span>
                <span style="background: rgba(255, 215, 0, 0.15); color: #b8860b; padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: bold;">üá∫üáø UZ</span>
            </div>

            <p style="color: var(--text-light); font-size: 13px; line-height: 1.5; margin-bottom: 20px;">
                –õ—É—á—à–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ç–≤–æ–µ–π —É—á–µ–±—ã. –ü—Ä–µ–≤—Ä–∞—â–∞–π –≤—Ä–µ–º—è –≤ –æ–ø—ã—Ç –∏ –º–æ–Ω–µ—Ç—ã.
            </p>

            <!-- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ -->
            <div style="background: var(--bg); border-radius: 12px; padding: 15px; text-align: left; font-size: 12px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 8px;">
                    <span style="color: var(--text-light);">–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫</span>
                    <span style="font-weight: bold;">Rustam M.</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 8px;">
                    <span style="color: var(--text-light);">–†–µ–ª–∏–∑</span>
                    <span style="font-weight: bold;">–Ø–Ω–≤–∞—Ä—å 2026</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-light);">–õ–∏—Ü–µ–Ω–∑–∏—è</span>
                    <!-- –ó–¥–µ—Å—å —Å—Ç–æ–∏—Ç PRO Active, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–¥–æ–≤–∞–ª—Å—è -->
                    <span style="font-weight: bold; color: var(--primary);">PRO Active ‚úÖ</span>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div style="margin-top: 25px; display: flex; flex-direction: column; gap: 10px;">
                <button class="btn btn-primary" onclick="App.switchTab('about'); document.getElementById('about-modal').classList.remove('show')">
                    üìñ –û –Ω–∞—Å / –ú–∏—Å—Å–∏—è
                </button>
                <button class="btn btn-outline" onclick="document.getElementById('about-modal').classList.remove('show')">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
            
            <div style="margin-top: 15px; font-size: 10px; color: var(--text-light); opacity: 0.6;">
                ¬© 2026 MathBooster Product.
            </div>
            
        </div>
    </div>
</div>

<!-- LEVEL UP MODAL (–ù–æ–≤–æ–µ –∫—Ä–∞—Å–∏–≤–æ–µ –æ–∫–Ω–æ) -->
<div id="levelup-modal" class="modal" style="z-index: 10000;">
    <div class="modal-content" style="text-align: center; background: linear-gradient(135deg, #FFD700, #FFA500); color: #2B3674; border: 4px solid white; box-shadow: 0 0 50px rgba(255, 215, 0, 0.8); max-width: 320px; padding: 30px 20px;">
        
        <!-- –ò–∫–æ–Ω–∫–∞ –≤—ã–ª–µ—Ç–∞–µ—Ç —Å–≤–µ—Ä—Ö—É -->
        <div style="font-size: 80px; margin-top: -60px; margin-bottom: 10px; text-shadow: 0 5px 10px rgba(0,0,0,0.2); animation: bounce 2s infinite;">üÜô</div>
        
        <h2 style="font-weight: 900; font-size: 32px; text-transform: uppercase; margin: 0;">Level Up!</h2>
        
        <div style="font-size: 16px; font-weight: bold; margin-bottom: 20px; opacity: 0.9;">
            –ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å: <span id="lvl-up-new-level" style="font-size: 28px; color: white; text-shadow: 1px 1px 0 rgba(0,0,0,0.3);">2</span>
        </div>

        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Å –Ω–∞–≥—Ä–∞–¥–æ–π -->
        <div style="background: rgba(255,255,255,0.9); padding: 15px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
            <div style="font-size: 11px; text-transform: uppercase; color: #888; font-weight: bold; margin-bottom: 5px;">–¢–≤–æ—è –Ω–∞–≥—Ä–∞–¥–∞</div>
            <div style="font-size: 28px; font-weight: 800; color: #00d26a;">+50 üí∞</div>
        </div>

        <button class="btn" onclick="document.getElementById('levelup-modal').classList.remove('show')" style="background: #2B3674; color: white; width: 100%; font-weight: bold; box-shadow: 0 5px 15px rgba(43, 54, 116, 0.4);">
            –ö—Ä—É—Ç–æ! üöÄ
        </button>
    </div>
</div>
<!-- TERMS MODAL (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ) -->
<div id="terms-modal" class="modal">
    <div class="modal-content" style="text-align: left; padding: 0; overflow: hidden; max-height: 85vh; display: flex; flex-direction: column;">
        
        <!-- –®–∞–ø–∫–∞ -->
        <div style="background: var(--surface); padding: 20px; border-bottom: 1px solid rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 18px;">üìÑ –°–æ–≥–ª–∞—à–µ–Ω–∏–µ</h3>
            <button onclick="document.getElementById('terms-modal').classList.remove('show')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light);">√ó</button>
        </div>

        <!-- –¢–µ–∫—Å—Ç (—Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π) -->
        <div style="padding: 20px; overflow-y: auto; font-size: 13px; color: var(--text); line-height: 1.6;">
            <p style="color: var(--text-light); margin-bottom: 15px;">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –Ø–Ω–≤–∞—Ä—å 2026</p>

            <h4 style="margin-top: 15px; color: var(--primary);">1. –û–±—â–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è</h4>
            <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ MathBooster PRO. –ò—Å–ø–æ–ª—å–∑—É—è –¥–∞–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –≤—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ –¥–∞–Ω–Ω–æ–≥–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –ú–∞–Ω—Å—É—Ä–æ–≤—ã–º –†—É—Å—Ç–∞–º–æ–º (–¥–∞–ª–µ–µ ‚Äî –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫) –∏ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–æ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ª–∏—á–Ω–æ–π –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.</p>

            <h4 style="margin-top: 15px; color: var(--primary);">2. –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å</h4>
            <p>–í—Å–µ –ø—Ä–∞–≤–∞ –Ω–∞ –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥, –¥–∏–∑–∞–π–Ω, –ª–æ–≥–æ—Ç–∏–ø, –Ω–∞–∑–≤–∞–Ω–∏–µ "MathBooster", –∞ —Ç–∞–∫–∂–µ –∏–≥—Ä–æ–≤—ã–µ –º–µ—Ö–∞–Ω–∏–∫–∏ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É. <br>‚õîÔ∏è <b>–ó–∞–ø—Ä–µ—â–µ–Ω–æ:</b> –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ, –¥–µ–∫–æ–º–ø–∏–ª—è—Ü–∏—è, –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –∏–ª–∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –±–µ–∑ –ø–∏—Å—å–º–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∞. –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–µ—Å–ª–µ–¥—É–µ—Ç—Å—è –ø–æ –ó–∞–∫–æ–Ω—É –†–£–∑ ¬´–û–± –∞–≤—Ç–æ—Ä—Å–∫–æ–º –ø—Ä–∞–≤–µ¬ª.</p>

            <h4 style="margin-top: 15px; color: var(--primary);">3. –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –∏ –î–æ–Ω–∞—Ç</h4>
            <p>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ (Freeware). –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–æ–≤–µ—Ä—à–∞—Ç—å –¥–æ–±—Ä–æ–≤–æ–ª—å–Ω—ã–µ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è (–¥–æ–Ω–∞—Ç—ã) –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.</p>
            <ul>
                <li><b>–ú–æ–Ω–µ—Ç—ã (Coins)</b> ‚Äî —ç—Ç–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –∏–≥—Ä–æ–≤–∞—è –µ–¥–∏–Ω–∏—Ü–∞, –Ω–µ –∏–º–µ—é—â–∞—è —Ä–µ–∞–ª—å–Ω–æ–π –¥–µ–Ω–µ–∂–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏.</li>
                <li>–ú–æ–Ω–µ—Ç—ã –Ω–µ–ª—å–∑—è –æ–±–º–µ–Ω—è—Ç—å –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –¥–µ–Ω—å–≥–∏ (—Å—É–º—ã, –¥–æ–ª–ª–∞—Ä—ã –∏ —Ç.–¥.).</li>
                <li>–°–æ–≤–µ—Ä—à–∞—è –ø–µ—Ä–µ–≤–æ–¥ (—á–µ—Ä–µ–∑ Click, Payme, Visa), –≤—ã —Å–æ–≤–µ—Ä—à–∞–µ—Ç–µ <b>–±–µ–∑–≤–æ–∑–º–µ–∑–¥–Ω–æ–µ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–µ</b>. –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –Ω–µ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω.</li>
            </ul>

            <h4 style="margin-top: 15px; color: var(--primary);">4. –û—Ç–∫–∞–∑ –æ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏</h4>
            <p>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É "–∫–∞–∫ –µ—Å—Ç—å" (As Is). –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ –Ω–µ—Å–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ —Å–±–æ–∏ –≤ —Ä–∞–±–æ—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –ø–æ—Ç–µ—Ä—é –∏–≥—Ä–æ–≤–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏–∑-–∑–∞ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.</p>

            <h4 style="margin-top: 15px; color: var(--primary);">5. –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</h4>
            <p>–ú—ã —É–≤–∞–∂–∞–µ–º –≤–∞—à—É –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —Å–æ–±–∏—Ä–∞–µ—Ç –ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤, –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é), –∫—Ä–æ–º–µ —Ç–µ—Ö, —á—Ç–æ –≤—ã –≤–≤–æ–¥–∏—Ç–µ —Å–∞–º–∏ (–ò–º—è). –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ –≤–∞—à–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –∏ –≤ –∑–∞—â–∏—â–µ–Ω–Ω–æ–π –æ–±–ª–∞—á–Ω–æ–π –±–∞–∑–µ.</p>

            <div style="margin-top: 20px; padding: 15px; background: rgba(108, 99, 255, 0.1); border-radius: 10px; text-align: center;">
                <b>MathBooster Inc.</b><br>
                Bukhara, Uzbekistan üá∫üáø
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –≤–Ω–∏–∑—É -->
        <div style="padding: 15px; border-top: 1px solid rgba(0,0,0,0.1); background: var(--surface);">
            <button class="btn btn-primary" onclick="document.getElementById('terms-modal').classList.remove('show')">–Ø –ø–æ–Ω–∏–º–∞—é –∏ –ø—Ä–∏–Ω–∏–º–∞—é</button>
        </div>
    </div>
</div>
<div id="toast-container"></div>

<script>
/* ==========================================
   0. FX SYSTEM
   ========================================== */
const FX = {
    floatText(x, y, text, color) {
        const el = document.createElement('div'); el.className = 'float-text';
        el.style.left = x + 'px'; el.style.top = y + 'px'; el.style.color = color || '#FFD700'; el.innerText = text;
        document.body.appendChild(el); setTimeout(() => el.remove(), 1000);
    },
    confetti() {
        for(let i=0; i<30; i++) {
            const el = document.createElement('div'); el.className = 'confetti-piece';
            el.style.left = Math.random() * 100 + 'vw'; el.style.background = ['#FFD700', '#FF7675', '#6C63FF', '#00d26a'][Math.floor(Math.random()*4)];
            el.style.animationDuration = (Math.random() * 2 + 2) + 's'; document.body.appendChild(el); setTimeout(() => el.remove(), 4000);
        }
    }
};

/* ==========================================
   0. PWA & SOUND
   ========================================== */
const PWA = {
    prompt: null,
    init() {
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); this.prompt = e;
            document.getElementById('btn-install').style.display = 'block';
        });
    },
    install() {
        if(this.prompt) {
            this.prompt.prompt();
            this.prompt.userChoice.then(() => {
                document.getElementById('btn-install').style.display = 'none'; this.prompt = null;
            });
        }
    }
};

const MusicPlayer = {
    playing: false,
    audio: null,
    
    init() { 
        this.audio = document.getElementById('lofi-stream'); 
        this.audio.addEventListener('ended', () => this.reset());
        this.audio.addEventListener('error', (e) => {
            App.toast("‚ùå –û—à–∏–±–∫–∞ —Ä–∞–¥–∏–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
            this.reset();
        });
    },

    reset() {
        this.playing = false;
        const btn = document.getElementById('music-btn');
        const vis = document.getElementById('music-vis');
        if(btn) btn.innerText = "‚ñ∂";
        if(vis) vis.style.opacity = "0";
    },

    toggle() {
        if(!this.audio) this.init();
        
        const btn = document.getElementById('music-btn');
        const vis = document.getElementById('music-vis');
        
        if(this.playing) {
            this.audio.pause();
            this.reset();
        } else {
            const playPromise = this.audio.play();
            if (playPromise !== undefined) {
                btn.innerText = "‚è≥";
                playPromise.then(_ => {
                    this.playing = true;
                    btn.innerText = "‚è∏";
                    vis.style.opacity = "1";
                })
                .catch(error => {
                    console.error("Audio Play Error:", error);
                    App.toast("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å —Ä–∞–¥–∏–æ");
                    this.reset();
                });
            }
        }
    }
};

const SoundSys = {
    ctx: null, enabled: true,
    init() { try { const AudioContext = window.AudioContext || window.webkitAudioContext; this.ctx = new AudioContext(); } catch(e) {} },
    toggleSFX(val) { this.enabled = val; DB.settings.sfx = val; Data.save(); if(val) this.play('click'); },
    play(type) {
        if(!this.enabled || !this.ctx) return; if(this.ctx.state === 'suspended') this.ctx.resume();
        const t = this.ctx.currentTime; const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
        osc.connect(gain); gain.connect(this.ctx.destination);
        if(type === 'click') { osc.type = 'sine'; osc.frequency.setValueAtTime(800, t); osc.frequency.exponentialRampToValueAtTime(1200, t+0.1); gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.001, t+0.1); osc.start(t); osc.stop(t+0.1); }
        else if(type === 'coin') { osc.type = 'sine'; osc.frequency.setValueAtTime(1200, t); osc.frequency.exponentialRampToValueAtTime(1800, t+0.3); gain.gain.setValueAtTime(0.1, t); gain.gain.linearRampToValueAtTime(0, t+0.5); osc.start(t); osc.stop(t+0.5); }
        else if(type === 'success') { this.beep(523.25, t, 0.1); this.beep(659.25, t+0.1, 0.1); this.beep(783.99, t+0.2, 0.2); }
        else if(type === 'error') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, t); osc.frequency.linearRampToValueAtTime(100, t+0.3); gain.gain.setValueAtTime(0.1, t); gain.gain.linearRampToValueAtTime(0, t+0.3); osc.start(t); osc.stop(t+0.3); }
        else if(type === 'win') { this.beep(523.25, t, 0.15); this.beep(523.25, t+0.15, 0.15); this.beep(523.25, t+0.30, 0.15); this.beep(659.25, t+0.45, 0.4); }
    },
    beep(freq, time, dur) { const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain(); osc.connect(gain); gain.connect(this.ctx.destination); osc.type = 'triangle'; osc.frequency.setValueAtTime(freq, time); gain.gain.setValueAtTime(0.1, time); gain.gain.linearRampToValueAtTime(0, time+dur); osc.start(time); osc.stop(time+dur); }
};

/* ==========================================
   1. DATA & CONFIG
   ========================================= */
const GenAch = () => {
    const list = []; let id = 1; const add = (title, desc, max, icon, type, sub=null) => list.push({id: id++, title, desc, max, icon, type, sub, unlocked:false});
    add("–ü–µ—Ä–≤—ã–π —à–∞–≥", "1 –º–∏–Ω—É—Ç–∞ —É—á–µ–±—ã", 60, "üå±", "total"); add("–†–∞–∑–º–∏–Ω–∫–∞", "15 –º–∏–Ω—É—Ç", 900, "ü§∏", "total"); add("–ß–∞—Å —Å–∏–ª—ã", "1 —á–∞—Å", 3600, "üïê", "total"); add("–°–ø—Ä–∏–Ω—Ç–µ—Ä", "5 —á–∞—Å–æ–≤", 18000, "üèÉ", "total"); add("–ú–∞—Ä–∞—Ñ–æ–Ω–µ—Ü", "10 —á–∞—Å–æ–≤", 36000, "üëü", "total"); add("–°—É—Ç–∫–∏", "24 —á–∞—Å–∞", 86400, "üåô", "total"); add("–ù–µ–¥–µ–ª—è", "50 —á–∞—Å–æ–≤", 180000, "üìÜ", "total"); add("–ü—Ä–æ—Ñ–∏", "100 —á–∞—Å–æ–≤", 360000, "üéì", "total"); add("–≠–∫—Å–ø–µ—Ä—Ç", "250 —á–∞—Å–æ–≤", 900000, "üíº", "total"); add("–ì—É—Ä—É", "500 —á–∞—Å–æ–≤", 1800000, "üßò", "total"); add("–ú—É–¥—Ä–µ—Ü", "1000 —á–∞—Å–æ–≤", 3600000, "üßô‚Äç‚ôÇÔ∏è", "total"); add("–õ–µ–≥–µ–Ω–¥–∞", "2000 —á–∞—Å–æ–≤", 7200000, "üëë", "total"); add("–¢–∏—Ç–∞–Ω", "5000 —á–∞—Å–æ–≤", 18000000, "üóø", "total"); add("–í–µ—á–Ω–æ—Å—Ç—å", "10000 —á–∞—Å–æ–≤", 36000000, "‚ö°", "total");
    [2, 5, 10, 15, 20, 30, 40, 50, 75, 100].forEach(l => add(`–£—Ä–æ–≤–µ–Ω—å ${l}`, `–î–æ—Å—Ç–∏–≥–Ω–∏ ${l} —É—Ä–æ–≤–Ω—è`, l, "üÜô", "lvl"));
    add("–ù–∞—á–∞–ª–æ –ø—É—Ç–∏", "–ó–∞—Ä–∞–±–æ—Ç–∞–π 100 XP", 100, "‚≠ê", "xp"); add("–û–ø—ã—Ç–Ω—ã–π", "–ó–∞—Ä–∞–±–æ—Ç–∞–π 1000 XP", 1000, "üåü", "xp"); add("–ú–∞—à–∏–Ω–∞ XP", "–ó–∞—Ä–∞–±–æ—Ç–∞–π 10.000 XP", 10000, "ü§ñ", "xp"); add("–ú–∏–ª–ª–∏–æ–Ω–µ—Ä", "–ó–∞—Ä–∞–±–æ—Ç–∞–π 1.000.000 XP", 1000000, "üíé", "xp");
    return list;
};

const DefaultDB = { 
    user: { 
        darkMode: false,
        xp:0, level:1, nextXp:500, totalSec:0, subject:'algebra', theme:'standard', 
        avatar:'üòé', gender:'male', coins:0, streak:0, lastStudyDate:null, 
        dailyStreak:0, lastDailyClaim:null, ownedThemes:['standard'], ownedAvatars:[], 
        trainerRecord:0, usedCodes:[] 
    }, 
    settings: { sfx:true }, 

    
    // üëá –í–û–¢ –ó–î–ï–°–¨ –ú–´ –î–û–ë–ê–í–ò–õ–ò –í–°–ï –ù–û–í–´–ï –ü–†–ï–î–ú–ï–¢–´ üëá
    subjects: { 
        algebra: {name:'–ê–ª–≥–µ–±—Ä–∞', icon:'‚úñÔ∏è', sec:0}, 
        geometry: {name:'–ì–µ–æ–º–µ—Ç—Ä–∏—è', icon:'üìê', sec:0},
        calculus: {name:'–ú–∞—Ç. –∞–Ω–∞–ª–∏–∑', icon:'‚à´', sec:0},
        arithmetic: {name:'–ê—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞', icon:'üî¢', sec:0},
        combinatorics: {name:'–ö–æ–º–±–∏–Ω–∞—Ç–æ—Ä–∏–∫–∞', icon:'üîÄ', sec:0},
        statistics: {name:'–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', icon:'üìä', sec:0},
        trigonometry: {name:'–¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è', icon:'üìè', sec:0},
        stereometry: {name:'–°—Ç–µ—Ä–µ–æ–º–µ—Ç—Ä–∏—è—è', icon:'üßä', sec:0}
    }, 
    history:{}, sessions:[], achievements:[] 
};


const AVATARS = [
    {id:'lion',icon:'ü¶Å',price:50}, 
    {id:'robot',icon:'ü§ñ',price:100}, 
    {id:'alien',icon:'üëΩ',price:150}, 
    {id:'dragon',icon:'üê≤',price:300}, 
    {id:'wizard',icon:'üßô‚Äç‚ôÇÔ∏è',price:300}, 
    {id:'king',icon:'üëë',price:500}
];

const THEMES = [
    { id: 'standard', name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç', icon: 'üíú', price: 0 },
    { id: 'dark', name: '–¢–µ–º–Ω–∞—è', icon: 'üåô', price: 0 },
    { id: 'pantone', name: '–ü–µ—Ä—Å–∏–∫', icon: 'üçë', price: 100 },
    { id: 'forest', name: '–õ–µ—Å', icon: 'üå≤', price: 150 },
    { id: 'neon', name: '–ù–µ–æ–Ω', icon: 'ü¶Ñ', price: 500 },
    { id: 'math', name: '–ê–ª–º–∞–∑', icon: 'üíé', price: 600 },
    { id: 'gold', name: '–ó–æ–ª–æ—Ç–æ', icon: 'ü•á', price: 1000 },
    { id: 'magma', name: 'MAGMA', icon: 'üî•', price: 2500 }
];

const SHOP_AVATARS = [
    // üê£ –ù–ê–ß–ê–õ–¨–ù–´–ï (50 - 100)
    { id: 'cat', icon: 'üê±', name: '–ö–æ—Ç–∏–∫', price: 50 },
    { id: 'dog', icon: 'üê∂', name: '–ü–µ—Å–µ–ª—å', price: 50 },
    { id: 'girl_student', icon: 'üë©‚Äçüéì', name: '–°—Ç—É–¥–µ–Ω—Ç–∫–∞', price: 100 },
    { id: 'boy_student', icon: 'üë®‚Äçüéì', name: '–°—Ç—É–¥–µ–Ω—Ç', price: 100 },
    { id: 'gamer', icon: 'üéß', name: '–ì–µ–π–º–µ—Ä', price: 100 },
    { id: 'nerd', icon: 'ü§ì', name: '–£–º–Ω–∏–∫', price: 100 },

    // üß¢ –°–†–ï–î–ù–ò–ï / –ü–†–û–§–ï–°–°–ò–ò (150 - 250)
    { id: 'muslimah', icon: 'üßï', name: '–ú—É—Å–ª–∏–º–∞', price: 150 },
    { id: 'brother', icon: 'üßî', name: '–ë–æ—Ä–æ–¥–∞—á', price: 150 },
    { id: 'footballer', icon: '‚öΩ', name: '–§—É—Ç–±–æ–ª–∏—Å—Ç', price: 200 }, 
    { id: 'boxer', icon: 'ü•ä', name: '–ë–æ–∫—Å–µ—Ä', price: 200 },       
    { id: 'doctor_w', icon: 'üë©‚Äç‚öïÔ∏è', name: '–í—Ä–∞—á ', price: 250 },
    { id: 'doctor_m', icon: 'üë®‚Äç‚öïÔ∏è', name: '–í—Ä–∞—á ', price: 250 },
    { id: 'police', icon: 'üëÆ‚Äç‚ôÇÔ∏è', name: '–û—Ñ–∏—Ü–µ—Ä', price: 250 },
    { id: 'artist', icon: 'üë©‚Äçüé®', name: '–•—É–¥–æ–∂–Ω–∏—Ü–∞', price: 250 },

    // üî• –≠–ü–ò–ß–ï–°–ö–ò–ï (300 - 500)
    { id: 'ghost', icon: 'üëª', name: '–ü—Ä–∏–∑—Ä–∞–∫', price: 300 },
    { id: 'superman', icon: 'ü¶∏‚Äç‚ôÇÔ∏è', name: '–°—É–ø–µ—Ä–º–µ–Ω', price: 350 },
    { id: 'supergirl', icon: 'ü¶∏‚Äç‚ôÄÔ∏è', name: '–°—É–ø–µ—Ä–≥—ë—Ä–ª', price: 350 },
    { id: 'wizard', icon: 'üßô‚Äç‚ôÇÔ∏è', name: '–í–æ–ª—à–µ–±–Ω–∏–∫', price: 400 },
    { id: 'fairy', icon: 'üßö‚Äç‚ôÄÔ∏è', name: '–§–µ—è', price: 400 },
    { id: 'vampire_m', icon: 'üßõ‚Äç‚ôÇÔ∏è', name: '–í–∞–º–ø–∏—Ä', price: 450 },
    { id: 'vampire_w', icon: 'üßõ‚Äç‚ôÄÔ∏è', name: '–í–∞–º–ø–∏—Ä—à–∞', price: 450 },
    { id: 'astronaut', icon: 'üë®‚ÄçüöÄ', name: '–ö–æ—Å–º–æ–Ω–∞–≤—Ç', price: 500 },
    { id: 'dragon', icon: 'üê≤', name: '–î—Ä–∞–∫–æ–Ω', price: 500 },

    // üíé –≠–õ–ò–¢–ê (600+)
    { id: 'king', icon: 'üëë', name: '–ö–æ—Ä–æ–ª—å', price: 600 },
    { id: 'queen', icon: 'üë∏', name: '–ö–æ—Ä–æ–ª–µ–≤–∞', price: 600 },
    { id: 'genie', icon: 'üßû‚Äç‚ôÇÔ∏è', name: '–î–∂–∏–Ω–Ω', price: 800 },
    { id: 'lion', icon: 'ü¶Å', name: '–õ–µ–≤', price: 1000 },
    { id: 'wolf', icon: 'üê∫', name: '–í–æ–ª–∫', price: 1000 },
    { id: 'diamond', icon: 'üíé', name: '–ú–∞–≥–Ω–∞—Ç', price: 2000 }
];

// –õ–ò–ì–ò 
const LEAGUES = [
    { min: 0, name: "ü•â –ë—Ä–æ–Ω–∑–æ–≤–∞—è –õ–∏–≥–∞", color: "league-bronze" },
    { min: 1000, name: "ü•à –°–µ—Ä–µ–±—Ä—è–Ω–∞—è –õ–∏–≥–∞", color: "league-silver" },
    { min: 5000, name: "ü•á –ó–æ–ª–æ—Ç–∞—è –õ–∏–≥–∞", color: "league-gold" },
    { min: 12000, name: "üí† –ü–ª–∞—Ç–∏–Ω–æ–≤–∞—è –õ–∏–≥–∞", color: "league-platinum" },
    { min: 25000, name: "üíé –ê–ª–º–∞–∑–Ω–∞—è –õ–∏–≥–∞", color: "league-diamond" },
    { min: 60000, name: "üëë –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è –õ–∏–≥–∞", color: "league-legend" }
];

const NameGuard = {
    // –°–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö –∫–æ—Ä–Ω–µ–π (RU, UZ, EN)
    // –ú—ã –∏—â–µ–º "–∫–æ—Ä–Ω–∏", —á—Ç–æ–±—ã –ø–æ–π–º–∞—Ç—å —Å–ª–æ–≤–∞ —Ç–∏–ø–∞ "—Å—É–∫@", "—Å—É—É—É–∫–∞" –∏ —Ç.–¥.
    blacklist: [
        // üá∑üá∫ RU
        '—Ö—É–π', '—Ö —É –π', '–ø–∏–∑–¥', '–µ–±–∞–ª', '–µ–±–ª–∞–Ω', '–º—É–¥–∞–∫', '–≥–∞–Ω–¥', '—à–ª—é—Ö', '–±–ª—è', '—Å—É–∫–∞', '—Å —É –∫ –∞', '–∂–æ–ø–∞', '—Ç—Ä–∞—Ö',
        // üá∫üáø UZ
        'qotoq', 'qo\'toq', 'sik', 's i k', 'jalab', 'j a l a b', 'om', 'gandon', 'kotag', 'k o t a g', 'am',
        // üá∫üá∏ EN
        'fuck', 'shit', 'bitch', 'whore', 'dick', 'cock', 'pussy'
    ],

    check(name) {
        // 1. –ü—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
        const lower = name.toLowerCase();
        
        // 2. –°–æ–∑–¥–∞–µ–º "—á–∏—Å—Ç—É—é" –≤–µ—Ä—Å–∏—é –±–µ–∑ —Å–∏–º–≤–æ–ª–æ–≤ –∏ –ø—Ä–æ–±–µ–ª–æ–≤
        // (—á—Ç–æ–±—ã –ø–æ–π–º–∞—Ç—å "—Å.—É.–∫.–∞" –∏–ª–∏ "—Ö-—É-–π")
        const clean = lower.replace(/[^a-z–∞-—è0-9]/g, '');

        // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ø–∏—Å–æ–∫
        for (let badWord of this.blacklist) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –ª–∏ –ø–ª–æ—Ö–æ–µ —Å–ª–æ–≤–æ –≤–Ω—É—Ç—Ä–∏ –∏–º–µ–Ω–∏
            if (lower.includes(badWord) || clean.includes(badWord)) {
                return false; // –ò–º—è –ü–õ–û–•–û–ï
            }
        }
        return true; // –ò–º—è –•–û–†–û–®–ï–ï
    }
};

let DB = null; 
const Data = {
    currentKey: null,
    initNewData(userId) { const newDB = JSON.parse(JSON.stringify(DefaultDB)); newDB.achievements = GenAch(); localStorage.setItem('MathData_' + userId, JSON.stringify(newDB)); },
    load(userId) { 
        this.currentKey = 'MathData_' + userId; const raw = localStorage.getItem(this.currentKey); 
        if (raw) { 
            const loaded = JSON.parse(raw);
            if(loaded.user) { 
                DB = loaded; 
                if (!DB.user.trainerRecords) {const oldRec = DB.user.trainerRecord || 0;
                    DB.user.trainerRecords = { easy: oldRec, medium: 0, hard: 0 };
                }
                if(DB.user.coins === undefined) DB.user.coins = 0;
                if(DB.user.gender === undefined) DB.user.gender = 'male';
                if(DB.user.dob === undefined) DB.user.dob = '';
                if(DB.user.ownedAvatars === undefined) DB.user.ownedAvatars = [];
                if(DB.user.avatar === null && Auth.currentUser) DB.user.avatar = Auth.currentUser.avatar;
                if(DB.settings.sfx === undefined) DB.settings.sfx = true;
                if(DB.user.dailyStreak === undefined) { DB.user.dailyStreak = 0; DB.user.lastDailyClaim = null; }
                if(DB.sessions === undefined) DB.sessions = []; 
                if(DB.user.usedCodes === undefined) DB.user.usedCodes = [];
                
                // Cloud Sync
                if(window.DB_Online) {
                    this.syncWithCloud(userId);
                }
            } else { this.initNewData(userId); DB = JSON.parse(localStorage.getItem(this.currentKey)); }
            
        } else { this.initNewData(userId); DB = JSON.parse(localStorage.getItem(this.currentKey)); } 
    },
    async syncWithCloud(userId) {
        try {
            const docRef = window.DB_Online.doc(window.DB_Online.db, "users", userId);
            const docSnap = await window.DB_Online.getDoc(docRef);
            if(docSnap.exists()) {
                const cloudData = docSnap.data();
                // Basic conflict resolution: take cloud if more playtime
                if(cloudData.user.totalSec > DB.user.totalSec) {
                    DB = cloudData;
                    this.save();
                }
            }
        } catch(e) {}
    },
        save() {
        if (this.currentKey && DB) localStorage.setItem(this.currentKey, JSON.stringify(DB));
        
        // –û–±–ª–∞—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è ‚Äî —Ç–µ–ø–µ—Ä—å —Å –∏–º–µ–Ω–µ–º!
        if (window.DB_Online && Auth.currentUser) {
            const docRef = window.DB_Online.doc(window.DB_Online.db, "users", Auth.currentUser.id);
            
            // –Ø–≤–Ω–æ –±–µ—Ä—ë–º –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –∏–º—è –∏–∑ Auth
            const currentName = Auth.currentUser.name || DB.user.name || "–ò–≥—Ä–æ–∫";

            window.DB_Online.setDoc(docRef, {
                user: {
                    ...DB.user,
                    name: currentName,  // ‚Üê‚Üê‚Üê –≤—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –∏–º—è
                    avatar: DB.user.avatar || "üòé",
                    level: DB.user.level || 1,
                    xp: DB.user.xp || 0
                },
                subjects: DB.subjects,
                history: DB.history,
                sessions: DB.sessions
            }, { merge: true }).catch(e => console.log(e));
        }
    },
    export() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(DB)); const node = document.createElement('a'); node.setAttribute("href", dataStr); node.setAttribute("download", `${Auth.currentUser.name}_MathData.json`); document.body.appendChild(node); node.click(); node.remove(); },
    import(el) { const fr = new FileReader(); fr.onload = (e) => { try { DB = JSON.parse(e.target.result); this.save(); location.reload(); } catch(x) { alert("–û—à–∏–±–∫–∞ —Ñ–∞–π–ª–∞"); } }; fr.readAsText(el.files[0]); }
};

const Sync = {
    autoSync: false,

    init() {
        const saved = localStorage.getItem('autoSync');
        if (saved === 'true') {
            this.autoSync = true;
            document.getElementById('sync-status').innerText = '–í–∫–ª';
        }
    },

    toggleAuto() {
        this.autoSync = !this.autoSync;
        localStorage.setItem('autoSync', this.autoSync);
        document.getElementById('sync-status').innerText = this.autoSync ? '–í–∫–ª' : '–í—ã–∫–ª';
        App.toast(this.autoSync ? "‚òÅÔ∏è –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞" : "‚òÅÔ∏è –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞");
        
        if (this.autoSync && window.DB_Online && Auth.currentUser) {
            Data.save(); // —Å—Ä–∞–∑—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º
        }
    }
};

// --- WHITEBOARD & CALC ---
const Whiteboard = {
    canvas: null, ctx: null, isDrawing: false,
    init() {
        this.canvas = document.getElementById('wb-canvas'); this.ctx = this.canvas.getContext('2d'); this.resize();
        const h = (e) => { e.preventDefault(); this.start(e.touches?e.touches[0]:e); };
        const m = (e) => { e.preventDefault(); this.draw(e.touches?e.touches[0]:e); };
        const e = () => this.stop();
        this.canvas.onmousedown = h; this.canvas.onmousemove = m; this.canvas.onmouseup = e; this.canvas.onmouseout = e;
        this.canvas.ontouchstart = h; this.canvas.ontouchmove = m; this.canvas.ontouchend = e;
    },
    open() { document.getElementById('wb-modal').classList.add('show'); this.resize(); },
    close() { document.getElementById('wb-modal').classList.remove('show'); },
    resize() { const p = this.canvas.parentElement; this.canvas.width = p.clientWidth; this.canvas.height = 350; this.ctx.lineCap = 'round'; this.ctx.lineWidth = 3; this.ctx.strokeStyle = '#2B3674'; },
    start(e) { this.isDrawing = true; this.ctx.beginPath(); const r = this.canvas.getBoundingClientRect(); this.ctx.moveTo(e.clientX - r.left, e.clientY - r.top); },
    draw(e) { if(!this.isDrawing) return; const r = this.canvas.getBoundingClientRect(); this.ctx.lineTo(e.clientX - r.left, e.clientY - r.top); this.ctx.stroke(); },
    stop() { this.isDrawing = false; },
    clear() { this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height); },
    toggle() { this.open(); SoundSys.play('click'); }
};

const Calc = { 
    current: '', 
    toggle() { document.getElementById('calc-modal').classList.toggle('show'); this.clear(); SoundSys.play('click'); }, 
    append(val) { if(this.current.length>15)return; this.current+=val; this.update(); SoundSys.play('click'); }, 
    clear() { this.current=''; this.update(); }, 
    solve() { 
        try { 
            // Simple security check (SAFE EVAL)
            if(/^[0-9+\-*/.() ]*$/.test(this.current)) {
                this.current=new Function('return ' + this.current)().toString();
            } else {
                this.current='Error';
            }
        } catch { this.current='Error'; } 
        this.update(); SoundSys.play('success'); 
    }, 
    update() { document.getElementById('calc-display').innerText=this.current||'0'; } 
};

// --- SUBJECT SYSTEM ---
const SubjectSys = {
    render() {
        const list = document.getElementById('settings-subject-list'); if(!list) return;
        list.innerHTML = Object.keys(DB.subjects).map(key => { const s = DB.subjects[key]; return `<div class="subject-manage-row"><div class="subject-manage-info"><span style="font-size:20px;">${s.icon}</span> ${s.name}</div><button class="btn-delete" onclick="SubjectSys.delete('${key}')">‚úï</button></div>`; }).join('');
    },
    addPreset(icon, name) {
        const id = 'subj_' + Date.now(); 
        DB.subjects[id] = { name: name, icon: icon, sec: 0 };
        Data.save(); this.render(); App.renderSubjects(); App.toast(name + " –¥–æ–±–∞–≤–ª–µ–Ω!");
    },
    delete(key) {
        if(Object.keys(DB.subjects).length <= 1) return App.toast("–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–µ–¥–º–µ—Ç!");
        if(!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–µ–¥–º–µ—Ç?")) return;
        delete DB.subjects[key]; if(DB.user.subject === key) { DB.user.subject = Object.keys(DB.subjects)[0]; }
        Data.save(); this.render(); App.renderSubjects(); App.updateUI(); App.toast("–ü—Ä–µ–¥–º–µ—Ç —É–¥–∞–ª–µ–Ω");
    }
};

// --- DAILY REWARD SYSTEM ---
const DailySys = {
    rewards: [10, 20, 30, 40, 50, 75, 100],
    check() {
        const today = new Date().toISOString().split('T')[0]; const last = DB.user.lastDailyClaim;
        if (last !== today) { if (last) { const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); const yesterdayStr = yesterday.toISOString().split('T')[0]; if (last !== yesterdayStr) DB.user.dailyStreak = 0; } this.showModal(); }
    },
    showModal() {
        const modal = document.getElementById('daily-modal'); const grid = document.getElementById('daily-grid'); const currentDayIndex = DB.user.dailyStreak % 7;
        grid.innerHTML = this.rewards.map((r, i) => { let cls = 'daily-day'; if (i < currentDayIndex) cls += ' claimed'; if (i === currentDayIndex) cls += ' active'; return `<div class="${cls}"><div class="daily-coin">üí∞</div><div>${r}</div></div>`; }).join('');
        document.getElementById('daily-reward-amount').innerText = this.rewards[currentDayIndex]; modal.classList.add('show'); FX.confetti(); SoundSys.play('win');
    },
    claim() {
        const currentDayIndex = DB.user.dailyStreak % 7; const reward = this.rewards[currentDayIndex];
        DB.user.coins += reward; DB.user.dailyStreak++; DB.user.lastDailyClaim = new Date().toISOString().split('T')[0];
        if (currentDayIndex === 6) { App.addXP(500); App.toast("üéâ –ù–µ–¥–µ–ª—è –ø—Ä–æ–π–¥–µ–Ω–∞! +500 XP"); FX.confetti(); }
        Data.save(); App.updateUI(); document.getElementById('daily-modal').classList.remove('show'); SoundSys.play('coin'); App.toast(`–ü–æ–ª—É—á–µ–Ω–æ: ${reward} –º–æ–Ω–µ—Ç!`);
    }
};

// --- DONATION & ONLINE ---
const Donation = {
    // –í–°–¢–ê–í–¨ –°–Æ–î–ê –ù–û–ú–ï–†–ê –ö–ê–†–¢
    uzCard: "9860 1901 0789 6911 (Rustam M.)", 
    worldCard: "4916 9903 0189 0056 (Rustam M.)",
    
    payUz() { 
        // –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –ø–æ–∫–∞–∂–µ—Ç –æ–∫–Ω–æ —Å –Ω–æ–º–µ—Ä–æ–º –∫–∞—Ä—Ç—ã, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
        prompt("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ (Payme/Click):", this.uzCard);
        alert("–ü–æ—Å–ª–µ –ø–µ—Ä–µ–≤–æ–¥–∞ —Å–∫–∏–Ω—å —Å–∫—Ä–∏–Ω—à–æ—Ç –º–Ω–µ –≤ —Ç–≥ @rustambey708, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥!");
    },
    payWorld() { 
        prompt("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ (Visa):", this.worldCard);
        alert("–ü–æ—Å–ª–µ –ø–µ—Ä–µ–≤–æ–¥–∞ —Å–∫–∏–Ω—å —Å–∫—Ä–∏–Ω—à–æ—Ç –º–Ω–µ –≤ —Ç–≥ @rustambey708, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥!");
    },
    enterCode() {
        const c = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥:"); if(!c) return;
        const code = c.trim().toUpperCase();
        if(DB.user.usedCodes && DB.user.usedCodes.includes(code)) return App.toast("–≠—Ç–æ—Ç –∫–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω!");
        
        const rewards = { 
            "START":{c:100,msg:"–ë–æ–Ω—É—Å –Ω–æ–≤–∏—á–∫–∞!"}, 
            "HUMO":{c:5000,msg:"–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏–∑ –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω–∞! üá∫üáø"}, 
            "VISA":{c:5000,msg:"Thanks for support! üåç"},
            "ADMIN_708":{c:10000,msg:"JACKPOT!!! "} 
        };
        
        if(rewards[code]) {
            DB.user.coins += rewards[code].c;
            if(!DB.user.usedCodes) DB.user.usedCodes = [];
            DB.user.usedCodes.push(code);
            Data.save(); App.updateUI(); FX.confetti(); SoundSys.play('win'); 
            alert(`‚úÖ –ö–û–î –ü–†–ò–ù–Ø–¢!\n\n${rewards[code].msg}\n–ù–∞—á–∏—Å–ª–µ–Ω–æ: ${rewards[code].c} –º–æ–Ω–µ—Ç`);
        } else { 
            SoundSys.play('error');
            App.toast("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥"); 
        }
    }
};

const Online = {
    async loadLeaderboard() {
    if (!window.DB_Online) {
        App.toast("‚ö†Ô∏è –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –æ–Ω–ª–∞–π–Ω-–±–∞–∑–µ");
        return;
    }

    const list = document.getElementById('leaderboard-list');
    const countEl = document.getElementById('total-players-count');
    list.innerHTML = '<div style="text-align:center; color:var(--text-light);">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

    try {
        const q = window.DB_Online.query(
            window.DB_Online.collection(window.DB_Online.db, "users"),
            window.DB_Online.orderBy("user.totalSec", "desc"),  // ‚Üê –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (—Å–µ–∫—É–Ω–¥–∞–º)
            window.DB_Online.limit(200)
        );

        const snap = await window.DB_Online.getDocs(q);
        countEl.innerText = `–í—Å–µ–≥–æ –∏–≥—Ä–æ–∫–æ–≤ –≤ –±–∞–∑–µ: ${snap.size}`;

        if (snap.empty) {
            list.innerHTML = '<div style="text-align:center; color:var(--text-light);">–¢–æ–ø –ø—É—Å—Ç üòî</div>';
            return;
        }

        list.innerHTML = '';
        let rank = 1;
        snap.forEach(doc => {
            const data = doc.data();
            const u = data.user || {};
            const name = u.name || "–ò–≥—Ä–æ–∫";
            const totalSec = u.totalSec || 0;
            const hours = Math.floor(totalSec / 3600);
            const minutes = Math.floor((totalSec % 3600) / 60);
            const level = u.level || 1;
            const xp = u.xp || 0;
            const avatar = u.avatar || "üòé";

            const timeStr = `${hours} —á ${minutes} –º–∏–Ω`;

            const item = document.createElement('div');
            item.className = 'user-list-item';
            item.style.justifyContent = 'space-between';
            item.innerHTML = `
                <div style="display:flex; align-items:center; gap:15px;">
                    <div style="font-size:24px;">${avatar}</div>
                    <div>
                        <b>#${rank} ${name}</b><br>
                        <small>–£—Ä–æ–≤–µ–Ω—å ${level} ‚Ä¢ ${xp.toLocaleString()} XP</small>
                    </div>
                </div>
                <b style="color:var(--primary); font-size:18px;">${timeStr}</b>
            `;
            list.appendChild(item);
            rank++;
        });

        App.toast("üèÜ –¢–æ–ø –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —É—á—ë–±—ã –æ–±–Ω–æ–≤–ª—ë–Ω!");
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞:", e);
        list.innerHTML = '<div style="text-align:center; color:red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ üòî</div>';
        App.toast("‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º");
    }
}
};

/* ==========================================
   APP CORE
   ========================================== */
const Auth = {
    users: [], currentUser: null,
    avatars: ['üòé', 'üë©‚Äçüéì', 'üë®‚Äçüéì', 'üë±‚Äç‚ôÄÔ∏è', 'üë®', 'üßï', 'üßî', 'üê±', 'ü¶ä', '‚öΩ'],
    init() { 
        const stored = localStorage.getItem('MathUsers'); 
        if (stored) {
            try {
                let rawUsers = JSON.parse(stored);
                // üî• –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–®–ò–ë–ö–ò:
                // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–ø–∏—Å–æ–∫: –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ—Ö, —É –∫–æ–≥–æ –µ—Å—Ç—å ID –∏ –ò–º—è
                this.users = rawUsers.filter(u => u && u.id && u.name);
                
                // –ï—Å–ª–∏ –Ω–∞—à–ª–∏—Å—å "–±–∏—Ç—ã–µ" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —á–∏—Å—Ç—ã–π —Å–ø–∏—Å–æ–∫
                if (this.users.length !== rawUsers.length) {
                    console.log("–£–¥–∞–ª–µ–Ω—ã –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏");
                    localStorage.setItem('MathUsers', JSON.stringify(this.users));
                }
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", e);
                this.users = [];
            }
        } 
        
        this.renderUserList(); 
        this.renderAvatars(); 
        SoundSys.init(); 
        Whiteboard.init(); 
        PWA.init(); 
        MusicPlayer.init(); 
    },

    renderUserList() { 
        const list = document.getElementById('user-list'); 
        if (!list) return; // –ó–∞—â–∏—Ç–∞ –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–µ—Ç

        list.innerHTML = ''; 
        if (this.users.length === 0) { 
            list.innerHTML = '<div style="text-align:center; color:var(--text-light); padding:20px;">–ù–µ—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π!</div>'; 
            return; 
        } 
        
        this.users.forEach(u => { 
            // üî• –ó–ê–©–ò–¢–ê –û–¢ –û–®–ò–ë–ö–ò SUBSTR:
            // –ï—Å–ª–∏ –≤–¥—Ä—É–≥ ID –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É, —á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–ª–æ
            const safeID = u.id ? u.id.toString().substr(0,8) : 'ERROR';

            const div = document.createElement('div'); 
            div.className = 'user-list-item'; 
            
            const infoDiv = document.createElement('div');
            infoDiv.style.cssText = "display:flex; align-items:center; gap:15px; flex-grow:1;";
            infoDiv.innerHTML = `<div class="user-avatar">${u.avatar}</div><div><div style="font-weight:bold">${u.name}</div><div style="font-size:12px; color:var(--text-light)">ID: ${safeID}...</div></div>`;
            infoDiv.onclick = () => this.login(u.id);

            const delBtn = document.createElement('button');
            delBtn.className = 'delete-user-btn';
            delBtn.innerHTML = '‚úï';
            delBtn.onclick = (e) => this.deleteUser(u.id, e);

            div.appendChild(infoDiv);
            div.appendChild(delBtn);
            list.appendChild(div); 
        }); 
    },

    deleteUser(id, event) {
        event.stopPropagation();
        if(!confirm("–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ—Ñ–∏–ª—å? –û–Ω –ø—Ä–æ–ø–∞–¥–µ—Ç —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –∏–∑ –¢–æ–ø–∞!")) return;
        
        this.users = this.users.filter(u => u.id !== id);
        localStorage.setItem('MathUsers', JSON.stringify(this.users));
        localStorage.removeItem('MathData_' + id);
        
        if (window.DB_Online) {
            const docRef = window.DB_Online.doc(window.DB_Online.db, "users", id);
            window.DB_Online.deleteDoc(docRef).catch(err => console.error(err));
        }
        
        this.renderUserList();
        App.toast("üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ");
    },

    renderAvatars() { 
        const el = document.getElementById('avatar-selector');
        if(el) el.innerHTML = this.avatars.map(a => 
            `<div class="avatar-option ${a===this.selectedAvatar?'selected':''}" onclick="Auth.selectAvatar('${a}')">${a}</div>`
        ).join(''); 
    },

    selectAvatar(a) { 
        this.selectedAvatar = a; 
        this.renderAvatars(); 
        SoundSys.play('click'); 
    },

    setGender(g) {
        this.selectedGender = g;
        document.querySelectorAll('.gender-btn').forEach(b => b.classList.remove('active'));
        const btns = document.querySelectorAll('.gender-btn');
        if(btns.length > 1) btns[g==='male'?0:1].classList.add('active');
    },

    showRegister() { 
        document.getElementById('login-view').style.display = 'none'; 
        document.getElementById('register-view').style.display = 'block'; 
        SoundSys.play('click'); 
    },

    showLogin() { 
        document.getElementById('login-view').style.display = 'block'; 
        document.getElementById('register-view').style.display = 'none'; 
        SoundSys.play('click'); 
    },

    createAccount() {
        // 1. –ü–†–û–í–ï–†–ö–ê –õ–ò–ú–ò–¢–ê (–ú–∞–∫—Å–∏–º—É–º 3 –∞–∫–∫–∞—É–Ω—Ç–∞)
        const MAX_ACCOUNTS = 2;
        
        if (this.users.length >= MAX_ACCOUNTS) {
            App.toast(`‚õî –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç: ${MAX_ACCOUNTS} –ø—Ä–æ—Ñ–∏–ª—è!`);
            alert(`–ù–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ —É–∂–µ —Å–æ–∑–¥–∞–Ω–æ ${MAX_ACCOUNTS} –ø—Ä–æ—Ñ–∏–ª—è.\n\n–ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π, —É–¥–∞–ª–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ —Å—Ç–∞—Ä—ã—Ö (–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫—Ä–µ—Å—Ç–∏–∫ ‚úï –≤ —Å–ø–∏—Å–∫–µ).`);
            return; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ
        }

        const inputField = document.getElementById('reg-name');
        const name = inputField.value.trim();
        
        // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–µ –∏–º—è
        if (!name) return App.toast('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –∏–º—è!');
        // 3. --- üõ°Ô∏è –ó–ê–©–ò–¢–ê –û–¢ –ú–ê–¢–ê ---
        if (!NameGuard.check(name)) {
            alert("‚õîÔ∏è –≠—Ç–æ –∏–º—è –∑–∞–ø—Ä–µ—â–µ–Ω–æ –ø–æ–ª–∏—Ç–∏–∫–æ–π —Å–æ–æ–±—â–µ—Å—Ç–≤–∞.\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–µ–∂–ª–∏–≤—ã–π –Ω–∏–∫–Ω–µ–π–º.");
            return;
        }
        // -------------------------
        // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã –∏–º–µ–Ω–∏ 
        if (name.length > 12) return App.toast('‚ö†Ô∏è –ò–º—è —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å 12)');

        // 5. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const user = {
            id: 'u' + Date.now(),
            name: name,
            avatar: this.selectedAvatar,
            gender: this.selectedGender
        };

        this.users.push(user);
        localStorage.setItem('MathUsers', JSON.stringify(this.users));

        // –°—Ä–∞–∑—É —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –≤ –æ–±–ª–∞—á–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
        Data.load(user.id);
        if(DB && DB.user) {
            DB.user.name = name;
            DB.user.avatar = this.selectedAvatar;
            Data.save();
        }

        this.login(user.id);
    },
    login(id) { 
        const user = this.users.find(u => u.id === id); 
        if (!user) return; 
        this.currentUser = user; 
        Data.load(user.id); 
        
        if(DB && DB.user) {
            DB.user.name = user.name;
            DB.user.avatar = user.avatar;
            Data.save();
        }
        
        document.getElementById('auth-screen').classList.add('hidden'); 
        document.getElementById('app-container').style.display = 'block'; 
        
        App.setText('header-avatar', user.avatar);
        App.setText('header-name', user.name);
        App.setText('profile-avatar-big', user.avatar);
        App.setText('profile-name-big', user.name);
        
        SoundSys.play('success'); 
        App.initAfterLogin();
        DailySys.check(); 
    },

    logout() { 
        if(confirm("–í—ã–π—Ç–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è?")) { 
            Timer.stop(false); 
            location.reload(); 
        } 
    },

    resetData() {
        if(confirm("–í–´ –£–í–ï–†–ï–ù–´? –í—Å—ë –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ –Ω–∞–≤—Å–µ–≥–¥–∞!")) {
            Data.initNewData(this.currentUser.id);
            alert("–î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã.");
            location.reload();
        }
    }
};

const Timer = {
    timerId: null,          // ‚Üê –î–æ–±–∞–≤–∏–ª–∏ –ø–æ–ª–µ –¥–ª—è setTimeout
    sec: 0,
    active: false,
    lastActive: 0,
    sessionDuration: 0,
    sessionCoins: 0,
    maxSessionTime: 30 * 60,
    maxIdleTime: 15 * 60 * 1000,
    wakeLock: null,
    useWakeLock: localStorage.getItem('useWakeLock') !== 'false', // ‚Üê –ß–∏—Ç–∞–µ–º –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é true)

    async requestWakeLock() {
        if (!this.useWakeLock) return; // ‚Üê –ü—Ä–æ–≤–µ—Ä–∫–∞ ‚Äî –µ—Å–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω–æ, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        try {
            if ('wakeLock' in navigator) {
                this.wakeLock = await navigator.wakeLock.request('screen');
            }
        } catch (err) {}
    },

    releaseWakeLock() {
        if (this.wakeLock) {
            this.wakeLock.release();
            this.wakeLock = null;
        }
    },

    toggleWakeLock(enabled) {
        this.useWakeLock = enabled;
        localStorage.setItem('useWakeLock', enabled ? 'true' : 'false');
        App.toast(enabled 
            ? "–≠–∫—Ä–∞–Ω –±—É–¥–µ—Ç –≥–æ—Ä–µ—Ç—å –≤–æ –≤—Ä–µ–º—è —É—á—ë–±—ã" 
            : "–≠–∫–æ–Ω–æ–º–∏–º –±–∞—Ç–∞—Ä–µ—é ‚Äî —ç–∫—Ä–∞–Ω –º–æ–∂–µ—Ç –≥–∞—Å–Ω—É—Ç—å");
    },

    preStart() {
        if (this.active) return;
        this.start();
    },

    start() {
        this.active = true; 
        this.lastActive = Date.now(); 
        this.sessionDuration = 0; 
        this.sessionCoins = 0; 
        SoundSys.play('click');
        this.requestWakeLock();
        
        // –°–ª—É—à–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, —á—Ç–æ–±—ã –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª –∞–Ω—Ç–∏-–∞—Ñ–∫
        window.onmousemove = window.onkeypress = () => { this.lastActive = Date.now(); };

        // –ó–ê–ü–£–°–ö –¢–ê–ô–ú–ï–†–ê
        this.ref = setInterval(() => {
            const now = Date.now();
            
            // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ —É—à–µ–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (15 –º–∏–Ω –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è)
            if (now - this.lastActive > this.maxIdleTime) { 
                this.forcePause("üõë –¢–∞–π–º–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ 15 –º–∏–Ω—É—Ç."); 
                return; 
            }
            
            // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞: —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–∞—è —Å–µ—Å—Å–∏—è (30 –º–∏–Ω)
            if (this.sessionDuration >= this.maxSessionTime) { 
                this.forcePause("üëÆ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é! –†–µ—à–∏—Ç–µ –ø—Ä–∏–º–µ—Ä."); 
                MathGame.show(true); 
                return; 
            }

            // 3. –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –≤—Ä–µ–º–µ–Ω–∏
            this.sec++; 
            this.sessionDuration++; 
            DB.user.totalSec++; 
            
            // –ë–µ–∑–æ–ø–∞—Å–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤—Ä–µ–º—è –ø—Ä–µ–¥–º–µ—Ç–∞
            if (DB.subjects && DB.subjects[DB.user.subject]) {
                DB.subjects[DB.user.subject].sec++;
            }

            // === 4. –û–ë–ù–û–í–õ–ï–ù–ò–ï –≠–ö–†–ê–ù–ê (–û–±—ã—á–Ω—ã–π + –≠–∫–æ —Ä–µ–∂–∏–º) ===
            const timeString = new Date(this.sec * 1000).toISOString().substr(11, 8);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—ã—á–Ω—ã–π —Ç–∞–π–º–µ—Ä
            const timerEl = document.getElementById('timer');
            if(timerEl) timerEl.innerText = timeString;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —á–µ—Ä–Ω—ã–π –≠–∫–æ-—ç–∫—Ä–∞–Ω
            const ecoEl = document.getElementById('eco-timer-display');
            if(ecoEl) ecoEl.innerText = timeString;
            // =================================================

            // 5. –ù–∞–≥—Ä–∞–¥–∞ –º–æ–Ω–µ—Ç–∫–∞–º–∏ (–∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç = 600 —Å–µ–∫)
            if(this.sec % 600 === 0) { 
                DB.user.coins++; 
                this.sessionCoins++; 
                SoundSys.play('coin'); 
                
                // –ê–Ω–∏–º–∞—Ü–∏—è –º–æ–Ω–µ—Ç–∫–∏
                const coinEl = document.getElementById('coin-display'); 
                if(coinEl) {
                    const rect = coinEl.getBoundingClientRect(); 
                    FX.floatText(rect.left, rect.top, "+1 üí∞"); 
                }
                
                Data.save(); 
                App.updateUI(); 
            } 

            // 6. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É)
            if(this.sec % 60 === 0) { 
                Data.save(); 

                AchievementSys.check(); 
            }

        }, 1000); // –ò–Ω—Ç–µ—Ä–≤–∞–ª 1 —Å–µ–∫—É–Ω–¥–∞
        
        // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É –∏ —Ü–≤–µ—Ç —Ç–∞–π–º–µ—Ä–∞
        document.getElementById('btn-start').innerText = "üî• –ò–î–ï–¢..."; 
        document.getElementById('timer').style.color = "var(--primary)";
    },

    forcePause(reason) {
        this.stop(false);
        App.toast(reason);
    },

    stop(manual = true) {
        // 1. –ï—Å–ª–∏ —Ç–∞–π–º–µ—Ä —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –≤—ã—Ö–æ–¥–∏–º
        if (!this.active) {
            return;
        }

        // 2. –û–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –¢–ê–ô–ú–ï–† (—Å–∞–º–∞—è –≤–∞–∂–Ω–∞—è —á–∞—Å—Ç—å)
        if (this.ref) {
            clearInterval(this.ref);
            this.ref = null; // –û—á–∏—â–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –Ω–µ–≥–æ
        }

        // 3. –ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ "–Ω–µ–∞–∫—Ç–∏–≤–µ–Ω"
        this.active = false;
        
        // –û—Ç–∫–ª—é—á–∞–µ–º –≤—Å–µ "—Å–ª—É—à–∞—Ç–µ–ª–∏"
        window.onmousemove = window.onkeypress = null;
        this.releaseWakeLock();
        SoundSys.play('click');

        // 4. –ï—Å–ª–∏ —Ç–∞–π–º–µ—Ä —Ä–∞–±–æ—Ç–∞–ª –±–æ–ª—å—à–µ –º–∏–Ω—É—Ç—ã, –Ω–∞—á–∏—Å–ª—è–µ–º XP –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ü–µ–ª–∏
        if (manual && this.sec > 60) {
            App.addXP(Math.floor(this.sec / 60) * 10);
            
            const goal = document.getElementById('session-goal').value.trim();
            if (goal && confirm(`–í—ã –≤—ã–ø–æ–ª–Ω–∏–ª–∏ —Ü–µ–ª—å: "${goal}"?`)) {
                App.addXP(50);
                App.toast("üéØ –¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞! +50 XP");
                SoundSys.play('win');
            }
            document.getElementById('session-goal').value = "";
        }
        
        // 5. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ —Å—Ç—Ä–∏–∫–∏
        const k = new Date().toISOString().split('T')[0]; 
        DB.history[k] = (DB.history[k] || 0) + this.sec; 
        
        if (this.sessionDuration > 5) { 
            const log = { date: new Date().toISOString(), subject: DB.subjects[DB.user.subject]?.name || '–ü—Ä–µ–¥–º–µ—Ç', sec: this.sessionDuration, coins: this.sessionCoins }; 
            DB.sessions.unshift(log); 
            if (DB.sessions.length > 50) DB.sessions.pop(); 
        }
        
        if (this.sessionDuration > 300) { 
            const today = new Date().toISOString().split('T')[0]; 
            const last = DB.user.lastStudyDate; 
            if (last !== today) { 
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); 
                const yesterdayStr = yesterday.toISOString().split('T')[0]; 
                if (last === yesterdayStr) { DB.user.streak++; App.toast("üî• –°—Ç—Ä–∏–∫ —É–≤–µ–ª–∏—á–µ–Ω!"); } 
                else { DB.user.streak = 1; App.toast("üî• –°—Ç—Ä–∏–∫ –Ω–∞—á–∞—Ç!"); } 
                DB.user.lastStudyDate = today; 
                SoundSys.play('success'); 
                FX.confetti(); 
            } 
        }

        // 6. –°–ë–†–ê–°–´–í–ê–ï–ú –°–ß–ï–¢–ß–ò–ö –°–ï–ö–£–ù–î
        if (manual) {
            this.sec = 0;
        }

        // 7. –û–ë–ù–û–í–õ–Ø–ï–ú –ò–ù–¢–ï–†–§–ï–ô–°, –ß–¢–û–ë–´ –ü–û–ö–ê–ó–ê–¢–¨ –û–°–¢–ê–ù–û–í–ö–£
        document.getElementById('btn-start').innerText = "üöÄ –°–¢–ê–†–¢";
        document.getElementById('timer').style.color = "var(--text)";
        
        // 8. –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –û–ë–ù–û–í–õ–Ø–ï–ú –î–ò–°–ü–õ–ï–ô –ù–ê 00:00:00
        const timeString = new Date(this.sec * 1000).toISOString().substr(11, 8);
        const timerEl = document.getElementById('timer');
        if(timerEl) timerEl.innerText = timeString;
        
        // 9. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω–æ–π UI
        Data.save(); 
        App.updateUI(); 
        App.renderHistory(); 
    }
};

const MathGame = { ans:0, show(isCheck=false) { const a=Math.floor(Math.random()*9)+2, b=Math.floor(Math.random()*9)+2; this.ans = a*b; document.getElementById('math-problem').innerText = `${a} x ${b} = ?`; document.getElementById('math-answer').value = ''; document.getElementById('modal-title').innerText = isCheck?"üëÆ –ü—Ä–æ–≤–µ—Ä–∫–∞":"üß† –ó–∞–¥–∞—á–∞"; document.getElementById('modal-msg').innerText = isCheck?"–í—ã –¥–æ–ª–≥–æ —É—á–∏–ª–∏—Å—å. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ.":""; document.getElementById('math-modal').classList.add('show'); document.getElementById('math-answer').focus(); }, check() { if(parseInt(document.getElementById('math-answer').value) === this.ans) { document.getElementById('math-modal').classList.remove('show'); Timer.start(); } else { document.getElementById('math-answer').style.borderColor='red'; SoundSys.play('error'); } } };

const Trainer = {
    score: 0, time: 60, interval: null, ans: 0, difficulty: 'easy',
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–æ—Ä–¥–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
    setDiff(diff, btn) {
        this.difficulty = diff;
        
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ –∫–Ω–æ–ø–∫–∏
        document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∫–æ—Ä–¥ –¥–ª—è –≠–¢–û–ô —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
        this.updateRecordDisplay();
    },

    updateRecordDisplay() {
        const rec = DB.user.trainerRecords ? DB.user.trainerRecords[this.difficulty] : 0;
        document.getElementById('trainer-high-score').innerText = rec;
    },

// –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ –≤–Ω—É—Ç—Ä—å –æ–±—ä–µ–∫—Ç–∞ Trainer:
    
    toggleMinus() {
        const input = document.getElementById('game-input');
        let val = input.value;

        // –ï—Å–ª–∏ –ø—É—Å—Ç–æ, –ø—Ä–æ—Å—Ç–æ —Å—Ç–∞–≤–∏–º –º–∏–Ω—É—Å
        if (val === '') {
            input.value = '-';
        } 
        // –ï—Å–ª–∏ –º–∏–Ω—É—Å —É–∂–µ –µ—Å—Ç—å ‚Äî —É–±–∏—Ä–∞–µ–º –µ–≥–æ
        else if (val.startsWith('-')) {
            input.value = val.substring(1);
        } 
        // –ï—Å–ª–∏ –º–∏–Ω—É—Å–∞ –Ω–µ—Ç ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º
        else {
            input.value = '-' + val;
        }

        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ, —á—Ç–æ–±—ã –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –Ω–µ –∑–∞–∫—Ä—ã–ª–∞—Å—å
        input.focus();
    },

    init() { 
        document.getElementById('trainer-menu').style.display = 'block'; 
        document.getElementById('trainer-game').style.display = 'none'; 
        document.getElementById('trainer-result').style.display = 'none'; 
        
        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—Ç–∞–≤–∏–º Easy –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ —Ä–µ–∫–æ—Ä–¥
        this.difficulty = 'easy';
        const btns = document.querySelectorAll('.diff-btn');
        btns.forEach(b => b.classList.remove('active'));
        if(btns[0]) btns[0].classList.add('active'); // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É Easy
        
        this.updateRecordDisplay();
    },

    start() {
        this.score = 0; 
        this.time = 60; 
        document.getElementById('trainer-menu').style.display = 'none'; 
        document.getElementById('trainer-game').style.display = 'block';
        document.getElementById('game-score').innerText = 0; 
        document.getElementById('game-time').innerText = 60;
        
        SoundSys.play('click'); 
        this.nextProblem(); 
        
        const input = document.getElementById('game-input'); 
        input.value = ''; 
        input.focus();
        // –§–∏–∫—Å –¥–ª—è –º–æ–±–∏–ª–æ–∫: —Ñ–æ–∫—É—Å –∏–Ω–æ–≥–¥–∞ —Å–±–∏–≤–∞–µ—Ç—Å—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º
        input.onclick = () => input.focus();

        input.onkeypress = (e) => { if(e.key === 'Enter') this.check(); };
        
        if(this.interval) clearInterval(this.interval);
        this.interval = setInterval(() => { 
            this.time--; 
            document.getElementById('game-time').innerText = this.time; 
            if(this.time <= 0) this.end(); 
        }, 1000);
    },

    nextProblem() {
        const ops = this.difficulty === 'hard' ? ['+','-','*','/'] : (this.difficulty === 'medium' ? ['+','-','*'] : ['+','-']);
        const op = ops[Math.floor(Math.random() * ops.length)];
        
        let range = 10;
        if(this.difficulty === 'medium') range = 50;
        if(this.difficulty === 'hard') range = 100;
        
        let a, b;
        
        if (op === '*') {
            let multRange = this.difficulty === 'hard' ? 20 : 10;
            a = Math.floor(Math.random() * multRange) + 2; 
            b = Math.floor(Math.random() * multRange) + 2;
        } else if (op === '/') {
             b = Math.floor(Math.random() * 10) + 2;
             a = b * (Math.floor(Math.random() * 10) + 2);
        } else {
            a = Math.floor(Math.random() * range) + 1;
            b = Math.floor(Math.random() * range) + 1;
        }

        if(op === '+') this.ans = a + b; 
        if(op === '-') this.ans = a - b; 
        if(op === '*') this.ans = a * b;
        if(op === '/') this.ans = a / b;

        let problemStr = `${a} ${op === '*' ? '√ó' : (op === '/' ? '√∑' : op)} ${b}`;
        document.getElementById('game-problem').innerText = problemStr; 
        document.getElementById('game-input').value = '';
    },

    check() {
        const val = parseInt(document.getElementById('game-input').value); 
        const inputEl = document.getElementById('game-input');
        
        if(val === this.ans) {
            this.score++; 
            document.getElementById('game-score').innerText = this.score; 
            SoundSys.play('success');
            
            inputEl.style.borderColor = 'var(--primary)'; 
            setTimeout(() => inputEl.style.borderColor = 'var(--text-light)', 200);
            
            let pts = 10; 
            if(this.difficulty==='medium') pts=20; 
            if(this.difficulty==='hard') pts=30;
            
            const rect = inputEl.getBoundingClientRect(); 
            FX.floatText(rect.left + 50, rect.top - 30, `+${pts} XP`, "#6C63FF");
            this.nextProblem();
        } else { 
            SoundSys.play('error'); 
            inputEl.style.borderColor = 'red'; 
            inputEl.value = ''; 
        }
    },

    end() {
        clearInterval(this.interval); 
        document.getElementById('trainer-game').style.display = 'none'; 
        document.getElementById('trainer-result').style.display = 'block';
        
        let mult = 10; 
        if(this.difficulty==='medium') mult=20; 
        if(this.difficulty==='hard') mult=30;
        
        const earnedXP = this.score * mult; 
        const earnedCoins = Math.floor(this.score / (this.difficulty === 'hard' ? 2 : 5)); 
        
        App.addXP(earnedXP);
        if(earnedCoins > 0) { 
            DB.user.coins += earnedCoins; 
            SoundSys.play('coin'); 
            App.toast(`ü™ô +${earnedCoins} üí∞`); 
        }

        // --- –°–û–•–†–ê–ù–ï–ù–ò–ï –û–¢–î–ï–õ–¨–ù–û–ì–û –†–ï–ö–û–†–î–ê ---
        // –ë–µ—Ä–µ–º —Ç–µ–∫—É—â–∏–π —Ä–µ–∫–æ—Ä–¥ –¥–ª—è —ç—Ç–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
        const currentRecord = DB.user.trainerRecords[this.difficulty];
        
        if(this.score > currentRecord) {
            DB.user.trainerRecords[this.difficulty] = this.score;
            SoundSys.play('win'); 
            App.toast(`üèÜ –ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥ (${this.difficulty}): ${this.score}!`); 
            FX.confetti(); 
        }
        // -------------------------------------

        Data.save(); 
        App.updateUI();
        
        document.getElementById('result-score').innerText = this.score; 
        document.getElementById('result-xp').innerText = `+${earnedXP} XP`; 
        document.getElementById('result-coins').innerText = `+${earnedCoins} üí∞`;
    }
};
const AchievementSys = {
    check() {
        if (!DB || !DB.achievements) return;
        
        // –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π "–í—Å–µ–≥–æ XP –∑–∞ –∂–∏–∑–Ω—å" –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ—ë (–Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ –æ–ø—ã—Ç–∞)
        if (DB.user.lifetimeXP === undefined) {
            DB.user.lifetimeXP = DB.user.xp; 
        }

        let changed = false;

        DB.achievements.forEach(a => {
            if (a.unlocked) return; // –ï—Å–ª–∏ —É–∂–µ –ø–æ–ª—É—á–µ–Ω–æ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º

            let currentVal = 0;
            let typeName = "";

            // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ (total)
            if (a.type === 'total') {
                currentVal = DB.user.totalSec;
                typeName = "—Å–µ–∫.";
            }
            // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–≤–Ω—è (lvl)
            else if (a.type === 'lvl') {
                currentVal = DB.user.level;
                typeName = "—É—Ä.";
            }
            // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø—ã—Ç–∞ (xp) - –∏—Å–ø–æ–ª—å–∑—É–µ–º "XP –∑–∞ –≤—Å—é –∂–∏–∑–Ω—å"
            else if (a.type === 'xp') {
                currentVal = DB.user.lifetimeXP;
                typeName = "XP";
            }

            // –ï—Å–ª–∏ —É—Å–ª–æ–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ ‚Äî –û–¢–ö–†–´–í–ê–ï–ú!
            if (currentVal >= a.max) {
                a.unlocked = true;
                changed = true;
                
                // –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —ç–∫—Ä–∞–Ω
                App.toast(`üèÖ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: ${a.title}`);
                SoundSys.play('success');
                FX.confetti();
            }
        });

        if (changed) {
            Data.save();
            // –ï—Å–ª–∏ –º—ã —Å–µ–π—á–∞—Å –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            const achTab = document.getElementById('achievements');
            if (achTab && achTab.classList.contains('active')) {
                App.updateUI();
            }
        }
    }
};
const App = {
    async init() { Auth.init(); },
    
    // –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø (–ó–∞—â–∏—Ç–∞ –æ—Ç —Ç–≤–æ–µ–π –æ—à–∏–±–∫–∏)
       setText(id, text) {
        const el = document.getElementById(id);
        if (el) {
            el.innerText = text;
        } else {
            console.warn(`–≠–ª–µ–º–µ–Ω—Ç —Å id="${id}" –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –Ω–æ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ`);
        }
    },
    
    initAfterLogin() {
        this.updateUI();
        this.renderSubjects();
        SubjectSys.render();
        Trainer.init();
        this.renderHistory();
        this.updateUI();   
        AchievementSys.check();
    },

toggleDarkMode(enabled) {
        DB.user.darkMode = enabled;
        if (enabled) {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }
        localStorage.setItem('darkMode', enabled);
        Data.save();
        this.updateUI();
    },

    updateUI() {
        if(!DB) return;
document.body.className = `theme-${DB.user.theme} ${DB.user.darkMode ? 'dark-mode' : ''}`.trim();
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è
        const toggle = document.getElementById('dark-toggle');
        if (toggle) toggle.checked = DB.user.darkMode;

        // –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –º—ã —Ö–æ—Ç–∏–º –≤–∏–¥–µ—Ç—å
        const newSubjects = {
            algebra: {name:'–ê–ª–≥–µ–±—Ä–∞', icon:'‚úñÔ∏è', sec:0},
            geometry: {name:'–ì–µ–æ–º–µ—Ç—Ä–∏—è', icon:'üìê', sec:0},
            calculus: {name:'–ú–∞—Ç. –∞–Ω–∞–ª–∏–∑', icon:'‚à´', sec:0},
            arithmetic: {name:'–ê—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞', icon:'üî¢', sec:0},
            combinatorics: {name:'–ö–æ–º–±–∏–Ω–∞—Ç–æ—Ä–∏–∫–∞', icon:'üîÄ', sec:0},
            statistics: {name:'–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', icon:'üìä', sec:0},
            trigonometry: {name:'–¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è', icon:'üìè', sec:0},
            stereometry: {name:'–°—Ç–µ—Ä–µ–æ–º–µ—Ç—Ä–∏—è', icon:'üßä', sec:0}
        };
        let changed = false;
        for (let key in newSubjects) {
            if (!DB.subjects[key]) {
                DB.subjects[key] = newSubjects[key];
                changed = true;
            }
        }
        if (changed) Data.save();


        this.setText('coin-display', DB.user.coins);
        this.setText('streak-display', DB.user.streak);
        this.setText('header-name', DB.user.name || '–ò–≥—Ä–æ–∫');
        this.setText('header-avatar', DB.user.avatar || 'üòé');

document.body.className = `theme-${DB.user.theme} ${DB.user.darkMode ? 'dark-mode' : ''}`.trim();

        // –õ–∏–≥–∏
        let cl = LEAGUES[0]; 
        for(let l of LEAGUES) { if(DB.user.xp >= l.min) cl = l; }
        
        this.setText('header-league', cl.name);
        this.setText('profile-league-big', cl.name);
        
        const headerBox = document.getElementById('header-avatar-box');
        if(headerBox) headerBox.className = `profile-img ${cl.color}`;
        
        const pb = document.getElementById('profile-avatar-box');
        if(pb) pb.className = `profile-img ${cl.color}`;

        // –ú–ê–ì–ê–ó–ò–ù –¢–ï–ú
        const themeList = document.getElementById('theme-list');
        if (themeList) {
            themeList.innerHTML = THEMES.map(t => {
                const owned = DB.user.ownedThemes.includes(t.id), active = DB.user.theme === t.id;
                return `<div class="shop-item ${active?'active':''}" onclick="App.buyTheme('${t.id}')"><div>${t.icon}</div><div>${t.name}</div>${owned?'':'<small>'+t.price+'üí∞</small>'}</div>`
            }).join('');
        }

        // --- –í–°–¢–ê–í–ò–¢–¨ –í–ù–£–¢–†–¨ App.updateUI() ---

        // –ú–ê–ì–ê–ó–ò–ù –ê–í–ê–¢–ê–†–û–í (–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π)
        const avatarList = document.getElementById('avatar-shop-list');
        if (avatarList) {
            avatarList.innerHTML = SHOP_AVATARS.map(a => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫—É–ø–ª–µ–Ω –ª–∏ –∞–≤–∞—Ç–∞—Ä
                const owned = DB.user.ownedAvatars.includes(a.id);
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞–¥–µ—Ç –ª–∏ –æ–Ω —Å–µ–π—á–∞—Å
                const active = DB.user.avatar === a.icon;
                
                // –ï—Å–ª–∏ –¥–µ–Ω–µ–≥ —Ö–≤–∞—Ç–∞–µ—Ç, –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Ü–µ–Ω—É (–∫–ª–∞—Å—Å affordable)
                const canBuy = DB.user.coins >= a.price;
                const priceClass = canBuy ? 'affordable' : '';
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É
                return `
                <div class="shop-item ${active ? 'active' : ''}" onclick="App.buyAvatar('${a.id}')">
                    <div style="font-size: 32px; margin-bottom: 5px;">${a.icon}</div>
                    <div style="font-size: 11px; font-weight: bold; margin-bottom: 3px; line-height: 1.2;">${a.name}</div>
                    ${owned 
                        ? '<small style="color:var(--success); font-weight:bold;">‚úî –ï—Å—Ç—å</small>' 
                        : `<small class="shop-price-tag ${priceClass}">${a.price} üí∞</small>`
                    }
                </div>`;
            }).join('');
        }
        
        // –î–û–°–¢–ò–ñ–ï–ù–ò–Ø
        const achList = document.getElementById('ach-list');
        if (achList && DB.achievements) {
            achList.innerHTML = DB.achievements.map(a => {
                let currentVal = 0;
                if (a.type === 'total') currentVal = DB.user.totalSec;
                else if (a.type === 'lvl') currentVal = DB.user.level;
                else if (a.type === 'xp') currentVal = DB.user.xp;

                const pct = Math.min(100, (currentVal / a.max) * 100);
                const unlocked = pct >= 100;

                return `<div class="ach-row ${unlocked ? 'unlocked' : ''}">
                    <div class="ach-icon">${unlocked ? '‚úÖ' : a.icon}</div>
                    <div class="ach-info">
                        <div class="ach-title">${a.title}</div>
                        <div class="ach-desc">${a.desc}</div>
                        <div class="ach-bar-bg"><div class="ach-bar-fill" style="width:${pct}%"></div></div>
                        <small>${currentVal} / ${a.max}</small>
                    </div>
                </div>`;
            }).join('');
        }

        // –°–¢–ê–¢–ò–°–¢–ò–ö–ê
        const h = (DB.user.totalSec/3600).toFixed(1);
        this.setText('timer', new Date(Timer.sec * 1000).toISOString().substr(11, 8));
        this.setText('stat-total-time', h + '—á');
        this.setText('prof-lvl', DB.user.level);
        this.setText('prof-xp', DB.user.xp);
        this.setText('prof-coins', DB.user.coins);
        
        const xpBar = document.getElementById('prof-xp-bar');
        if(xpBar) xpBar.style.width = (DB.user.xp/DB.user.nextXp*100)+'%';
        
        this.setText('xp-progress-text', `${DB.user.xp} / ${DB.user.nextXp} XP`);
    },

    buyTheme(id) {
        const t = THEMES.find(x=>x.id===id);
        if(DB.user.ownedThemes.includes(id)) { 
            DB.user.theme=id; Data.save(); App.updateUI(); 
        } else if(DB.user.coins >= t.price && confirm(`–ö—É–ø–∏—Ç—å –∑–∞ ${t.price}?`)) {
            DB.user.coins -= t.price; DB.user.ownedThemes.push(id); DB.user.theme=id; Data.save(); App.updateUI(); SoundSys.play('success');
        } else { App.toast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç"); }
    },
    buyAvatar(id) {
        // –ò—â–µ–º –∞–≤–∞—Ç–∞—Ä –≤ –Ω–æ–≤–æ–º —Å–ø–∏—Å–∫–µ
        const a = SHOP_AVATARS.find(x => x.id === id);
        if (!a) return; // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ (–∑–∞—â–∏—Ç–∞)

        // –ï—Å–ª–∏ —É–∂–µ –∫—É–ø–ª–µ–Ω ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∞–¥–µ–≤–∞–µ–º
        if (DB.user.ownedAvatars.includes(id)) { 
            DB.user.avatar = a.icon; 
            Data.save(); 
            App.updateUI(); 
            SoundSys.play('click');
        } 
        // –ï—Å–ª–∏ –Ω–µ –∫—É–ø–ª–µ–Ω ‚Äî –ø—Ä–æ–±—É–µ–º –∫—É–ø–∏—Ç—å
        else if (DB.user.coins >= a.price) {
            if(confirm(`–ö—É–ø–∏—Ç—å "${a.name}" –∑–∞ ${a.price} –º–æ–Ω–µ—Ç?`)) {
                DB.user.coins -= a.price; 
                DB.user.ownedAvatars.push(id); 
                DB.user.avatar = a.icon; 
                Data.save(); 
                App.updateUI(); 
                SoundSys.play('success');
                FX.confetti(); // –°–∞–ª—é—Ç –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ!
            }
        } else { 
            App.toast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç üí∞"); 
            SoundSys.play('error');
        }
    },
    addXP(n) { 
        DB.user.xp += n; 
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞: –•–≤–∞—Ç–∞–µ—Ç –ª–∏ –æ–ø—ã—Ç–∞ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è?
        if(DB.user.xp >= DB.user.nextXp){
            DB.user.level++; 
            
            // –ü–µ—Ä–µ–Ω–æ—Å–∏–º –æ—Å—Ç–∞—Ç–æ–∫ –æ–ø—ã—Ç–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å (—á–µ—Å—Ç–Ω–æ)
            // –ù–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞–¥–æ 500, –Ω–∞–±—Ä–∞–ª–∏ 510 -> –æ—Å—Ç–∞–Ω–µ—Ç—Å—è 10
            DB.user.xp = DB.user.xp - DB.user.nextXp; 
            
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å–ª–æ–∂–Ω–æ—Å—Ç—å —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è –Ω–∞ 20%
            DB.user.nextXp = Math.floor(DB.user.nextXp * 1.2); 
            
            // --- –ù–ê–ì–†–ê–î–ê ---
            const reward = 50; // –î–∞–µ–º 50 –º–æ–Ω–µ—Ç
            DB.user.coins += reward;

            // --- –ü–û–ö–ê–ó –û–ö–ù–ê ---
            document.getElementById('lvl-up-new-level').innerText = DB.user.level;
            document.getElementById('levelup-modal').classList.add('show');
            
            // --- –≠–§–§–ï–ö–¢–´ ---
            FX.confetti(); // –°–∞–ª—é—Ç
            SoundSys.play('win'); // –ó–≤—É–∫ –ø–æ–±–µ–¥—ã
        } 
        
        Data.save(); 
        this.updateUI(); 

        AchievementSys.check();

    },
    switchTab(id, btn) {
        // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
        document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
        const sec = document.getElementById(id);
        if(sec) sec.classList.add('active');
       
        document.querySelectorAll('.nav-btn').forEach(x => x.classList.remove('active'));
        if(btn) btn.classList.add('active');
       
        if (id === 'stats') {
            this.renderStats();
        }
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –Ø–Ω–¥–µ–∫—Å –ú–µ—Ç—Ä–∏–∫—É
        if (typeof ym !== 'undefined') {
            ym(105919372, 'hit', '#' + id, {
                title: id.toUpperCase() // –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –æ—Ç—á–µ—Ç–µ
            });
        }
    },
    
    renderStats(){
        const ctx = document.getElementById('weekChart');
        if(window.myChart) window.myChart.destroy();
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–∞–Ω–≤–∞—Å–∞
        if (ctx) {
            window.myChart = new Chart(ctx, {type:'bar', data:{labels:['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'], datasets:[{label:'–ß–∞—Å—ã',data:[0,0,0,0,0,0,0],backgroundColor:'#6C63FF'}]}});
        }
    },
       renderSubjects() {
        const grid = document.getElementById('subjects-grid');
        if (!grid || !DB || !DB.subjects) return;

        grid.innerHTML = Object.keys(DB.subjects).map(k => {
            const s = DB.subjects[k];
            const isActive = DB.user.subject === k;
            return `
                <div onclick="App.selectSubject('${k}')"
                     class="card"
                     style="padding:15px; text-align:center; cursor:pointer; 
                            ${isActive ? 'border:2px solid var(--primary); background:rgba(108,99,255,0.1);' : 'border:2px solid transparent;'}">
                    <div style="font-size:24px">${s.icon}</div>
                    <div style="font-weight:bold; font-size:12px; margin-top:5px;">${s.name}</div>
                </div>`;
        }).join('');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ –¥–∞—à–±–æ—Ä–¥–µ
        const currentSub = DB.subjects[DB.user.subject];
        if (currentSub && document.getElementById('subject-title')) {
            document.getElementById('subject-title').innerText = currentSub.name;
        }
    },

    selectSubject(key) {
        if (DB.subjects[key]) {
            DB.user.subject = key;
            Data.save();
            this.renderSubjects();
            this.updateUI();
            App.toast("–ü—Ä–µ–¥–º–µ—Ç: " + DB.subjects[key].name);
        }
    },

        renderHistory() {
        // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª—è–µ—Ç –∂—É—Ä–Ω–∞–ª –∑–∞–Ω—è—Ç–∏–π –≤ —Ä–∞–∑–¥–µ–ª–µ "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"
        const logContainer = document.getElementById('session-log');
        if (!logContainer || !DB || !DB.sessions) return;

        logContainer.innerHTML = '';
        DB.sessions.forEach(s => {
            const row = document.createElement('div');
            row.className = 'session-row';
            row.innerHTML = `
                <div class="session-info">
                    <div>${s.subject}</div>
                    <div class="session-date">${new Date(s.date).toLocaleDateString('ru-RU')}</div>
                </div>
                <div>
                    <span style="color:var(--text-light);">${Math.floor(s.sec/60)} –º–∏–Ω</span>
                    ${s.coins > 0 ? `<span class="session-coins">+${s.coins} üí∞</span>` : ''}
                </div>
            `;
            logContainer.appendChild(row);
        });

        // –ï—Å–ª–∏ —Å–µ—Å—Å–∏–π –Ω–µ—Ç ‚Äî –ø–æ–∫–∞–∂–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        if (DB.sessions.length === 0) {
            logContainer.innerHTML = '<div style="text-align:center; color:var(--text-light); padding:20px;">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>';
        }
    },

            renderStats() {
        // –î–∞—ë–º –≤—Ä–µ–º—è, —á—Ç–æ–±—ã –≤–∫–ª–∞–¥–∫–∞ —Å—Ç–∞–ª–∞ –≤–∏–¥–∏–º–æ–π –∏ canvas –ø–æ—è–≤–∏–ª—Å—è –≤ DOM
        setTimeout(() => {
            // –ü–∏—Ä–æ–≥ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
            const subjectCtx = document.getElementById('subjectChart');
            if (subjectCtx) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —á–∞—Ä—Ç –∏ –º–æ–∂–Ω–æ –ª–∏ –µ–≥–æ —É–Ω–∏—á—Ç–æ–∂–∏—Ç—å
                if (window.subjectChart && typeof window.subjectChart.destroy === 'function') {
                    window.subjectChart.destroy();
                }

                const labels = [];
                const data = [];
                const colors = ['#6C63FF', '#00E0D0', '#FF8F66', '#556B2F', '#D60270', '#FF7675', '#00d26a', '#FFD700'];

                if (DB.subjects) {
                    Object.values(DB.subjects).forEach(s => {
                        if (s.sec > 0) {
                            labels.push(s.name);
                            data.push(Math.round(s.sec / 60));
                        }
                    });
                }

                window.subjectChart = new Chart(subjectCtx, {
                    type: 'doughnut',
                    data: {
                        labels: labels.length ? labels : ['–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'],
                        datasets: [{
                            data: data.length ? data : [1],
                            backgroundColor: colors,
                            borderWidth: 3,
                            borderColor: 'var(--bg)'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }

            // –ë–∞—Ä-—á–∞—Ä—Ç –Ω–µ–¥–µ–ª–∏
            const weekCtx = document.getElementById('weekChart');
            if (weekCtx) {
                if (window.weekChart && typeof window.weekChart.destroy === 'function') {
                    window.weekChart.destroy();
                }

                const days = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
                const data = [];
                for (let i = 0; i < 7; i++) {
                    const d = new Date();
                    d.setDate(d.getDate() - d.getDay() + 1 + i);
                    const key = d.toISOString().split('T')[0];
                    data.push(Math.round(((DB.history && DB.history[key]) || 0) / 3600 * 10) / 10);
                }

                window.weekChart = new Chart(weekCtx, {
                    type: 'bar',
                    data: {
                        labels: days,
                        datasets: [{
                            label: '–ß–∞—Å—ã —É—á—ë–±—ã',
                            data: data,
                            backgroundColor: 'var(--primary)',
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }

                           // –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ‚Äî heatmap –∑–∞ 30 –¥–Ω–µ–π (–∫–≤–∞–¥—Ä–∞—Ç–∏–∫–∏)
        const heatmap = document.getElementById('heatmap');
        if (heatmap) {
            const today = new Date();
            const start = new Date(today);
            start.setDate(today.getDate() - 29); // 30 –¥–Ω–µ–π –Ω–∞–∑–∞–¥

            // –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏: –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ = 0
            const firstDayOffset = start.getDay() === 0 ? 6 : start.getDay() - 1;

            let html = '';
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ –∫–ª–µ—Ç–∫–∏ –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
            for (let i = 0; i < firstDayOffset; i++) {
                html += '<div style="background:var(--bg); border-radius:4px; aspect-ratio:1/1;"></div>';
            }

            for (let i = 0; i < 30; i++) {
                const date = new Date(start);
                date.setDate(start.getDate() + i);
                const key = date.toISOString().split('T')[0];
                const sec = (DB.history && DB.history[key]) || 0;
                const minutes = Math.round(sec / 60);
                const intensity = sec === 0 ? 0 : Math.min(4, Math.ceil(minutes / 30)); // –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω = —É—Ä–æ–≤–µ–Ω—å

                const colors = ['var(--bg)', '#c6e48b', '#7bc96f', '#239a3b', '#196127'];
                const title = minutes > 0 ? `${minutes} –º–∏–Ω ‚Äî ${date.toLocaleDateString('ru-RU')}` : '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏';

                html += `<div title="${title}" style="background:${colors[intensity]}; border-radius:4px; aspect-ratio:1/1; display:flex; align-items:flex-end; justify-content:center; padding-bottom:2px; font-size:9px; color:var(--text); font-weight:bold;">
                    ${minutes > 0 ? minutes : ''}
                </div>`;
            }

            heatmap.innerHTML = html;
        }

        }, 200); // –∑–∞–¥–µ—Ä–∂–∫–∞ 200–º—Å ‚Äî —á—Ç–æ–±—ã canvas —Ç–æ—á–Ω–æ –±—ã–ª –≤–∏–¥–∏–º—ã–º
    },
    toggleEcoMode(enable) {
        const overlay = document.getElementById('eco-overlay');
        if (enable) {
            overlay.classList.add('active');
            App.toast("üîã –≠–∫–æ–Ω–æ–º–∏—è —ç–Ω–µ—Ä–≥–∏–∏ –≤–∫–ª—é—á–µ–Ω–∞. –ù–∞–∂–º–∏ –Ω–∞ —ç–∫—Ä–∞–Ω, —á—Ç–æ–±—ã –≤—ã–π—Ç–∏.");
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å—Ç–∞–≤–∏–º —è—Ä–∫–æ—Å—Ç—å —ç–∫—Ä–∞–Ω–∞ –Ω–∞ –º–∏–Ω–∏–º—É–º (–ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ –Ω–µ–ª—å–∑—è, –Ω–æ —á–µ—Ä–Ω—ã–π —Ü–≤–µ—Ç –ø–æ–º–æ–≥–∞–µ—Ç)
        } else {
            overlay.classList.remove('active');
        }
    },
    toast(m) { 
        const container = document.getElementById('toast-container');
        if (container) {
            const t=document.createElement('div'); t.className='toast'; t.innerText=m; 
            container.appendChild(t); 
            setTimeout(()=>t.classList.add('show'),10); 
            setTimeout(()=>{t.classList.remove('show');t.remove()},3000); 
        }
    }
    
};



const Transfer = {
    generateTransferID() {
        if (!Auth.currentUser) return App.toast("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç");

        // 1. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∏–º—è –≤ —Ñ–∞–π–ª –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
        if (DB && DB.user) {
            DB.user.name = Auth.currentUser.name;
            DB.user.avatar = Auth.currentUser.avatar;
            DB.user.id = Auth.currentUser.id;
            Data.save(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
        }

        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let id = '';
        for (let i = 0; i < 8; i++) {
            id += chars.charAt(Math.floor(Math.random() * chars.length));
        }

        App.toast("‚è≥ –°–æ–∑–¥–∞–µ–º –∫–æ–¥...");

        const docRef = window.DB_Online.doc(window.DB_Online.db, "transfers", id);
        window.DB_Online.setDoc(docRef, {
            userId: Auth.currentUser.id,
            data: DB,
            createdAt: new Date().toISOString(),
            expiresAt: new Date(Date.now() + 24*60*60*1000).toISOString()
        }).then(() => {
            prompt("‚úÖ –í–∞—à –∫–æ–¥ –ø–µ—Ä–µ–Ω–æ—Å–∞ (–¥–µ–π—Å—Ç–≤—É–µ—Ç 24—á):", id);
        }).catch(e => {
            console.error(e);
            App.toast("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–¥–∞");
        });
    },

    transferByID() {
        const inputID = prompt("–í–≤–µ–¥–∏—Ç–µ 8-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:");
        if (!inputID) return;
        const cleanID = inputID.trim();
        if (cleanID.length !== 8) return App.toast("–ö–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 8 —Å–∏–º–≤–æ–ª–æ–≤");

        App.toast("‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...");

        const docRef = window.DB_Online.doc(window.DB_Online.db, "transfers", cleanID);
        let isSuccess = false;

        window.DB_Online.getDoc(docRef).then(docSnap => {
            if (docSnap.exists()) {
                const transferData = docSnap.data();
                if (new Date() > new Date(transferData.expiresAt)) {
                    App.toast("‚ùå –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∫–æ–¥–∞ –∏—Å—Ç–µ–∫");
                    return;
                }

                DB = transferData.data;

                // –ï—Å–ª–∏ –∏–º—è –ø—É—Å—Ç–æ–µ –∏–ª–∏ "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π" ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–µ–º —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (!DB.user.name || DB.user.name === "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π") {
                    let newName = prompt("–ò–º—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏. –ö–∞–∫ –Ω–∞–∑–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å?", "–ò–≥—Ä–æ–∫");
                    if (newName && !NameGuard.check(newName)) {
                        alert("‚õîÔ∏è –¢–∞–∫–æ–µ –∏–º—è –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å. –ë—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–º—è '–ò–≥—Ä–æ–∫'.");
                        newName = "–ò–≥—Ä–æ–∫";
                    }
                    DB.user.name = newName && newName.trim() ? newName : "–ò–≥—Ä–æ–∫";
                }
                
                if (!DB.user.avatar) DB.user.avatar = "üòé";
                if (!DB.user.id) DB.user.id = 'u' + Date.now();

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                let usersList = [];
                try {
                    const stored = localStorage.getItem('MathUsers');
                    if (stored) usersList = JSON.parse(stored);
                } catch (e) { usersList = []; }

                usersList = usersList.filter(u => u.id !== DB.user.id);
                
                usersList.unshift({ 
                    id: DB.user.id, 
                    name: DB.user.name, 
                    avatar: DB.user.avatar, 
                    gender: DB.user.gender || 'male' 
                });

                localStorage.setItem('MathUsers', JSON.stringify(usersList));

                Data.currentKey = 'MathData_' + DB.user.id; 
                localStorage.setItem(Data.currentKey, JSON.stringify(DB));

                isSuccess = true;
                App.toast(`‚úÖ –£–°–ü–ï–®–ù–û! –ü—Ä–∏–≤–µ—Ç, ${DB.user.name}`);
                
                window.DB_Online.deleteDoc(docRef).catch(() => {});
                setTimeout(() => location.reload(), 1000);

            } else {
                App.toast("‚ùå –ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω");
            }
        }).catch(e => {
            console.error(e);
            if (!isSuccess) App.toast("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
        });
    }
};
const InstallSys = {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≥–¥–µ –º—ã: –≤ –±—Ä–∞—É–∑–µ—Ä–µ –∏–ª–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
    init() {
        // –ï—Å–ª–∏ —ç—Ç–æ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ - —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
        
        if (!isStandalone) {
            // –ú—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            const btn = document.getElementById('install-promo-card');
            if (btn) btn.style.display = 'block';
        }
    },

    // –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞ "–£–º–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏"
    startFlow() {
        if (!Auth.currentUser) return App.toast("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å!");

        // 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥ (—Ç–æ—Ç –∂–µ –ø—Ä–∏–Ω—Ü–∏–ø, —á—Ç–æ –∏ —Ä–∞–Ω—å—à–µ)
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // –ë–µ–∑ –ø–æ—Ö–æ–∂–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ (I, 1, 0, O)
        let code = '';
        for (let i = 0; i < 8; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));

        // 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –∏ –¥–∞–Ω–Ω—ã–µ
        DB.user.name = Auth.currentUser.name;
        DB.user.avatar = Auth.currentUser.avatar;
        DB.user.id = Auth.currentUser.id;
        
        App.toast("‚è≥ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö...");

        // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –æ–±–ª–∞–∫–æ
        const docRef = window.DB_Online.doc(window.DB_Online.db, "transfers", code);
        window.DB_Online.setDoc(docRef, {
            userId: Auth.currentUser.id,
            data: DB,
            createdAt: new Date().toISOString(),
            expiresAt: new Date(Date.now() + 24*60*60*1000).toISOString()
        }).then(() => {
            // 4. –ö–û–ü–ò–†–£–ï–ú –ö–û–î –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò
            navigator.clipboard.writeText(code).then(() => {
                // 5. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
                alert(
                    `‚úÖ –ö–û–î –°–ö–û–ü–ò–†–û–í–ê–ù: ${code}\n\n` +
                    `1. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" -> "–ù–∞ —ç–∫—Ä–∞–Ω –¥–æ–º–æ–π"\n` +
                    `2. –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\n` +
                    `3. –ù–∞–∂–º–∏—Ç–µ "üì• –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" –∏ –≤—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥.`
                );
            }).catch(() => {
                // –ï—Å–ª–∏ –∞–≤—Ç–æ-–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ
                prompt("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥, –æ–Ω –Ω—É–∂–µ–Ω –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:", code);
            });
        }).catch(e => {
            App.toast("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
        });
    }
};
/* === SPLASH SCREEN LOGIC === */
window.onload = () => {
    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    Auth.init();
    InstallSys.init(); // <--- –î–û–ë–ê–í–ò–¢–¨ –í–û–¢ –≠–¢–û

    // 2. –£–±–∏—Ä–∞–µ–º —Å–ø–ª—ç—à-—Å–∫—Ä–∏–Ω —á–µ—Ä–µ–∑ –∑–∞–¥–µ—Ä–∂–∫—É (—á—Ç–æ–±—ã –ª–æ–≥–æ —É—Å–ø–µ–ª–æ –ø–æ–∫–∞–∑–∞—Ç—å—Å—è)
    setTimeout(() => {
        const splash = document.getElementById('splash-screen');
        if(splash) {
            splash.classList.add('hidden');
            // –£–¥–∞–ª—è–µ–º –∏–∑ DOM –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
            setTimeout(() => splash.remove(), 500);
        }
    }, 2000); // 2000 –º—Å = 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ–∫–∞–∑–∞ –ª–æ–≥–æ—Ç–∏–ø–∞
};

// ===== –ê–ù–¢–ò-–ê–§–ö: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 20 –º–∏–Ω—É—Ç =====
let afkTimer = null;
let afkPromptActive = false;
const AFK_INTERVAL = 20 * 60 * 1000; // 20 –º–∏–Ω—É—Ç
const PROMPT_TIMEOUT = 30 * 1000;    // 30 —Å–µ–∫—É–Ω–¥ –Ω–∞ –æ—Ç–≤–µ—Ç

function startAfkCheck() {
    if (afkTimer) clearTimeout(afkTimer);
    afkTimer = setTimeout(showAfkPrompt, AFK_INTERVAL);
}

function stopAfkCheck() {
    if (afkTimer) {
        clearTimeout(afkTimer);
        afkTimer = null;
    }
    afkPromptActive = false;
    hideAfkPrompt();
}

function showAfkPrompt() {
    if (afkPromptActive || !Timer.isRunning) return;
    afkPromptActive = true;

    const prompt = document.createElement('div');
    prompt.id = 'afk-prompt';
    prompt.style.cssText = `
        position: fixed;
        bottom: 90px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--surface);
        padding: 15px 25px;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.4);
        z-index: 999;
        text-align: center;
        max-width: 90vw;
    `;
    prompt.innerHTML = `
        <p style="margin:0 0 10px; font-weight:bold;">–ü—Ä–æ–¥–æ–ª–∂–∞–µ—à—å —É—á–∏—Ç—å—Å—è? üòä</p>
        <p style="margin:0 0 15px; font-size:14px;">–ù–∞–∂–º–∏ "–î–∞" –≤ —Ç–µ—á–µ–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥</p>
        <button onclick="confirmAfk()" class="btn btn-primary" style="margin-right:10px;">–î–∞, –ø—Ä–æ–¥–æ–ª–∂–∞—é!</button>
        <button onclick="pauseAfk()" class="btn btn-outline">–Ø –æ—Ç–æ—à—ë–ª</button>
    `;
    document.body.appendChild(prompt);

    setTimeout(() => {
        if (afkPromptActive) pauseAfk();
    }, PROMPT_TIMEOUT);
}

function confirmAfk() {
    afkPromptActive = false;
    hideAfkPrompt();
    startAfkCheck();
    App.toast("–ö—Ä—É—Ç–æ! –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º üí™");
}

function pauseAfk() {
    afkPromptActive = false;
    hideAfkPrompt();
    Timer.pause();
    App.toast("–¢–∞–π–º–µ—Ä –Ω–∞ –ø–∞—É–∑–µ. –í–æ–∑–æ–±–Ω–æ–≤–∏ –∫–æ–≥–¥–∞ –≤–µ—Ä–Ω—ë—à—å—Å—è!");
}

function hideAfkPrompt() {
    const prompt = document.getElementById('afk-prompt');
    if (prompt) prompt.remove();
}

// –ü–æ–¥–∫–ª—é—á–∞–µ–º –∫ —Ç–∞–π–º–µ—Ä—É (–µ—Å–ª–∏ —É —Ç–µ–±—è Timer ‚Äî –æ–±—ä–µ–∫—Ç)
if (typeof Timer !== 'undefined') {
    const originalStart = Timer.start;
    Timer.start = function() {
        originalStart?.apply(this, arguments);
        startAfkCheck();
    };

    const originalPause = Timer.pause;
    Timer.pause = function() {
        originalPause?.apply(this, arguments);
        stopAfkCheck();
    };

    const originalStop = Timer.stop;
    Timer.stop = function() {
        originalStop?.apply(this, arguments);
        stopAfkCheck();
    };
}

// ===== –ü–†–ï–î–ú–ï–¢–´: –ü–ï–†–ï–ú–ï–©–ï–ù–ò–ï –û–î–ù–ò–ú –ö–õ–ò–ö–û–ú ‚Äî –§–ò–ù–ê–õ–¨–ù–´–ô –í–ê–†–ò–ê–ù–¢ =====

// –í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã
const ALL_SUBJECTS = [
    { id: 'algebra', name: '–ê–ª–≥–µ–±—Ä–∞', icon: '‚úñÔ∏è' },
    { id: 'geometry', name: '–ì–µ–æ–º–µ—Ç—Ä–∏—è', icon: 'üìê' },
    { id: 'calculus', name: '–ú–∞—Ç. –∞–Ω–∞–ª–∏–∑', icon: '‚à´' },
    { id: 'arithmetic', name: '–ê—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞', icon: 'üî¢' },
    { id: 'combinatorics', name: '–ö–æ–º–±–∏–Ω–∞—Ç–æ—Ä–∏–∫–∞', icon: 'üîÄ' },
    { id: 'statistics', name: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', icon: 'üìä' },
    { id: 'trigonometry', name: '–¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è', icon: 'üìè' },
    { id: 'stereometry', name: '–°—Ç–µ—Ä–µ–æ–º–µ—Ç—Ä–∏—è', icon: 'üßä' }
];

// –ó–∞—â–∏—Ç–∞ –æ—Ç null (—Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ!)
if (!DB) DB = {};
if (!DB.subjects) DB.subjects = {};

// –û—á–∏—Å—Ç–∫–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö –∫–ª—é—á–µ–π (—Ñ–∏–∫—Å Firebase)
function cleanSubjects() {
    if (!DB.subjects) return;
    Object.keys(DB.subjects).forEach(key => {
        if (!key || key.trim() === '') {
            delete DB.subjects[key];
            console.log("–£–¥–∞–ª—ë–Ω –ø—É—Å—Ç–æ–π –∫–ª—é—á:", key);
        }
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤
function updateSubjectLists() {
    const my = document.getElementById('my-subjects-list');
    const avail = document.getElementById('available-subjects-list');

    if (!my || !avail) return;

    my.innerHTML = '';
    avail.innerHTML = '';

    // –ó–∞—â–∏—Ç–∞ –æ—Ç null
    if (!DB || !DB.subjects) {
        my.innerHTML = '<div style="text-align:center; color:var(--text-light); padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        return;
    }

    // –ú–æ–∏ –ø—Ä–µ–¥–º–µ—Ç—ã
    Object.keys(DB.subjects).forEach(id => {
        const s = DB.subjects[id];
        if (s) {
            const div = document.createElement('div');
            div.className = 'subject-item added';
            div.innerHTML = `<div class="icon">${s.icon}</div><div class="name">${s.name}</div>`;
            div.addEventListener('click', () => moveSubject(id, true));
            div.style.cursor = 'pointer';
            my.appendChild(div);
        }
    });

    if (my.children.length === 0) {
        my.innerHTML = '<div style="text-align:center; color:var(--text-light); padding:20px;">–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>';
    }

    // –î–æ—Å—Ç—É–ø–Ω—ã–µ
    ALL_SUBJECTS.forEach(s => {
        if (!DB.subjects[s.id]) {
            const div = document.createElement('div');
            div.className = 'subject-item';
            div.innerHTML = `<div class="icon">${s.icon}</div><div class="name">${s.name}</div>`;
            div.addEventListener('click', () => moveSubject(s.id, false));
            div.style.cursor = 'pointer';
            avail.appendChild(div);
        }
    });
}
function updatePresets() {
    const presetGrid = document.querySelector('.preset-grid');
    if (!presetGrid) return;

    presetGrid.innerHTML = ''; // –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–µ—Å–µ—Ç—ã

    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –ø—Ä–µ—Å–µ—Ç—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –º–æ–∏—Ö –ø—Ä–µ–¥–º–µ—Ç–∞—Ö
    const availablePresets = [
        { emoji: 'üìñ', name: '–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞' },
        { emoji: '‚öõÔ∏è', name: '–§–∏–∑–∏–∫–∞' },
        { emoji: 'üß™', name: '–•–∏–º–∏—è' },
        { emoji: 'üß¨', name: '–ë–∏–æ–ª–æ–≥–∏—è' },
        { emoji: 'üè∫', name: '–ò—Å—Ç–æ—Ä–∏—è' },
        { emoji: 'üåê', name: '–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫' }
    ];

    availablePresets.forEach(p => {
        const id = p.name.toLowerCase().replace(/[^a-z–∞-—è0-9]/gi, '-');
        if (!DB.subjects[id]) {
            const div = document.createElement('div');
            div.className = 'subject-item';
            div.innerHTML = `<div class="icon">${p.emoji}</div><div class="name">${p.name}</div>`;
            div.addEventListener('click', () => moveFromPreset(p.emoji, p.name));
            div.style.cursor = 'pointer';
            presetGrid.appendChild(div);
        }
    });
}
// –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
function moveSubject(id, isInMyList) {
    if (!DB || !DB.subjects) {
        App.toast("–î–∞–Ω–Ω—ã–µ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã");
        return;
    }

    let toastText = '';

    if (isInMyList) {
        if (DB.subjects[id]) {
            delete DB.subjects[id];
            toastText = `–ü–µ—Ä–µ–º–µ—â—ë–Ω –≤ –¥–æ—Å—Ç—É–ø–Ω—ã–µ`;
        }
    } else {
        const subj = ALL_SUBJECTS.find(s => s.id === id);
        if (subj && !DB.subjects[id]) {
            DB.subjects[id] = { name: subj.name, icon: subj.icon, sec: 0 };
            toastText = `–ü–µ—Ä–µ–º–µ—â—ë–Ω –≤ –º–æ–∏ –ø—Ä–µ–¥–º–µ—Ç—ã`;
        }
    }

    Data.save();

    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–ø–∏—Å–∫–æ–≤
    setTimeout(() => {
        updateSubjectLists();
        updatePresets(); // ‚Üê –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ—Å–µ—Ç–æ–≤
        if (App && App.renderSubjects) App.renderSubjects();
    }, 0);

    if (toastText) App.toast(toastText);
}

// –ó–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –ø—Ä–æ—Ñ–∏–ª—è
document.addEventListener('DOMContentLoaded', updateSubjectLists);

// –í–∞–∂–Ω–æ! –í—ã–∑–æ–≤ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è (–¥–æ–±–∞–≤—å —ç—Ç–æ –≤ Auth.login –∏–ª–∏ initAfterLogin)
if (typeof Auth !== 'undefined' && Auth.login) {
    const originalLogin = Auth.login;
    Auth.login = function(...args) {
        originalLogin.apply(Auth, args);
        setTimeout(() => {
            updateSubjectLists();
            console.log("–°–ø–∏—Å–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞");
        }, 500); // 0.5 —Å–µ–∫ ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —á—Ç–æ–±—ã DB –∑–∞–≥—Ä—É–∑–∏–ª—Å—è
    };
}

// ===== –ü–ï–†–ï–ú–ï–©–ï–ù–ò–ï –ò–ó –ü–†–ï–°–ï–¢–ê –í "–ú–û–ò –ü–†–ï–î–ú–ï–¢–´" =====

// –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∏–∑ –ø—Ä–µ—Å–µ—Ç–∞
function moveFromPreset(emoji, name) {
    const id = name.toLowerCase().replace(/[^a-z–∞-—è0-9]/gi, '-');

    if (DB.subjects[id]) {
        App.toast("–ü—Ä–µ–¥–º–µ—Ç —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω");
        return;
    }

    DB.subjects[id] = { name: name, icon: emoji, sec: 0 };
    Data.save();

    App.toast(`–ü–µ—Ä–µ–º–µ—â—ë–Ω: ${name}`);

    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Å–ø–∏—Å–∫–∏
    updateSubjectLists();
    updatePresets(); // ‚Üê –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ—Å–µ—Ç—ã

    if (App && App.renderSubjects) App.renderSubjects();
}
// –û—á–∏—Å—Ç–∫–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö/–Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –∫–ª—é—á–µ–π –≤ subjects (–∑–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–∫–∏ Firebase)
function cleanSubjects() {
    if (!DB || !DB.subjects) return;

    const keys = Object.keys(DB.subjects);
    keys.forEach(key => {
        if (!key || key.trim() === '' || key === 'undefined' || key === 'null') {
            delete DB.subjects[key];
            console.log("–£–¥–∞–ª—ë–Ω –ø—É—Å—Ç–æ–π/–Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π –∫–ª—é—á:", key);
        }
    });
}
function cleanEmptyKeys() {
    if (!DB || !DB.subjects) return;

    const keys = Object.keys(DB.subjects);
    keys.forEach(key => {
        if (!key || key.trim() === '' || key === 'undefined' || key === 'null') {
            delete DB.subjects[key];
            console.log("–£–¥–∞–ª—ë–Ω –ø—É—Å—Ç–æ–π –∫–ª—é—á subjects:", key);
        }
    });
}


// –†—É—á–Ω–æ–π –ø–µ—Ä–µ–Ω–æ—Å –ø–æ –∫–æ–¥—É (–∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç)
function manualQRTransfer() {
    const code = document.getElementById('manual-qr-code').value.trim();
    if (!code) return App.toast("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥");
    Transfer.pasteCode(code);
    document.querySelector('.modal.show').remove();
}
Transfer.pasteCode = function(code) {
    if (!code || code.trim() === '') {
        App.toast("‚ùå –ö–æ–¥ –ø—É—Å—Ç–æ–π");
        return;
    }

    try {
        // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
        const cleanedCode = code.trim().replace(/\s+/g, '');

        // –î–µ–∫–æ–¥–∏—Ä—É–µ–º base64 ‚Üí —Ç–µ–∫—Å—Ç ‚Üí JSON
        const decoded = atob(cleanedCode);
        const jsonText = decodeURIComponent(escape(decoded));
        const imported = JSON.parse(jsonText);

        if (imported && imported.user && imported.subjects) {
            DB = imported;
            Data.save();
            App.toast("‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—ë–Ω!");
            setTimeout(() => location.reload(), 1500); // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫
        } else {
            App.toast("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö");
        }
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞:", e);
        App.toast("‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫–æ–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω–æ–≤–æ.");
    }
};


</script>
<!-- ECO MODE OVERLAY -->
<div id="eco-overlay" onclick="App.toggleEcoMode(false)">
    <div class="eco-floater">
        <div id="eco-timer-display">00:00:00</div>
        <div class="eco-text">
            üîã –†–µ–∂–∏–º —ç–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–∂–µ–Ω–∏—è<br>
            –¢–∞–π–º–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç<br>
            –ù–∞–∂–º–∏, —á—Ç–æ–±—ã —Ä–∞–∑–±—É–¥–∏—Ç—å
        </div>
    </div>
</div>
</body>
</html>


